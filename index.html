<!DOCTYPE html>
	<html lang="zh-TW">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>é¥‹ç·šåœ–åœ°åœ–ç³»çµ±</title>
		
		<!-- ğŸ”§ ä¿®æ­£ï¼šå…ˆè¼‰å…¥ Leaflet CSS -->
		<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
			  integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" 
			  crossorigin=""/>
		
		<!-- ğŸ”§ ä¿®æ­£ï¼šå†è¼‰å…¥ Leaflet JavaScript -->
		<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" 
				integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" 
				crossorigin=""></script>
		
		<!-- ğŸ”§ ä¿®æ­£ï¼šæœ€å¾Œè¼‰å…¥ä¾è³´ Leaflet çš„æ’ä»¶ -->
		<script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.7.5/proj4.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/leaflet-rotatedmarker@0.2.0/leaflet.rotatedMarker.js"></script>
		<script src="https://unpkg.com/leaflet-rotate@0.1.4/dist/leaflet-rotate-src.js"></script>
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-compass@1.0.0/dist/leaflet-compass.css">
		<script src="https://cdn.jsdelivr.net/npm/leaflet-compass@1.0.0/dist/leaflet-compass.js"></script>
		<!-- ğŸ†• æ–°å¢ï¼šFont Awesome åœ–æ¨™åº« -->
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
		<script src="https://unpkg.com/leaflet.vectorgrid@1.3.0/dist/Leaflet.VectorGrid.bundled.js"></script>
		<!-- åœ¨ head å€åŸŸåŠ å…¥ Supabase å®¢æˆ¶ç«¯ -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
		<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Arial', sans-serif;
    background-color: #f5f5f5;
}

.header {
    background: linear-gradient(135deg, #2c3e50, #3498db);
    color: white;
    padding: 15px 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.header h1 {
    font-size: 24px;
    margin-bottom: 5px;
}

.header p {
    font-size: 14px;
    opacity: 0.9;
}

/* ğŸ”§ ä¿®æ­£ï¼šé›»è…¦ç‰ˆå›ºå®šå¸ƒå±€ + æ‰‹æ©Ÿç‰ˆéŸ¿æ‡‰å¼ */
.container {
    display: flex;
    height: calc(100vh - 80px);
    position: relative;
}

.sidebar {
    width: 320px;
    background: white;
    border-right: 1px solid #ddd;
    overflow-y: auto;
    box-shadow: 2px 0 5px rgba(0,0,0,0.1);
    z-index: 100;
    position: relative;
}

.map-container {
    flex: 1;
    position: relative;
    margin-left: 0;
	
	    image-rendering: -webkit-optimize-contrast;
    image-rendering: optimize-contrast;
    image-rendering: crisp-edges;
}

#map {
    width: 100%;
    height: 100%;
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
}

/* ğŸ†• æ‰‹æ©Ÿç‰ˆå°èˆª - é è¨­éš±è— */
.mobile-nav {
    display: none;
    background: #2c3e50;
    justify-content: space-around;
    padding: 10px 0;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 1000;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}

.nav-tab {
    flex: 1;
    padding: 12px;
    background: transparent;
    color: #bdc3c7;
    border: none;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.nav-tab.active {
    color: #3498db;
    background: rgba(52, 152, 219, 0.1);
    border-radius: 8px;
}

.file-upload-section {
    margin-bottom: 25px;
    padding: 20px;
    background: #f8f9fa;
    border-radius: 8px;
    border: 2px dashed #dee2e6;
    transition: all 0.3s ease;
}

.file-upload-section:hover {
    border-color: #3498db;
    background: #e3f2fd;
}

.file-upload-section h3 {
    margin-bottom: 15px;
    color: #2c3e50;
    font-size: 16px;
}

.file-input-wrapper {
    position: relative;
    display: inline-block;
    width: 100%;
}

#fileInput {
    display: none;
}

.file-input-button {
    display: block;
    width: 100%;
    padding: 12px 20px;
    background: linear-gradient(135deg, #3498db, #2980b9);
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.3s ease;
    text-align: center;
}

.file-input-button:hover {
    background: linear-gradient(135deg, #2980b9, #1f5f8b);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
}

.file-info {
    margin-top: 10px;
    font-size: 12px;
    color: #666;
    text-align: center;
}

.layer-controls {
    margin-bottom: 25px;
}

.layer-controls h3 {
    margin-bottom: 15px;
    color: #2c3e50;
    font-size: 16px;
    border-bottom: 2px solid #3498db;
    padding-bottom: 5px;
}

.layer-item {
    display: flex;
    align-items: center;
    margin-bottom: 12px;
    padding: 8px 12px;
    background: #f8f9fa;
    border-radius: 6px;
    transition: background 0.3s ease;
}

.layer-item:hover {
    background: #e9ecef;
}

.layer-item input[type="checkbox"] {
    margin-right: 10px;
    transform: scale(1.2);
}

.layer-item label {
    flex: 1;
    cursor: pointer;
    font-size: 14px;
    color: #495057;
}

.layer-count {
    font-size: 12px;
    color: #6c757d;
    background: #e9ecef;
    padding: 2px 8px;
    border-radius: 12px;
    margin-left: 8px;
}

.status-section {
    margin-bottom: 20px;
}

.status-section h3 {
    margin-bottom: 10px;
    color: #2c3e50;
    font-size: 16px;
}

#loadStatus {
    padding: 10px;
    background: #e8f5e8;
    border: 1px solid #c3e6c3;
    border-radius: 6px;
    font-size: 13px;
    color: #155724;
}

.legend {
    margin-top: 20px;
    padding: 15px;
    background: #fff;
    border: 1px solid #ddd;
    border-radius: 6px;
}

.legend h4 {
    margin-bottom: 10px;
    color: #2c3e50;
    font-size: 14px;
}

.legend-item {
    display: flex;
    align-items: center;
    margin-bottom: 8px;
    font-size: 12px;
}

.legend-color {
    width: 16px;
    height: 16px;
    border-radius: 50%;
    margin-right: 8px;
    border: 2px solid #fff;
    box-shadow: 0 0 0 1px rgba(0,0,0,0.2);
}

.legend-line {
    width: 20px;
    height: 3px;
    margin-right: 8px;
    border-radius: 2px;
}

.legend-line-dashed {
    width: 20px;
    height: 3px;
    margin-right: 8px;
    border-radius: 2px;
    background-image: repeating-linear-gradient(
        to right,
        currentColor,
        currentColor 4px,
        transparent 4px,
        transparent 8px
    );
}

.loading {
    display: none;
    text-align: center;
    padding: 20px;
    color: #666;
}

.loading.show {
    display: block;
}

.feeder-info {
    margin-bottom: 20px;
    padding: 15px;
    background: #e3f2fd;
    border-radius: 6px;
    border-left: 4px solid #2196f3;
}

.feeder-info h4 {
    margin-bottom: 8px;
    color: #1976d2;
}

.feeder-info p {
    margin: 4px 0;
    font-size: 13px;
    color: #424242;
}

/* ç·šæ®µé«˜äº®æ§åˆ¶æŒ‰éˆ•æ¨£å¼ */
.highlight-controls {
    margin-top: 15px;
    padding: 10px;
    background: #fff3cd;
    border: 1px solid #ffeaa7;
    border-radius: 6px;
    text-align: center;
}

.reset-highlight-btn {
    background: #28a745;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
    transition: background 0.3s ease;
}

.reset-highlight-btn:hover {
    background: #218838;
}

/* è¨­å‚™åœ–æ¨™æ¨£å¼ */
.simple-device-icon {
    background: transparent !important;
    border: none !important;
}

.simple-device-icon div {
    transition: none !important;
}

.leaflet-div-icon.arrow-icon {
    background: transparent !important;
    border: none !important;
}

.arrow-marker {
    width: 0;
    height: 0;
    border-left: 12px solid transparent;
    border-right: 12px solid transparent;
    border-bottom: 24px solid;
    transform-origin: center bottom;
}

/* æ˜Ÿæ˜Ÿæ¨™è¨˜æ¨£å¼ */
.opposite-star-icon {
    background: transparent !important;
    border: none !important;
}

.opposite-star-marker {
    display: flex;
    flex-direction: row;
    align-items: center;
    text-align: left;
    white-space: nowrap;
}

.star-icon {
    font-size: 16px;
    filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5));
    margin-right: 4px;
    flex-shrink: 0;
}

.opposite-text {
    background: rgba(255, 0, 0, 0.9);
    color: white;
    padding: 2px 6px;
    border-radius: 12px;
    font-size: 10px;
    font-weight: bold;
    border: 1px solid #ff0000;
    box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    white-space: nowrap;
    flex-shrink: 0;
}

/* å…¨é¸æ§åˆ¶å€åŸŸæ¨£å¼ */
.select-all-container {
    margin-bottom: 15px;
    padding: 12px;
    background: #f8f9fa;
    border-radius: 6px;
    border: 1px solid #dee2e6;
}

.select-all-section h4 {
    margin: 0 0 10px 0;
    color: #2c3e50;
    font-size: 14px;
    font-weight: bold;
}

.select-all-buttons {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
    margin-bottom: 8px;
}

.select-all-btn {
    padding: 6px 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    background: #fff;
    cursor: pointer;
    font-size: 12px;
    transition: all 0.2s;
    text-align: center;
    font-weight: 500;
}

.select-all-btn:hover {
    background: #e9ecef;
    border-color: #adb5bd;
    transform: translateY(-1px);
}

.select-all-btn.equipment {
    border-left: 3px solid #ff6b35;
    color: #ff6b35;
}

.select-all-btn.lines {
    border-left: 3px solid #4ecdc4;
    color: #4ecdc4;
}

.select-all-btn.deselect {
    grid-column: 1 / -1;
    border-left: 3px solid #dc3545;
    color: #dc3545;
}

.select-all-btn.active {
    background: linear-gradient(135deg, #28a745, #20c997);
    color: white;
    border-color: #28a745;
    box-shadow: 0 2px 4px rgba(40, 167, 69, 0.3);
}

.select-all-btn.active:hover {
    background: linear-gradient(135deg, #218838, #1e7e34);
    transform: translateY(-1px);
    box-shadow: 0 3px 6px rgba(40, 167, 69, 0.4);
}

.select-all-btn.equipment.active,
.select-all-btn.lines.active {
    border-left: 3px solid #fff;
}

.divider {
    border: none;
    border-top: 1px solid #dee2e6;
    margin: 10px 0;
}

/* è‡ªè¨‚å½ˆå‡ºè¦–çª—æ¨£å¼ */
.custom-popup .leaflet-popup-content-wrapper {
    border-radius: 12px;
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    border: none;
}

.custom-popup .leaflet-popup-content {
    margin: 10px;
    line-height: 1.4;
}

.custom-popup .leaflet-popup-tip {
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

/* é¥‹ç·šé¸æ“‡å€åŸŸæ¨£å¼ */
.feeder-selection-section {
    margin-bottom: 25px;
    padding: 20px;
    background: #e8f5e8;
    border-radius: 8px;
    border: 2px solid #28a745;
    transition: all 0.3s ease;
}

.feeder-selection-section h3 {
    margin-bottom: 15px;
    color: #155724;
    font-size: 16px;
    font-weight: bold;
}

.feeder-input-row {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-bottom: 12px;
}

.feeder-input {
    width: 100%;
    padding: 10px;
    border: 2px solid #28a745;
    border-radius: 6px;
    font-size: 14px;
    outline: none;
    transition: border-color 0.3s ease;
}

.feeder-input:focus {
    border-color: #20c997;
    box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.1);
}

.feeder-dropdown {
    width: 100%;
    padding: 10px;
    border: 2px solid #28a745;
    border-radius: 6px;
    font-size: 14px;
    outline: none;
    background: white;
    cursor: pointer;
}

.feeder-button-row {
    margin-bottom: 12px;
}

.load-feeder-btn {
    width: 100%;
    padding: 12px 20px;
    background: linear-gradient(135deg, #28a745, #20c997);
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 16px;
    font-weight: bold;
    transition: all 0.3s ease;
    box-shadow: 0 4px 8px rgba(40, 167, 69, 0.2);
}

.load-feeder-btn:hover {
    background: linear-gradient(135deg, #218838, #1e7e34);
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(40, 167, 69, 0.3);
}

.load-feeder-btn:active {
    transform: translateY(0);
    box-shadow: 0 2px 4px rgba(40, 167, 69, 0.2);
}

.load-feeder-btn:disabled {
    background: #6c757d;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
}

.load-feeder-btn.loading {
    background: #17a2b8;
    animation: pulse 1.5s ease-in-out infinite;
}

@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.7; }
    100% { opacity: 1; }
}

.feeder-info-text {
    font-size: 12px;
    color: #155724;
    text-align: center;
    line-height: 1.4;
}

.feeder-selection-section.success {
    border-color: #28a745;
    background: linear-gradient(135deg, #d4edda, #c3e6cb);
}

.feeder-selection-section.loading {
    border-color: #17a2b8;
    background: linear-gradient(135deg, #d1ecf1, #bee5eb);
}

.feeder-selection-section.error {
    border-color: #dc3545;
    background: linear-gradient(135deg, #f8d7da, #f5c6cb);
}

/* å®šä½æŒ‰éˆ•æ¨£å¼ */
.location-controls {
    position: absolute;
    bottom: 20px;
    right: 10px;
    z-index: 1000;
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.location-btn {
    background: #4CAF50;
    color: white;
    border: none;
    padding: 10px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 14px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    transition: background 0.3s;
}

.location-btn:hover {
    background: #45a049;
}

.location-btn.active {
    background: #2196F3;
}

/* åœ–è™Ÿåº§æ¨™è¼¸å…¥å€åŸŸ */
.coordinate-input-section {
    margin-bottom: 25px;
    padding: 20px;
    background: #fff3cd;
    border-radius: 8px;
    border: 2px solid #ffc107;
}

.coordinate-input-section h3 {
    margin-bottom: 15px;
    color: #856404;
    font-size: 16px;
}

.coordinate-input {
    width: 100%;
    padding: 10px;
    border: 2px solid #ffc107;
    border-radius: 6px;
    font-size: 14px;
    margin-bottom: 10px;
}

.coordinate-btn {
    width: 100%;
    padding: 10px;
    background: #ffc107;
    color: #212529;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: bold;
}

.coordinate-btn:hover {
    background: #e0a800;
}

/* åœ°åœ–æ—‹è½‰æ§åˆ¶æ¨£å¼ */
/* åœ°åœ–æ—‹è½‰æ§åˆ¶æ¨£å¼ - ç°¡åŒ–ç‰ˆ */
.rotation-controls {
    position: absolute;
    bottom: 120px;
    right: 10px;
    background: rgba(255, 255, 255, 0.95);
    border-radius: 8px;
    padding: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    display: flex;
    flex-direction: column;
    gap: 8px;
    min-width: 140px; /* ç¸®å°å¯¬åº¦ */
    z-index: 1000;
}

/* ğŸ”§ ä¿®æ­£ç‰ˆï¼šæŒ‰éˆ•æ¨£å¼ - ç¢ºä¿ active ç‹€æ…‹æ­£ç¢ºé¡¯ç¤º */
.rotation-btn {
    background: white;
    border: 2px solid #ddd;
    color: #333;
    padding: 8px 12px;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.3s ease;
    user-select: none;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    -webkit-tap-highlight-color: transparent;
}

.rotation-btn:hover {
    background: #f8f9fa;
    border-color: #007bff;
    transform: translateY(-1px);
}

.rotation-btn.active {
    background: #007bff !important;
    color: white !important;
    border-color: #0056b3 !important;
    box-shadow: 0 2px 8px rgba(0, 123, 255, 0.3);
}

/* ğŸ”§ ç‰¹åˆ¥è™•ç†è·Ÿéš¨æ–¹å‘æŒ‰éˆ•çš„å•Ÿç”¨ç‹€æ…‹ */
#followHeadingBtn.active {
    background: #007bff !important;
    border-color: #0056b3 !important;
    box-shadow: 0 2px 8px rgba(0, 123, 255, 0.3);
}
/* åœ–å±¤åˆ‡æ›å¢å¼·æ¨£å¼ */
.layer-switcher-compact {
    position: absolute;
    top: 10px;
    right: 10px;
    z-index: 1001;
}

.layer-toggle-btn {
    background: rgba(255, 255, 255, 0.9);
    border: 2px solid #ddd;
    border-radius: 6px;
    padding: 8px 12px;
    font-size: 14px;
    font-weight: bold;
    cursor: pointer;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
}

.layer-toggle-btn:hover {
    background: white;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
}

.layer-menu {
    position: absolute;
    top: 45px;
    right: 0;
    background: white;
    border: 2px solid #ddd;
    border-radius: 8px;
    padding: 15px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    max-width: 280px;
    max-height: 400px;
    overflow-y: auto;
    animation: slideDown 0.3s ease;
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.layer-group {
    margin-bottom: 15px;
    border-bottom: 1px solid #eee;
    padding-bottom: 10px;
}

.layer-group:last-child {
    border-bottom: none;
    margin-bottom: 0;
}

.layer-group h5 {
    margin: 0 0 8px 0;
    font-size: 13px;
    font-weight: bold;
    color: #333;
}

.layer-option {
    display: flex;
    align-items: center;
    margin: 5px 0;
    font-size: 12px;
}

.layer-option input {
    margin-right: 8px;
}

.layer-option label {
    cursor: pointer;
    flex: 1;
}

.layer-opacity-control {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 11px;
}

.opacity-slider {
    flex: 1;
    height: 4px;
}

/* å…¨è¢å¹•æ§åˆ¶ */
.fullscreen-btn {
    position: absolute;
    top: 10px;
    left: 10px;
    z-index: 10000;
    background: #4CAF50;
    color: white;
    border: none;
    padding: 10px 15px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    font-weight: bold;
    box-shadow: 0 3px 8px rgba(0,0,0,0.3);
    transition: all 0.3s ease;
    white-space: nowrap;
}

.fullscreen-btn:hover {
    background: #45a049;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.4);
}

.fullscreen-mode .fullscreen-btn {
    background: #ff5722;
    animation: pulse 2s infinite;
}

.fullscreen-mode .fullscreen-btn:hover {
    background: #e64a19;
}

/* ğŸ†• æ–°å¢ï¼šå´é‚Šæ¬„åˆ‡æ›æŒ‰éˆ• */
.sidebar-toggle-btn {
    position: absolute;
    top: 10px;
    left: 70px; /* åœ¨å…¨è¢å¹•æŒ‰éˆ•å³é‚Š */
    z-index: 10000;
    background: #2196F3;
    color: white;
    border: none;
    padding: 10px 15px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    font-weight: bold;
    box-shadow: 0 3px 8px rgba(0,0,0,0.3);
    transition: all 0.3s ease;
    white-space: nowrap;
    display: none; /* é è¨­éš±è— */
}

.sidebar-toggle-btn:hover {
    background: #1976D2;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.4);
}

.fullscreen-mode .sidebar-toggle-btn {
    display: block; /* å…¨è¢å¹•æ™‚é¡¯ç¤º */
}

/* ğŸ”§ ä¿®æ”¹ï¼šå…¨è¢å¹•æ¨¡å¼ä¿ç•™å·¦å´é¸å–® */
.fullscreen-mode .header {
    display: none;
}

.fullscreen-mode .container {
    height: 100vh;
}

/* ğŸ”§ æ–°å¢ï¼šå…¨è¢å¹•æ™‚ä¿ç•™å´é‚Šæ¬„ï¼Œä½†å¯ä»¥åˆ‡æ›é¡¯ç¤º/éš±è— */
.fullscreen-mode .sidebar {
    position: fixed;
    left: 0;
    top: 0;
    width: 320px;
    height: 100vh;
    z-index: 1001;
    background: white;
    box-shadow: 2px 0 10px rgba(0,0,0,0.3);
    transition: left 0.3s ease;
}
/* ğŸ†• æ–°å¢ï¼šéš±è—å´é‚Šæ¬„çš„ç‹€æ…‹ */
.fullscreen-mode .sidebar.hidden {
    left: -320px;
}

.fullscreen-mode .map-container {
    width: 100%;
    height: 100vh;
    margin-left: 0;
    transition: margin-left 0.3s ease;
}

/* ğŸ†• æ–°å¢ï¼šç•¶å´é‚Šæ¬„é¡¯ç¤ºæ™‚ï¼Œåœ°åœ–å®¹å™¨å‘å³åç§» */
.fullscreen-mode .map-container.with-sidebar {
    margin-left: 320px;
    width: calc(100% - 320px);
}
/* ğŸ”§ æ–°å¢ï¼šæ‰‹æ©Ÿç‰ˆéš±è—å…¨è¢å¹•æŒ‰éˆ• */
@media (max-width: 768px) {
    .fullscreen-btn {
        display: none !important;
    }
}

/* æ¸¬é‡å·¥å…·æ¨£å¼ */
.measure-controls {
    position: absolute;
    top: 60px;
    left: 10px;
    z-index: 1000;
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.measure-btn {
    background: #FF9800;
    color: white;
    border: none;
    padding: 8px 12px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 12px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}

.measure-btn:hover {
    background: #F57C00;
}

.measure-btn.active {
    background: #E65100;
}

/* ğŸ”§ ä¿®æ­£ï¼šæ‰‹æ©Ÿç‰ˆå°ˆç”¨æ¨£å¼ */
@media (max-width: 768px) {
	/* å®šä½æ§åˆ¶æŒ‰éˆ• - ç¸®å°ç‰ˆ */
    .location-controls {
        position: fixed;
        bottom: 20px;        /* ğŸ”§ æ”¹åˆ°åº•éƒ¨ */
        right: 15px;         /* ğŸ”§ ä¿æŒå³å´ */
        z-index: 1000;
        display: flex;
        flex-direction: column;
        gap: 8px;
    }
		
    .location-btn, .rotation-btn {
        background: #4CAF50;
        color: white;
        border: none;
        padding: 6px 10px;   /* ğŸ”§ ç¸®å°æŒ‰éˆ• */
        border-radius: 6px;
        cursor: pointer;
        font-size: 11px;     /* ğŸ”§ ç¸®å°å­—é«” */
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        transition: background 0.3s;
        min-width: 70px;     /* ğŸ”§ é™åˆ¶å¯¬åº¦ */
        max-width: 90px;
        text-align: center;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
		

    .mobile-nav {
        display: flex !important;
    }
    
   .nav-tab {
        flex: 1;
        padding: 10px 8px;
        background: transparent;
        color: #bdc3c7;
        border: none;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: center;
    }
    
    .nav-tab.active {
        color: #3498db;
        background: rgba(52, 152, 219, 0.1);
        border-radius: 8px;
    }
    
    .header {
        display: none;
    }
    
    .container {
        height: 100vh;
        margin-top: 60px;
        flex-direction: column;
    }
    
    .sidebar {
        width: 100%;
        height: calc(100vh - 60px);
        position: fixed;
        top: 60px;
        left: 0;
        z-index: 999;
        display: none;
        border-right: none;
        border-bottom: 1px solid #ddd;
    }
    
    .map-container {
        width: 100%;
        height: calc(100vh - 60px);
        position: fixed;
        top: 60px;
        left: 0;
        margin-left: 0;
    }
    
    #map {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
    }
    
    /* è§¸æ§å„ªåŒ– */
    .control-btn {
        padding: 12px 16px;
        font-size: 14px;
        min-height: 44px; /* ğŸ”§ ç¢ºä¿è§¸æ§å‹å¥½çš„æœ€å°é«˜åº¦ */
        -webkit-touch-callout: none; /* ğŸ”§ ç¦ç”¨é•·æŒ‰é¸å–® */
    }
    .measure-btn,
    .load-feeder-btn {
        min-height: 44px;
        min-width: 44px;
        font-size: 16px;
        padding: 12px 16px;
    }
    
    .measure-controls {
        position: fixed;
        bottom: 20px;
        right: 20px;
        top: auto;
        left: auto;
        flex-direction: row;
        background: rgba(255, 255, 255, 0.95);
        padding: 10px;
        border-radius: 25px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .control-btn:active,
    .measure-btn:active {
        transform: scale(0.95);
        transition: transform 0.1s;
    }
    
    .feeder-input,
    .feeder-dropdown {
        width: 100%;
    }
    
    .load-feeder-btn {
        font-size: 14px;
        padding: 10px 16px;
    }
	
	.coordinate-input-section {
        margin-bottom: 25px;
        padding: 15px;
        background: #fff3cd;
        border-radius: 8px;
        border: 2px solid #ffc107;
        /* ğŸ”§ é‡è¦ï¼šç¢ºä¿åœ¨æ‰‹æ©Ÿç‰ˆæœ‰è¶³å¤ çš„åº•éƒ¨ç©ºé–“ */
        padding-bottom: 80px; /* å¢åŠ åº•éƒ¨å…§é‚Šè· */
    }
    
    .coordinate-input-section h3 {
        margin-bottom: 12px;
        color: #856404;
        font-size: 16px;
    }
    
    .coordinate-input {
        width: 100%;
        padding: 12px;
        border: 2px solid #ffc107;
        border-radius: 6px;
        font-size: 16px; /* ğŸ”§ å¢å¤§å­—é«”é¿å…ç¸®æ”¾ */
        margin-bottom: 15px;
        box-sizing: border-box;
    }
    
    .coordinate-btn {
        width: 100%;
        padding: 15px; /* ğŸ”§ å¢åŠ æŒ‰éˆ•é«˜åº¦ */
        background: #ffc107;
        color: #212529;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
        font-size: 16px; /* ğŸ”§ å¢å¤§æŒ‰éˆ•å­—é«” */
        min-height: 50px; /* ğŸ”§ ç¢ºä¿æœ€å°è§¸æ§é«˜åº¦ */
        margin-bottom: 15px; /* ğŸ”§ å¢åŠ åº•éƒ¨é–“è· */
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        transition: all 0.2s ease;
    }
    
    .coordinate-btn:hover,
    .coordinate-btn:active {
        background: #e0a800;
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
	
}

/* ğŸ”§ ä¿®æ­£ï¼šæ¡Œé¢ç‰ˆç¢ºä¿æ­£å¸¸é¡¯ç¤º */
@media (min-width: 769px) {
    .mobile-nav {
        display: none !important;
    }
    
    .header {
        display: block;
    }
    
    .container {
        margin-top: 0;
        height: calc(100vh - 80px);
    }
    
    .sidebar {
        position: relative;
        display: block;
    }
    
    .map-container {
        position: relative;
    }
}

/* Google Maps é¢¨æ ¼çš„å®šä½åœ–æ¨™ */
.location-marker {
    position: relative;
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* å¤–åœˆå…‰æšˆæ•ˆæœ */
.location-marker::before {
    content: '';
    position: absolute;
    width: 40px;
    height: 40px;
    background: rgba(66, 133, 244, 0.2);
    border-radius: 50%;
    animation: pulse-glow 2s infinite;
    z-index: 1;
}

/* ä¸­é–“ç™½è‰²åœ“åœˆ */
.location-marker::after {
    content: '';
    position: absolute;
    width: 20px;
    height: 20px;
    background: white;
    border-radius: 50%;
    border: 2px solid #4285f4;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    z-index: 2;
}

/* ä¸­å¿ƒè—è‰²åœ“é» - åŠ å¤§å°ºå¯¸ */
.location-marker .center-dot {
    width: 12px;
    height: 12px;
    background: #4285f4;
    border-radius: 50%;
    z-index: 3;
    position: relative;
}

/* å…‰æšˆå‹•ç•« */
@keyframes pulse-glow {
    0% {
        transform: scale(0.8);
        opacity: 0.8;
    }
    50% {
        transform: scale(1.2);
        opacity: 0.3;
    }
    100% {
        transform: scale(0.8);
        opacity: 0.8;
    }
}



/* æ‰‹æ©Ÿç‰ˆæŒ‡åŒ—é‡èª¿æ•´ */

/* ğŸ”§ æ–°å¢ï¼šæ‰‹æ©Ÿç‰ˆéš±è—æ¸¬é‡å·¥å…· */
@media (max-width: 768px) {
    .measure-controls {
        display: none !important;
    }
}

/* ğŸ”§ ä¿®æ­£ç‰ˆï¼šæŒ‰éˆ•æ¨£å¼ - é¿å…åç™½å•é¡Œ */
.control-btn {
    background: #fff;
    border: 2px solid #ddd;
    color: #333;
    padding: 8px 12px;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.3s ease;
    user-select: none; /* ğŸ”§ é˜²æ­¢æ–‡å­—é¸å– */
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    -webkit-tap-highlight-color: transparent; /* ğŸ”§ ç§»é™¤é»æ“Šé«˜äº® */
}

.control-btn:hover {
    background: #f8f9fa;
    border-color: #007bff;
    transform: translateY(-1px);
}

.control-btn.active {
    background: #007bff !important;
    color: white !important;
    border-color: #0056b3 !important;
    box-shadow: 0 2px 8px rgba(0, 123, 255, 0.3);
}

/* ğŸ”§ ç‰¹åˆ¥è™•ç†åœæ­¢æŒ‰éˆ• */
.control-btn.active[id="locateBtn"] {
    background: #dc3545 !important;
    border-color: #c82333 !important;
    box-shadow: 0 2px 8px rgba(220, 53, 69, 0.3);
}

/* ğŸ†• åœé›»è³‡æ–™æ¨£å¼ */
.outage-data-section {
    animation: slideIn 0.5s ease-out;
}

/* ğŸ”§ ä¿®æ”¹ï¼šåœé›»è³‡æ–™æ¨£å¼ - åŠ å…¥ç‹€æ…‹é¡è‰²æ”¯æ´ */
.outage-feeder-item:hover {
    background: #f8f9fa !important;
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    transition: all 0.2s ease;
}

.fault-line-animation {
    animation: dash 2s linear infinite;
}

@keyframes dash {
    to {
        stroke-dashoffset: -20;
    }
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}
/* ğŸ†• ä¸åŒç‹€æ…‹çš„ hover æ•ˆæœ */
.outage-feeder-item[style*="border-left: 4px solid #28a745"]:hover {
    box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
}

.outage-feeder-item[style*="border-left: 4px solid #6c757d"]:hover {
    box-shadow: 0 2px 8px rgba(108, 117, 125, 0.3);
}

.outage-feeder-item[style*="border-left: 4px solid #dc3545"]:hover {
    box-shadow: 0 2px 8px rgba(220, 53, 69, 0.3);
}
/* ğŸ†• æ‰‹æ©Ÿç‰ˆé¥‹ç·šè©³æƒ…æ¨£å¼ */
@media (max-width: 768px) {
    #feederDetailsContainer {
        animation: slideInFromRight 0.3s ease-out;
    }
    
    @keyframes slideInFromRight {
        from {
            transform: translateX(100%);
        }
        to {
            transform: translateX(0);
        }
    }
    
    /* é˜²æ­¢åœ¨è©³æƒ…é é¢æ™‚èª¤è§¸åœ°åœ– */
    #feederDetailsContainer ~ * {
        pointer-events: none;
    }
}

/* æ‰‹æ©Ÿç‰ˆæŒ‰éˆ•å„ªåŒ– */
@media (max-width: 768px) {
    .outage-feeder-item {
        padding: 15px !important;
        margin-bottom: 12px !important;
    }
    
    .outage-feeder-item strong {
        font-size: 16px !important;
    }
}

/* ğŸ”§ ä¿®æ”¹ï¼šç½æƒ…æŸ¥å ±ç›¸é—œæ¨£å¼ - è—è‰²ç³» */
.disaster-report-section {
    margin-bottom: 25px;
    padding: 20px;
    background: linear-gradient(135deg, #e3f2fd, #bbdefb);
    border-radius: 8px;
    border: 2px solid #2196f3;
    transition: all 0.3s ease;
}


.disaster-marker-icon {
    background: transparent !important;
    border: none !important;
}

.disaster-popup .leaflet-popup-content-wrapper {
    border-radius: 12px;
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    border: none;
}

.photo-modal {
    display: none;
    position: fixed;
    z-index: 2000;
    padding-top: 50px;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0,0,0,0.9);
}

.photo-modal-content {
    margin: auto;
    display: block;
    max-width: 90%;
    max-height: 80%;
    object-fit: contain;
}

.photo-modal-close {
    position: absolute;
    top: 15px;
    right: 25px;
    color: white;
    font-size: 35px;
    font-weight: bold;
    cursor: pointer;
    z-index: 2002;
}

.photo-navigation {
    position: absolute;
    width: 100%;
    top: 50%;
    display: flex;
    justify-content: space-between;
    padding: 0 20px;
    box-sizing: border-box;
    z-index: 2001;
}

.photo-nav-btn {
    background-color: rgba(0,0,0,0.5);
    color: white;
    border: none;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    font-size: 20px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background-color 0.3s;
}

.photo-nav-btn:hover {
    background-color: rgba(0,0,0,0.8);
}

.photo-counter {
    position: absolute;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    background-color: rgba(0,0,0,0.5);
    color: white;
    padding: 5px 10px;
    border-radius: 15px;
    font-size: 14px;
    z-index: 2001;
}

.repair-status-badge {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 10px;
    font-weight: bold;
    margin-bottom: 5px;
}

.repair-status-completed {
    background-color: #28a745;
    color: white;
}

.repair-status-dispatched {
    background-color: #ffc107;
    color: #212529;
}

.repair-status-pending {
    background-color: #dc3545;
    color: white;
}

.severity-badge {
    display: inline-block;
    padding: 2px 6px;
    border-radius: 8px;
    font-size: 9px;
    font-weight: bold;
    margin-left: 5px;
}

.severity-æ¥µåš´é‡ { background-color: #6f42c1; color: white; }
.severity-åš´é‡ { background-color: #dc3545; color: white; }
.severity-ä¸€èˆ¬ { background-color: #fd7e14; color: white; }
.severity-è¼•å¾® { background-color: #ffc107; color: #212529; }
.severity-ä¸å½±éŸ¿ { background-color: #6c757d; color: white; }
.severity-æœªå®šç¾© { background-color: #e9ecef; color: #495057; }
/* ğŸ”§ æ–°å¢ï¼šåœ–å±¤è¼‰å…¥å„ªåŒ–ï¼Œæ¸›å°‘é–ƒçˆ */
.leaflet-tile-container {
    transition: none !important; /* ç§»é™¤éæ¸¡å‹•ç•« */
}

.leaflet-tile {
    image-rendering: -webkit-optimize-contrast;
    image-rendering: crisp-edges;
    image-rendering: pixelated;
    transition: opacity 0.1s ease; /* æ¸›å°‘éæ¸¡æ™‚é–“ */
}

/* ğŸ†• ä½ç½®æ¨™è¨˜å„ªåŒ– */
.location-marker {
    will-change: transform;
    backface-visibility: hidden;
	transform: translateZ(0); /* å•Ÿç”¨ç¡¬é«”åŠ é€Ÿ */
}
/* ğŸ”§ ä¿®æ­£ç‰ˆï¼šæŒ‡åŒ—é‡æ§åˆ¶æ¨£å¼ - ç¶ è‰²ç³»é…è‰² */
.compass-controls {
    position: absolute;
    bottom: 95px; /* æ›´è²¼è¿‘è·Ÿéš¨è£ç½®æŒ‰éˆ• */
    right: 10px;
    z-index: 1000;
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.compass-btn {
    background: #4CAF50; /* ğŸ”§ æ”¹ç‚ºç¶ è‰²åº•ï¼Œè·Ÿè·Ÿéš¨è£ç½®ä¸€è‡´ */
    color: white;
    border: none;
    padding: 12px;
    border-radius: 50%; /* åœ“å½¢æŒ‰éˆ• */
    cursor: pointer;
    font-size: 18px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    transition: all 0.3s ease;
    width: 50px;
    height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
    user-select: none;
    -webkit-user-select: none;
    -webkit-tap-highlight-color: transparent;
}

.compass-btn:hover {
    background: #45a049; /* ğŸ”§ æ·±ç¶ è‰² hoverï¼Œè·Ÿè·Ÿéš¨è£ç½®ä¸€è‡´ */
    transform: translateY(-1px) scale(1.05);
}

.compass-btn.active {
    background: #1976d2 !important; /* ğŸ”§ æ·ºè—è‰²å•Ÿå‹•ç‹€æ…‹ */
    color: white !important;
    box-shadow: 0 2px 8px rgba(135, 206, 235, 0.4); /* ğŸ”§ æ·ºè—è‰²é™°å½± */
    animation: compass-pulse 2s infinite;
}

/* ğŸ”§ å¢å¼·ç‰ˆï¼šæŒ‡åŒ—é‡è„ˆè¡å‹•ç•« - æ›´å¤§çš„è„ˆè¡æ•ˆæœ */
@keyframes compass-pulse {
    0% { 
        box-shadow: 0 2px 8px rgba(135, 206, 235, 0.4);
        transform: scale(1);
    }
    50% { 
        box-shadow: 0 8px 32px rgba(135, 206, 235, 0.8);
        transform: scale(1.15);
    }
    100% { 
        box-shadow: 0 2px 8px rgba(135, 206, 235, 0.4);
        transform: scale(1);
    }
}

/* æ‰‹æ©Ÿç‰ˆæŒ‡åŒ—é‡èª¿æ•´ */
@media (max-width: 768px) {
    .compass-controls {
        bottom: 75px; /* æ‰‹æ©Ÿç‰ˆæ›´è²¼è¿‘ */
        right: 15px;
    }
    
    .compass-btn {
        width: 45px;
        height: 45px;
        font-size: 16px;
        padding: 10px;
    }
}

/* ç½æƒ…æŸ¥å ±ç³»çµ±æ¨£å¼ */
.disaster-form-section {
    transition: all 0.3s ease;
}

.disaster-form-section:hover {
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

/* ç½æƒ…æŸ¥å ±æŒ‰éˆ•å‹•ç•« */
button[onclick*="openDisasterReportSystem"] {
    position: relative;
    overflow: hidden;
}

button[onclick*="openDisasterReportSystem"]:before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
    transition: left 0.5s;
}

button[onclick*="openDisasterReportSystem"]:hover:before {
    left: 100%;
}

/* æ‰‹æ©Ÿç‰ˆç½æƒ…æŸ¥å ±å„ªåŒ– */
@media (max-width: 768px) {
    .mobile-disaster-form {
        padding: 0 !important;
    }
    
    .disaster-form-section {
        margin-bottom: 20px !important;
        padding: 15px !important;
    }
    
    #disaster-drag-area {
        padding: 30px 20px !important;
    }
    
    input, select, textarea {
        font-size: 16px !important; /* é˜²æ­¢ iOS ç¸®æ”¾ */
    }
}

/* ç½æƒ…æŸ¥å ±è¼‰å…¥å‹•ç•« */
@keyframes disasterFadeIn {
    from {
        opacity: 0;
        transform: scale(0.9);
    }
    to {
        opacity: 1;
        transform: scale(1);
    }
}

#disaster-report-container {
    animation: disasterFadeIn 0.3s ease-out;
}
/* è‡ªå‹•å¡«å…¥æ¬„ä½çš„å‹•ç•«æ•ˆæœ */
@keyframes autoFillHighlight {
    0% {
        background-color: #e8f5e8;
        border-color: #28a745;
        transform: scale(1);
    }
    50% {
        background-color: #d4edda;
        border-color: #155724;
        transform: scale(1.02);
    }
    100% {
        background-color: #e8f5e8;
        border-color: #28a745;
        transform: scale(1);
    }
}

/* ç½æƒ…æŸ¥å ±è‡ªå‹•å¡«å…¥æç¤º */
.disaster-auto-filled {
    animation: autoFillHighlight 0.8s ease-in-out;
}
		</style>
	</head>
	<body>
	    <!-- ğŸ†• åœ¨é€™è£¡åŠ å…¥æ‰‹æ©Ÿç‰ˆå°èˆª - æ”¾åœ¨æœ€é ‚éƒ¨ -->
	<div class="mobile-nav" style="display: none;">
		<button class="nav-tab active" data-tab="map">ğŸ—ºï¸ åœ°åœ–</button>
		<button class="nav-tab" data-tab="controls">âš™ï¸ æ§åˆ¶</button>
		<button class="nav-tab" data-tab="layers">ğŸ›ï¸ åœ–å±¤</button>
	</div>
		<div class="header">
			<h1>ğŸ—ºï¸ é¥‹ç·šåœ–åœ°åœ–ç³»çµ±</h1>
			<p>è¼‰å…¥é…é›»ç³»çµ± JSON æª”æ¡ˆä¸¦è‡ªè¨‚åœ–å±¤é¡¯ç¤ºï¼ˆæ”¯æ´é»èˆ‡ç·šæ®µé«˜äº®ï¼‰</p>
		</div>
		
		<div class="container">
			<div class="sidebar">
			<!-- ğŸ†• åœé›»è³‡æ–™å€åŸŸ -->
			<div class="outage-data-section" style="margin-bottom: 25px; padding: 20px; background: #fff3cd; border-radius: 8px; border: 2px solid #ffc107;">
				<h3 style="color: #856404; margin-bottom: 15px;">âš¡ é¥‹ç·šç›£æ§é¢æ¿</h3>
				
				<div id="outageStatus" style="margin-bottom: 15px; padding: 10px; background: #e8f5e8; border-radius: 6px; font-size: 13px;">
					æ­£åœ¨è¼‰å…¥åœé›»è³‡æ–™...
				</div>
				<!-- ğŸ†• æ–°å¢ï¼šä¸»å¹¹å¾©é›»ç‹€æ…‹ç¯©é¸ -->
				<div style="margin-bottom: 15px;">
					<select id="outageFilter" style="width: 100%; padding: 8px; border: 2px solid #ffc107; border-radius: 4px; background: white; color: #856404; font-weight: 500;" onchange="filterOutageByStatus()">
						<option value="all">å…¨éƒ¨äº‹æ•…é¥‹ç·š</option>
						<option value="restored">ä¸»å¹¹å·²å¾©é›»</option>
						<option value="not_restored">ä¸»å¹¹æœªå¾©é›»</option>
					</select>
				</div>

				<!-- é¥‹ç·šè·³è„«æ¸…å–® -->
				<div id="outageFeederList" style="max-height: 200px; overflow-y: auto; margin-bottom: 15px;">
					<!-- å‹•æ…‹è¼‰å…¥çš„é¥‹ç·šæ¸…å–® -->
				</div>
				
				<!-- æ“ä½œæŒ‰éˆ• -->
				<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
					<button onclick="refreshOutageData()" 
							style="padding: 8px 12px; background: #17a2b8; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
						ğŸ”„ é‡æ–°æ•´ç†
					</button>

				</div>
			</div>
			
			<!-- ğŸ”§ ä¿®æ”¹ï¼šç½æƒ…æŸ¥å ±å€åŸŸ - æ”¹ç‚ºè—è‰²ç³» -->
			<div class="disaster-report-section" style="margin-bottom: 25px; padding: 20px; background: linear-gradient(135deg, #e3f2fd, #bbdefb); border-radius: 8px; border: 2px solid #2196f3;">
				<h3 style="color: #0d47a1; margin-bottom: 15px; text-shadow: 0 1px 2px rgba(13, 71, 161, 0.1);">ğŸš¨ ç½æƒ…æŸ¥å ±é¢æ¿</h3>
				
				<div id="disasterStatus" style="margin-bottom: 15px; padding: 10px; background: #e8f4fd; border: 1px solid #64b5f6; border-radius: 6px; font-size: 13px; color: #1565c0;">
					æ­£åœ¨è¼‰å…¥ç½æƒ…è³‡æ–™...
				</div>
								<!-- ç¯©é¸æ§åˆ¶ -->
				<div style="margin-bottom: 10px;">
					<select id="disasterFilter" style="width: 100%; padding: 8px; border: 2px solid #42a5f5; border-radius: 4px; background: white; color: #1565c0; font-weight: 500;" onchange="filterDisasterReports()">
						<option value="all">æ‰€æœ‰ç½æƒ…</option>
						<option value="æœªæ´¾ä¿®">æœªæ´¾ä¿®</option>
						<option value="å·²æ´¾ä¿®">å·²æ´¾ä¿®</option>
						<option value="å·²ä¿®å¾©">å·²ä¿®å¾©</option>
					</select>
				</div>
				<!-- ç½æƒ…æ¸…å–® -->
				<div id="disasterReportList" style="max-height: 200px; overflow-y: auto; margin-bottom: 15px;">
					<!-- å‹•æ…‹è¼‰å…¥çš„ç½æƒ…æ¸…å–® -->
				</div>
				

				<!-- æ“ä½œæŒ‰éˆ• -->
				<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
					<button onclick="refreshDisasterData()" 
							style="padding: 8px 12px; background: linear-gradient(135deg, #1976d2, #1565c0); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: bold; transition: all 0.3s ease; box-shadow: 0 2px 4px rgba(25, 118, 210, 0.3);"
							onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 8px rgba(25, 118, 210, 0.4)';"
							onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(25, 118, 210, 0.3)';">
						ğŸ”„ é‡æ–°æ•´ç†
					</button>
					<button onclick="showDisasterMap()" 
							style="padding: 8px 12px; background: linear-gradient(135deg, #2196f3, #1976d2); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: bold; transition: all 0.3s ease; box-shadow: 0 2px 4px rgba(33, 150, 243, 0.3);"
							onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 8px rgba(33, 150, 243, 0.4)';"
							onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(33, 150, 243, 0.3)';">
						ğŸ—ºï¸ ç½æƒ…åœ°åœ–
					</button>
				</div>
			</div>
			<!-- ğŸ†• é¥‹ç·šé¸æ“‡å€åŸŸ -->
			<div class="feeder-selection-section">
				<h3>ğŸŒ å¾é›²ç«¯è¼‰å…¥é¥‹ç·šè³‡æ–™</h3>
				
				<!-- ğŸ†• åˆ†æˆå…©è¡Œé¡¯ç¤º -->
				<div class="feeder-input-row">
					<input type="text" 
						   id="feederInput" 
						   class="feeder-input" 
						   placeholder="è¼¸å…¥é¥‹ç·šåç¨±(å¦‚: 6A22)"
						   maxlength="4">
					<select id="feederDropdown" class="feeder-dropdown">
						<option value="">é¸æ“‡é¥‹ç·š</option>
					</select>
				</div>
				
				<!-- ğŸ†• æŒ‰éˆ•ç¨ç«‹ä¸€è¡Œ -->
				<div class="feeder-button-row">
					<button class="load-feeder-btn" onclick="loadFeederFromCloud()">
						ğŸŒ è¼‰å…¥é¥‹ç·šè³‡æ–™
					</button>
				</div>
				
				<div class="feeder-info-text">
					<!-- ğŸ†• å¿«å–æ§åˆ¶å€åŸŸ -->
						<div class="cache-controls" style="margin-top: 10px; display: flex; gap: 8px;">
							<button onclick="preloadPopularFeeders()" 
									style="flex: 1; padding: 6px; font-size: 11px; background: #17a2b8; 
										   color: white; border: none; border-radius: 4px; cursor: pointer;">
								ğŸ”¥ é è¼‰ç†±é–€
							</button>
							<button onclick="showCacheStats()" 
									style="flex: 1; padding: 6px; font-size: 11px; background: #6c757d; 
										   color: white; border: none; border-radius: 4px; cursor: pointer;">
								ğŸ“Š å¿«å–ç‹€æ…‹
							</button>
							<button onclick="feederCache.clear(); showToast('å¿«å–å·²æ¸…é™¤', 'info')" 
									style="flex: 1; padding: 6px; font-size: 11px; background: #dc3545; 
										   color: white; border: none; border-radius: 4px; cursor: pointer;">
								ğŸ—‘ï¸ æ¸…é™¤å¿«å–
							</button>
						</div>
				</div>
			</div>
			
			<!-- ğŸ†• é„°è¿‘è¨­å‚™æœå°‹å€åŸŸ -->
			<!-- ğŸ”§ ä¿®æ­£ç‰ˆï¼šé„°è¿‘è¨­å‚™æœå°‹å€åŸŸ - æ–°å¢æ›´å¤šåŠå¾‘é¸é … -->
			<div class="nearby-search-section" style="margin-bottom: 25px; padding: 20px; background: #e8f4fd; border-radius: 8px; border: 2px solid #2196f3;">
				<h3 style="color: #0d47a1; margin-bottom: 15px; text-shadow: 0 1px 2px rgba(13, 71, 161, 0.1);">ğŸ¯ é„°è¿‘è¨­å‚™æœå°‹</h3>
				
				<div style="margin-bottom: 15px;">
					<label style="display: block; margin-bottom: 8px; font-weight: bold; color: #1565c0;">æœå°‹åŠå¾‘</label>
					<select id="searchRadius" style="width: 100%; padding: 8px; border: 2px solid #42a5f5; border-radius: 4px; background: white; color: #1565c0;">
						<option value="0.1"  selected>100 å…¬å°º</option>
						<option value="0.2">200 å…¬å°º</option>
						<option value="0.5">500 å…¬å°º</option>
						<option value="0.75">750 å…¬å°º</option>
						<option value="1">1 å…¬é‡Œ</option>
						<option value="2">2 å…¬é‡Œ</option>
						<option value="5">5 å…¬é‡Œ</option>
						<option value="10">10 å…¬é‡Œ</option>
					</select>
				</div>
				
				<div style="display: grid; grid-template-columns: 1fr; gap: 8px;">
					<button onclick="searchNearbyFromLocation()" 
							style="padding: 12px 20px; background: linear-gradient(135deg, #2196f3, #1976d2); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: bold; transition: all 0.3s ease; box-shadow: 0 4px 8px rgba(33, 150, 243, 0.3);"
							onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 12px rgba(33, 150, 243, 0.4)';"
							onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 8px rgba(33, 150, 243, 0.3)';">
						ğŸ“ æœå°‹æˆ‘çš„ä½ç½®é™„è¿‘
					</button>
					<button onclick="enableMapClickForSearch()" 
							style="padding: 12px 20px; background: linear-gradient(135deg, #ff9800, #f57c00); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: bold; transition: all 0.3s ease; box-shadow: 0 4px 8px rgba(255, 152, 0, 0.3);"
							onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 12px rgba(255, 152, 0, 0.4)';"
							onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 8px rgba(255, 152, 0, 0.3)';">
						ğŸ—ºï¸ é»é¸åœ°åœ–æœå°‹
					</button>
					<button onclick="showNearbyDevicesOnly()" 
							style="padding: 12px 20px; background: linear-gradient(135deg, #4caf50, #388e3c); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: bold; transition: all 0.3s ease; box-shadow: 0 4px 8px rgba(76, 175, 80, 0.3);"
							onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 12px rgba(76, 175, 80, 0.4)';"
							onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 8px rgba(76, 175, 80, 0.3)';">
						ğŸ“ ç›´æ¥é¡¯ç¤ºé™„è¿‘è¨­å‚™
					</button>
				</div>
    
    <!-- ğŸ†• æ–°å¢æ§åˆ¶é¸é … -->
			<div style="margin-top: 15px; padding: 10px; background: rgba(255,255,255,0.7); border-radius: 6px;">
				<label style="display: flex; align-items: center; font-size: 12px; color: #1565c0; cursor: pointer;">
					<input type="checkbox" id="showSearchCircle" checked style="margin-right: 8px;">
					é¡¯ç¤ºæœå°‹ç¯„åœåœ“åœˆ
				</label>
				<label style="display: flex; align-items: center; font-size: 12px; color: #1565c0; cursor: pointer; margin-top: 5px;">
					<input type="checkbox" id="autoLoadFeeder" style="margin-right: 8px;">
					è‡ªå‹•è¼‰å…¥æœ€è¿‘çš„é¥‹ç·š
				</label>
				<label style="display: flex; align-items: center; font-size: 12px; color: #1565c0; cursor: pointer; margin-top: 5px;">
					<input type="checkbox" id="showDevicesOnly" style="margin-right: 8px;">
					åªé¡¯ç¤ºè¨­å‚™æ¨™è¨˜ï¼ˆä¸é¡¯ç¤ºå´é‚Šæ¬„ï¼‰
				</label>
			</div>
			
			<!-- ğŸ†• åœ¨æœå°‹å€åŸŸåº•éƒ¨åŠ å…¥æ¸…é™¤æŒ‰éˆ• -->
			<div style="margin-top: 10px;">
				<button onclick="clearSearchResults()" 
						style="width: 100%; padding: 8px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
					ğŸ§¹ æ¸…é™¤æœå°‹çµæœ
				</button>
			</div>
</div>

			<!-- æ–°å¢ï¼šåœ–è™Ÿåº§æ¨™è¼¸å…¥å€åŸŸ -->
			<div class="coordinate-input-section">
				<h3>ğŸ—ºï¸ åœ–è™Ÿåº§æ¨™æŸ¥è©¢</h3>
				<input type="text" 
					   id="coordinateInput" 
					   class="coordinate-input" 
					   placeholder="è¼¸å…¥åœ–è™Ÿåº§æ¨™ (å¦‚: Q1520CB20)"
					   maxlength="15">
				<button class="coordinate-btn" onclick="searchByCoordinate()">
					ğŸ” åº§æ¨™å®šä½
				</button>
				<div style="font-size: 12px; color: #856404; margin-top: 8px; text-align: center;">
					æ”¯æ´å°é›»åœ–è™Ÿåº§æ¨™æ ¼å¼
				</div>
			</div>
				<!-- æª”æ¡ˆä¸Šå‚³å€åŸŸ -->
				<div class="file-upload-section">
					<h3>ğŸ“ è¼‰å…¥é…é›»ç³»çµ±æª”æ¡ˆ</h3>
					<div class="file-input-wrapper">
						<input type="file" id="fileInput" accept=".json" />
						<button class="file-input-button" onclick="document.getElementById('fileInput').click()">
							ğŸ“‚ é¸æ“‡ JSON æª”æ¡ˆ
						</button>
					</div>
					<div class="file-info">
						æ”¯æ´å°é›»é…é›»ç³»çµ± GeoNode æ ¼å¼ï¼ˆé»èˆ‡ç·šæ®µï¼‰
					</div>
				</div>
				
				<!-- é¥‹ç·šè³‡è¨Š -->
				<div id="feederInfo" class="feeder-info" style="display: none;">
					<h4>ğŸ“Š é¥‹ç·šè³‡è¨Š</h4>
					<p id="feederDetails">ç­‰å¾…è¼‰å…¥...</p>
				</div>
				
				<!-- è¼‰å…¥ç‹€æ…‹ -->
				<div class="status-section">
					<h3>ğŸ“Š è¼‰å…¥ç‹€æ…‹</h3>
					<div id="loadStatus">è«‹é¸æ“‡ JSON æª”æ¡ˆé–‹å§‹è¼‰å…¥...</div>
				</div>
				

				
				<!-- åœ–å±¤æ§åˆ¶ -->
				<div class="layer-controls">
					<h3>ğŸ›ï¸ åœ–å±¤æ§åˆ¶</h3>
					<div id="layerControlsContainer">
						<p style="color: #666; font-size: 14px; text-align: center; padding: 20px;">
							è¼‰å…¥æª”æ¡ˆå¾Œå°‡é¡¯ç¤ºåœ–å±¤æ§åˆ¶é¸é …
						</p>
					</div>
				</div>
				<!-- æ–°å¢ï¼šå¿«æ·éµèªªæ˜ - åŠ åœ¨é€™è£¡ -->

				<!-- è¼‰å…¥ä¸­æŒ‡ç¤ºå™¨ -->
				<div class="loading" id="loadingIndicator">
					<div>â³ æ­£åœ¨è™•ç†æª”æ¡ˆ...</div>
				</div>
				
				<!-- åœ–ä¾‹ -->
				<div class="legend">
					<h4 style="margin: 10px 0 5px 0;">ğŸ”Œ ç·šè·¯åœ–ä¾‹</h4>
					<div class="legend-item">
						<div class="legend-line" style="background: #dc3545; color: #dc3545;"></div>
						<span>22.8kV ä¸»å¹¹ç·š (æ¶ç©º)</span>
					</div>
					<div class="legend-item">
						<div class="legend-line-dashed" style="color: #dc3545;"></div>
						<span>22.8kV ä¸»å¹¹ç·š (åœ°ä¸‹)</span>
					</div>
					<div class="legend-item">
						<div class="legend-line" style="background: #007bff; color: #007bff;"></div>
						<span>22.8kV åˆ†æ­§ç·š (æ¶ç©º)</span>
					</div>
					<div class="legend-item">
						<div class="legend-line-dashed" style="color: #007bff;"></div>
						<span>22.8kV åˆ†æ­§ç·š (åœ°ä¸‹)</span>
					</div>
					<div class="legend-item">
						<div class="legend-line" style="background: #fd7e14; color: #fd7e14;"></div>
						<span>11.4kV ä¸»å¹¹ç·š (æ¶ç©º)</span>
					</div>
					<div class="legend-item">
						<div class="legend-line-dashed" style="color: #fd7e14;"></div>
						<span>11.4kV ä¸»å¹¹ç·š (åœ°ä¸‹)</span>
					</div>
					<div class="legend-item">
						<div class="legend-line" style="background: #28a745; color: #28a745;"></div>
						<span>11.4kV åˆ†æ­§ç·š (æ¶ç©º)</span>
					</div>
					<div class="legend-item">
						<div class="legend-line-dashed" style="color: #28a745;"></div>
						<span>11.4kV åˆ†æ­§ç·š (åœ°ä¸‹)</span>
					</div>
					<div class="legend-item">
						<div class="legend-line" style="background: #6c757d; color: #6c757d;"></div>
						<span>å…¶ä»–ç·šè·¯ (æ¶ç©º)</span>
					</div>
					<div class="legend-item">
						<div class="legend-line-dashed" style="color: #6c757d;"></div>
						<span>å…¶ä»–ç·šè·¯ (åœ°ä¸‹)</span>
					</div>
					<hr style="margin: 8px 0;">
				</div>
				
				<!-- ç·šæ®µé«˜äº®æ§åˆ¶ -->
				<div class="highlight-controls" style="display: none;" id="highlightControls">
					<h4 style="margin: 0 0 8px 0; font-size: 14px; color: #856404;">ğŸ¯ ç·šæ®µé«˜äº®</h4>
					<p style="margin: 0 0 8px 0; font-size: 12px; color: #856404;">é»é¸åœ°åœ–ä¸Šçš„ç·šæ®µé€²è¡Œé«˜äº®é¡¯ç¤º</p>
					<button class="reset-highlight-btn" onclick="resetLineHighlight()">
						ğŸ”„ é‡ç½®é«˜äº®
					</button>
				</div>
			</div>
			
			<div class="map-container">
				<div id="map"></div>
				<!-- ğŸ†• åœ¨é€™è£¡åŠ å…¥ï¼šå¯æ”¶åˆåœ–å±¤åˆ‡æ›å™¨ -->
				<div class="layer-switcher-compact" id="layerSwitcherCompact">
					<button class="layer-toggle-btn" onclick="toggleLayerMenu()">
						ğŸ—ºï¸ åœ–å±¤
					</button>
					
					<div class="layer-menu" id="layerMenu" style="display: none;">
						<div class="layer-group">
							<h5>ğŸ—ºï¸ åŸºç¤åœ–å±¤</h5>
							<div class="layer-option">
								<input type="radio" id="googleStreets" name="baseLayer" value="googleStreets" checked>
								<label for="googleStreets">Google è¡—æ™¯åœ–</label>
							</div>
							<div class="layer-option">
								<input type="radio" id="googleSatellite" name="baseLayer" value="googleSatellite">
								<label for="googleSatellite">Google è¡›æ˜Ÿå½±åƒ</label>
							</div>
							<div class="layer-option">
								<input type="radio" id="googleHybrid" name="baseLayer" value="googleHybrid">
								<label for="googleHybrid">Google æ··åˆåœ–</label>
							</div>
							<div class="layer-option">
								<input type="radio" id="openStreetMap" name="baseLayer" value="openStreetMap">
								<label for="openStreetMap">OpenStreetMap</label>
							</div>
							<div class="layer-option">
								<input type="radio" id="esriWorldImagery" name="baseLayer" value="esriWorldImagery">
								<label for="esriWorldImagery">Esri è¡›æ˜Ÿåœ–</label>
							</div>
							<div class="layer-option">
								<input type="radio" id="nlscMap" name="baseLayer" value="nlscMap">
								<label for="nlscMap">åœ‹åœŸæ¸¬ç¹ªé›»å­åœ°åœ–</label>
							</div>
							<div class="layer-option">
								<input type="radio" id="nlscContour" name="baseLayer" value="nlscContour">
								<label for="nlscContour">åœ‹åœŸæ¸¬ç¹ªåœ°åœ–(å«ç­‰é«˜ç·š)</label>
							</div>
							<div class="layer-option">
								<input type="radio" id="nlscPhoto" name="baseLayer" value="nlscPhoto">
								<label for="nlscPhoto">åœ‹åœŸæ¸¬ç¹ªæ­£å°„å½±åƒ</label>
							</div>
						</div>
						
						<div class="layer-group">
							<h5>ğŸ›ï¸ æ”¿åºœåœ–å±¤</h5>
							<div class="layer-option">
								<input type="checkbox" id="roadNetworkLayer" onchange="toggleOverlayLayer('roadNetwork')">
								<label for="roadNetworkLayer">è·¯ç¶²åœ–å±¤</label>
							</div>
							<div class="layer-option">
								<input type="checkbox" id="railwayLayer" onchange="toggleOverlayLayer('railway')">
								<label for="railwayLayer">éµè·¯åœ–å±¤</label>
							</div>
							<div class="layer-option">
								<input type="checkbox" id="publicLandLayer" onchange="toggleOverlayLayer('landmark')">
								<label for="publicLandLayer">å…¬æœ‰åœŸåœ°åœ–</label>
							</div>
							<div class="layer-option">
								<input type="checkbox" id="adminBoundaryLayer" onchange="toggleOverlayLayer('cadastre')">
								<label for="adminBoundaryLayer">è¡Œæ”¿å€ç•Œåœ–</label>
							</div>
							<div class="layer-option">
								<input type="checkbox" id="landParcelLayer" onchange="toggleOverlayLayer('section')">
								<label for="landParcelLayer">æ®µç±åœ–</label>
							</div>
							<div class="layer-option">
								<input type="checkbox" id="villageLayer" onchange="toggleOverlayLayer('village')">
								<label for="villageLayer">æ‘é‡Œç•Œåœ–</label>
							</div>
							<div class="layer-option">
								<input type="checkbox" id="roadMilestoneLayer" onchange="toggleOverlayLayer('wayMeter')">
								<label for="roadMilestoneLayer">å…¬è·¯é‡Œç¨‹æ¨™èªŒ</label>
							</div>

						</div>
						
						<div class="layer-group">
							<h5>ğŸ”ï¸ é«˜é›„å¸‚å°ˆç”¨åœ–å±¤</h5>
							<div class="layer-option">
								<input type="checkbox" id="kaohsiungSlopeLayer" onchange="toggleOverlayLayer('kaohsiungSlope')">
								<label for="kaohsiungSlopeLayer">é«˜é›„å±±å¡åœ°ç¯„åœ</label>
							</div>
							<div class="layer-option">
								<input type="checkbox" id="urbanPlanLayer" onchange="toggleOverlayLayer('urbanPlan')">
								<label for="urbanPlanLayer">é«˜é›„å¸‚éƒ½å¸‚è¨ˆç•«åœ–</label>
							</div>
							<div class="layer-option">
								<input type="checkbox" id="urbanPlanBoundaryLayer" onchange="toggleOverlayLayer('urbanPlanBoundary')">
								<label for="urbanPlanBoundaryLayer">é«˜é›„å¸‚éƒ½å¸‚è¨ˆç•«ç¯„åœåœ–</label>
							</div>
							<div class="layer-option">
								<input type="checkbox" id="nationalLandPlanLayer" onchange="toggleOverlayLayer('trafficNetwork')">
								<label for="nationalLandPlanLayer">åœ‹åœŸè¨ˆç•«åœ–</label>
							</div>
							<div class="layer-option">
								<input type="checkbox" id="cadastralLayer" onchange="toggleOverlayLayer('cadastral')">
								<label for="cadastralLayer">åœ°ç±åœ–åŠé‡åŠƒå€åœ–</label>
							</div>
						</div>
						
						<div class="layer-group">
							<h5>ğŸš° ä¸‹æ°´é“ç³»çµ±åœ–å±¤</h5>
							<div class="layer-option">
								<input type="checkbox" id="sewerSystemLayer" onchange="toggleOverlayLayer('sewerSystem')">
								<label for="sewerSystemLayer">ğŸ”µ ä¸‹æ°´é“ç®¡ç·š</label>
							</div>
							<div class="layer-option">
								<input type="checkbox" id="sewerManholesLayer" onchange="toggleOverlayLayer('sewerManholes')">
								<label for="sewerManholesLayer">ğŸ”´ é›¨æ°´ç«£å·¥äººå­”</label>
							</div>
						</div>
						
						<div class="layer-group">
							<h5>ğŸ›ï¸ åœ–å±¤æ§åˆ¶</h5>
							<div class="layer-opacity-control">
								<span>é€æ˜åº¦:</span>
								<input type="range" class="opacity-slider" id="layerOpacity" 
									   min="0" max="100" value="100" onchange="adjustLayerOpacity(this.value)">
								<span id="opacityValue">100%</span>
							</div>
						</div>
					</div>
				</div>
				
				<!-- åŸæœ‰çš„æ§åˆ¶æŒ‰éˆ•ç¹¼çºŒä¿ç•™åœ¨ä¸‹é¢ -->
				<button class="fullscreen-btn" onclick="toggleFullscreen()">
					ğŸ”² å…¨è¢å¹•
				</button>
				


				
				
				<!-- ä¿®æ”¹ï¼šå®šä½æ§åˆ¶æŒ‰éˆ• -->
				<div class="location-controls">
								<!-- ğŸ†• æŒ‡åŒ—é‡æ§åˆ¶æŒ‰éˆ• -->
					<!-- ğŸ†• æŒ‡åŒ—é‡æ§åˆ¶æŒ‰éˆ• - ä¿®æ”¹ç‰ˆ -->
					<div class="compass-controls">
						<button id="compassBtn" class="compass-btn" onclick="toggleCompass()" title="æŒ‡åŒ—é‡">
							<i class="fas fa-compass"></i>
						</button>
					</div>

										<button id="locateBtn" class="location-btn" onclick="toggleContinuousLocation()">
						ğŸ“ å®šä½
					</button>
					 <button class="rotation-btn" id="followLocationBtn" onclick="toggleFollowLocation()">
						ğŸ“± è·Ÿéš¨ä½ç½®
					</button>

				</div>

				<!-- ç°¡åŒ–ï¼šæ—‹è½‰æ§åˆ¶ - åªä¿ç•™è·Ÿéš¨æ–¹å‘ -->

								
				<!-- æ–°å¢ï¼šæ¸¬é‡å·¥å…· -->
				<div class="measure-controls">
					<button class="measure-btn" id="measureDistanceBtn" onclick="toggleMeasureDistance()">
						ğŸ“ æ¸¬è·
					</button>
					<button class="measure-btn" onclick="clearMeasurements()">
						ğŸ—‘ï¸ æ¸…é™¤
					</button>
				</div>
				

				
				
			</div>
		</div>
		

		
		<script>
			// å…¨åŸŸè®Šæ•¸
			let map;
			let allDevicesData = [];
			let allLinesData = [];
			let layerGroups = {};
			let layerCounts = {};
			let currentFeederInfo = null;
			let selectedLine = null; // å„²å­˜ç•¶å‰é¸ä¸­çš„ç·šæ®µ
			// ğŸ”§ æ–°å¢ï¼šç®­é ­ç®¡ç†
			let allArrowMarkers = []; // å„²å­˜æ‰€æœ‰ç®­é ­æ¨™è¨˜
			let arrowLayerGroup = null; // ç®­é ­åœ–å±¤ç¾¤çµ„
			// åœ°åœ–åˆå§‹åŒ–
			// åœ°åœ–åˆå§‹åŒ– - ä¿®æ”¹ç‰ˆ
			// ğŸŒŸ æ–°å¢ï¼šæ˜Ÿæ˜Ÿç®¡ç†
			let oppositeStarMarkers = []; // å„²å­˜æ‰€æœ‰æ˜Ÿæ˜Ÿæ¨™è¨˜
			let oppositeLayerGroup = null; // æ˜Ÿæ˜Ÿåœ–å±¤ç¾¤çµ„
			
			// ğŸ†• å…¨åŸŸè®Šæ•¸å„²å­˜é¥‹ç·šè³‡æ–™
			let feederDataMap = {};
			let feederList = [];
			// ğŸ†• é¥‹ç·šæ¸…å–® - æ ¹æ“šæ‚¨æä¾›çš„æª”æ¡ˆåç¨±
			// ğŸ†• è¶…é«˜é€Ÿè¼‰å…¥ç›¸é—œå…¨åŸŸè®Šæ•¸
			let feederCache = null;
			let fastJsonLoader = null;
			let localStorageManager = null;
			// æ–°å¢ï¼šå®šä½åŠŸèƒ½ç›¸é—œè®Šæ•¸
			let isContinuousLocationEnabled = false;
			let userLocationMarker;
			let watchId;
			
			// ğŸ†• åœé›»è³‡æ–™ç›¸é—œè®Šæ•¸
			let outageData = null;
			let outageMarkers = [];
			let faultLineMarkers = [];
			
			// ç½æƒ…æŸ¥å ±ç›¸é—œè®Šæ•¸
			let disasterData = [];
			let disasterMarkers = [];
			let currentPhotoIndex = 0;
			let currentReportId = null;
			let currentReportPhotos = [];
			// ğŸ†• ä¿®æ”¹åœ°åœ–åˆå§‹åŒ–å‡½æ•¸
			// ğŸ”§ ä¿®æ­£ç‰ˆï¼šåœ°åœ–åˆå§‹åŒ– - ç¢ºä¿æ‰€æœ‰çµ„ä»¶å®Œå…¨è¼‰å…¥å¾Œå†å•Ÿç”¨æ‰‹æ©Ÿå°èˆª
			// ğŸ†• æŒ‡åŒ—é‡ç›¸é—œè®Šæ•¸
			let isCompassActive = false;
			let orientationHandler = null;
			let lastHeading = null;
			let loadingOverlay = null;
// ğŸ”§ ä¿®æ­£ç‰ˆï¼šåœ°åœ–åˆå§‹åŒ– - åŠ å…¥æ—‹è½‰åŠŸèƒ½
async function initMap() {
    console.log('ğŸ—ºï¸ åˆå§‹åŒ–åœ°åœ–...');
    
    // ğŸ”§ é‡è¦ï¼šåˆå§‹åŒ– Supabase
    const supabaseReady = initSupabase();
    if (!supabaseReady) {
        console.warn('âš ï¸ Supabase æœªæ­£ç¢ºåˆå§‹åŒ–ï¼Œé„°è¿‘æœå°‹åŠŸèƒ½å°‡ç„¡æ³•ä½¿ç”¨');
        showToast('âš ï¸ è³‡æ–™åº«é€£æ¥å¤±æ•—ï¼Œé„°è¿‘æœå°‹åŠŸèƒ½ç„¡æ³•ä½¿ç”¨', 'warning');
    } else {
        console.log('âœ… Supabase å·²æˆåŠŸåˆå§‹åŒ–ï¼Œé„°è¿‘æœå°‹åŠŸèƒ½å¯ç”¨');
        showToast('âœ… è³‡æ–™åº«é€£æ¥æˆåŠŸï¼Œé„°è¿‘æœå°‹åŠŸèƒ½å·²å•Ÿç”¨', 'success');
    }
    
    // åˆå§‹åŒ–è¶…é«˜é€Ÿè¼‰å…¥çµ„ä»¶
    feederCache = new FeederCache();
    fastJsonLoader = new FastJsonLoader();
    localStorageManager = new LocalStorageManager();
    
    // ğŸ†• å»ºç«‹åœ°åœ–å¯¦ä¾‹ï¼ŒåŠ å…¥æ—‹è½‰åŠŸèƒ½
    map = L.map('map', {
        center: [22.67, 120.34],
        zoom: 12,
        maxZoom: 22,
        rotate: true, // ğŸ†• å•Ÿç”¨æ—‹è½‰åŠŸèƒ½
        rotateControl: {
            closeOnZeroBearing: false
        },
        bearing: 0, // ğŸ†• åˆå§‹æ–¹ä½è§’
        zoomControl: false
    });
    
    // ğŸ†• å–å¾—è¼‰å…¥æç¤ºå…ƒç´ 
    loadingOverlay = document.getElementById('loadingOverlay');
    
    // ç¶å®šåœ°åœ–äº‹ä»¶ï¼ˆä¿æŒåŸæœ‰é‚è¼¯ï¼‰
    bindMapEvents();
    
    // å®šç¾©åº§æ¨™ç³»çµ±
    setupCoordinateSystems();
    
    // å»ºç«‹åœ°åœ–åœ–å±¤
    setupMapLayers();
    
    // åˆå§‹åŒ–ç®­é ­å’Œæ˜Ÿæ˜Ÿåœ–å±¤ç¾¤çµ„
    arrowLayerGroup = L.layerGroup().addTo(map);
    oppositeLayerGroup = L.layerGroup().addTo(map);
    
    // åˆå§‹åŒ–æ¸¬é‡å·¥å…·
    initializeMeasureTools();
    
    // åˆå§‹åŒ–åœ–å±¤åˆ‡æ›äº‹ä»¶
    initializeLayerSwitcher();
    
    // è¼‰å…¥é¥‹ç·šè³‡æ–™
    await loadFeederDataFromSheet();
    
    // å»ºç«‹é€²åº¦æ¢
    createProgressBar();
    
    // ğŸ”§ é‡è¦ä¿®æ­£ï¼šç¢ºä¿æ‰€æœ‰æ§åˆ¶é …å®Œå…¨åˆå§‹åŒ–å¾Œå†å•Ÿç”¨æ‰‹æ©Ÿå°èˆª
    setTimeout(() => {
        initMobileNavigation();
        console.log('ğŸ“± æ‰‹æ©Ÿç‰ˆå°èˆªå»¶é²åˆå§‹åŒ–å®Œæˆ');
    }, 500);
    
    // ğŸ”§ ä¿®æ­£ï¼šåœé›»è³‡æ–™æ”¹ç‚ºèƒŒæ™¯è¼‰å…¥ï¼Œä¸é˜»å¡ä¸»è¦åŠŸèƒ½
    loadOutageDataInBackground();
    
    updateLoadStatus('åœ°åœ–åˆå§‹åŒ–å®Œæˆï¼Œè«‹é¸æ“‡ JSON æª”æ¡ˆæˆ–å¾é›²ç«¯è¼‰å…¥...');
    
    // è¼‰å…¥ç½æƒ…è³‡æ–™
    setTimeout(() => {
        loadDisasterData();
    }, 2000);
    
    console.log('âœ… åœ°åœ–åˆå§‹åŒ–å®Œæˆ');
}

		// ğŸ”§ æ–°å¢ï¼šæª¢æ¸¬ä¸¦éš±è—æ‰‹æ©Ÿç‰ˆå…¨è¢å¹•æŒ‰éˆ•
		function handleFullscreenButtonVisibility() {
			const fullscreenBtn = document.querySelector('.fullscreen-btn');
			
			if (fullscreenBtn) {
				// æª¢æ¸¬æ˜¯å¦ç‚ºæ‰‹æ©Ÿè£ç½®
				const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
				const isSmallScreen = window.innerWidth <= 768;
				
				if (isMobile || isSmallScreen) {
					fullscreenBtn.style.display = 'none';
					console.log('ğŸ“± æ‰‹æ©Ÿæ¨¡å¼ï¼šå·²éš±è—å…¨è¢å¹•æŒ‰éˆ•');
				} else {
					fullscreenBtn.style.display = 'block';
					console.log('ğŸ–¥ï¸ æ¡Œé¢æ¨¡å¼ï¼šé¡¯ç¤ºå…¨è¢å¹•æŒ‰éˆ•');
				}
			}
		}
	// ğŸ†• èƒŒæ™¯è¼‰å…¥åœé›»è³‡æ–™
	async function loadOutageDataInBackground() {
	  try {
		  console.log('ğŸ”„ é–‹å§‹èƒŒæ™¯è¼‰å…¥åœé›»è³‡æ–™...');
		  
		  // æ›´æ–°ç‹€æ…‹é¡¯ç¤º
		  const outageStatus = document.getElementById('outageStatus');
		  if (outageStatus) {
			  outageStatus.textContent = 'ğŸ”„ èƒŒæ™¯è¼‰å…¥åœé›»è³‡æ–™ä¸­...';
			  outageStatus.style.background = '#fff3cd';
		  }
		  
		  // éåŒæ­¥è¼‰å…¥åœé›»è³‡æ–™
		  await loadOutageData();
		  
		  console.log('âœ… åœé›»è³‡æ–™èƒŒæ™¯è¼‰å…¥å®Œæˆ');
		  
	  } catch (error) {
		  console.error('âŒ åœé›»è³‡æ–™èƒŒæ™¯è¼‰å…¥å¤±æ•—:', error);
		  
		  const outageStatus = document.getElementById('outageStatus');
		  if (outageStatus) {
			  outageStatus.textContent = 'âš ï¸ åœé›»è³‡æ–™è¼‰å…¥å¤±æ•—ï¼Œä½†ä¸å½±éŸ¿å…¶ä»–åŠŸèƒ½ä½¿ç”¨';
			  outageStatus.style.background = '#f8d7da';
		  }
	  }
	}


// ğŸ”§ è¼”åŠ©å‡½æ•¸ï¼šè¨­å®šåº§æ¨™ç³»çµ±
function setupCoordinateSystems() {
  proj4.defs([
      ['EPSG:3826', '+proj=tmerc +lat_0=0 +lon_0=121 +k=0.9999 +x_0=250000 +y_0=0 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs'],
      ['EPSG:3828', '+proj=tmerc +lat_0=0 +lon_0=121 +k=0.9999 +x_0=250000 +y_0=0 +ellps=aust_SA +towgs84=-752,-358,-179,-.0000011698,.0000018398,.0000009822,.00002329 +units=m +no_defs'],
      ['EPSG:4326', '+proj=longlat +datum=WGS84 +no_defs']
  ]);
}

// ğŸ”§ è¼”åŠ©å‡½æ•¸ï¼šè¨­å®šåœ°åœ–åœ–å±¤
function setupMapLayers() {
  // å»ºç«‹å¤šç¨®åœ°åœ–åœ–å±¤
  window.mapLayers = {
// Google ç³»åˆ—
					googleStreets: L.tileLayer('https://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', {
						maxZoom: 22,
						subdomains: ['mt0', 'mt1', 'mt2', 'mt3'],
						attribution: 'Â© Google Maps'
					}),
					
					googleSatellite: L.tileLayer('https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
						maxZoom: 22,
						subdomains: ['mt0', 'mt1', 'mt2', 'mt3'],
						attribution: 'Â© Google Satellite'
					}),
					
					googleHybrid: L.tileLayer('https://{s}.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', {
						maxZoom: 22,
						subdomains: ['mt0', 'mt1', 'mt2', 'mt3'],
						attribution: 'Â© Google Hybrid'
					}),
					
					// OpenStreetMap
					openStreetMap: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
						attribution: 'Â© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
						maxZoom: 22
					}),
					
					// Esri è¡›æ˜Ÿåœ–
					esriWorldImagery: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
						attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community',
						maxZoom: 22
					}),

					// ğŸ†• åœ‹åœŸæ¸¬ç¹ªä¸­å¿ƒåœ–å±¤
					nlscMap: L.tileLayer('https://wmts.nlsc.gov.tw/wmts/EMAP/default/GoogleMapsCompatible/{z}/{y}/{x}', {
						maxZoom: 30,
						attribution: 'Â© å…§æ”¿éƒ¨åœ‹åœŸæ¸¬ç¹ªä¸­å¿ƒ'
					}),

					nlscContour: L.tileLayer('https://wmts.nlsc.gov.tw/wmts/EMAP2/default/GoogleMapsCompatible/{z}/{y}/{x}', {
						maxZoom: 30,
						attribution: 'Â© å…§æ”¿éƒ¨åœ‹åœŸæ¸¬ç¹ªä¸­å¿ƒ'
					}),

					nlscPhoto: L.tileLayer('https://wmts.nlsc.gov.tw/wmts/PHOTO2/default/GoogleMapsCompatible/{z}/{y}/{x}', {
						maxZoom: 30,
						attribution: 'Â© å…§æ”¿éƒ¨åœ‹åœŸæ¸¬ç¹ªä¸­å¿ƒ'
					})
  };
  
  // å»ºç«‹ç–ŠåŠ åœ–å±¤
  window.overlayLayers = {
      // âœ… è·¯ç¶²åœ–å±¤ (å·²æ­£å¸¸é‹ä½œ)
					roadNetwork: L.tileLayer('https://wmts.nlsc.gov.tw/wmts/ROAD/default/GoogleMapsCompatible/{z}/{y}/{x}', {
						maxZoom: 19,
						attribution: 'Â© å…§æ”¿éƒ¨åœ‹åœŸæ¸¬ç¹ªä¸­å¿ƒ'
					}),
					
					// âœ… éµè·¯åœ–å±¤ (å·²æ­£å¸¸é‹ä½œ)
					railway: L.tileLayer('https://{s}.tiles.openrailwaymap.org/standard/{z}/{x}/{y}.png', {
						maxZoom: 30,
						subdomains: ['a', 'b', 'c'],
						attribution: 'Map data: &copy; OpenStreetMap contributors | Style: &copy; OpenRailwayMap'
					}),
					
					// ğŸ”§ ä¿®æ­£ï¼šå…¬æœ‰åœŸåœ°åœ– - ä½¿ç”¨æ­£ç¢ºçš„ WMTS URL
					landmark: L.tileLayer('https://wmts.nlsc.gov.tw/wmts/LAND_OPENDATA/default/GoogleMapsCompatible/{z}/{y}/{x}', {
						maxZoom: 30,
						attribution: 'Â© å…§æ”¿éƒ¨åœ‹åœŸæ¸¬ç¹ªä¸­å¿ƒ'
					}),
					
					// ğŸ”§ ä¿®æ­£ï¼šè¡Œæ”¿å€ç•Œåœ– - ä½¿ç”¨æ­£ç¢ºçš„ WMTS URL
					cadastre: L.tileLayer('https://wmts.nlsc.gov.tw/wmts/TOWN/default/GoogleMapsCompatible/{z}/{y}/{x}', {
						maxZoom: 30,
						attribution: 'Â© å…§æ”¿éƒ¨åœ‹åœŸæ¸¬ç¹ªä¸­å¿ƒ'
					}),
					
					// ğŸ”§ ä¿®æ­£ï¼šæ®µç±åœ– - ä½¿ç”¨æ­£ç¢ºçš„ WMTS URL
					section: L.tileLayer('https://wmts.nlsc.gov.tw/wmts/LANDSECT/default/GoogleMapsCompatible/{z}/{y}/{x}', {
						maxZoom: 30,
						attribution: 'Â© å…§æ”¿éƒ¨åœ‹åœŸæ¸¬ç¹ªä¸­å¿ƒ'
					}),
					
					// âœ… æ‘é‡Œç•Œåœ– (å·²æ­£å¸¸é‹ä½œ)
					village: L.tileLayer('https://wmts.nlsc.gov.tw/wmts/Village/default/GoogleMapsCompatible/{z}/{y}/{x}', {
						maxZoom: 30,
						attribution: 'Â© å…§æ”¿éƒ¨åœ‹åœŸæ¸¬ç¹ªä¸­å¿ƒ'
					}),
					
					// ğŸ”§ ä¿®æ­£ï¼šå…¬è·¯é‡Œç¨‹æ¨™èªŒ - ä½¿ç”¨æ­£ç¢ºçš„ WMTS URL
					wayMeter:L.tileLayer('https://wmts.nlsc.gov.tw/wmts/WAYMETER/default/GoogleMapsCompatible/{z}/{y}/{x}', {
					  maxZoom: 30,
					  attribution: 'Map data: &copy; OpenStreetMap contributors | Style: &copy; OpenRailwayMap'
				    }),
					
					// âœ… å…¶ä»–åœ–å±¤ä¿æŒä¸è®Š
					kaohsiungSlope: L.tileLayer.wms('https://swc.kcg.gov.tw/geoserver/KaoHill/ows', {
						layers: 'HillRange',
						format: 'image/png',
						transparent: true,
						version: '1.3.0',
						attribution: 'Â© é«˜é›„å¸‚æ°´åœŸä¿æŒå±€'
					}),
					
					urbanPlan: L.tileLayer.wms('https://urbanproxy.kcg.gov.tw/arcgis/services/UrbanAPI/KcgUrbanDataForUrbanAPI/MapServer/WmsServer', {
						layers: 'é«˜é›„å¸‚éƒ½å¸‚è¨ˆç•«åœ–',
						format: 'image/png',
						transparent: true,
						version: '1.3.0',
						attribution: 'Â© é«˜é›„å¸‚æ”¿åºœ',
						crs: L.CRS.EPSG4326,
						bounds: L.latLngBounds([22.474447, 120.174156], [23.086414, 120.653181])
					}),
					
					urbanPlanBoundary: L.tileLayer.wms('https://urbanproxy.kcg.gov.tw/arcgis/services/UrbanAPI/KcgUrbanDataForPlanAPI/MapServer/WmsServer', {
						layers: 'é«˜é›„å¸‚éƒ½å¸‚è¨ˆç•«ç¯„åœåœ–',
						format: 'image/png',
						transparent: true,
						version: '1.3.0',
						attribution: 'Â© é«˜é›„å¸‚æ”¿åºœ'
					}),
					
					trafficNetwork: L.tileLayer('https://wmts.nlsc.gov.tw/wmts/LUIMAP/default/GoogleMapsCompatible/{z}/{y}/{x}', {
						maxZoom: 19,
						attribution: 'Â© å…§æ”¿éƒ¨åœ‹åœŸæ¸¬ç¹ªä¸­å¿ƒ'
					}),
					// ğŸ†• é›¨æ°´ç®¡ç·šåœ–å±¤
					sewerSystem: L.vectorGrid.protobuf('https://gis.liquid.net.tw/arcgis/rest/services/Hosted/CPAMI_Sewer_804020102/VectorTileServer/tile/{z}/{y}/{x}.pbf', {
						vectorTileLayerStyles: {
							'': {
								weight: 2,
								color: '#0066cc',
								opacity: 0.8,
								fillColor: '#0066cc',
								fillOpacity: 0.3
							}
						},
						rendererFactory: L.svg.tile,
						attribution: 'Â© å…§æ”¿éƒ¨ç‡Ÿå»ºç½² - ä¸‹æ°´é“',
						maxZoom: 30,
						minZoom: 8,
						interactive: true
					}),

		// ğŸ¯ å¼·åˆ¶æ¨£å¼è¨­å®šç‰ˆæœ¬
		sewerManholes: (function() {
			const layer = L.vectorGrid.protobuf('https://gis.liquid.net.tw/arcgis/rest/services/Hosted/CPAMI_Sewer_804020202/VectorTileServer/tile/{z}/{y}/{x}.pbf', {
				vectorTileLayerStyles: {
					'': function(properties, zoom) {
						return {
							radius: 1,
							fillColor: '#e74c3c',
							color: '#e74c3c',
							weight: 0,
							opacity: 1,
							fillOpacity: 1
						};
					}
				},
				rendererFactory: L.svg.tile,
				attribution: 'Â© å…§æ”¿éƒ¨ç‡Ÿå»ºç½² - é›¨æ°´äººå­”',
				maxZoom: 30,
				minZoom: 19,
				interactive: true
			});
			
			// ğŸ”§ ç›£è½ç“¦ç‰‡è¼‰å…¥å®Œæˆäº‹ä»¶
			layer.on('tileload', function(e) {
				console.log('ğŸ” ç“¦ç‰‡è¼‰å…¥å®Œæˆ');
				// å¼·åˆ¶é‡æ–°è¨­å®šæ‰€æœ‰åœ“é»çš„æ¨£å¼
				setTimeout(() => {
					const svgElements = document.querySelectorAll('.leaflet-overlay-pane svg circle');
					svgElements.forEach(circle => {
						if (circle.getAttribute('fill') === '#0000ff' || circle.getAttribute('fill') === 'blue') {
							circle.setAttribute('fill', '#e74c3c');
							circle.setAttribute('stroke', '#e74c3c');
							circle.setAttribute('r', '2');
							console.log('ğŸ¨ å·²ä¿®æ”¹åœ“é»æ¨£å¼');
						}
					});
				}, 100);
			});
			
			return layer;
		})(),


					// åœ¨ window.overlayLayers ä¸­åŠ å…¥åœ°ç±åœ–å±¤
					cadastral: (function() {
						// å®šç¾©åº§æ¨™è½‰æ›å‡½æ•¸
						function wgs84ToTwd97(lng, lat) {
							try {
								const result = proj4("EPSG:4326", "EPSG:3826", [lng, lat]);
								return [Math.round(result[0]), Math.round(result[1])];
							} catch (e) {
								console.error('åº§æ¨™è½‰æ›éŒ¯èª¤:', e);
								return [250000, 2500000];
							}
						}
						
						// å»ºç«‹åœ°ç±åœ–ç“¦ç‰‡å±¤
						const CadastralTileLayer = L.GridLayer.extend({
							createTile: function (coords, done) {
								const tile = L.DomUtil.create('img', 'leaflet-tile');
								tile.style.opacity = '0';
								
								// è¨ˆç®—ç“¦ç‰‡é‚Šç•Œ
								const bounds = this._tileCoordsToBounds(coords);
								const sw = bounds.getSouthWest();
								const ne = bounds.getNorthEast();
								
								// ç²¾ç¢ºåº§æ¨™è½‰æ›
								const [swX, swY] = wgs84ToTwd97(sw.lng, sw.lat);
								const [neX, neY] = wgs84ToTwd97(ne.lng, ne.lat);
								
								const bbox = `${swX},${swY},${neX},${neY}`;
								
								// åœ°ç±åœ– URL (ä½¿ç”¨ä½ æä¾›çš„æ–° URL)
								const url = `https://gisdawh.kcg.gov.tw/landeasy/proxy/proxy2.ashx?` +
									`https://mapgis2.kcg.gov.tw/server/rest/services/data/KCG_LANDEASY/MapServer/export?` +
									`dpi=96&transparent=true&format=png32&` +
									`layers=show:6,7&` +
									`bbox=${bbox}&` +
									`bboxSR=3826&imageSR=3826&` +
									`size=256,256&f=image`;
								
								tile.onload = function() {
									tile.style.transition = 'opacity 0.3s';
									tile.style.opacity = '1';
									done(null, tile);
								};
								
								tile.onerror = function() {
									// å‚™ç”¨æ–¹æ¡ˆ
									const fallbackUrl = `https://gisdawh.kcg.gov.tw/landeasy/proxy/proxy2.ashx?` +
										`https://mapgis2.kcg.gov.tw/server/rest/services/data/KCG_LANDEASY/MapServer/export?` +
										`dpi=96&transparent=true&format=png32&` +
										`layers=show:7&` +
										`bbox=${bbox}&` +
										`bboxSR=3826&imageSR=3826&` +
										`size=256,256&f=image`;
									
									tile.onerror = function() {
										done(null, tile);
									};
									
									tile.onload = function() {
										tile.style.transition = 'opacity 0.3s';
										tile.style.opacity = '1';
										done(null, tile);
									};
									
									tile.src = fallbackUrl;
								};
								
								tile.src = url;
								return tile;
							},
							
							_tileCoordsToBounds: function (coords) {
								const map = this._map;
								const tileSize = this.getTileSize();
								const nwPoint = coords.scaleBy(tileSize);
								const sePoint = nwPoint.add(tileSize);
								const nw = map.unproject(nwPoint, coords.z);
								const se = map.unproject(sePoint, coords.z);
								return new L.LatLngBounds(se, nw);
							}
						});
						
						const layer = new CadastralTileLayer({
							opacity: 0.8,
							attribution: 'Â© é«˜é›„å¸‚æ”¿åºœåœ°ç±åœ–',
							minZoom: 2,
							maxZoom: 36,
							// ğŸ†• è¨­å®šé«˜ z-indexï¼Œç¢ºä¿åœ¨ Google åœ–å±¤ä¹‹ä¸Š
							zIndex: 1000
						});
						
						// ğŸ†• ç•¶åœ–å±¤è¢«åŠ å…¥åœ°åœ–æ™‚ï¼Œç¢ºä¿å®ƒçš„ z-index æœ€é«˜
						layer.on('add', function() {
							setTimeout(() => {
								const pane = this.getPane();
								if (pane) {
									pane.style.zIndex = 1000;
									pane.style.pointerEvents = 'none'; // è®“æ»‘é¼ äº‹ä»¶ç©¿é€ï¼Œä¸å½±éŸ¿åœ°åœ–æ“ä½œ
								}
							}, 100);
						});
						
						return layer;
					})()
					
  };
  
  // é è¨­è¼‰å…¥ Google è¡—æ™¯åœ–
  window.currentBaseLayer = window.mapLayers.googleStreets.addTo(map);
}

// åœ¨åœ°åœ–åˆå§‹åŒ–å®Œæˆå¾ŒåŸ·è¡Œ
handleFullscreenButtonVisibility();

// ç›£è½è¦–çª—å¤§å°è®ŠåŒ–
window.addEventListener('resize', handleFullscreenButtonVisibility);

			
			// æ–°å¢ï¼šå°ç£åœ°å€é›»åŠ›åº§æ¨™åŸé»
const taiGridArr = [
    {taiCode: 'A', taiGrid: [170000, 2750000]},
    {taiCode: 'B', taiGrid: [250000, 2750000]},
    {taiCode: 'C', taiGrid: [330000, 2750000]},
    {taiCode: 'D', taiGrid: [170000, 2700000]},
    {taiCode: 'E', taiGrid: [250000, 2700000]},
    {taiCode: 'F', taiGrid: [330000, 2700000]},
    {taiCode: 'G', taiGrid: [170000, 2650000]},
    {taiCode: 'H', taiGrid: [250000, 2650000]},
    {taiCode: 'J', taiGrid: [90000, 2600000]},
    {taiCode: 'K', taiGrid: [170000, 2600000]},
    {taiCode: 'L', taiGrid: [250000, 2600000]},
    {taiCode: 'M', taiGrid: [90000, 2550000]},
    {taiCode: 'N', taiGrid: [170000, 2550000]},
    {taiCode: 'O', taiGrid: [250000, 2550000]},
    {taiCode: 'P', taiGrid: [90000, 2500000]},
    {taiCode: 'Q', taiGrid: [170000, 2500000]},
    {taiCode: 'R', taiGrid: [250000, 2500000]},
    {taiCode: 'T', taiGrid: [170000, 2450000]},
    {taiCode: 'U', taiGrid: [250000, 2450000]},
    {taiCode: 'V', taiGrid: [170000, 2400000]},
    {taiCode: 'W', taiGrid: [250000, 2400000]},
    {taiCode: 'X', taiGrid: [275000, 2614000]},
    {taiCode: 'Y', taiGrid: [275000, 2564000]}
];

// æ–°å¢ï¼šå®šä½åŠŸèƒ½
// ğŸ”§ ä¿®æ­£ç‰ˆï¼šè·Ÿéš¨è£ç½®ä½ç½®åŠŸèƒ½
function toggleContinuousLocation() {
    if (!isContinuousLocationEnabled) {
        enableContinuousLocation();
    } else {
        disableContinuousLocation();
    }
}

// ğŸ”§ è¼”åŠ©å‡½æ•¸ï¼šç¶å®šåœ°åœ–äº‹ä»¶
function bindMapEvents() {
  // åœ°åœ–ç¸®æ”¾æ™‚è‡ªå‹•èª¿æ•´æ§åˆ¶é¢æ¿
  map.on('zoomend', function() {
      const zoom = map.getZoom();
      const controls = document.querySelectorAll('.rotation-controls, .layer-switcher');
      
      controls.forEach(control => {
          if (zoom < 10) {
              control.style.opacity = '0.7';
          } else {
              control.style.opacity = '1';
          }
      });
  });
  
  // åœ°åœ–ç§»å‹•æ™‚æ›´æ–° URL
  let urlUpdateTimeout;
  map.on('moveend', function() {
      clearTimeout(urlUpdateTimeout);
      urlUpdateTimeout = setTimeout(() => {
          const center = map.getCenter();
          const zoom = map.getZoom();
          const bearing = 0;
          
          const newUrl = `${window.location.pathname}#${zoom}/${center.lat.toFixed(6)}/${center.lng.toFixed(6)}/${bearing}`;
          window.history.replaceState(null, null, newUrl);
      }, 1000);
  });
  
	 // å³éµé¸å–®åŠŸèƒ½
	map.on('contextmenu', function(e) {
		const lat = e.latlng.lat;
		const lng = e.latlng.lng;
		
		const contextMenu = L.popup({
			closeButton: false,
			autoClose: true,
			closeOnEscapeKey: true
		})
		.setLatLng(e.latlng)
		.setContent(`
			<div style="text-align: center; min-width: 150px;">
				<h4 style="margin: 0 0 10px 0;">ğŸ“ ä½ç½®æ“ä½œ</h4>
				<button onclick="copyCoordinates(${lat}, ${lng}); map.closePopup();" 
						style="width: 100%; margin: 2px 0; padding: 5px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer;">
					ğŸ“‹ è¤‡è£½åº§æ¨™
				</button>
				<button onclick="openStreetView(${lat}, ${lng}); map.closePopup();" 
						style="width: 100%; margin: 2px 0; padding: 5px; background: #28a745; color: white; border: none; border-radius: 3px; cursor: pointer;">
					ğŸ—ºï¸ è¡—æ™¯åœ–
				</button>
				<button onclick="openNavigation(${lat}, ${lng}, 'é¸å®šä½ç½®'); map.closePopup();" 
						style="width: 100%; margin: 2px 0; padding: 5px; background: #ffc107; color: black; border: none; border-radius: 3px; cursor: pointer;">
					ğŸ§­ å°èˆªè‡³æ­¤
				</button>
				<button onclick="openDisasterReportSystem(${lat}, ${lng}, 'é¸å®šä½ç½®', null); map.closePopup();" 
						style="width: 100%; margin: 2px 0; padding: 5px; background: #dc3545; color: white; border: none; border-radius: 3px; cursor: pointer; font-weight: bold;">
					ğŸš¨ ç½æƒ…æŸ¥å ±
				</button>
			</div>
		`)
		.openOn(map);
	});
  
  // åœ°åœ–é»é¸äº‹ä»¶
  map.on('click', function(e) {
    const isMobile = window.innerWidth <= 768;
    
    // ğŸ”§ ä¿®æ­£ï¼šæ‰‹æ©Ÿç‰ˆä¸è‡ªå‹•é—œé–‰æ‹–æ›³é¢æ¿ï¼ˆå› ç‚ºä¸æœƒé¡¯ç¤ºï¼‰
    if (!isMobile && draggableFaultPanel) {
        setTimeout(() => {
            closeDraggableFaultInfoPanel();
        }, 100);
    }
    
      resetLineHighlight();
      const layerMenu = document.getElementById('layerMenu');
      if (layerMenu) {
          layerMenu.style.display = 'none';
      }
  });
}
// ğŸ”§ è¼”åŠ©å‡½æ•¸ï¼šè¨­å®šåº§æ¨™ç³»çµ±
function setupCoordinateSystems() {
  proj4.defs([
      ['EPSG:3826', '+proj=tmerc +lat_0=0 +lon_0=121 +k=0.9999 +x_0=250000 +y_0=0 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs'],
      ['EPSG:3828', '+proj=tmerc +lat_0=0 +lon_0=121 +k=0.9999 +x_0=250000 +y_0=0 +ellps=aust_SA +towgs84=-752,-358,-179,-.0000011698,.0000018398,.0000009822,.00002329 +units=m +no_defs'],
      ['EPSG:4326', '+proj=longlat +datum=WGS84 +no_defs']
  ]);
}

// ğŸ”§ ä¿®æ­£ï¼šåŠ å…¥è·é›¢é–¾å€¼é˜²æ­¢æŠ–å‹•
let lastPosition = null;
const POSITION_THRESHOLD = 5; // 5å…¬å°ºé–¾å€¼
// ğŸ”§ ä¿®æ­£ç‰ˆï¼šè·Ÿéš¨è£ç½®ä½ç½®åŠŸèƒ½
let userHasDraggedMap = false; // ğŸ†• è¿½è¹¤ç”¨æˆ¶æ˜¯å¦æ‹–æ›³éåœ°åœ–
let initialLocationSet = false; // ğŸ†• è¿½è¹¤æ˜¯å¦å·²è¨­å®šåˆå§‹ä½ç½®
// ğŸ”§ ä¿®æ­£ç‰ˆï¼šå¹³æ»‘è·Ÿéš¨å®šä½åœ°é»
// ğŸ”§ ä¿®æ­£ç‰ˆï¼šå¹³æ»‘è·Ÿéš¨å®šä½åœ°é» - è§£æ±ºé–ƒå±å•é¡Œ
function enableContinuousLocation() {
    if (navigator.geolocation) {
        isContinuousLocationEnabled = true;
        userHasDraggedMap = false;
        initialLocationSet = false;
        
        const btn = document.getElementById('locateBtn');
        if (btn) {
            btn.classList.add('active');
            btn.textContent = 'â¹ï¸ åœæ­¢å®šä½';
            btn.style.backgroundColor = '#dc3545';
            btn.style.color = 'white';
        }

        // ç›£è½åœ°åœ–æ‹–æ›³äº‹ä»¶
        map.on('dragstart', function() {
            userHasDraggedMap = true;
            console.log('ğŸ–±ï¸ ç”¨æˆ¶é–‹å§‹æ‹–æ›³åœ°åœ–');
        });

        watchId = navigator.geolocation.watchPosition(function (position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            const accuracy = position.coords.accuracy;
            const currentPosition = L.latLng(lat, lng);

            // ğŸ”§ å¢åŠ è·é›¢é–¾å€¼ï¼Œæ¸›å°‘é »ç¹æ›´æ–°
            if (lastPosition && lastPosition.distanceTo(currentPosition) < Math.max(15, accuracy/2)) {
                return;
            }

            lastPosition = currentPosition;

            // æ›´æ–°æˆ–å‰µå»ºä½ç½®æ¨™è¨˜
            if (!userLocationMarker) {
                const locationIcon = L.divIcon({
                    html: '<div class="location-marker"><div class="center-dot"></div></div>',
                    className: 'custom-location-icon',
                    iconSize: [40, 40],
                    iconAnchor: [20, 20]
                });
                
                userLocationMarker = L.marker([lat, lng], {
                    icon: locationIcon
                }).addTo(map);
            } else {
                // ğŸ”§ é‡è¦ï¼šåªæ›´æ–°æ¨™è¨˜ä½ç½®ï¼Œä¸ç§»å‹•åœ°åœ–
                userLocationMarker.setLatLng([lat, lng]);
            }

            // ğŸ”§ ä¿®æ­£ï¼šåœ°åœ–ç§»å‹•é‚è¼¯ - é¿å…é–ƒå±
            if (!initialLocationSet) {
                // åˆæ¬¡å®šä½ï¼šä½¿ç”¨å¹³æ»‘ç§»å‹•
                map.flyTo([lat, lng], Math.max(map.getZoom(), 16), {
                    animate: true,
                    duration: 1.5
                });
                initialLocationSet = true;
                console.log('ğŸ“ åˆæ¬¡å®šä½å®Œæˆ');
            } else if (!userHasDraggedMap) {
                const currentCenter = map.getCenter();
                const distanceFromCenter = currentCenter.distanceTo(currentPosition);
                
                // ğŸ”§ é‡è¦ï¼šåªæœ‰è·é›¢è¼ƒé æ™‚æ‰ç§»å‹•åœ°åœ–
                if (distanceFromCenter > 300) {
                    // ä½¿ç”¨å¹³æ»‘ç§»å‹•ï¼Œä¸åˆ·æ–°åœ–å±¤
                    map.flyTo([lat, lng], map.getZoom(), {
                        animate: true,
                        duration: 2.0
                    });
                }
            }

        }, function (error) {
            console.error('å®šä½éŒ¯èª¤:', error);
            showToast('âŒ ç„¡æ³•ç²å–æ‚¨çš„ä½ç½®', 'error');
            disableContinuousLocation();
        }, {
            enableHighAccuracy: true,
            maximumAge: 15000,  // ğŸ”§ å¢åŠ å¿«å–æ™‚é–“
            timeout: 25000
        });
        
        console.log('ğŸ“ é–‹å§‹è·Ÿéš¨è£ç½®ä½ç½®');
    } else {
        showToast('âŒ æ‚¨çš„è£ç½®ä¸æ”¯æ´å®šä½åŠŸèƒ½', 'error');
    }
}
// ğŸ”§ ä¿®æ­£ç‰ˆï¼šåœ°åœ–å°ºå¯¸ç„¡æ•ˆåŒ– - æ¸›å°‘é »ç‡
let invalidateSizeTimeout = null;
function invalidateMapSize() {
    // ğŸ”§ é˜²æŠ–æ©Ÿåˆ¶ï¼Œé¿å…é »ç¹èª¿ç”¨
    if (invalidateSizeTimeout) {
        clearTimeout(invalidateSizeTimeout);
    }
    
    invalidateSizeTimeout = setTimeout(() => {
        try {
            map.invalidateSize({
                animate: false,
                pan: false
            });
            console.log('ğŸ—ºï¸ åœ°åœ–å°ºå¯¸å·²é‡æ–°è¨ˆç®—');
        } catch (error) {
            console.warn('âš ï¸ åœ°åœ–å°ºå¯¸é‡æ–°è¨ˆç®—å¤±æ•—:', error);
        }
        invalidateSizeTimeout = null;
    }, 500); // å»¶é²500msåŸ·è¡Œ
}

// ğŸ†• æ–°å¢ï¼šå¼·åˆ¶åˆ·æ–°ç•¶å‰åœ–å±¤
function refreshCurrentLayer() {
    if (window.currentBaseLayer) {
        try {
            // æ–¹æ³•1ï¼šé‡æ–°è¼‰å…¥åœ–å±¤
            window.currentBaseLayer.redraw();
            
            // æ–¹æ³•2ï¼šå¦‚æœæœ‰ _url å±¬æ€§ï¼Œå¼·åˆ¶åˆ·æ–°
            if (window.currentBaseLayer._url) {
                const originalUrl = window.currentBaseLayer._url;
                window.currentBaseLayer._url = originalUrl + '?refresh=' + Date.now();
                window.currentBaseLayer.redraw();
                
                // æ¢å¾©åŸå§‹ URL
                setTimeout(() => {
                    window.currentBaseLayer._url = originalUrl;
                }, 100);
            }
            
            console.log('ğŸ”„ å·²åˆ·æ–°èƒŒæ™¯åœ–å±¤');
        } catch (error) {
            console.warn('âš ï¸ åœ–å±¤åˆ·æ–°å¤±æ•—:', error);
            
            // ğŸ”§ å‚™ç”¨æ–¹æ¡ˆï¼šé‡æ–°è¨­ç½®åœ–å±¤
            fallbackRefreshLayer();
        }
    }
}

// ğŸ†• æ–°å¢ï¼šå‚™ç”¨åœ–å±¤åˆ·æ–°æ–¹æ¡ˆ
function fallbackRefreshLayer() {
    try {
        // å–å¾—ç•¶å‰é¸ä¸­çš„åœ–å±¤é¡å‹
        const selectedLayer = document.querySelector('input[name="baseLayer"]:checked');
        if (selectedLayer) {
            const layerName = selectedLayer.value;
            
            // æš«æ™‚ç§»é™¤ç•¶å‰åœ–å±¤
            if (window.currentBaseLayer) {
                map.removeLayer(window.currentBaseLayer);
            }
            
            // é‡æ–°æ·»åŠ åœ–å±¤
            setTimeout(() => {
                if (window.mapLayers[layerName]) {
                    window.currentBaseLayer = window.mapLayers[layerName].addTo(map);
                    console.log('ğŸ”„ å·²é‡æ–°è¼‰å…¥èƒŒæ™¯åœ–å±¤:', layerName);
                }
            }, 100);
        }
    } catch (error) {
        console.error('âŒ å‚™ç”¨åœ–å±¤åˆ·æ–°ä¹Ÿå¤±æ•—:', error);
    }
}

// ğŸ”§ ä¿®æ­£ç‰ˆï¼šåœç”¨é€£çºŒå®šä½
// ğŸ”§ ä¿®æ­£ç‰ˆï¼šåœç”¨é€£çºŒå®šä½
function disableContinuousLocation() {
    if (watchId) {
        navigator.geolocation.clearWatch(watchId);
        watchId = null;
    }
    
    isContinuousLocationEnabled = false;
    userHasDraggedMap = false;
    initialLocationSet = false;
    
    // ç§»é™¤åœ°åœ–æ‹–æ›³ç›£è½
    map.off('dragstart');
    
    // ğŸ”§ ä¿®æ­£ï¼šæ­£ç¢ºé‡ç½®æŒ‰éˆ•ç‹€æ…‹
    const btn = document.getElementById('locateBtn');
    if (btn) {
        btn.classList.remove('active');
        btn.textContent = 'ğŸ“ è·Ÿéš¨è£ç½®';
        btn.style.backgroundColor = ''; // é‡ç½®èƒŒæ™¯è‰²
        btn.style.color = ''; // é‡ç½®æ–‡å­—è‰²
    }
    
    console.log('â¹ï¸ å·²åœæ­¢è·Ÿéš¨è£ç½®ä½ç½®');
}

// æ–°å¢ï¼šåœ–è™Ÿåº§æ¨™è½‰æ›åŠŸèƒ½
function searchByCoordinate() {
    const input = document.getElementById('coordinateInput');
    const coordinate = input.value.trim().toUpperCase();
    
    if (!coordinate) {
        showToast('è«‹è¼¸å…¥åœ–è™Ÿåº§æ¨™ï¼', 'error');
        return;
    }
    
    try {
        const result = convertPowerCoordinate(coordinate);
        const [lng, lat] = result.split(',').map(Number);
        
        // åœ¨åœ°åœ–ä¸Šæ¨™è¨˜ä½ç½®
        const marker = L.marker([lat, lng], {
            icon: L.icon({
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                shadowSize: [41, 41]
            })
        }).addTo(map);
        
        const popupContent = `
            <div style="text-align: center;">
                <h4>ğŸ“ åœ–è™Ÿåº§æ¨™å®šä½</h4>
                <p><strong>åº§æ¨™:</strong> ${coordinate}</p>
                <p><strong>ç¶“ç·¯åº¦:</strong> ${lat.toFixed(3)}, ${lng.toFixed(3)}</p>
                <button onclick="openStreetView(${lat}, ${lng})" 
                        style="width: 100%; margin: 2px 0; padding: 10px; background: #ffc107; color: black; border: none; border-radius: 3px; cursor: pointer;">
                    ğŸ—ºï¸ è¡—æ™¯åœ–
                </button>
				<button onclick="openNavigation(${lat}, ${lng}, 'é¸å®šä½ç½®'); map.closePopup();" 
						style="width: 100%; margin: 2px 0; padding: 10px; background: #ffc107; color: black; border: none; border-radius: 3px; cursor: pointer;">
					ğŸ§­ å°èˆªè‡³æ­¤
				</button>
                <button onclick="copyCoordinates(${lat}, ${lng})" 
                        style="width: 100%; margin: 2px 0; padding: 10px; background: #ffc107; color: black; border: none; border-radius: 3px; cursor: pointer;">
                    ğŸ“‹ è¤‡è£½åº§æ¨™
                </button>
            </div>
        `;
        
        marker.bindPopup(popupContent).openPopup();
        
        // ç§»å‹•åœ°åœ–åˆ°è©²ä½ç½®
        map.flyTo([lat, lng], 18, {
            duration: 1.0
        });
        
        showToast(`âœ… åº§æ¨™å®šä½æˆåŠŸ: ${coordinate}`, 'success');
        
    } catch (error) {
        console.error('åº§æ¨™è½‰æ›éŒ¯èª¤:', error);
        showToast(`âŒ åº§æ¨™è½‰æ›å¤±æ•—: ${error.message}`, 'error');
    }
}

// æ–°å¢ï¼šé›»åŠ›åº§æ¨™è½‰æ›å‡½æ•¸
function convertPowerCoordinate(powerCoord, lonOffset = -0.00002, latOffset = -0.00001) {
    powerCoord = powerCoord.toUpperCase();
    
    // é©—è­‰æ ¼å¼
    if (!/^[A-HJ-Z]\d{4}[A-H][A-E]\d{2,4}$/.test(powerCoord)) {
        throw new Error('ç„¡æ•ˆçš„é›»åŠ›åº§æ¨™æ ¼å¼');
    }

    try {
        // è§£æé›»åŠ›åº§æ¨™
        const zone = powerCoord.charAt(0);
        const block = powerCoord.substring(1, 5);
        const subBlock = powerCoord.substring(5, 7);
        const detail = powerCoord.substring(7, 11);

        // è¨ˆç®—ç›¸å°ä½ç§»
        const offsetX = calculateOffset(block, subBlock, detail, true);
        const offsetY = calculateOffset(block, subBlock, detail, false);

        // æŸ¥æ‰¾å°æ‡‰çš„åŸé»åº§æ¨™
        const taiXY = taiGridArr.find(e => e.taiCode === zone);
        if (!taiXY) {
            throw new Error('ç„¡æ•ˆçš„åˆ†å€ä»£ç¢¼');
        }

        // è¨ˆç®—TWD67åº§æ¨™
        const twd67X = parseFloat((taiXY.taiGrid[0] + offsetX).toFixed(6));
        const twd67Y = parseFloat((taiXY.taiGrid[1] + offsetY).toFixed(6));

        // è½‰æ›ç‚ºWGS84
        let wgs84 = proj4('EPSG:3828', 'WGS84', [twd67X, twd67Y]);
        wgs84[0] = parseFloat((wgs84[0] + lonOffset).toFixed(10));
        wgs84[1] = parseFloat((wgs84[1] + latOffset).toFixed(10));
        
        return `${wgs84[0]},${wgs84[1]}`;

    } catch (error) {
        throw new Error('è½‰æ›éç¨‹ç™¼ç”ŸéŒ¯èª¤: ' + error.message);
    }
}

function calculateOffset(block, subBlock, detail, isX) {
    let offset = 0;
    if (isX) {
        offset += parseInt(block.substring(0, 2)) * 800;
        offset += (subBlock.charCodeAt(0) - 65) * 100;
        if (detail.length === 2) {
            offset += parseInt(detail.substring(0, 1)) * 10;
        } else if (detail.length === 4) {
            offset += parseInt(detail.substring(2, 3)) * 1;
        }
    } else {
        offset += parseInt(block.substring(2, 4)) * 500;
        offset += (subBlock.charCodeAt(1) - 65) * 100;
        if (detail.length === 2) {
            offset += parseInt(detail.substring(1, 2)) * 10;
        } else if (detail.length === 4) {
            offset += parseInt(detail.substring(3, 4)) * 1;
        }
    }
    return offset;
}
			
			// é‡ç½®ç·šæ®µé«˜äº® - ä¿®æ”¹ç‰ˆ
			function resetLineHighlight() {
				if (selectedLine) {
					selectedLine.setStyle(selectedLine.originalStyle);
					
					// ğŸ”§ æ•ˆèƒ½å„ªåŒ–ï¼šæ‰¹é‡é‡ç½®ç®­é ­é¡è‰²
					if (selectedLine.arrowMarkers && selectedLine.arrowMarkers.length > 0) {
						selectedLine.arrowMarkers.forEach(marker => {
							updateArrowColor(marker, selectedLine.originalStyle.color);
						});
					}
					
					selectedLine = null;
					console.log('ğŸ”„ å·²é‡ç½®ç·šæ®µé«˜äº®');
				}
			}
			
			// æ›´æ–°è¼‰å…¥ç‹€æ…‹
			function updateLoadStatus(message) {
				const statusElement = document.getElementById('loadStatus');
				statusElement.textContent = message;
				console.log('ğŸ“Š', message);
			}
			
		// ğŸ”§ ä¿®æ­£ï¼šä½¿ç”¨å‘½åå‡½æ•¸ä»¥ä¾¿é‡æ–°ç¶å®š
		document.getElementById('fileInput').addEventListener('change', handleFileInput);
			
		// è™•ç† JSON è³‡æ–™ - ä¿®æ­£ç‰ˆï¼ˆé‡å°å°é›»æ ¼å¼ï¼‰
	function processJsonData(data, fileName) {
		console.log('ğŸ“ é–‹å§‹è™•ç†æª”æ¡ˆ:', fileName);
		console.log('ğŸ“Š åŸå§‹è³‡æ–™çµæ§‹:', data);
		
		// æ¸…é™¤èˆŠè³‡æ–™
		clearAllLayers();
		allDevicesData = [];
		allLinesData = [];
		layerGroups = {};
		layerCounts = {};
		currentFeederInfo = null;
		selectedLine = null; // é‡ç½®é¸ä¸­ç·šæ®µ
		
		let processedPointCount = 0;
		let processedLineCount = 0;
		let totalNodes = 0;
		let totalLinks = 0;
		
		// ğŸ”§ ä¿®æ­£ç‰ˆï¼šè™•ç†è£ç½®æ–¹å‘äº‹ä»¶ - ä¿®æ­£è§’åº¦åè½‰å•é¡Œ
		let lastHeading = null;
		const HEADING_THRESHOLD = 0.3; // å¢åŠ æ–¹å‘è®ŠåŒ–é–¾å€¼
		let orientationSupported = false;
		let permissionGranted = false;
		
		// è™•ç†å°é›»é…é›»ç³»çµ±çš„ GeoNode å’Œ GeoLink æ ¼å¼
		if (data.GeoNode && Array.isArray(data.GeoNode)) {
			console.log('âœ… è­˜åˆ¥ç‚ºå°é›»é…é›»ç³»çµ±æ ¼å¼');
			
			const geoNodes = data.GeoNode;
			const geoLinks = data.GeoLink || [];
			
			totalNodes = geoNodes.length;
			totalLinks = geoLinks.length;
			
			updateLoadStatus(`æ‰¾åˆ° ${totalNodes} å€‹è¨­å‚™ç¯€é», ${totalLinks} æ¢é€£æ¥ç·šæ®µï¼Œé–‹å§‹è™•ç†...`);
			
			// æå–é¥‹ç·šè³‡è¨Š
			if (geoNodes.length > 0) {
				extractFeederInfo(geoNodes[0], fileName);
			}
			
			// ğŸ”§ é‡è¦ä¿®æ­£ï¼šå…ˆè™•ç†æ‰€æœ‰é»è¨­å‚™ (GeoNode) - ç¢ºä¿ allDevicesData å®Œæ•´
			console.log('ğŸ”„ ç¬¬ä¸€éšæ®µï¼šè™•ç†æ‰€æœ‰é»è¨­å‚™...');
			geoNodes.forEach((node, index) => {
				try {
					const processedNode = processGeoNode(node, index);
					if (processedNode) {
						allDevicesData.push(processedNode);
						processedPointCount++;
					}
				} catch (error) {
					console.warn(`âš ï¸ GeoNode ${index} è™•ç†å¤±æ•—:`, error, node);
				}
			});
			
			console.log(`âœ… ç¬¬ä¸€éšæ®µå®Œæˆï¼šè™•ç†äº† ${processedPointCount} å€‹é»è¨­å‚™`);
			console.log(`ğŸ“Š allDevicesData ç¾åœ¨åŒ…å« ${allDevicesData.length} å€‹è¨­å‚™`);
			
			// ğŸ”§ é‡è¦ä¿®æ­£ï¼šå†è™•ç†ç·šæ®µ (GeoLink) - æ­¤æ™‚å¯ä»¥æŸ¥æ‰¾ç¯€é»è³‡æ–™
			console.log('ğŸ”„ ç¬¬äºŒéšæ®µï¼šè™•ç†æ‰€æœ‰ç·šæ®µ...');
			geoLinks.forEach((link, index) => {
				try {
					const processedLine = processGeoLink(link, index);
					if (processedLine) {
						allLinesData.push(processedLine);
						processedLineCount++;
					}
				} catch (error) {
					console.warn(`âš ï¸ GeoLink ${index} è™•ç†å¤±æ•—:`, error, link);
				}
			});
			
			console.log(`âœ… ç¬¬äºŒéšæ®µå®Œæˆï¼šè™•ç†äº† ${processedLineCount} æ¢ç·šæ®µ`);
			
		} else {
			// è™•ç†å…¶ä»–æ ¼å¼ï¼ˆä¿æŒåŸæœ‰é‚è¼¯ï¼‰
			let features = [];
			
			if (Array.isArray(data)) {
				features = data;
				console.log('âœ… è­˜åˆ¥ç‚º Features é™£åˆ—æ ¼å¼');
			} else if (data.type === 'FeatureCollection' && data.features) {
				features = data.features;
				console.log('âœ… è­˜åˆ¥ç‚º GeoJSON FeatureCollection');
			} else if (data.features && Array.isArray(data.features)) {
				features = data.features;
				console.log('âœ… è­˜åˆ¥ç‚ºåŒ…å« features çš„æ ¼å¼');
			} else {
				console.error('âŒ ä¸æ”¯æ´çš„è³‡æ–™æ ¼å¼ï¼Œè³‡æ–™çµæ§‹:', Object.keys(data));
				updateLoadStatus('âŒ ä¸æ”¯æ´çš„è³‡æ–™æ ¼å¼ï¼Œè«‹æª¢æŸ¥æª”æ¡ˆçµæ§‹');
				return;
			}
			
			totalNodes = features.length;
			updateLoadStatus(`æ‰¾åˆ° ${totalNodes} å€‹ Featureï¼Œé–‹å§‹è™•ç†...`);
			
			// æå–é¥‹ç·šè³‡è¨Š
			if (features.length > 0) {
				extractFeederInfo(features[0], fileName);
			}
			
			// è™•ç†æ¯å€‹ Feature
			features.forEach((feature, index) => {
				try {
					if (!feature.type || feature.type !== 'Feature') {
						console.warn(`Feature ${index} æ ¼å¼ç„¡æ•ˆ:`, feature);
						return;
					}
					
					if (!feature.geometry || !feature.geometry.type) {
						console.warn(`Feature ${index} ç¼ºå°‘ geometry:`, feature);
						return;
					}
					
					const geometryType = feature.geometry.type;
					
					if (geometryType === 'Point') {
						const processedNode = processPointFeature(feature, index);
						if (processedNode) {
							allDevicesData.push(processedNode);
							processedPointCount++;
						}
					} else if (geometryType === 'LineString') {
						const processedLine = processLineFeature(feature, index);
						if (processedLine) {
							allLinesData.push(processedLine);
							processedLineCount++;
						}
					}
				} catch (error) {
					console.warn(`âš ï¸ Feature ${index} è™•ç†å¤±æ•—:`, error, feature);
				}
			});
		}
		
		console.log(`âœ… æˆåŠŸè™•ç† ${processedPointCount} å€‹é»è¨­å‚™, ${processedLineCount} æ¢ç·šæ®µ`);
		updateLoadStatus(`âœ… æˆåŠŸè¼‰å…¥ ${processedPointCount} å€‹è¨­å‚™, ${processedLineCount} æ¢ç·šæ®µ`);
		
		// å»ºç«‹åœ–å±¤æ§åˆ¶
		createLayerControls();
		
		// è‡ªå‹•ç¸®æ”¾åˆ°è³‡æ–™ç¯„åœ
		if (processedPointCount > 0 || processedLineCount > 0) {
			fitMapToData();
		}
		
		// é¡¯ç¤ºé¥‹ç·šè³‡è¨Š
		displayFeederInfo();
		
		// é¡¯ç¤ºé«˜äº®æ§åˆ¶
		if (processedLineCount > 0) {
			document.getElementById('highlightControls').style.display = 'block';
		}
	}

	// è™•ç†å°é›» GeoLink - å®Œå…¨ä¿®æ­£ç‰ˆï¼ˆä¿®æ­£å±¬æ€§ä½ç½®ï¼‰
	function processGeoLink(link, index) {
		console.log(`ğŸ” è™•ç† GeoLink ${index}:`, link);
		
		if (!link.type || link.type !== 'Feature') {
			console.warn(`GeoLink ${index} ä¸æ˜¯æœ‰æ•ˆçš„ Feature:`, link);
			return null;
		}
		
		const geometry = link.geometry;
		if (!geometry || geometry.type !== 'LineString') {
			console.warn(`GeoLink ${index} ä¸æ˜¯ç·šæ®µå¹¾ä½•:`, link);
			return null;
		}
		
		// ğŸ”§ é‡è¦ä¿®æ­£ï¼šGeoLink çš„å±¬æ€§ä¹Ÿåœ¨ geometry.properties å…§éƒ¨ï¼ˆå’Œ GeoNode ä¸€æ¨£ï¼‰
		let properties = {};
		
		// å„ªå…ˆé †åºï¼šgeometry.properties > link.properties > ç©ºç‰©ä»¶
		if (geometry.properties && typeof geometry.properties === 'object') {
			properties = geometry.properties;
			console.log(`âœ… GeoLink ${index} å¾ geometry.properties å–å¾—å±¬æ€§`);
		} else if (link.properties && typeof link.properties === 'object') {
			properties = link.properties;
			console.log(`âœ… GeoLink ${index} å¾ link.properties å–å¾—å±¬æ€§`);
		} else {
			console.warn(`GeoLink ${index} ç„¡æ³•æ‰¾åˆ°æœ‰æ•ˆçš„ properties`);
			properties = {};
		}
		
		console.log(`ğŸ” GeoLink ${index} å®Œæ•´å±¬æ€§:`, properties);
		
		const coordinates = geometry.coordinates;
		
		if (!coordinates || !Array.isArray(coordinates) || coordinates.length < 2) {
			console.warn(`GeoLink ${index} åº§æ¨™æ ¼å¼ç„¡æ•ˆ:`, coordinates);
			return null;
		}
		
		// è½‰æ›åº§æ¨™æ ¼å¼ä¸¦é©—è­‰
		const latLngs = [];
		for (let i = 0; i < coordinates.length; i++) {
			const coord = coordinates[i];
			if (!Array.isArray(coord) || coord.length < 2) {
				console.warn(`GeoLink ${index} ç¬¬ ${i} å€‹åº§æ¨™ç„¡æ•ˆ:`, coord);
				continue;
			}
			
			// è™•ç†å­—ä¸²æ ¼å¼åº§æ¨™ - è½‰æ›ç‚ºæ•¸å­—
			const lng = parseFloat(coord[0]);
			const lat = parseFloat(coord[1]);
			
			if (isNaN(lng) || isNaN(lat)) {
				console.warn(`GeoLink ${index} ç¬¬ ${i} å€‹åº§æ¨™æ•¸å€¼ç„¡æ•ˆ:`, coord);
				continue;
			}
			
			// æª¢æŸ¥åº§æ¨™åˆç†æ€§ï¼ˆå°ç£ç¯„åœï¼‰
			if (lng >= 118 && lng <= 122 && lat >= 21 && lat <= 26) {
				latLngs.push([lat, lng]);
			} else {
				console.warn(`GeoLink ${index} ç¬¬ ${i} å€‹åº§æ¨™è¶…å‡ºå°ç£ç¯„åœ:`, [lng, lat]);
			}
		}
		
		if (latLngs.length < 2) {
			console.warn(`GeoLink ${index} æœ‰æ•ˆåº§æ¨™é»ä¸è¶³:`, latLngs);
			return null;
		}
		
		// åˆ†é¡ç·šæ®µ - æ ¹æ“šé›»å£“ç­‰ç´šå’Œç·šè·¯é¡å‹
		const category = categorizeGeoLinkAdvanced(properties);
		
		console.log(`âœ… GeoLink ${index} è™•ç†æˆåŠŸï¼Œåº§æ¨™é»æ•¸: ${latLngs.length}, é¡åˆ¥: ${category}`);
		
		return {
			coordinates: latLngs,
			properties: properties,
			category: category,
			featureIndex: index,
			type: 'LineString'
		};
	}

	// GeoLink é€²éšåˆ†é¡ - å®Œå…¨ä¿®æ­£ç‰ˆï¼ˆåŠ å¼·é™¤éŒ¯è¼¸å‡ºï¼‰
	function categorizeGeoLinkAdvanced(properties) {
		console.log('ğŸ” GeoLink å®Œæ•´å±¬æ€§åˆ†æ:', properties);
		
		// ğŸ”§ ä¿®æ­£ï¼šç›´æ¥å¾ GeoLink å±¬æ€§ä¸­å–å¾—é›»å£“ç­‰ç´š
		let voltageLevel = 'unknown';
		
		// æ–¹æ³•1: ç›´æ¥å¾ GeoLink å±¬æ€§åˆ¤æ–·é›»å£“ç­‰ç´š
		const vlevel = properties.VLevel || properties.vlevel || '';
		console.log(`ğŸ” GeoLink VLevel åŸå§‹å€¼:`, vlevel, `(é¡å‹: ${typeof vlevel})`);
		
		if (vlevel) {
			const vLevel = parseInt(vlevel);
			if (vLevel === 1) {
				voltageLevel = '11.4kv';
			} else if (vLevel === 2) {
				voltageLevel = '22.8kv';
			}
			console.log(`âœ… å¾ GeoLink ç›´æ¥å–å¾—é›»å£“ç­‰ç´š: VLevel=${vLevel} -> ${voltageLevel}`);
		} else {
			// æ–¹æ³•2: å¦‚æœ GeoLink æ²’æœ‰ VLevelï¼Œå˜—è©¦æŸ¥æ‰¾ç¯€é»
			const fromId = properties.FromID;
			const toId = properties.ToID;
			
			if (fromId || toId) {
				const fromNode = allDevicesData.find(device => 
					device.properties.ID == fromId || device.properties.ID === fromId
				);
				const toNode = allDevicesData.find(device => 
					device.properties.ID == toId || device.properties.ID === toId
				);
				
				console.log(`ğŸ” æŸ¥æ‰¾ç¯€é» - FromID: ${fromId}, ToID: ${toId}`);
				console.log(`ğŸ” æ‰¾åˆ°èµ·é»ç¯€é»:`, fromNode ? `ID=${fromNode.properties.ID}, VLevel=${fromNode.properties.VLevel}` : 'æœªæ‰¾åˆ°');
				console.log(`ğŸ” æ‰¾åˆ°çµ‚é»ç¯€é»:`, toNode ? `ID=${toNode.properties.ID}, VLevel=${toNode.properties.VLevel}` : 'æœªæ‰¾åˆ°');
				
				const referenceNode = fromNode || toNode;
				if (referenceNode && referenceNode.properties.VLevel) {
					const vLevel = parseInt(referenceNode.properties.VLevel);
					if (vLevel === 1) {
						voltageLevel = '11.4kv';
					} else if (vLevel === 2) {
						voltageLevel = '22.8kv';
					}
					console.log(`âœ… å¾ç¯€é»å–å¾—é›»å£“ç­‰ç´š: VLevel=${vLevel} -> ${voltageLevel}`);
				}
			}
		}
		
		// ğŸ”§ ä¿®æ­£ï¼šåˆ¤æ–·æ¶ç©º/åœ°ä¸‹ - æª¢æŸ¥æ‰€æœ‰å¯èƒ½çš„å±¬æ€§åç¨±å’Œå€¼
		const ohug = properties.OHUG || properties.ohug || properties.Ohug || '';
		console.log(`ğŸ” OHUG åŸå§‹å€¼:`, ohug, `(é¡å‹: ${typeof ohug})`);
		
		let isUnderground = false;
		
		// è™•ç†ä¸åŒçš„è³‡æ–™é¡å‹å’Œå€¼
		if (typeof ohug === 'string') {
			isUnderground = (ohug === '1' || ohug.toLowerCase() === 'underground' || ohug.toLowerCase() === 'u');
		} else if (typeof ohug === 'number') {
			isUnderground = (ohug === 1);
		} else if (typeof ohug === 'boolean') {
			isUnderground = ohug;
		}
		
		console.log(`ğŸ” æ¶è¨­æ–¹å¼åˆ¤æ–·: OHUG=${ohug} -> ${isUnderground ? 'åœ°ä¸‹' : 'æ¶ç©º'}`);
		
		// ğŸ”§ ä¿®æ­£ï¼šåˆ¤æ–·ä¸»å¹¹ç·š/åˆ†æ­§ç·š - æª¢æŸ¥æ‰€æœ‰å¯èƒ½çš„å±¬æ€§åç¨±å’Œå€¼
		const cabType = properties.CabType || properties.cabtype || properties.Cabtype || '';
		console.log(`ğŸ” CabType åŸå§‹å€¼:`, cabType, `(é¡å‹: ${typeof cabType})`);
		
		let isMainLine = false;
		
		// è™•ç†ä¸åŒçš„è³‡æ–™é¡å‹å’Œå€¼
		if (typeof cabType === 'string') {
			isMainLine = (cabType === '0' || cabType.toLowerCase() === 'main' || cabType.toLowerCase() === 'm');
		} else if (typeof cabType === 'number') {
			isMainLine = (cabType === 0);
		} else if (typeof cabType === 'boolean') {
			isMainLine = !cabType; // å‡è¨­ false ä»£è¡¨ä¸»å¹¹ç·š
		}
		
		console.log(`ğŸ” ç·šè·¯é¡å‹åˆ¤æ–·: CabType=${cabType} -> ${isMainLine ? 'ä¸»å¹¹ç·š' : 'åˆ†æ­§ç·š'}`);
		
		// çµ„åˆåˆ†é¡
		let category = '';
		
		if (voltageLevel === '22.8kv') {
			if (isMainLine) {
				category = isUnderground ? 'line_22_8kv_main_underground' : 'line_22_8kv_main_overhead';
			} else {
				category = isUnderground ? 'line_22_8kv_branch_underground' : 'line_22_8kv_branch_overhead';
			}
		} else if (voltageLevel === '11.4kv') {
			if (isMainLine) {
				category = isUnderground ? 'line_11_4kv_main_underground' : 'line_11_4kv_main_overhead';
			} else {
				category = isUnderground ? 'line_11_4kv_branch_underground' : 'line_11_4kv_branch_overhead';
			}
		} else {
			// æœªçŸ¥é›»å£“ç­‰ç´š
			category = isUnderground ? 'line_other_underground' : 'line_other_overhead';
		}
		
		console.log(`âœ… æœ€çµ‚åˆ†é¡çµæœ:`);
		console.log(`   - é›»å£“ç­‰ç´š: ${voltageLevel}`);
		console.log(`   - æ¶è¨­æ–¹å¼: ${isUnderground ? 'åœ°ä¸‹' : 'æ¶ç©º'}`);
		console.log(`   - ç·šè·¯é¡å‹: ${isMainLine ? 'ä¸»å¹¹ç·š' : 'åˆ†æ­§ç·š'}`);
		console.log(`   - æœ€çµ‚é¡åˆ¥: ${category}`);
		
		return category;
	}
	// è™•ç†å°é›» GeoNode - å®Œå…¨ä¿®æ­£ç‰ˆï¼ˆåƒè€ƒä½ çš„ Python ç¨‹å¼ï¼‰
	function processGeoNode(node, index) {
		console.log(`ğŸ” è™•ç† GeoNode ${index}:`, node);
		
		if (!node.type || node.type !== 'Feature') {
			console.warn(`GeoNode ${index} ä¸æ˜¯æœ‰æ•ˆçš„ Feature:`, node);
			return null;
		}
		
		const geometry = node.geometry;
		if (!geometry || geometry.type !== 'Point') {
			console.warn(`GeoNode ${index} ä¸æ˜¯é»å¹¾ä½•:`, node);
			return null;
		}
		
		// ğŸ”§ é‡è¦ä¿®æ­£ï¼šæ ¹æ“šä½ çš„ Python ç¨‹å¼ï¼Œproperties åœ¨ geometry.properties å…§éƒ¨
		const properties = geometry.properties || {};
		const coordinates = geometry.coordinates;
		
		console.log(`ğŸ” GeoNode ${index} å±¬æ€§å…§å®¹:`, properties);
		console.log(`ğŸ” GeoNode ${index} åº§æ¨™:`, coordinates);
		
		if (!coordinates || !Array.isArray(coordinates) || coordinates.length < 2) {
			console.warn(`GeoNode ${index} åº§æ¨™æ ¼å¼ç„¡æ•ˆ:`, coordinates);
			return null;
		}
		
		// ğŸ”§ é‡è¦ä¿®æ­£ï¼šä½ çš„è³‡æ–™ä¸­åº§æ¨™æ˜¯å­—ä¸²æ ¼å¼ï¼Œéœ€è¦è½‰æ›ç‚ºæ•¸å­—
		const lng = parseFloat(coordinates[0]);
		const lat = parseFloat(coordinates[1]);
		
		if (isNaN(lng) || isNaN(lat)) {
			console.warn(`GeoNode ${index} åº§æ¨™è½‰æ›å¤±æ•—:`, coordinates);
			return null;
		}
		
		// æª¢æŸ¥åº§æ¨™åˆç†æ€§ï¼ˆå°ç£ç¯„åœï¼‰
		if (lng < 118 || lng > 122 || lat < 21 || lat > 26) {
			console.warn(`GeoNode ${index} åº§æ¨™è¶…å‡ºå°ç£ç¯„åœ:`, [lng, lat]);
			// ä¸ç›´æ¥ return nullï¼Œç¹¼çºŒè™•ç†ï¼ˆå¯èƒ½æ˜¯æ¸¬è©¦è³‡æ–™ï¼‰
		}
		
		// ğŸ”§ æ¨™æº–åŒ–å±¬æ€§ - ç¢ºä¿æ‰€æœ‰å±¬æ€§éƒ½æ˜¯æ­£ç¢ºçš„è³‡æ–™é¡å‹
		const standardizedProps = {
			ID: properties.ID || properties.id || `temp_${index}`,
			Area: properties.Area || properties.area || '',
			Feeder: properties.Feeder || properties.feeder || '',
			Tpclid: properties.Tpclid || properties.tpclid || '',
			FSC: properties.FSC || properties.fsc || '',
			VLevel: properties.VLevel || properties.vlevel || '',
			CabType: properties.CabType || properties.cabtype || '',
			OHUG: properties.OHUG || properties.ohug || '',
			Tag: properties.Tag || properties.tag || '',
			Spec: properties.Spec || properties.spec || '',
			Length: properties.Length || properties.length || '',
			Location: properties.Location || properties.location || '',
			Type: properties.Type || properties.type || '',
			Name: properties.Name || properties.name || '',
			Visible: properties.Visible !== undefined ? properties.Visible : true,
			NO: properties.NO || false,
			Auto: properties.Auto || false,
			Fuse: properties.Fuse || false,
			Opposite: properties.Opposite || '',
			
			// å®¹é‡ç›¸é—œ
			Capacity: properties.Capacity || '',
			Capacities: properties.Capacities || '',
			Capacity1: properties.Capacity1 || '',
			Capacity2: properties.Capacity2 || '',
			Capacity3: properties.Capacity3 || '',
			
			// ç›¸åˆ¥ç›¸é—œ
			Group1: properties.Group1 || '',
			Phase1: properties.Phase1 || '',
			Phase2: properties.Phase2 || '',
			Phase3: properties.Phase3 || '',
			
			// ç‡ˆå…·é¡å‹
			LightType1: properties.LightType1 || '',
			LightType2: properties.LightType2 || '',
			LightType3: properties.LightType3 || '',
			SupplyType: properties.SupplyType || '',
			
			// è¿´è·¯è³‡è¨Š
			SrcLoop: properties.SrcLoop || null,
			DestLoop: properties.DestLoop || null
		};
		
		// ä¿ç•™åŸå§‹å±¬æ€§ï¼ˆä»¥é˜²æœ‰å…¶ä»–æœªçŸ¥å±¬æ€§ï¼‰
		Object.keys(properties).forEach(key => {
			if (!standardizedProps.hasOwnProperty(key)) {
				standardizedProps[key] = properties[key];
			}
		});
		
		// åˆ†é¡è¨­å‚™
		const category = categorizeNode(standardizedProps);
		
		console.log(`âœ… GeoNode ${index} è™•ç†æˆåŠŸ:`);
		console.log(`   - ID: ${standardizedProps.ID}`);
		console.log(`   - FSC: ${standardizedProps.FSC}`);
		console.log(`   - Area: ${standardizedProps.Area}`);
		console.log(`   - Feeder: ${standardizedProps.Feeder}`);
		console.log(`   - é¡åˆ¥: ${category}`);
		console.log(`   - åº§æ¨™: [${lng}, ${lat}]`);
		
		return {
			coordinates: [lng, lat],
			properties: standardizedProps,
			category: category,
			featureIndex: index,
			type: 'Point'
		};
	}

	// è™•ç†ç·šæ®µ Feature - æ–°å‡½æ•¸
	function processLineFeature(feature, index) {
		const geometry = feature.geometry;
		const properties = feature.properties || {};
		
		if (!geometry.coordinates || !Array.isArray(geometry.coordinates)) {
			console.warn(`ç·šæ®µ Feature ${index} ç¼ºå°‘æœ‰æ•ˆåº§æ¨™:`, feature);
			return null;
		}
		
		const coordinates = geometry.coordinates;
		
		// é©—è­‰ LineString åº§æ¨™æ ¼å¼
		if (coordinates.length < 2) {
			console.warn(`ç·šæ®µ Feature ${index} åº§æ¨™é»ä¸è¶³:`, coordinates);
			return null;
		}
		
		// è½‰æ›åº§æ¨™æ ¼å¼ä¸¦é©—è­‰
		const latLngs = [];
		for (let i = 0; i < coordinates.length; i++) {
			const coord = coordinates[i];
			if (!Array.isArray(coord) || coord.length < 2) {
				console.warn(`ç·šæ®µ Feature ${index} ç¬¬ ${i} å€‹åº§æ¨™ç„¡æ•ˆ:`, coord);
				continue;
			}
			
			// è™•ç†å­—ä¸²æ ¼å¼åº§æ¨™ - è½‰æ›ç‚ºæ•¸å­—
			const lng = parseFloat(coord[0]);
			const lat = parseFloat(coord[1]);
			
			if (isNaN(lng) || isNaN(lat)) {
				console.warn(`ç·šæ®µ Feature ${index} ç¬¬ ${i} å€‹åº§æ¨™æ•¸å€¼ç„¡æ•ˆ:`, coord);
				continue;
			}
			
			// æª¢æŸ¥åº§æ¨™åˆç†æ€§ï¼ˆå°ç£ç¯„åœï¼‰
			if (lng >= 118 && lng <= 122 && lat >= 21 && lat <= 26) {
				latLngs.push([lat, lng]);
			} else {
				console.warn(`ç·šæ®µ Feature ${index} ç¬¬ ${i} å€‹åº§æ¨™è¶…å‡ºå°ç£ç¯„åœ:`, [lng, lat]);
			}
		}
		
		if (latLngs.length < 2) {
			console.warn(`ç·šæ®µ Feature ${index} æœ‰æ•ˆåº§æ¨™é»ä¸è¶³:`, latLngs);
			return null;
		}
		
		// åˆ†é¡ç·šæ®µ
		const category = categorizeLineFeatureAdvanced(properties);
		
		console.log(`âœ… ç·šæ®µ Feature ${index} è™•ç†æˆåŠŸï¼Œåº§æ¨™é»æ•¸: ${latLngs.length}, é¡åˆ¥: ${category}`);
		
		return {
			coordinates: latLngs,
			properties: properties,
			category: category,
			featureIndex: index,
			type: 'LineString'
		};
	}

	// è™•ç†é» Feature - æ–°å‡½æ•¸
	function processPointFeature(feature, index) {
		const geometry = feature.geometry;
		const properties = feature.properties || {};
		
		if (!geometry.coordinates || !Array.isArray(geometry.coordinates)) {
			console.warn(`é» Feature ${index} ç¼ºå°‘æœ‰æ•ˆåº§æ¨™:`, feature);
			return null;
		}
		
		const coordinates = geometry.coordinates;
		
		if (coordinates.length < 2) {
			console.warn(`é» Feature ${index} åº§æ¨™æ ¼å¼ç„¡æ•ˆ:`, coordinates);
			return null;
		}
		
		// ç¢ºä¿åº§æ¨™æ˜¯æ•¸å­— - è™•ç†å­—ä¸²æ ¼å¼åº§æ¨™
		const lng = parseFloat(coordinates[0]);
		const lat = parseFloat(coordinates[1]);
		
		if (isNaN(lng) || isNaN(lat)) {
			console.warn(`é» Feature ${index} åº§æ¨™ç„¡æ•ˆ:`, coordinates);
			return null;
		}
		
		// æª¢æŸ¥åº§æ¨™åˆç†æ€§ï¼ˆå°ç£ç¯„åœï¼‰
		if (lng < 118 || lng > 122 || lat < 21 || lat > 26) {
			console.warn(`é» Feature ${index} åº§æ¨™è¶…å‡ºå°ç£ç¯„åœ:`, [lng, lat]);
			return null;
		}
		
		// åˆ†é¡è¨­å‚™
		const category = categorizeNode(properties);
		
		return {
			coordinates: [lng, lat],
			properties: properties,
			category: category,
			featureIndex: index,
			type: 'Point'
		};
	}

	// ç·šæ®µåˆ†é¡ - é‡å° Feature æ ¼å¼ï¼ˆé€²éšç‰ˆï¼‰
	function categorizeLineFeatureAdvanced(properties) {
		// åˆ¤æ–·é›»å£“ç­‰ç´šï¼ˆé€™è£¡éœ€è¦æ ¹æ“šå¯¦éš›è³‡æ–™èª¿æ•´ï¼‰
		const vlevel = properties.VLevel || properties.vlevel || '';
		let voltageLevel = 'unknown';
		
		if (vlevel) {
			const vLevel = parseInt(vlevel);
			if (vLevel === 1) {
				voltageLevel = '11.4kv';
			} else if (vLevel === 2) {
				voltageLevel = '22.8kv';
			}
		}
		
		// åˆ¤æ–·æ¶ç©º/åœ°ä¸‹
		const ohug = properties.OHUG || properties.ohug || '';
		const isUnderground = (ohug === '1' || ohug === 1);
		
		// åˆ¤æ–·ä¸»å¹¹ç·š/åˆ†æ­§ç·š
		const cabType = properties.CabType || properties.cabtype || '';
		const isMainLine = (cabType === '0' || cabType === 0);
		
		// çµ„åˆåˆ†é¡
		let category = '';
		
		if (voltageLevel === '22.8kv') {
			if (isMainLine) {
				category = isUnderground ? 'line_22_8kv_main_underground' : 'line_22_8kv_main_overhead';
			} else {
				category = isUnderground ? 'line_22_8kv_branch_underground' : 'line_22_8kv_branch_overhead';
			}
		} else if (voltageLevel === '11.4kv') {
			if (isMainLine) {
				category = isUnderground ? 'line_11_4kv_main_underground' : 'line_11_4kv_main_overhead';
			} else {
				category = isUnderground ? 'line_11_4kv_branch_underground' : 'line_11_4kv_branch_overhead';
			}
		} else {
			// æœªçŸ¥é›»å£“ç­‰ç´š
			category = isUnderground ? 'line_other_underground' : 'line_other_overhead';
		}
		
		return category;
	}
			
			// æå–é¥‹ç·šè³‡è¨Š - ä¿®æ­£ç‰ˆ
	function extractFeederInfo(firstNode, fileName) {
		let properties = {};
		
		// å°é›»æ ¼å¼
		if (firstNode.geometry && firstNode.geometry.properties) {
			properties = firstNode.geometry.properties;
		}
		// æ¨™æº– GeoJSON æ ¼å¼
		else if (firstNode.properties) {
			properties = firstNode.properties;
		}
		
		currentFeederInfo = {
			fileName: fileName,
			area: properties.Area || 'æœªçŸ¥',
			feeder: properties.Feeder || 'æœªçŸ¥',
			totalDevices: 0,
			totalLines: 0
		};
		
		console.log('ğŸ“Š é¥‹ç·šè³‡è¨Š:', currentFeederInfo);
	}
			
		   // é¡¯ç¤ºé¥‹ç·šè³‡è¨Š - æ”¹é€²ç‰ˆ
	function displayFeederInfo() {
		if (!currentFeederInfo) return;
		
		// æ›´æ–°çµ±è¨ˆæ•¸æ“š
		currentFeederInfo.totalDevices = allDevicesData.length;
		currentFeederInfo.totalLines = allLinesData.length;
		
		const infoContainer = document.getElementById('feederInfo');
		if (infoContainer) {
			infoContainer.innerHTML = `
				<div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px; border-radius: 8px; margin-bottom: 10px;">
					<h3 style="margin: 0 0 8px 0; font-size: 16px;">ğŸ“Š ${currentFeederInfo.fileName}</h3>
					<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 13px;">
						<div>ğŸ¢ å€åŸŸ: ${currentFeederInfo.area}</div>
						<div>âš¡ é¥‹ç·š: ${currentFeederInfo.feeder}</div>
						<div>ğŸ“ è¨­å‚™: ${currentFeederInfo.totalDevices}</div>
						<div>ğŸ“ ç·šæ®µ: ${currentFeederInfo.totalLines}</div>
					</div>
				</div>
			`;
			infoContainer.style.display = 'block';
		}
	}
			
			// è¨­å‚™åˆ†é¡ - æ ¹æ“šå°é›» FSC ä»£ç¢¼ï¼ˆçºŒï¼‰
			  function categorizeNode(properties) {
				  const fsc = properties.FSC || properties.fsc || '';
				  const fscNum = parseInt(fsc);
				  
				  // æ ¹æ“šå°é›» FSC ä»£ç¢¼åˆ†é¡
				  switch (fscNum) {
					  case 106: return 'poles_106';      // é›»æ¡¿è¨­å‚™
					  case 108: return 'cable_heads';    // é›»çºœé ­
					  case 109: return 'pole_markers';   // é›»æ¡¿æ¨™ç¤º
					  case 110: return 'solar';          // å¤ªé™½èƒ½è¨­å‚™
					  case 114: return 'switches';       // é–‹é—œè¨­å‚™
					  case 115: return 'transformers';   // è®Šå£“å™¨
					  case 116: return 'poles_116';      // çµ‚ç«¯
					  case 120: return 'grounding';      // æ¥åœ°è¨­å‚™
					  case 131: return 'others_131';     // å…¶ä»–è¨­å‚™
					  default: return 'unknown';         // æœªçŸ¥è¨­å‚™
				  }
			  }
			  
			  // æ›´æ–°åœ–å±¤åˆ†é¡å®šç¾© - é‡å°ç·šè·¯å€éš”åŒ–
	function createLayerControls() {
    // å®šç¾©è¨­å‚™é¡åˆ¥ - æ ¹æ“šå°é›» FSC åˆ†é¡
    const categories = {
        // é»è¨­å‚™é¡åˆ¥
        'poles_106': { name: 'ğŸ”´ ç·šè·¯ç¯€é» (FSC:106)', color: '#e74c3c', count: 0, type: 'point' },
        'cable_heads': { name: 'ğŸŸ  è®Šé›»æ‰€ (FSC:108)', color: '#f39c12', count: 0, type: 'point' },
        'pole_markers': { name: 'ğŸŸ£ é›»æ¡¿æ¨™ç¤º (FSC:109)', color: '#9b59b6', count: 0, type: 'point' },
        'solar': { name: 'ğŸŸ¡ å¤ªé™½èƒ½è¨­å‚™ (FSC:110)', color: '#f1c40f', count: 0, type: 'point' },
        'switches': { name: 'ğŸŸ¢ é–‹é—œè¨­å‚™ (FSC:114)', color: '#27ae60', count: 0, type: 'point' },
        'transformers': { name: 'ğŸ”µ è®Šå£“å™¨ (FSC:115)', color: '#3498db', count: 0, type: 'point' },
        'poles_116': { name: 'ğŸŸ¤ çµ‚ç«¯ (FSC:116)', color: '#8b4513', count: 0, type: 'point' },
        'grounding': { name: 'âš« é›»æ¡¿è¨­å‚™ (FSC:120)', color: '#2c3e50', count: 0, type: 'point' },
        'others_131': { name: 'ğŸŸ£ å…¶ä»–è¨­å‚™ (FSC:131)', color: '#8e44ad', count: 0, type: 'point' },
        'unknown': { name: 'ğŸ”˜ æœªçŸ¥è¨­å‚™', color: '#95a5a6', count: 0, type: 'point' },
        
        // ç·šæ®µé¡åˆ¥ - æ ¹æ“šé›»å£“ç­‰ç´šã€æ¶ç©ºåœ°ä¸‹ã€ä¸»å¹¹åˆ†æ­§å€éš”
        'line_22_8kv_main_overhead': { name: 'ğŸ”´ 22.8kV ä¸»å¹¹ç·š (æ¶ç©º)', color: '#dc3545', count: 0, type: 'line', style: 'solid' },
        'line_22_8kv_main_underground': { name: 'ğŸ”´ 22.8kV ä¸»å¹¹ç·š (åœ°ä¸‹)', color: '#dc3545', count: 0, type: 'line', style: 'dashed' },
        'line_22_8kv_branch_overhead': { name: 'ğŸ”µ 22.8kV åˆ†æ­§ç·š (æ¶ç©º)', color: '#007bff', count: 0, type: 'line', style: 'solid' },
        'line_22_8kv_branch_underground': { name: 'ğŸ”µ 22.8kV åˆ†æ­§ç·š (åœ°ä¸‹)', color: '#007bff', count: 0, type: 'line', style: 'dashed' },
        'line_11_4kv_main_overhead': { name: 'ğŸŸ  11.4kV ä¸»å¹¹ç·š (æ¶ç©º)', color: '#fd7e14', count: 0, type: 'line', style: 'solid' },
        'line_11_4kv_main_underground': { name: 'ğŸŸ  11.4kV ä¸»å¹¹ç·š (åœ°ä¸‹)', color: '#fd7e14', count: 0, type: 'line', style: 'dashed' },
        'line_11_4kv_branch_overhead': { name: 'ğŸŸ¢ 11.4kV åˆ†æ­§ç·š (æ¶ç©º)', color: '#28a745', count: 0, type: 'line', style: 'solid' },
        'line_11_4kv_branch_underground': { name: 'ğŸŸ¢ 11.4kV åˆ†æ­§ç·š (åœ°ä¸‹)', color: '#28a745', count: 0, type: 'line', style: 'dashed' },
        'line_other_overhead': { name: 'âš« å…¶ä»–ç·šè·¯ (æ¶ç©º)', color: '#6c757d', count: 0, type: 'line', style: 'solid' },
        'line_other_underground': { name: 'âš« å…¶ä»–ç·šè·¯ (åœ°ä¸‹)', color: '#6c757d', count: 0, type: 'line', style: 'dashed' }
    };
    
    // å®šç¾©ä¸é è¨­é¡¯ç¤ºçš„é¡åˆ¥
    const initiallyHiddenCategories = [
        'poles_106', 
        'grounding',
        'poles_116',
        'pole_markers',
        'transformers',
        'unknown',
        'others_131',
        'line_22_8kv_branch_overhead',
        'line_22_8kv_branch_underground', 
        'line_11_4kv_branch_overhead',
        'line_11_4kv_branch_underground'
    ];
    
    // çµ±è¨ˆé»è¨­å‚™æ•¸é‡ä¸¦å»ºç«‹åœ–å±¤ç¾¤çµ„
    allDevicesData.forEach(device => {
        const category = device.category;
        if (categories[category]) {
            categories[category].count++;
        }
        
        if (!layerGroups[category]) {
            layerGroups[category] = L.layerGroup();
            
            // åªæœ‰ä¸åœ¨éš±è—æ¸…å–®çš„æ‰åŠ å…¥åœ°åœ–
            if (!initiallyHiddenCategories.includes(category)) {
                layerGroups[category].addTo(map);
            }
        }
        
        const marker = createMarker(device, categories[category].color);
        layerGroups[category].addLayer(marker);
    });

    // çµ±è¨ˆç·šæ®µæ•¸é‡ä¸¦å»ºç«‹åœ–å±¤ç¾¤çµ„
    allLinesData.forEach(line => {
        const category = line.category;
        if (categories[category]) {
            categories[category].count++;
        }
        
        if (!layerGroups[category]) {
            layerGroups[category] = L.layerGroup();
            
            if (!initiallyHiddenCategories.includes(category)) {
                layerGroups[category].addTo(map);
            }
        }
        
        const polyline = createPolylineAdvanced(line, categories[category]);
        layerGroups[category].addLayer(polyline);
        
        if (!initiallyHiddenCategories.includes(category)) {
            if (polyline.arrowMarkers && Array.isArray(polyline.arrowMarkers)) {
                polyline.arrowMarkers.forEach(marker => {
                    arrowLayerGroup.addLayer(marker);
                });
            }
        }
    });
    
    // æ›´æ–°åœ–å±¤è¨ˆæ•¸
    layerCounts = Object.keys(categories).reduce((acc, key) => {
        acc[key] = categories[key].count;
        return acc;
    }, {});
    
    // å»ºç«‹æ§åˆ¶ä»‹é¢
    const container = document.getElementById('layerControlsContainer');
    container.innerHTML = '';
    
    // ğŸ†• æ–°å¢å…¨é¸æ§åˆ¶å€åŸŸ
    const selectAllContainer = document.createElement('div');
    selectAllContainer.className = 'select-all-container';
	selectAllContainer.innerHTML = `
		<div class="select-all-section">
			<h4>ğŸ”§ æ‰¹æ¬¡æ§åˆ¶</h4>
			<div class="select-all-buttons">
				<button class="select-all-btn equipment" id="equipmentToggleBtn" onclick="toggleAllEquipment()">
					ğŸ“ å…¨é¸è¨­å‚™
				</button>
				<button class="select-all-btn lines" id="linesToggleBtn" onclick="toggleAllLines()">
					âš¡ å…¨é¸ç·šè·¯
				</button>
				<button class="select-all-btn deselect" onclick="deselectAll()">
					âŒ å…¨éƒ¨å–æ¶ˆ
				</button>
			</div>
		</div>
		<hr class="divider">
	`;
    container.appendChild(selectAllContainer);
    
    // å…ˆé¡¯ç¤ºé»è¨­å‚™
    const pointCategories = Object.keys(categories).filter(key => 
        categories[key].type === 'point' && categories[key].count > 0
    );
    if (pointCategories.length > 0) {
        const pointHeader = document.createElement('h4');
        pointHeader.textContent = 'ğŸ“ é»è¨­å‚™';
        pointHeader.style.cssText = 'margin: 10px 0 5px 0; font-size: 14px; color: #2c3e50; border-bottom: 1px solid #ecf0f1; padding-bottom: 3px;';
        container.appendChild(pointHeader);
        
        pointCategories.forEach(categoryKey => {
            const category = categories[categoryKey];
            const layerItem = createLayerControlItem(categoryKey, category);
            container.appendChild(layerItem);
        });
    }
    
    // å†é¡¯ç¤ºç·šæ®µ
    const lineCategories = Object.keys(categories).filter(key => 
        categories[key].type === 'line' && categories[key].count > 0
    );
    if (lineCategories.length > 0) {
        const lineHeader = document.createElement('h4');
        lineHeader.textContent = 'ğŸ“ ç·šæ®µ';
        lineHeader.style.cssText = 'margin: 15px 0 5px 0; font-size: 14px; color: #2c3e50; border-bottom: 1px solid #ecf0f1; padding-bottom: 3px;';
        container.appendChild(lineHeader);
        
        lineCategories.forEach(categoryKey => {
            const category = categories[categoryKey];
            const layerItem = createLayerControlItem(categoryKey, category);
            container.appendChild(layerItem);
        });
    }
    
    // é¡¯ç¤ºçµ±è¨ˆæ‘˜è¦
    const totalPoints = pointCategories.reduce((sum, key) => sum + categories[key].count, 0);
    const totalLines = lineCategories.reduce((sum, key) => sum + categories[key].count, 0);
    
    const summaryDiv = document.createElement('div');
    summaryDiv.style.cssText = 'margin-top: 15px; padding: 8px; background: #f8f9fa; border-radius: 4px; font-size: 12px; color: #6c757d;';
    summaryDiv.innerHTML = `
        <strong>ğŸ“Š è³‡æ–™çµ±è¨ˆ</strong><br>
        é»è¨­å‚™: ${totalPoints} å€‹<br>
        ç·šæ®µ: ${totalLines} æ¢
    `;
    container.appendChild(summaryDiv);
}
			  
		// å»ºç«‹åœ–å±¤æ§åˆ¶é …ç›® - ä¿®æ”¹ç‰ˆ
		function createLayerControlItem(categoryKey, category) {
			// ğŸ”§ ä¿®æ”¹ï¼šæ“´å±•é è¨­éš±è—æ¸…å–®ï¼ŒåŒ…å«æ‰€æœ‰åˆ†æ­§ç·šæ®µ
			const initiallyHiddenCategories = [
				'poles_106', 
				'grounding',
				'poles_116',
				'pole_markers',
				'transformers',
				'unknown',
				'others_131',
				'line_22_8kv_branch_overhead',
				'line_22_8kv_branch_underground', 
				'line_11_4kv_branch_overhead',
				'line_11_4kv_branch_underground'
			];
			
			const isChecked = !initiallyHiddenCategories.includes(categoryKey);
			
			const layerItem = document.createElement('div');
			layerItem.className = 'layer-item';
			
			layerItem.innerHTML = `
				<input type="checkbox" id="layer_${categoryKey}" ${isChecked ? 'checked' : ''} onchange="toggleLayer('${categoryKey}')">
				<label for="layer_${categoryKey}">${category.name}</label>
				<span class="layer-count">${category.count}</span>
			`;
			
			return layerItem;
		}
		// ğŸ†• åˆ‡æ›è¨­å‚™é¡¯ç¤ºåŠŸèƒ½
function toggleAllEquipment() {
    const equipmentCategories = [
        'poles_106', 'cable_heads', 'pole_markers', 'solar', 
        'switches', 'transformers', 'poles_116', 'grounding', 
        'others_131', 'unknown'
    ];
    
    const btn = document.getElementById('equipmentToggleBtn');
    const isActive = btn.classList.contains('active');
    
    if (isActive) {
        // ç›®å‰æ˜¯å•Ÿç”¨ç‹€æ…‹ï¼ŒåŸ·è¡Œé—œé–‰
        equipmentCategories.forEach(category => {
            const checkbox = document.getElementById(`layer_${category}`);
            const layerGroup = layerGroups[category];
            
            if (checkbox && layerGroup && checkbox.checked) {
                checkbox.checked = false;
                map.removeLayer(layerGroup);
            }
        });
        
        // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
        btn.classList.remove('active');
        btn.innerHTML = 'ğŸ“ å…¨é¸è¨­å‚™';
        console.log('ğŸ“ å·²éš±è—æ‰€æœ‰è¨­å‚™åœ–å±¤');
        
    } else {
        // ç›®å‰æ˜¯é—œé–‰ç‹€æ…‹ï¼ŒåŸ·è¡Œé–‹å•Ÿ
        equipmentCategories.forEach(category => {
            const checkbox = document.getElementById(`layer_${category}`);
            const layerGroup = layerGroups[category];
            
            if (checkbox && layerGroup && !checkbox.checked) {
                checkbox.checked = true;
                map.addLayer(layerGroup);
            }
        });
        
        // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
        btn.classList.add('active');
        btn.innerHTML = 'ğŸ“ éš±è—è¨­å‚™';
        console.log('ğŸ“ å·²é¡¯ç¤ºæ‰€æœ‰è¨­å‚™åœ–å±¤');
    }
}

// ğŸ†• åˆ‡æ›ç·šè·¯é¡¯ç¤ºåŠŸèƒ½
function toggleAllLines() {
    const lineCategories = [
        'line_22_8kv_main_overhead', 'line_22_8kv_main_underground',
        'line_22_8kv_branch_overhead', 'line_22_8kv_branch_underground',
        'line_11_4kv_main_overhead', 'line_11_4kv_main_underground',
        'line_11_4kv_branch_overhead', 'line_11_4kv_branch_underground',
        'line_other_overhead', 'line_other_underground'
    ];
    
    const btn = document.getElementById('linesToggleBtn');
    const isActive = btn.classList.contains('active');
    
    if (isActive) {
        // ç›®å‰æ˜¯å•Ÿç”¨ç‹€æ…‹ï¼ŒåŸ·è¡Œé—œé–‰
        lineCategories.forEach(category => {
            const checkbox = document.getElementById(`layer_${category}`);
            const layerGroup = layerGroups[category];
            
            if (checkbox && layerGroup && checkbox.checked) {
                checkbox.checked = false;
                map.removeLayer(layerGroup);
                
                // éš±è—è©²åœ–å±¤çš„ç®­é ­
                layerGroup.eachLayer(layer => {
                    if (layer.arrowMarkers && Array.isArray(layer.arrowMarkers)) {
                        layer.arrowMarkers.forEach(marker => {
                            arrowLayerGroup.removeLayer(marker);
                        });
                    }
                });
            }
        });
        
        // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
        btn.classList.remove('active');
        btn.innerHTML = 'âš¡ å…¨é¸ç·šè·¯';
        console.log('âš¡ å·²éš±è—æ‰€æœ‰ç·šè·¯åœ–å±¤');
        
    } else {
        // ç›®å‰æ˜¯é—œé–‰ç‹€æ…‹ï¼ŒåŸ·è¡Œé–‹å•Ÿ
        lineCategories.forEach(category => {
            const checkbox = document.getElementById(`layer_${category}`);
            const layerGroup = layerGroups[category];
            
            if (checkbox && layerGroup && !checkbox.checked) {
                checkbox.checked = true;
                map.addLayer(layerGroup);
                
                // é¡¯ç¤ºè©²åœ–å±¤çš„ç®­é ­
                layerGroup.eachLayer(layer => {
                    if (layer.arrowMarkers && Array.isArray(layer.arrowMarkers)) {
                        layer.arrowMarkers.forEach(marker => {
                            arrowLayerGroup.addLayer(marker);
                        });
                    }
                });
            }
        });
        
        // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
        btn.classList.add('active');
        btn.innerHTML = 'âš¡ éš±è—ç·šè·¯';
        console.log('âš¡ å·²é¡¯ç¤ºæ‰€æœ‰ç·šè·¯åœ–å±¤');
    }
}

		// ğŸ†• å…¨é¸è¨­å‚™åŠŸèƒ½
function selectAllEquipment() {
    const equipmentCategories = [
        'poles_106', 'cable_heads', 'pole_markers', 'solar', 
        'switches', 'transformers', 'poles_116', 'grounding', 
        'others_131', 'unknown'
    ];
    
    equipmentCategories.forEach(category => {
        const checkbox = document.getElementById(`layer_${category}`);
        const layerGroup = layerGroups[category];
        
        if (checkbox && layerGroup && !checkbox.checked) {
            checkbox.checked = true;
            map.addLayer(layerGroup);
        }
    });
    
    console.log('ğŸ“ å·²å…¨é¸æ‰€æœ‰è¨­å‚™åœ–å±¤');
}

// ğŸ†• å…¨é¸ç·šè·¯åŠŸèƒ½
function selectAllLines() {
    const lineCategories = [
        'line_22_8kv_main_overhead', 'line_22_8kv_main_underground',
        'line_22_8kv_branch_overhead', 'line_22_8kv_branch_underground',
        'line_11_4kv_main_overhead', 'line_11_4kv_main_underground',
        'line_11_4kv_branch_overhead', 'line_11_4kv_branch_underground',
        'line_other_overhead', 'line_other_underground'
    ];
    
    lineCategories.forEach(category => {
        const checkbox = document.getElementById(`layer_${category}`);
        const layerGroup = layerGroups[category];
        
        if (checkbox && layerGroup && !checkbox.checked) {
            checkbox.checked = true;
            map.addLayer(layerGroup);
            
            // é¡¯ç¤ºè©²åœ–å±¤çš„ç®­é ­
            layerGroup.eachLayer(layer => {
                if (layer.arrowMarkers && Array.isArray(layer.arrowMarkers)) {
                    layer.arrowMarkers.forEach(marker => {
                        arrowLayerGroup.addLayer(marker);
                    });
                }
            });
        }
    });
    
    console.log('âš¡ å·²å…¨é¸æ‰€æœ‰ç·šè·¯åœ–å±¤');
}

// ğŸ”§ ä¿®æ”¹å…¨éƒ¨å–æ¶ˆåŠŸèƒ½ï¼ˆåŒæ™‚é‡ç½®æŒ‰éˆ•ç‹€æ…‹ï¼‰
function deselectAll() {
    Object.keys(layerGroups).forEach(category => {
        const checkbox = document.getElementById(`layer_${category}`);
        const layerGroup = layerGroups[category];
        
        if (checkbox && layerGroup && checkbox.checked) {
            checkbox.checked = false;
            map.removeLayer(layerGroup);
            
            // éš±è—è©²åœ–å±¤çš„ç®­é ­
            layerGroup.eachLayer(layer => {
                if (layer.arrowMarkers && Array.isArray(layer.arrowMarkers)) {
                    layer.arrowMarkers.forEach(marker => {
                        arrowLayerGroup.removeLayer(marker);
                    });
                }
            });
        }
    });
    
    // ğŸ†• é‡ç½®æŒ‰éˆ•ç‹€æ…‹
    const equipmentBtn = document.getElementById('equipmentToggleBtn');
    const linesBtn = document.getElementById('linesToggleBtn');
    
    if (equipmentBtn) {
        equipmentBtn.classList.remove('active');
        equipmentBtn.innerHTML = 'ğŸ“ å…¨é¸è¨­å‚™';
    }
    
    if (linesBtn) {
        linesBtn.classList.remove('active');
        linesBtn.innerHTML = 'âš¡ å…¨é¸ç·šè·¯';
    }
    
    console.log('âŒ å·²å–æ¶ˆæ‰€æœ‰åœ–å±¤ä¸¦é‡ç½®æŒ‰éˆ•ç‹€æ…‹');
}
			  
			  // å»ºç«‹é€²éšç·šæ®µ - æ”¯æ´å¯¦ç·šè™›ç·šå€éš” + é»é¸é«˜äº®
	// å»ºç«‹é€²éšç·šæ®µ - æ”¯æ´å¯¦ç·šè™›ç·šå€éš” + é»é¸é«˜äº® + ç®­é ­æ–¹å‘
	function createPolylineAdvanced(lineData, categoryInfo) {
		const coordinates = lineData.coordinates;
		const props = lineData.properties;
		
		// å»ºç«‹ç·šæ®µæ¨£å¼
		const lineStyle = {
			color: categoryInfo.color,
			weight: 4,
			opacity: 0.8,
			smoothFactor: 1
		};
		
		// æ ¹æ“šæ¨£å¼è¨­å®šå¯¦ç·šæˆ–è™›ç·š
		if (categoryInfo.style === 'dashed') {
			lineStyle.dashArray = '8,8';  // åœ°ä¸‹ç·šè·¯ç”¨è™›ç·š
		} else {
			lineStyle.dashArray = null;     // æ¶ç©ºç·šè·¯ç”¨å¯¦ç·š
		}
		
		const polyline = L.polyline(coordinates, lineStyle);
		
		// å„²å­˜åŸå§‹æ¨£å¼
		polyline.originalStyle = { ...lineStyle };
		
		// ğŸ”§ æ–°å¢ï¼šæ·»åŠ ç®­é ­æ¨™è¨˜
		const arrowMarkers = addArrowsToPolyline(polyline, categoryInfo.color);
		
		// åŠ å…¥é»é¸äº‹ä»¶ - é«˜äº®åŠŸèƒ½
		polyline.on('click', function(e) {
			// é‡ç½®ä¹‹å‰é¸ä¸­çš„ç·šæ®µ
			if (selectedLine && selectedLine !== polyline) {
				selectedLine.setStyle(selectedLine.originalStyle);
				// é‡ç½®ä¹‹å‰ç·šæ®µçš„ç®­é ­é¡è‰²
				if (selectedLine.arrowMarkers) {
					selectedLine.arrowMarkers.forEach(marker => {
						updateArrowColor(marker, selectedLine.originalStyle.color);
					});
				}
			}
			
			// è¨­å®šæ–°çš„é¸ä¸­ç·šæ®µ
			selectedLine = polyline;
			
			// æ‡‰ç”¨é«˜äº®æ¨£å¼
			const highlightStyle = {
				color: '#ffff00',  // é»ƒè‰²é«˜äº®
				weight: 6,
				opacity: 1.0,
				dashArray: lineStyle.dashArray  // ä¿æŒåŸæœ‰çš„å¯¦ç·š/è™›ç·šæ¨£å¼
			};
			
			polyline.setStyle(highlightStyle);
			
			// é«˜äº®ç®­é ­
			if (arrowMarkers) {
				arrowMarkers.forEach(marker => {
					updateArrowColor(marker, '#ffff00');
				});
			}
			
			// é˜»æ­¢äº‹ä»¶å†’æ³¡
			L.DomEvent.stopPropagation(e);
			
			console.log('ğŸ¯ ç·šæ®µå·²é«˜äº®:', props.FromID, '->', props.ToID);
		});
		
		// æ»‘é¼ ç§»å…¥æ•ˆæœ
		polyline.on('mouseover', function() {
			if (selectedLine !== polyline) {
				const hoverStyle = {
					...lineStyle,
					weight: lineStyle.weight + 1,
					opacity: 1.0
				};
				polyline.setStyle(hoverStyle);
			}
		});
		
		// æ»‘é¼ ç§»å‡ºæ•ˆæœ
		polyline.on('mouseout', function() {
			if (selectedLine !== polyline) {
				polyline.setStyle(lineStyle);
			}
		});
		
		// å„²å­˜ç®­é ­æ¨™è¨˜åƒè€ƒ
		polyline.arrowMarkers = arrowMarkers;
		
		// å»ºç«‹å½ˆå‡ºè¦–çª—å…§å®¹ï¼ˆä¿æŒåŸæœ‰åŠŸèƒ½ï¼‰
		let popupContent = '<div style="max-width: 320px; font-size: 13px;">';
		popupContent += `<h4 style="margin: 0 0 10px 0; color: ${categoryInfo.color}; font-size: 14px;">ğŸ”— ${categoryInfo.name}</h4>`;
		
		// é¡¯ç¤ºä¸»è¦å±¬æ€§
		const importantProps = [
			{ key: 'FromID', label: 'èµ·é»è¨­å‚™ID' },
			{ key: 'ToID', label: 'çµ‚é»è¨­å‚™ID' },
			{ key: 'FromLoop', label: 'èµ·é»è¿´è·¯' },
			{ key: 'ToLoop', label: 'çµ‚é»è¿´è·¯' },
			{ key: 'CabType', label: 'ç·šè·¯é¡å‹' },
			{ key: 'OHUG', label: 'æ¶è¨­æ–¹å¼' },
			{ key: 'Visible', label: 'å¯è¦‹æ€§' }
		];
		
		importantProps.forEach(prop => {
			if (props[prop.key] !== undefined && props[prop.key] !== '') {
				let value = props[prop.key];
				
				// ç‰¹æ®Šå€¼è½‰æ›
				if (prop.key === 'CabType') {
					if (value === '0' || value === 0) {
						value = 'ä¸»å¹¹ç·š';
					} else if (value === '1' || value === 1) {
						value = 'åˆ†æ­§ç·š';
					}
				} else if (prop.key === 'OHUG') {
					if (value === '0' || value === 0) {
						value = 'æ¶ç©º';
					} else if (value === '1' || value === 1) {
						value = 'åœ°ä¸‹';
					}
				} else if (prop.key === 'Visible') {
					value = value ? 'æ˜¯' : 'å¦';
				}
				
				popupContent += `<p style="margin: 3px 0;"><strong>${prop.label}:</strong> ${value}</p>`;
			}
		});
		
		// é¡¯ç¤ºç·šæ®µçµ±è¨ˆ
		const lineLength = calculateLineLength(coordinates);
		const pointCount = coordinates.length;
		
		popupContent += '<hr style="margin: 8px 0; border: none; border-top: 1px solid #eee;">';
		popupContent += `<p style="margin: 3px 0;"><strong>ğŸ“ åº§æ¨™é»æ•¸:</strong> ${pointCount}</p>`;
		popupContent += `<p style="margin: 3px 0;"><strong>ğŸ“ è¨ˆç®—é•·åº¦:</strong> ${lineLength.toFixed(2)} å…¬å°º</p>`;
		popupContent += `<p style="margin: 3px 0;"><strong>â¡ï¸ é›»æµæ–¹å‘:</strong> ${props.FromID} â†’ ${props.ToID}</p>`;
		
		// é¡¯ç¤ºèµ·çµ‚é»åº§æ¨™
		if (coordinates.length > 0) {
			const startPoint = coordinates[0];
			const endPoint = coordinates[coordinates.length - 1];
			popupContent += `<p style="margin: 3px 0; font-size: 11px; color: #666;"><strong>èµ·é»:</strong> ${startPoint[0].toFixed(6)}, ${startPoint[1].toFixed(6)}</p>`;
			popupContent += `<p style="margin: 3px 0; font-size: 11px; color: #666;"><strong>çµ‚é»:</strong> ${endPoint[0].toFixed(6)}, ${endPoint[1].toFixed(6)}</p>`;
		}
		
		popupContent += '<hr style="margin: 5px 0; border: none; border-top: 1px solid #eee;">';
		popupContent += '</div>';
		
		polyline.bindPopup(popupContent);
		
		return polyline;
	}
	// ç‚ºç·šæ®µæ·»åŠ ç®­é ­æ¨™è¨˜ - æ•ˆèƒ½å„ªåŒ–ç‰ˆ
	// ç‚ºç·šæ®µæ·»åŠ ç®­é ­æ¨™è¨˜ - ä¿®æ­£ç‰ˆï¼ˆä¸ç›´æ¥é¡¯ç¤ºï¼‰
	function addArrowsToPolyline(polyline, color) {
		const coordinates = polyline.getLatLngs();
		const arrowMarkers = [];
		
		// ğŸ”§ æ•ˆèƒ½å„ªåŒ–ï¼šæ ¹æ“šåœ°åœ–ç¸®æ”¾ç­‰ç´šèª¿æ•´å¯†åº¦
		const currentZoom = map.getZoom();
		let arrowInterval;
		
		if (currentZoom >= 16) {
			arrowInterval = 25;
		} else if (currentZoom >= 14) {
			arrowInterval = 50;
		} else {
			arrowInterval = 100;
		}
		
		const totalLength = calculatePolylineLength(coordinates);
		const maxArrows = 10;
		const calculatedInterval = Math.max(arrowInterval, totalLength / maxArrows);
		
		let currentDistance = 0;
		let nextArrowDistance = calculatedInterval / 2;
		let arrowCount = 0;
		
		for (let i = 1; i < coordinates.length && arrowCount < maxArrows; i++) {
			const segmentLength = coordinates[i-1].distanceTo(coordinates[i]);
			
			while (currentDistance + segmentLength >= nextArrowDistance && arrowCount < maxArrows) {
				const ratio = (nextArrowDistance - currentDistance) / segmentLength;
				const arrowPosition = interpolateLatLng(coordinates[i-1], coordinates[i], ratio);
				const bearing = calculateBearing(coordinates[i-1], coordinates[i]);
				
				const arrowMarker = createArrowMarkerOptimized(arrowPosition, bearing, color);
				arrowMarkers.push(arrowMarker);
				
				// ğŸ”§ ä¿®æ­£ï¼šä¸ç›´æ¥æ·»åŠ åˆ°åœ°åœ–ï¼Œåªå‰µå»ºç®­é ­ç‰©ä»¶
				// è®“ toggleLayer å‡½æ•¸ä¾†æ§åˆ¶æ˜¯å¦é¡¯ç¤º
				// arrowLayerGroup.addLayer(arrowMarker); // ç§»é™¤é€™è¡Œ
				
				nextArrowDistance += calculatedInterval;
				arrowCount++;
			}
			
			currentDistance += segmentLength;
		}
		
		return arrowMarkers;
	}
		// ğŸ”§ æ•ˆèƒ½å„ªåŒ–ç‰ˆç®­é ­å‰µå»º - æ”¾å¤§1.5å€
		function createArrowMarkerOptimized(position, bearing, color) {
			// ğŸ”§ ä¿®æ”¹ï¼šç®­é ­å°ºå¯¸æ”¾å¤§1.5å€ï¼ˆå¾ 3px/6px æ”¹ç‚º 4.5px/9pxï¼‰
			const arrowIcon = L.divIcon({
				html: `<div style="width:0;height:0;border-left:4.5px solid transparent;border-right:4.5px solid transparent;border-bottom:9px solid ${color};transform:rotate(${bearing}deg);"></div>`,
				className: 'arrow-icon',
				iconSize: [18, 18],        // ğŸ”§ å¾ [6, 6] æ”¹ç‚º [9, 9]
				iconAnchor: [9, 18]     // ğŸ”§ å¾ [3, 6] æ”¹ç‚º [4.5, 9]
			});
			
			// ğŸ”§ æ•ˆèƒ½å„ªåŒ–ï¼šç¦ç”¨ä¸å¿…è¦çš„äº’å‹•
			return L.marker(position, { 
				icon: arrowIcon,
				interactive: false  // ç¦ç”¨é»é¸äº‹ä»¶æå‡æ•ˆèƒ½
			});
		}
	// ğŸ”§ æ•ˆèƒ½å„ªåŒ–ç‰ˆç®­é ­å‰µå»º
	function createArrowMarkerOptimized(position, bearing, color) {
		// ç°¡åŒ–çš„ç®­é ­ HTML - æ¸›å°‘ DOM è¤‡é›œåº¦
		const arrowIcon = L.divIcon({
			html: `<div style="width:0;height:0;border-left:3px solid transparent;border-right:3px solid transparent;border-bottom:6px solid ${color};transform:rotate(${bearing}deg);"></div>`,
			className: 'arrow-icon',
			iconSize: [6, 6],
			iconAnchor: [3, 6]
		});
		
		// ğŸ”§ æ•ˆèƒ½å„ªåŒ–ï¼šç¦ç”¨ä¸å¿…è¦çš„äº’å‹•
		return L.marker(position, { 
			icon: arrowIcon,
			interactive: false  // ç¦ç”¨é»é¸äº‹ä»¶æå‡æ•ˆèƒ½
		});
	}
		 
	// è¨ˆç®—ç·šæ®µç¸½é•·åº¦ï¼ˆä½¿ç”¨ Leaflet çš„ distanceTo æ–¹æ³•ï¼‰
	function calculatePolylineLength(coordinates) {
		let totalLength = 0;
		for (let i = 1; i < coordinates.length; i++) {
			totalLength += coordinates[i-1].distanceTo(coordinates[i]);
		}
		return totalLength;
	}
			  
	// åœ¨å…©é»é–“æ’å€¼è¨ˆç®—ä½ç½®
	function interpolateLatLng(latlng1, latlng2, ratio) {
		const lat = latlng1.lat + (latlng2.lat - latlng1.lat) * ratio;
		const lng = latlng1.lng + (latlng2.lng - latlng1.lng) * ratio;
		return L.latLng(lat, lng);
	}

	// è¨ˆç®—å…©é»é–“çš„æ–¹ä½è§’
	function calculateBearing(latlng1, latlng2) {
		const lat1 = latlng1.lat * Math.PI / 180;
		const lat2 = latlng2.lat * Math.PI / 180;
		const deltaLng = (latlng2.lng - latlng1.lng) * Math.PI / 180;
		
		const x = Math.sin(deltaLng) * Math.cos(lat2);
		const y = Math.cos(lat1) * Math.sin(lat2) - Math.sin(lat1) * Math.cos(lat2) * Math.cos(deltaLng);
		
		const bearing = Math.atan2(x, y) * 180 / Math.PI;
		return (bearing + 360) % 360; // ç¢ºä¿çµæœç‚ºæ­£å€¼
	}

	// å‰µå»ºç®­é ­æ¨™è¨˜
	function createArrowMarker(position, bearing, color) {
		const arrowIcon = L.divIcon({
			html: `<div class="arrow-marker" style="border-bottom-color: ${color}; transform: rotate(${bearing}deg);"></div>`,
			className: 'arrow-icon',
			iconSize: [8, 8],
			iconAnchor: [4, 8]
		});
		
		return L.marker(position, { icon: arrowIcon });
	}

	// æ›´æ–°ç®­é ­é¡è‰²
	function updateArrowColor(marker, color) {
		const iconElement = marker.getElement();
		if (iconElement) {
			const arrowDiv = iconElement.querySelector('.arrow-marker');
			if (arrowDiv) {
				arrowDiv.style.borderBottomColor = color;
			}
		}
	}
			  
			 // è¨ˆç®—ç·šæ®µé•·åº¦ - æ–°å‡½æ•¸
				function calculateLineLength(coordinates) {
					if (!coordinates || coordinates.length < 2) return 0;
					
					let totalLength = 0;
					for (let i = 1; i < coordinates.length; i++) {
						const lat1 = coordinates[i-1][0];
						const lng1 = coordinates[i-1][1];
						const lat2 = coordinates[i][0];
						const lng2 = coordinates[i][1];
						
						// ä½¿ç”¨ Haversine å…¬å¼è¨ˆç®—å…©é»é–“è·é›¢
						const distance = getDistanceFromLatLonInM(lat1, lng1, lat2, lng2);
						totalLength += distance;
					}
					
					return totalLength;
				}
	// Haversine å…¬å¼è¨ˆç®—å…©é»é–“è·é›¢ï¼ˆå…¬å°ºï¼‰
	function getDistanceFromLatLonInM(lat1, lon1, lat2, lon2) {
		const R = 6371000; // åœ°çƒåŠå¾‘ï¼ˆå…¬å°ºï¼‰
		const dLat = deg2rad(lat2 - lat1);
		const dLon = deg2rad(lon2 - lon1);
		const a = 
			Math.sin(dLat/2) * Math.sin(dLat/2) +
			Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * 
			Math.sin(dLon/2) * Math.sin(dLon/2);
		const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
		const d = R * c;
		return d;
	}
			  
		  function deg2rad(deg) {
		return deg * (Math.PI/180);
	}
			 // å»ºç«‹æ¨™è¨˜å½ˆå‡ºè¦–çª—å…§å®¹ - ç§»é™¤å‹•ç•«æ•ˆæœ
	// å»ºç«‹æ¨™è¨˜å½ˆå‡ºè¦–çª—å…§å®¹ - æ•ˆèƒ½å„ªåŒ–ç‰ˆï¼ˆåŠ å…¥ Opposite æ˜Ÿæ˜Ÿæª¢æŸ¥ï¼‰
	function createMarker(deviceData, color) {
    const coords = deviceData.coordinates;
    const props = deviceData.properties;
    
    // ğŸŒŸ æª¢æŸ¥æ˜¯å¦æœ‰ Opposite åƒæ•¸ä¸” FSC æ˜¯ 114
    const hasOpposite = props.FSC === '114' && props.Opposite && props.Opposite.trim() !== '';
    
    // æ ¹æ“š FSC å»ºç«‹ç°¡åŒ–åœ–æ¨™ï¼ˆä¿ç•™ä½ çš„åŸå§‹è¨­è¨ˆï¼‰
    const iconConfig = getSimpleDeviceIcon(props);
    
    // æ ¹æ“š FSC å‹•æ…‹èª¿æ•´åœ–æ¨™å¤§å°
    let iconSize = [16, 16];
    let iconAnchor = [8, 8];

    if (props.FSC === '114') {
        iconSize = [24, 24];
        iconAnchor = [12, 12];
    }

    const customIcon = L.divIcon({
        html: iconConfig.html,
        className: 'simple-device-icon',
        iconSize: iconSize,
        iconAnchor: iconAnchor
    });
    
    const marker = L.marker([coords[1], coords[0]], { icon: customIcon });
    
    // ğŸŒŸ å¦‚æœæ˜¯ FSC 114 ä¸”æœ‰ Opposite åƒæ•¸ï¼Œå‰µå»ºç´…è‰²æ˜Ÿæ˜Ÿæ¨™è¨˜
    if (hasOpposite) {
        console.log(`â­ ç™¼ç¾ FSC 114 è¨­å‚™æœ‰ Opposite åƒæ•¸: ID=${props.ID}, Opposite=${props.Opposite}`);
        createOppositeStarMarker([coords[1], coords[0]], props.Opposite);
    }
    
    // ğŸ†• å»ºç«‹å¢å¼·ç‰ˆå½ˆå‡ºè¦–çª—å…§å®¹ï¼ˆçµåˆåŸå§‹å…§å®¹ + Google åŠŸèƒ½ï¼‰
    let popupContent = '<div style="max-width: 320px; font-size: 13px; font-family: Arial, sans-serif;">';
    
    // ğŸ¨ æ¨™é¡Œå€åŸŸï¼ˆä¿ç•™ä½ çš„åŸå§‹è¨­è¨ˆï¼‰
    popupContent += `<div style="background: linear-gradient(135deg, ${color}, ${adjustColor(color, -20)}); color: white; padding: 12px; margin: -10px -10px 15px -10px; border-radius: 8px 8px 0 0; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">`;
    popupContent += `<h3 style="margin: 0; font-size: 16px; font-weight: bold;">ğŸ—ï¸ ${getDeviceTypeName(props.FSC)}</h3>`;
    popupContent += `<div style="font-size: 12px; opacity: 0.9; margin-top: 4px;">è¨­å‚™ID: ${props.ID || 'N/A'}</div>`;
    popupContent += `</div>`;
    
    popupContent += `<div style="padding: 0 5px;">`;
    
    // ğŸŒŸ Opposite è³‡è¨Šé¡¯ç¤ºï¼ˆä¿ç•™ä½ çš„åŸå§‹è¨­è¨ˆï¼‰
    if (hasOpposite) {
        popupContent += `<div style="background: #ffebee; border: 1px solid #f44336; border-radius: 4px; padding: 8px; margin-bottom: 10px;">`;
        popupContent += `<p style="margin: 0; font-weight: bold; color: #c62828;"><span style="color: #ff0000;">â­</span> Opposite: ${props.Opposite}</p>`;
        popupContent += `</div>`;
    }
    
    // ğŸ“Š ä¸»è¦å±¬æ€§é¡¯ç¤ºï¼ˆä¿ç•™ä½ çš„åŸå§‹é‚è¼¯ï¼‰
    const importantProps = [
        { key: 'ID', label: 'è¨­å‚™ID' },
        { key: 'Tpclid', label: 'å°é›»ID' },
        { key: 'FSC', label: 'FSCä»£ç¢¼' },
        { key: 'Area', label: 'å€åŸŸ' },
        { key: 'Feeder', label: 'é¥‹ç·š' },
        { key: 'VLevel', label: 'é›»å£“ç­‰ç´š' },
        { key: 'Location', label: 'ä½ç½®' },
        { key: 'Spec', label: 'è¦æ ¼' },
        { key: 'Length', label: 'é•·åº¦' },
        { key: 'Type', label: 'é¡å‹' },
        { key: 'Phase1', label: 'ç›¸åˆ¥1' },
        { key: 'Phase2', label: 'ç›¸åˆ¥2' },
        { key: 'Phase3', label: 'ç›¸åˆ¥3' },
        { key: 'Capacity1', label: 'å®¹é‡1' },
        { key: 'Capacity2', label: 'å®¹é‡2' },
        { key: 'Capacity3', label: 'å®¹é‡3' },
        { key: 'SupplyType', label: 'ä¾›é›»å‹å¼' }
    ];
    
    // é¡¯ç¤ºé‡è¦å±¬æ€§ï¼ˆä¿ç•™ä½ çš„åŸå§‹è™•ç†é‚è¼¯ï¼‰
    const displayedProps = [];
    importantProps.forEach(prop => {
        if (props[prop.key] !== undefined && props[prop.key] !== '' && props[prop.key] !== '0.0') {
            let value = props[prop.key];
            
            // ç‰¹æ®Šå€¼è™•ç†ï¼ˆä¿ç•™ä½ çš„åŸå§‹é‚è¼¯ï¼‰
            if (prop.key === 'VLevel') {
                if (value === '1') value = '11.4kV';
                else if (value === '2') value = '22.8kV';
                else if (value === '3') value = 'ç‰¹é«˜å£“';
            } else if (prop.key.includes('Capacity') && value !== '0.0') {
                value += ' kVA';
            } else if (prop.key === 'Length' && value !== '0.0') {
                value += ' å…¬å°º';
            }
            
            displayedProps.push({ label: prop.label, value: value });
        }
    });
    
    // ç”¨ç¶²æ ¼é¡¯ç¤ºå±¬æ€§
    if (displayedProps.length > 0) {
        popupContent += `<div style="display: grid; grid-template-columns: auto 1fr; gap: 6px 12px; margin-bottom: 12px; font-size: 12px;">`;
        displayedProps.forEach(prop => {
            popupContent += `<strong>${prop.label}:</strong><span>${prop.value}</span>`;
        });
        popupContent += `</div>`;
    }
    
    // ğŸ“ åº§æ¨™é¡¯ç¤ºï¼ˆä¿ç•™ä½ çš„åŸå§‹æ ¼å¼ï¼‰
    popupContent += '<hr style="margin: 8px 0; border: none; border-top: 1px solid #eee;">';
    popupContent += `<p style="margin: 3px 0; font-size: 11px; color: #666;"><strong>ğŸ“ åº§æ¨™:</strong> ${coords[1].toFixed(6)}, ${coords[0].toFixed(6)}</p>`;
    
    // ğŸ”„ è¿´è·¯è³‡è¨Šé¡¯ç¤ºï¼ˆä¿ç•™ä½ çš„åŸå§‹é‚è¼¯ï¼‰
    if (props.SrcLoop || props.DestLoop) {
        popupContent += '<hr style="margin: 8px 0; border: none; border-top: 1px solid #eee;">';
        popupContent += '<p style="margin: 5px 0 3px 0; font-weight: bold; color: #2c3e50;">ğŸ”„ è¿´è·¯è³‡è¨Š:</p>';
        
        if (props.SrcLoop && props.SrcLoop.Loop) {
            popupContent += `<p style="margin: 2px 0; font-size: 12px;">ä¾†æº: ${props.SrcLoop.Loop} (${props.SrcLoop.Name || ''})</p>`;
        }
        
        if (props.DestLoop && Array.isArray(props.DestLoop)) {
            props.DestLoop.forEach((dest, index) => {
                if (dest.Loop) {
                    popupContent += `<p style="margin: 2px 0; font-size: 12px;">ç›®æ¨™${index + 1}: ${dest.Loop} (${dest.Name || ''})</p>`;
                }
            });
        }
    }
    
  // ğŸ†• Google æœå‹™æŒ‰éˆ•å€åŸŸ + ç½æƒ…æŸ¥å ±
		const lat = coords[1];
		const lng = coords[0];
		const deviceName = props.Name || props.ID || 'è¨­å‚™ä½ç½®';

		popupContent += '<hr style="margin: 8px 0; border: none; border-top: 1px solid #eee;">';
		popupContent += `<div style="margin-top: 12px;">`;

		// ç¬¬ä¸€æ’ï¼šè¡—æ™¯åœ–å’Œå°èˆªæŒ‰éˆ•
		popupContent += `<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px;">`;

		// è¡—æ™¯åœ–æŒ‰éˆ•
		popupContent += `<button onclick="openStreetView(${lat}, ${lng})" 
								style="background: linear-gradient(135deg, #4285f4, #34a853); 
									   color: white; border: none; padding: 8px 6px; 
									   border-radius: 6px; cursor: pointer; font-size: 11px; 
									   font-weight: bold; transition: all 0.2s;
									   box-shadow: 0 2px 4px rgba(66, 133, 244, 0.3);"
								onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 8px rgba(66, 133, 244, 0.4)';"
								onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(66, 133, 244, 0.3)';">
							ğŸ—ºï¸ è¡—æ™¯åœ–
						</button>`;

		// å°èˆªæŒ‰éˆ•
		popupContent += `<button onclick="openNavigation(${lat}, ${lng}, '${encodeURIComponent(deviceName)}')" 
								style="background: linear-gradient(135deg, #ea4335, #fbbc04); 
									   color: white; border: none; padding: 8px 6px; 
									   border-radius: 6px; cursor: pointer; font-size: 11px; 
									   font-weight: bold; transition: all 0.2s;
									   box-shadow: 0 2px 4px rgba(234, 67, 53, 0.3);"
								onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 8px rgba(234, 67, 53, 0.4)';"
								onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(234, 67, 53, 0.3)';">
							ğŸ§­ å°èˆª
						</button>`;

		popupContent += `</div>`;

		// ç¬¬äºŒæ’ï¼šç½æƒ…æŸ¥å ±æŒ‰éˆ•ï¼ˆå…¨å¯¬ï¼‰- å‚³éè¨­å‚™è³‡è¨Šï¼ˆä½¿ç”¨ Tpclid ä½œç‚ºå°é›»IDï¼‰
		const deviceInfo = {
			tpcId: props.Tpclid || '', // ğŸ”¥ é‡é»ï¼šä½¿ç”¨ Tpclid ä½œç‚ºå°é›»ID
			deviceId: props.ID || props.Name || '', // è¨­å‚™IDå¦å¤–ä¿å­˜
			feederCode: props.FeederCode || props.Feeder || '',
			deviceType: props.Type || props.DeviceType || '',
			voltage: props.Voltage || props.KV || ''
		};

		popupContent += `<button onclick="openDisasterReportSystem(${lat}, ${lng}, '${encodeURIComponent(deviceName)}', ${JSON.stringify(deviceInfo).replace(/"/g, '&quot;')})" 
								style="width: 100%; background: linear-gradient(135deg, #dc3545, #c82333); 
									   color: white; border: none; padding: 10px 12px; 
									   border-radius: 8px; cursor: pointer; font-size: 13px; 
									   font-weight: bold; transition: all 0.3s ease;
									   box-shadow: 0 3px 6px rgba(220, 53, 69, 0.3);
									   margin-bottom: 8px;"
								onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 5px 10px rgba(220, 53, 69, 0.4)';"
								onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 3px 6px rgba(220, 53, 69, 0.3)';">
							ğŸš¨ ç½æƒ…æŸ¥å ±
						</button>`;

		// è¤‡è£½åº§æ¨™æŒ‰éˆ•
		popupContent += `<button onclick="copyCoordinates(${lat}, ${lng})" 
								style="width: 100%; background: #6c757d; 
									   color: white; border: none; padding: 6px; 
									   border-radius: 4px; cursor: pointer; font-size: 10px;
									   transition: all 0.2s;"
								onmouseover="this.style.background='#5a6268';"
								onmouseout="this.style.background='#6c757d';">
							ğŸ“‹ è¤‡è£½åº§æ¨™
						</button>`;

		popupContent += `</div>`;
    popupContent += `</div>`;
    popupContent += '</div>';
    
    marker.bindPopup(popupContent, {
        maxWidth: 350,
        className: 'custom-popup'
    });
    
    return marker;
}
// ğŸ†• é–‹å•Ÿ Google è¡—æ™¯åœ–
function openStreetView(lat, lng) {
    const streetViewUrl = `https://www.google.com/maps/@?api=1&map_action=pano&viewpoint=${lat},${lng}`;
    window.open(streetViewUrl, '_blank');
    console.log(`ğŸ—ºï¸ é–‹å•Ÿè¡—æ™¯åœ–: ${lat}, ${lng}`);
}

// ğŸ†• é–‹å•Ÿ Google å°èˆª
function openNavigation(lat, lng, name) {
    // å˜—è©¦å¤šç¨®å°èˆªæ–¹å¼ï¼Œå„ªå…ˆä½¿ç”¨ Google Maps
    const googleMapsUrl = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}&destination_place_id=${encodeURIComponent(name)}`;
    
    // æª¢æ¸¬æ˜¯å¦ç‚ºè¡Œå‹•è£ç½®
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    
    if (isMobile) {
        // è¡Œå‹•è£ç½®å„ªå…ˆå˜—è©¦é–‹å•Ÿ Google Maps App
        const appUrl = `google.navigation:q=${lat},${lng}`;
        const fallbackUrl = googleMapsUrl;
        
        // å˜—è©¦é–‹å•Ÿ Appï¼Œå¤±æ•—å‰‡é–‹å•Ÿç¶²é ç‰ˆ
        const iframe = document.createElement('iframe');
        iframe.style.display = 'none';
        iframe.src = appUrl;
        document.body.appendChild(iframe);
        
        setTimeout(() => {
            document.body.removeChild(iframe);
            window.open(fallbackUrl, '_blank');
        }, 1000);
    } else {
        // æ¡Œé¢ç‰ˆç›´æ¥é–‹å•Ÿç¶²é ç‰ˆ Google Maps
        window.open(googleMapsUrl, '_blank');
    }
    
    console.log(`ğŸ§­ é–‹å•Ÿå°èˆªè‡³: ${name} (${lat}, ${lng})`);
}

// ğŸ†• è¤‡è£½åº§æ¨™åˆ°å‰ªè²¼ç°¿
function copyCoordinates(lat, lng) {
    const coordinates = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
    
    if (navigator.clipboard && window.isSecureContext) {
        // ç¾ä»£ç€è¦½å™¨çš„å‰ªè²¼ç°¿ API
        navigator.clipboard.writeText(coordinates).then(() => {
            showToast(`ğŸ“‹ åº§æ¨™å·²è¤‡è£½: ${coordinates}`, 'success');
        }).catch(err => {
            console.error('è¤‡è£½å¤±æ•—:', err);
            fallbackCopyText(coordinates);
        });
    } else {
        // èˆŠç‰ˆç€è¦½å™¨çš„å‚™ç”¨æ–¹æ³•
        fallbackCopyText(coordinates);
    }
}

// ğŸ†• å‚™ç”¨è¤‡è£½æ–¹æ³•
function fallbackCopyText(text) {
    const textArea = document.createElement('textarea');
    textArea.value = text;
    textArea.style.position = 'fixed';
    textArea.style.left = '-999999px';
    textArea.style.top = '-999999px';
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    
    try {
        document.execCommand('copy');
        showToast(`ğŸ“‹ åº§æ¨™å·²è¤‡è£½: ${text}`, 'success');
    } catch (err) {
        console.error('è¤‡è£½å¤±æ•—:', err);
        showToast('âŒ è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½', 'error');
    }
    
    document.body.removeChild(textArea);
}

// ğŸ†• é¡¯ç¤ºè¼‰å…¥æç¤ºè¨Šæ¯
function showToast(message, type = 'info') {
  // å‰µå»ºæç¤ºå…ƒç´ 
  const toast = document.createElement('div');
  toast.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 10000;
      padding: 12px 20px;
      border-radius: 6px;
      color: white;
      font-weight: bold;
      font-size: 14px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      transition: all 0.3s ease;
      max-width: 300px;
  `;
  
  // æ ¹æ“šé¡å‹è¨­å®šé¡è‰²
  switch(type) {
      case 'success':
          toast.style.background = '#28a745';
          break;
      case 'error':
          toast.style.background = '#dc3545';
          break;
      case 'warning':
          toast.style.background = '#ffc107';
          toast.style.color = '#000';
          break;
      default:
          toast.style.background = '#17a2b8';
  }
  
  toast.textContent = message;
  document.body.appendChild(toast);
  
  // 3ç§’å¾Œè‡ªå‹•ç§»é™¤
  setTimeout(() => {
      toast.style.opacity = '0';
      toast.style.transform = 'translateX(100%)';
      setTimeout(() => {
          if (toast.parentNode) {
              toast.parentNode.removeChild(toast);
          }
      }, 300);
  }, 3000);
}

// ğŸ†• é¡è‰²èª¿æ•´è¼”åŠ©å‡½æ•¸
function adjustColor(color, percent) {
    const num = parseInt(color.replace("#", ""), 16);
    const amt = Math.round(2.55 * percent);
    const R = (num >> 16) + amt;
    const G = (num >> 8 & 0x00FF) + amt;
    const B = (num & 0x0000FF) + amt;
    
    return "#" + (0x1000000 + (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 +
        (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 +
        (B < 255 ? B < 1 ? 0 : B : 255)).toString(16).slice(1);
}

// ğŸŒŸ ä¿®æ”¹ï¼šå‰µå»º Opposite ç´…è‰²æ˜Ÿæ˜Ÿæ¨™è¨˜ - åŠ å…¥è¼‰å…¥é¥‹ç·šæŒ‰éˆ•
function createOppositeStarMarker(position, oppositeText) {
    console.log(`â­ å‰µå»º Opposite ç´…è‰²æ˜Ÿæ˜Ÿæ¨™è¨˜: ${oppositeText} at`, position);
    
    const starIcon = L.divIcon({
        html: `
            <div class="opposite-star-marker">
                <div class="star-icon">â­</div>
                <div class="opposite-text">${oppositeText}</div>
            </div>
        `,
        className: 'opposite-star-icon',
        iconSize: [60, 25],   
        iconAnchor: [8, 35]
    });
    
    const starMarker = L.marker(position, { 
        icon: starIcon,
        zIndexOffset: 1000
    });
    
    // åŠ å…¥åˆ°æ˜Ÿæ˜Ÿåœ–å±¤ç¾¤çµ„
    oppositeLayerGroup.addLayer(starMarker);
    
    // åŠ å…¥åˆ°å…¨åŸŸæ˜Ÿæ˜Ÿé™£åˆ—
    oppositeStarMarkers.push(starMarker);
    
    // ğŸ”§ ä¿®æ”¹ï¼šåŠ å…¥è¼‰å…¥é¥‹ç·šæŒ‰éˆ•çš„é»é¸äº‹ä»¶
    starMarker.on('click', function(e) {
        const popup = L.popup()
            .setLatLng(position)
            .setContent(createOppositePopupContent(oppositeText, position))
            .openOn(map);
        
        // é˜»æ­¢äº‹ä»¶å†’æ³¡
        L.DomEvent.stopPropagation(e);
    });
    
    return starMarker;
}

// ğŸ†• æ–°å¢ï¼šå‰µå»º Opposite å½ˆå‡ºè¦–çª—å…§å®¹
function createOppositePopupContent(oppositeText, position) {
    // ğŸ”§ æª¢æŸ¥ oppositeText æ˜¯å¦ç‚ºæœ‰æ•ˆçš„é¥‹ç·šåç¨±
    const isValidFeeder = checkIfValidFeeder(oppositeText);
    
    return `
        <div style="text-align: center; padding: 8px; min-width: 200px;">
            <h4 style="margin: 0 0 8px 0; color: #ff0000;">â­ Opposite æ¨™è¨˜</h4>
            <div style="background: #fff3cd; padding: 8px; border-radius: 4px; margin: 8px 0;">
                <p style="margin: 0; font-weight: bold; color: #c62828; font-size: 14px;">${oppositeText}</p>
            </div>
            <p style="margin: 5px 0; font-size: 11px; color: #666;">FSC 114 é–‹é—œè¨­å‚™</p>
            
            <!-- ğŸ†• æ“ä½œæŒ‰éˆ•å€åŸŸ -->
            <div style="margin-top: 12px; display: flex; flex-direction: column; gap: 6px;">
                ${isValidFeeder ? `
                    <button onclick="loadOppositeFeeder('${oppositeText}')" 
                            style="width: 100%; padding: 10px 12px; background: linear-gradient(135deg, #28a745, #20c997); 
                                   color: white; border: none; border-radius: 6px; cursor: pointer; 
                                   font-size: 13px; font-weight: bold; transition: all 0.3s ease;
                                   box-shadow: 0 2px 4px rgba(40, 167, 69, 0.3);"
                            onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 8px rgba(40, 167, 69, 0.4)';"
                            onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(40, 167, 69, 0.3)';">
                        ğŸ—ºï¸ è¼‰å…¥ ${oppositeText} é¥‹ç·š
                    </button>
                ` : `
                    <div style="padding: 8px; background: #f8d7da; border: 1px solid #f5c6cb; 
                                border-radius: 4px; font-size: 11px; color: #721c24;">
                        âš ï¸ "${oppositeText}" ä¸åœ¨å¯è¼‰å…¥çš„é¥‹ç·šæ¸…å–®ä¸­
                    </div>
                `}
                
                <button onclick="copyOppositeInfo('${oppositeText}', ${position[0]}, ${position[1]})" 
                        style="width: 100%; padding: 8px 12px; background: #17a2b8; 
                               color: white; border: none; border-radius: 4px; cursor: pointer; 
                               font-size: 12px; transition: all 0.2s ease;"
                        onmouseover="this.style.background='#138496';"
                        onmouseout="this.style.background='#17a2b8';">
                    ğŸ“‹ è¤‡è£½æ¨™è¨˜è³‡è¨Š
                </button>
                
                <button onclick="map.closePopup()" 
                        style="width: 100%; padding: 6px 12px; background: #6c757d; 
                               color: white; border: none; border-radius: 4px; cursor: pointer; 
                               font-size: 11px;"
                        onmouseover="this.style.background='#5a6268';"
                        onmouseout="this.style.background='#6c757d';">
                    é—œé–‰
                </button>
            </div>
            
            <!-- ğŸ†• ä½ç½®è³‡è¨Š -->
            <div style="margin-top: 8px; padding: 6px; background: #f8f9fa; border-radius: 4px; font-size: 10px; color: #666;">
                ğŸ“ ${position[0].toFixed(6)}, ${position[1].toFixed(6)}
            </div>
        </div>
    `;
}
// ğŸ†• æ–°å¢ï¼šè¤‡è£½ Opposite æ¨™è¨˜è³‡è¨Š
function copyOppositeInfo(oppositeText, lat, lng) {
    const infoText = `â­ Opposite æ¨™è¨˜è³‡è¨Š

ğŸ”— Opposite é¥‹ç·š: ${oppositeText}
ğŸ“ ä½ç½®åº§æ¨™: ${lat.toFixed(6)}, ${lng.toFixed(6)}
ğŸ·ï¸ è¨­å‚™é¡å‹: FSC 114 é–‹é—œè¨­å‚™
ğŸ“… è¤‡è£½æ™‚é–“: ${new Date().toLocaleString('zh-TW')}

â€» æ­¤æ¨™è¨˜è¡¨ç¤ºèˆ‡ ${oppositeText} é¥‹ç·šç›¸é—œçš„é–‹é—œè¨­å‚™ä½ç½®`;

    // è¤‡è£½åˆ°å‰ªè²¼ç°¿
    if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(infoText).then(() => {
            showToast('ğŸ“‹ Opposite æ¨™è¨˜è³‡è¨Šå·²è¤‡è£½ï¼', 'success');
            map.closePopup();
        }).catch(err => {
            console.error('è¤‡è£½å¤±æ•—:', err);
            fallbackCopyOppositeInfo(infoText);
        });
    } else {
        fallbackCopyOppositeInfo(infoText);
    }
}
// ğŸ†• æ–°å¢ï¼šå‚™ç”¨è¤‡è£½æ–¹æ³•
function fallbackCopyOppositeInfo(text) {
    const textArea = document.createElement('textarea');
    textArea.value = text;
    textArea.style.position = 'fixed';
    textArea.style.left = '-999999px';
    textArea.style.top = '-999999px';
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    
    try {
        document.execCommand('copy');
        showToast('ğŸ“‹ Opposite æ¨™è¨˜è³‡è¨Šå·²è¤‡è£½ï¼', 'success');
        map.closePopup();
    } catch (err) {
        console.error('è¤‡è£½å¤±æ•—:', err);
        showToast('âŒ è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½', 'error');
        
        // é¡¯ç¤ºæ–‡å­—è®“ç”¨æˆ¶æ‰‹å‹•è¤‡è£½
        alert('è«‹æ‰‹å‹•è¤‡è£½ä»¥ä¸‹è³‡è¨Šï¼š\n\n' + text);
    }
    
    document.body.removeChild(textArea);
}

// ğŸ†• æ–°å¢ï¼šè¼‰å…¥ Opposite é¥‹ç·šåŠŸèƒ½
function loadOppositeFeeder(oppositeText) {
    console.log(`âš¡ æº–å‚™è¼‰å…¥ Opposite é¥‹ç·š: ${oppositeText}`);
    
    // æ¸…ç†é¥‹ç·šåç¨±
    const cleanFeederName = oppositeText.trim().toUpperCase();
    
    // ğŸ”§ æª¢æŸ¥é¥‹ç·šæ˜¯å¦å­˜åœ¨æ–¼æ¸…å–®ä¸­
    if (!feederList.includes(cleanFeederName)) {
        showToast(`âš ï¸ é¥‹ç·š "${cleanFeederName}" ä¸åœ¨å¯è¼‰å…¥æ¸…å–®ä¸­`, 'warning');
        
        // ğŸ†• æä¾›å»ºè­°çš„ç›¸ä¼¼é¥‹ç·šåç¨±
        const suggestions = findSimilarFeeders(cleanFeederName);
        if (suggestions.length > 0) {
            const suggestionText = suggestions.slice(0, 3).join(', ');
            showToast(`ğŸ’¡ å»ºè­°çš„ç›¸ä¼¼é¥‹ç·š: ${suggestionText}`, 'info');
        }
        return;
    }
    
    // ğŸ”§ é—œé–‰å½ˆå‡ºè¦–çª—
    map.closePopup();
    
    // ğŸ”§ è¨­å®šé¥‹ç·šè¼¸å…¥æ¡†
    const feederInput = document.getElementById('feederInput');
    if (feederInput) {
        feederInput.value = cleanFeederName;
        
        // åŒæ­¥ä¸‹æ‹‰é¸å–®
        const feederDropdown = document.getElementById('feederDropdown');
        if (feederDropdown) {
            feederDropdown.value = cleanFeederName;
        }
        
        // ğŸ”§ é¡¯ç¤ºè¼‰å…¥æç¤º
        showToast(`ğŸ”„ æ­£åœ¨è¼‰å…¥ Opposite é¥‹ç·š: ${cleanFeederName}`, 'info');
        
        // ğŸ”§ åŸ·è¡Œè¼‰å…¥
        try {
            loadFeederFromCloud();
        } catch (error) {
            console.error('âŒ è¼‰å…¥ Opposite é¥‹ç·šå¤±æ•—:', error);
            showToast(`âŒ è¼‰å…¥é¥‹ç·šå¤±æ•—: ${error.message}`, 'error');
        }
        
    } else {
        console.error('âŒ æ‰¾ä¸åˆ°é¥‹ç·šè¼¸å…¥æ¡†');
        showToast('âŒ ç³»çµ±éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°é¥‹ç·šè¼¸å…¥æ¡†', 'error');
    }
}
// ğŸ†• æ–°å¢ï¼šå°‹æ‰¾ç›¸ä¼¼çš„é¥‹ç·šåç¨±
function findSimilarFeeders(targetFeeder) {
    if (!feederList || !Array.isArray(feederList)) {
        return [];
    }
    
    const suggestions = [];
    
    // ğŸ”§ æ–¹æ³•1ï¼šå°‹æ‰¾ç›¸åŒå‰ç¶´çš„é¥‹ç·š
    const prefix = targetFeeder.substring(0, 2); // å–å‰å…©å€‹å­—ç¬¦
    const prefixMatches = feederList.filter(feeder => 
        feeder.startsWith(prefix) && feeder !== targetFeeder
    );
    suggestions.push(...prefixMatches);
    
    // ğŸ”§ æ–¹æ³•2ï¼šå°‹æ‰¾ç·¨è¼¯è·é›¢ç›¸è¿‘çš„é¥‹ç·šï¼ˆç°¡åŒ–ç‰ˆï¼‰
    const closeMatches = feederList.filter(feeder => {
        if (feeder === targetFeeder) return false;
        
        // é•·åº¦ç›¸ä¼¼ä¸”æœ‰å…±åŒå­—ç¬¦
        const lengthDiff = Math.abs(feeder.length - targetFeeder.length);
        if (lengthDiff <= 1) {
            let commonChars = 0;
            const minLength = Math.min(feeder.length, targetFeeder.length);
            
            for (let i = 0; i < minLength; i++) {
                if (feeder[i] === targetFeeder[i]) {
                    commonChars++;
                }
            }
            
            // å¦‚æœæœ‰è¶…éä¸€åŠçš„å­—ç¬¦ç›¸åŒ
            return commonChars >= minLength / 2;
        }
        
        return false;
    });
    
    suggestions.push(...closeMatches);
    
    // å»é‡ä¸¦é™åˆ¶æ•¸é‡
    return [...new Set(suggestions)].slice(0, 5);
}

// ğŸ†• æ–°å¢ï¼šæª¢æŸ¥æ˜¯å¦ç‚ºæœ‰æ•ˆçš„é¥‹ç·šåç¨±
function checkIfValidFeeder(feederName) {
    if (!feederName || typeof feederName !== 'string') {
        return false;
    }
    
    // æ¸…ç†é¥‹ç·šåç¨±ï¼ˆç§»é™¤ç©ºæ ¼ã€è½‰å¤§å¯«ï¼‰
    const cleanFeederName = feederName.trim().toUpperCase();
    
    // æª¢æŸ¥æ˜¯å¦åœ¨é¥‹ç·šæ¸…å–®ä¸­
    if (feederList && Array.isArray(feederList)) {
        return feederList.some(feeder => 
            feeder.toUpperCase() === cleanFeederName
        );
    }
    
    // ğŸ”§ å‚™ç”¨æª¢æŸ¥ï¼šä½¿ç”¨æ­£è¦è¡¨é”å¼æª¢æŸ¥é¥‹ç·šåç¨±æ ¼å¼
    // å°é›»é¥‹ç·šåç¨±é€šå¸¸æ ¼å¼ï¼šæ•¸å­—+å­—æ¯+æ•¸å­— (å¦‚: 6A22, 5B15)
    const feederPattern = /^[0-9]+[A-Z]+[0-9]+$/;
    return feederPattern.test(cleanFeederName);
}

	// ç°¡åŒ–è¨­å‚™åœ–æ¨™ - æ•ˆèƒ½å„ªåŒ–ç‰ˆ
	function getSimpleDeviceIcon(props) {
		const fsc = props.FSC || props.fsc || '';
		const baseStyle = `
			width: 12px; 
			height: 12px; 
			display: flex; 
			align-items: center; 
			justify-content: center; 
			font-size: 8px; 
			font-weight: bold;
			border: 1px solid white;
			box-shadow: 0 1px 2px rgba(0,0,0,0.3);
		`;
		
		switch (fsc) {
			case '120': // æ¥åœ°è¨­å‚™ - åœ“åœˆ + 45åº¦æ–œç·š
				return {
					html: `<div style="${baseStyle} 
						background-color: #2c3e50; 
						border-radius: 50%;
						position: relative;
					">
						<div style="
							position: absolute;
							width: 10px;
							height: 1px;
							background-color: white;
							transform: rotate(45deg);
							top: 50%;
							left: 50%;
							margin-left: -5px;
							margin-top: -0.5px;
						"></div>
					</div>`
				};
				
			case '114': // é–‹é—œè¨­å‚™ - ğŸ”§ èª¿æ•´åœˆåœˆå¤§å°
				const switchType = getSwitchType(props);
				return {
					html: `<div style="
						width: 20px; 
						height: 20px; 
						display: flex; 
						align-items: center; 
						justify-content: center; 
						font-size: 12px; 
						font-weight: bold;
						border: 2px solid white;
						box-shadow: 0 2px 4px rgba(0,0,0,0.4);
						background-color: #27ae60; 
						border-radius: 50%;
						color: white;
					">${switchType}</div>`
				};

				
			case '115': // è®Šå£“å™¨ - ä¸‰è§’å½¢ (æ”¾å¤§1.5å€)
				return {
					html: `<div style="
						width: 0;
						height: 0;
						border-left: 9px solid transparent;
						border-right: 9px solid transparent;
						border-bottom: 15px solid #3498db;
						filter: drop-shadow(0 2px 3px rgba(0,0,0,0.4));
					"></div>`
				};

				
			case '106': // é›»æ¡¿è¨­å‚™ - æ·±ç°è‰²å°åœ“é»
				return {
					html: `<div style="
						width: 6px; 
						height: 6px; 
						background-color: #34495e; 
						border-radius: 50%;
						border: 1px solid white;
						box-shadow: 0 1px 2px rgba(0,0,0,0.3);
					"></div>`
				};

			case '108': // é›»çºœé ­ - å¤§æ–¹å½¢ + "è®Š"å­—
				return {
					html: `<div style="
						width: 20px; 
						height: 20px; 
						background-color: #f39c12; 
						border-radius: 3px;
						border: 2px solid white;
						box-shadow: 0 2px 4px rgba(0,0,0,0.4);
						display: flex;
						align-items: center;
						justify-content: center;
						font-size: 12px;
						font-weight: bold;
						color: white;
						text-shadow: 1px 1px 1px rgba(0,0,0,0.5);
					">è®Š</div>`
				};

				
			case '109': // é›»æ¡¿æ¨™ç¤º - è±å½¢
				return {
					html: `<div style="
						width: 8px;
						height: 8px;
						background-color: #9b59b6;
						transform: rotate(45deg);
						border: 1px solid white;
						box-shadow: 0 1px 2px rgba(0,0,0,0.3);
					"></div>`
				};
				
			case '110': // å¤ªé™½èƒ½è¨­å‚™ - æ–œæ”¾å¤ªé™½èƒ½æ¿
				return {
					html: `<div style="
						width: 12px;
						height: 8px;
						background: linear-gradient(135deg, #3498db 0%, #2980b9 50%, #1f4e79 100%);
						transform: rotate(-15deg) skewX(-10deg);
						border: 1px solid white;
						box-shadow: 0 1px 2px rgba(0,0,0,0.3);
						position: relative;
					">
						<div style="
							position: absolute;
							top: 1px;
							left: 1px;
							right: 1px;
							height: 1px;
							background-color: rgba(255,255,255,0.4);
						"></div>
						<div style="
							position: absolute;
							top: 4px;
							left: 1px;
							right: 1px;
							height: 1px;
							background-color: rgba(255,255,255,0.2);
						"></div>
					</div>`
				};

				
			case '116': // é›»æ¡¿è¨­å‚™ - åœ“é»ï¼ˆä¸åŒé¡è‰²ï¼‰
				return {
					html: `<div style="${baseStyle} 
						background-color: #8b4513; 
						border-radius: 50%;
					"></div>`
				};
				
			case '131': // å…¶ä»–è¨­å‚™ - å…«è§’å½¢
				return {
					html: `<div style="
						width: 10px;
						height: 10px;
						background-color: #8e44ad;
						clip-path: polygon(30% 0%, 70% 0%, 100% 30%, 100% 70%, 70% 100%, 30% 100%, 0% 70%, 0% 30%);
						border: 1px solid white;
						box-shadow: 0 1px 2px rgba(0,0,0,0.3);
					"></div>`
				};
				
			default: // æœªçŸ¥è¨­å‚™ - ç°¡å–®åœ“é»
				return {
					html: `<div style="${baseStyle} 
						background-color: #95a5a6; 
						border-radius: 50%;
					"></div>`
				};
		}
	}

	// ğŸ”§ ä¿®æ­£ï¼šåˆ¤æ–·é–‹é—œé¡å‹ - æ ¹æ“šè¨­å‚™å±¬æ€§è¿”å›æ­£ç¢ºè‹±æ–‡å­—æ¯
	function getSwitchType(props) {
		console.log('ğŸ” åˆ¤æ–·é–‹é—œé¡å‹ï¼Œè¨­å‚™å±¬æ€§:', props);
		
		// æ ¹æ“šè¨­å‚™å±¬æ€§åˆ¤æ–·é–‹é—œé¡å‹
		const auto = props.Auto;
		const fuse = props.Fuse;
		const no = props.NO;
		const type = props.Type || '';
		const spec = props.Spec || '';
		const swtype = props.SrcLoop ? props.SrcLoop.Type : undefined;
		
		console.log(`ğŸ” é–‹é—œå±¬æ€§åˆ†æ: Auto=${auto}, Fuse=${fuse}, NO=${no}, Type="${type}", Spec="${spec}"`);
		console.log(swtype);
		
		// ğŸ”§ ä¿®æ­£ï¼šåˆ¤æ–·é‚è¼¯ä¸¦è¿”å›å°æ‡‰è‹±æ–‡å­—æ¯
		if (fuse === true || fuse === '1' || fuse === 1 || type.includes('ç†”çµ²') || spec.includes('FUSE')) {
			console.log('âœ… åˆ¤æ–·ç‚ºç†”çµ² (F)');
			return 'F'; // ç†”çµ² (Fuse)
		} else if (auto === true || auto === '1' || auto === 1 || type.includes('è‡ªå‹•') || spec.includes('AUTO')) {
			console.log('âœ… åˆ¤æ–·ç‚ºè‡ªå‹•åŒ–é–‹é—œ (A)');
			return 'A'; // è‡ªå‹•åŒ–é–‹é—œ (Automatic)
		} else if (no === true || no === '1' || no === 1 || type.includes('åˆ†æ®µ') || spec.includes('SECT') || spec.includes('DISCONNECT') || swtype === 2 ||swtype ==='2') {
			console.log('âœ… åˆ¤æ–·ç‚ºåˆ†æ®µé–‹é—œ (D)');
			return 'D'; // åˆ†æ®µé–‹é—œ (Disconnector)
		} else if (type.includes('æ°£å°') || spec.includes('SECTIONALIZER') || spec.includes('æ°£å°')) {
			console.log('âœ… åˆ¤æ–·ç‚ºæ°£å°é–‹é—œ (S)');
			return 'S'; // æ°£å°é–‹é—œ (Sectionalizer)
		} else {
			console.log('âš ï¸ æœªçŸ¥é–‹é—œé¡å‹ï¼Œä½¿ç”¨é è¨­ (S)');
			return 'S'; // é è¨­ç‚ºæ°£å°é–‹é—œ (Switch/Sectionalizer)
		}
	}


	// å–å¾—è¨­å‚™åœ–æ¨™
	// ğŸ”§ ä¿®æ­£ç‰ˆï¼šå–å¾—è¨­å‚™åœ–ç¤º - ä½¿ç”¨æ­£ç¢ºçš„åœ–ç¤º
function getDeviceIcon(fsc) {
    const icons = {
        '106': { 
            url: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png', 
            size: [20, 32], 
            anchor: [10, 32] 
        }, // ç·šè·¯ç¯€é»
        '108': { 
            url: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png', 
            size: [25, 41], 
            anchor: [12, 41] 
        }, // è®Šé›»æ‰€
        '114': { 
            url: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-orange.png', 
            size: [20, 32], 
            anchor: [10, 32] 
        }, // é–‹é—œè¨­å‚™
        '115': { 
            url: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-yellow.png', 
            size: [20, 32], 
            anchor: [10, 32] 
        }, // è®Šå£“å™¨
        '110': { 
            url: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-violet.png', 
            size: [20, 32], 
            anchor: [10, 32] 
        }, // å¤ªé™½èƒ½
        '120': { 
            url: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-black.png', 
            size: [18, 29], 
            anchor: [9, 29] 
        }, // é›»æ¡¿è¨­å‚™
    };
    
    return icons[fsc] || { 
        url: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-grey.png', 
        size: [18, 29], 
        anchor: [9, 29] 
    };
}

	// ğŸ”§ ä¿®æ­£ï¼šå–å¾—è¨­å‚™é¡å‹åç¨± - é…åˆæ‚¨çš„ FSC åˆ†é¡
	function getDeviceTypeName(fsc) {
		const types = {
			'106': 'ç·šè·¯ç¯€é»',
			'108': 'è®Šé›»æ‰€', 
			'109': 'é›»æ¡¿æ¨™ç¤º',
			'110': 'å¤ªé™½èƒ½è¨­å‚™',
			'114': 'é–‹é—œè¨­å‚™',
			'115': 'è®Šå£“å™¨',
			'116': 'çµ‚ç«¯',
			'120': 'é›»æ¡¿è¨­å‚™',
			'131': 'å…¶ä»–è¨­å‚™'
		};
		return types[fsc] || `FSC-${fsc}` || 'æœªçŸ¥è¨­å‚™';
	}
			  
	function toggleLayer(categoryKey) {
    const checkbox = document.getElementById(`layer_${categoryKey}`);
    const layerGroup = layerGroups[categoryKey];
    
    if (!layerGroup) return;
    
    if (checkbox.checked) {
        map.addLayer(layerGroup);
        
        // ğŸ”§ ä¿®æ­£ï¼šé¡¯ç¤ºè©²åœ–å±¤ä¸­æ‰€æœ‰ç·šæ®µçš„ç®­é ­
        layerGroup.eachLayer(layer => {
            if (layer.arrowMarkers && Array.isArray(layer.arrowMarkers)) {
                layer.arrowMarkers.forEach(marker => {
                    arrowLayerGroup.addLayer(marker); // æ·»åŠ åˆ°ç®­é ­åœ–å±¤ç¾¤çµ„
                });
            }
        });
    } else {
        map.removeLayer(layerGroup);
        
        // ğŸ”§ ä¿®æ­£ï¼šéš±è—è©²åœ–å±¤ä¸­æ‰€æœ‰ç·šæ®µçš„ç®­é ­
        layerGroup.eachLayer(layer => {
            if (layer.arrowMarkers && Array.isArray(layer.arrowMarkers)) {
                layer.arrowMarkers.forEach(marker => {
                    arrowLayerGroup.removeLayer(marker); // å¾ç®­é ­åœ–å±¤ç¾¤çµ„ç§»é™¤
                });
            }
        });
    }
}
			  
			// æ¸…é™¤æ‰€æœ‰åœ–å±¤ - å®Œå…¨ä¿®æ”¹ç‰ˆï¼ˆåŠ å…¥æ˜Ÿæ˜Ÿæ¸…é™¤ï¼‰
			function clearAllLayers() {
				console.log('ğŸ§¹ é–‹å§‹æ¸…é™¤æ‰€æœ‰åœ–å±¤ã€ç®­é ­å’Œæ˜Ÿæ˜Ÿ...');
				
				// æ¸…é™¤ç¾æœ‰åœ–å±¤
				Object.values(layerGroups).forEach(layerGroup => {
					if (map.hasLayer(layerGroup)) {
						map.removeLayer(layerGroup);
					}
				});
				
				// ğŸ”§ é‡è¦ï¼šæ¸…é™¤æ‰€æœ‰ç®­é ­æ¨™è¨˜
				clearAllArrows();
				
				// ğŸŒŸ æ–°å¢ï¼šæ¸…é™¤æ‰€æœ‰æ˜Ÿæ˜Ÿæ¨™è¨˜
				clearAllOppositeStars();
				
				// é‡ç½®è®Šæ•¸
				layerGroups = {};
				selectedLine = null;
				
				console.log('âœ… æ‰€æœ‰åœ–å±¤ã€ç®­é ­å’Œæ˜Ÿæ˜Ÿå·²æ¸…é™¤');
			}
			
			// ğŸŒŸ æ–°å¢ï¼šå°ˆé–€æ¸…é™¤æ˜Ÿæ˜Ÿçš„å‡½æ•¸
	function clearAllOppositeStars() {
		console.log(`ğŸ§¹ æ¸…é™¤ ${oppositeStarMarkers.length} å€‹æ˜Ÿæ˜Ÿæ¨™è¨˜...`);
		
		// æ–¹æ³•1ï¼šå¾åœ–å±¤ç¾¤çµ„æ¸…é™¤ï¼ˆæ•ˆèƒ½è¼ƒå¥½ï¼‰
		if (oppositeLayerGroup) {
			oppositeLayerGroup.clearLayers();
		}
		
		// æ–¹æ³•2ï¼šé€ä¸€æ¸…é™¤ï¼ˆå‚™ç”¨æ–¹æ¡ˆï¼‰
		oppositeStarMarkers.forEach(marker => {
			if (map.hasLayer(marker)) {
				map.removeLayer(marker);
			}
		});
		
		// é‡ç½®æ˜Ÿæ˜Ÿé™£åˆ—
		oppositeStarMarkers = [];
		
		console.log('âœ… æ‰€æœ‰æ˜Ÿæ˜Ÿå·²æ¸…é™¤');
	}
			
			// ğŸ”§ æ–°å¢ï¼šå°ˆé–€æ¸…é™¤ç®­é ­çš„å‡½æ•¸
	function clearAllArrows() {
		console.log(`ğŸ§¹ æ¸…é™¤ ${allArrowMarkers.length} å€‹ç®­é ­æ¨™è¨˜...`);
		
		// æ–¹æ³•1ï¼šå¾åœ–å±¤ç¾¤çµ„æ¸…é™¤ï¼ˆæ•ˆèƒ½è¼ƒå¥½ï¼‰
		if (arrowLayerGroup) {
			arrowLayerGroup.clearLayers();
		}
		
		// æ–¹æ³•2ï¼šé€ä¸€æ¸…é™¤ï¼ˆå‚™ç”¨æ–¹æ¡ˆï¼‰
		allArrowMarkers.forEach(marker => {
			if (map.hasLayer(marker)) {
				map.removeLayer(marker);
			}
		});
		
		// é‡ç½®ç®­é ­é™£åˆ—
		allArrowMarkers = [];
		
		console.log('âœ… æ‰€æœ‰ç®­é ­å·²æ¸…é™¤');
	}
			  
			  // è‡ªå‹•ç¸®æ”¾åˆ°è³‡æ–™ç¯„åœ
			  function fitMapToData() {
				  const bounds = L.latLngBounds();
				  let hasData = false;
				  
				  // åŠ å…¥é»è¨­å‚™ç¯„åœ
				  allDevicesData.forEach(device => {
					  const [lng, lat] = device.coordinates;
					  bounds.extend([lat, lng]);
					  hasData = true;
				  });
				  
				  // åŠ å…¥ç·šæ®µç¯„åœ
				  allLinesData.forEach(line => {
					  line.coordinates.forEach(coord => {
						  bounds.extend(coord);
						  hasData = true;
					  });
				  });
				  
				  if (hasData) {
					  // åŠ å…¥ä¸€äº›é‚Šç•Œå¡«å……
					  map.fitBounds(bounds, { padding: [20, 20] });
				  }
			  }
			  
// ğŸ”§ ä¿®æ­£ç‰ˆï¼šé é¢è¼‰å…¥å®Œæˆå¾Œçš„åˆå§‹åŒ– - ç§»é™¤é‡æ–°è¼‰å…¥ç›¸é—œé‚è¼¯
// ğŸ”§ ä¿®æ­£ç‰ˆï¼šé é¢è¼‰å…¥å®Œæˆå¾Œçš„åˆå§‹åŒ– - å„ªå…ˆè™•ç†åˆ†äº«é€£çµ
document.addEventListener('DOMContentLoaded', function() {
    // åˆå§‹åŒ–åœ°åœ–
    initMap();
    initMobileOptimizations();
    
    // ğŸ”§ é‡è¦ä¿®æ­£ï¼šå„ªå…ˆæª¢æŸ¥åˆ†äº«é€£çµï¼Œç„¶å¾Œå†è¼‰å…¥ç½æƒ…è³‡æ–™
    setTimeout(() => {
        const isDisasterShareLink = handleDisasterShareLink();
        
        if (isDisasterShareLink) {
            // ğŸ”§ å¦‚æœæ˜¯ç½æƒ…åˆ†äº«é€£çµï¼Œç«‹å³è¼‰å…¥ç½æƒ…è³‡æ–™
            console.log('ğŸ”— æª¢æ¸¬åˆ°ç½æƒ…åˆ†äº«é€£çµï¼Œå„ªå…ˆè¼‰å…¥ç½æƒ…è³‡æ–™...');
            loadDisasterData().then(() => {
                // ç½æƒ…è³‡æ–™è¼‰å…¥å®Œæˆå¾Œï¼Œå†æ¬¡å˜—è©¦é–‹å•Ÿåˆ†äº«é€£çµ
                setTimeout(() => {
                    handleDisasterShareLink();
                }, 500);
            });
        } else {
            // ğŸ”§ ä¸æ˜¯ç½æƒ…åˆ†äº«é€£çµï¼Œæ­£å¸¸è¼‰å…¥
            loadMapFromURL();
            
            // å»¶é²è¼‰å…¥ç½æƒ…è³‡æ–™ï¼ˆä¸é˜»å¡ä¸»è¦åŠŸèƒ½ï¼‰
            setTimeout(() => {
                loadDisasterData();
            }, 2000);
        }
    }, 1000);
    
    // ç›£è½å…¨è¢å¹•è®ŠåŒ–ï¼ˆä¸é‡æ–°è¼‰å…¥ï¼‰
    document.addEventListener('fullscreenchange', function() {
        setTimeout(() => {
            if (map) {
                map.invalidateSize();
                console.log('ğŸ—ºï¸ å…¨è¢å¹•ç‹€æ…‹è®ŠåŒ–ï¼Œåœ°åœ–å·²èª¿æ•´');
            }
        }, 100);
    });
    
    // ğŸ”§ ä¿®æ­£ç‰ˆï¼šéŸ¿æ‡‰å¼è™•ç† - è¦–çª—å¤§å°è®ŠåŒ–æ™‚é‡æ–°ç¶å®šäº‹ä»¶
    window.addEventListener('resize', function() {
        const wasMobile = document.body.classList.contains('mobile-mode');
        const isMobile = window.innerWidth <= 768;
        
        if (wasMobile !== isMobile) {
            console.log(`ğŸ“± è£ç½®æ¨¡å¼è®Šæ›´: ${wasMobile ? 'æ‰‹æ©Ÿ' : 'æ¡Œé¢'} â†’ ${isMobile ? 'æ‰‹æ©Ÿ' : 'æ¡Œé¢'}`);
            
            // æ›´æ–° body class
            if (isMobile) {
                document.body.classList.add('mobile-mode');
            } else {
                document.body.classList.remove('mobile-mode');
            }
            
            // ğŸ”§ é‡è¦ï¼šå¦‚æœå¾æ¡Œé¢åˆ‡æ›åˆ°æ‰‹æ©Ÿï¼Œé—œé–‰ä»»ä½•é–‹å•Ÿçš„æ‹–æ›³é¢æ¿
            if (isMobile && draggableFaultPanel) {
                closeDraggableFaultInfoPanel();
            }
            
            // é‡æ–°ç¶å®šæ•…éšœæ¨™è¨˜äº‹ä»¶
            rebindFaultMarkersForMobile();
        }
        
        // åŸæœ‰çš„åœ°åœ–å¤§å°èª¿æ•´
        setTimeout(() => {
            if (map) {
                map.invalidateSize();
                console.log('ğŸ—ºï¸ è¦–çª—å¤§å°è®ŠåŒ–ï¼Œåœ°åœ–å·²èª¿æ•´');
            }
        }, 100);
    });
});
// ğŸ†• æ–°å¢ï¼šå°ˆé–€ç‚ºæ‰‹æ©Ÿç‰ˆé‡æ–°ç¶å®šæ•…éšœæ¨™è¨˜äº‹ä»¶
function rebindFaultMarkersForMobile() {
    const isMobile = window.innerWidth <= 768;
    
    faultLineMarkers.forEach(marker => {
        // ç§»é™¤èˆŠçš„äº‹ä»¶ç›£è½å™¨
        marker.off('click');
        
        if (marker instanceof L.Polyline) {
            // é‡æ–°ç¶å®šç·šæ®µé»æ“Šäº‹ä»¶
            if (!isMobile) {
                // ğŸ–¥ï¸ æ¡Œé¢ç‰ˆï¼šé¡¯ç¤ºæ‹–æ›³é¢æ¿
                marker.on('click', function(e) {
                    const clickPosition = e.latlng;
                    if (marker.faultInfo) {
                        marker.faultInfo.clickPoint = [clickPosition.lat, clickPosition.lng];
                        showDraggableFaultInfoPanel([clickPosition.lat, clickPosition.lng], 'æ•…éšœå€é–“', '#ff0000', marker.faultInfo);
                    }
                    L.DomEvent.stopPropagation(e);
                });
            } else {
                // ğŸ“± æ‰‹æ©Ÿç‰ˆï¼šé¡¯ç¤ºåŸå§‹æ•…éšœå€é–“å½ˆçª—
                marker.on('click', function(e) {
                    if (marker.faultInfo) {
                        const midLat = (marker.faultInfo.startPoint[0] + marker.faultInfo.endPoint[0]) / 2;
                        const midLng = (marker.faultInfo.startPoint[1] + marker.faultInfo.endPoint[1]) / 2;
                        
                        const infoPopup = L.popup()
                            .setLatLng([midLat, midLng])
                            .setContent(`
                                <div style="text-align: center;">
                                    <h4 style="color: #dc3545; margin: 0 0 8px 0;">âš¡ æ•…éšœå€é–“</h4>
                                    <p style="margin: 4px 0;"><strong>é¥‹ç·š:</strong> ${marker.faultInfo.feeder}</p>
                                    <p style="margin: 4px 0;"><strong>å€é–“:</strong> ${marker.faultInfo.faultSection}</p>
                                    <p style="margin: 4px 0; font-size: 11px; color: #666;">
                                        ${marker.faultInfo.coord1} â†” ${marker.faultInfo.coord2}
                                    </p>
                                    <button onclick="clearFaultMarkers()" 
                                            style="margin-top: 8px; padding: 4px 8px; background: #6c757d; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 11px;">
                                        æ¸…é™¤æ¨™è¨˜
                                    </button>
                                </div>
                            `)
                            .openOn(map);
                    }
                    L.DomEvent.stopPropagation(e);
                });
            }
        } else if (marker instanceof L.Marker) {
            // é‡æ–°ç¶å®šæ¨™è¨˜é»æ“Šäº‹ä»¶
            if (!isMobile) {
                // ğŸ–¥ï¸ æ¡Œé¢ç‰ˆï¼šé¡¯ç¤ºæ‹–æ›³é¢æ¿
                marker.on('click', function(e) {
                    if (marker.faultTitle && marker.faultColor) {
                        showDraggableFaultInfoPanel(marker.getLatLng(), marker.faultTitle, marker.faultColor);
                    }
                    L.DomEvent.stopPropagation(e);
                });
            } else {
                // ğŸ“± æ‰‹æ©Ÿç‰ˆï¼šé¡¯ç¤ºåŸæœ¬çš„ popup
                marker.on('click', function(e) {
                    marker.openPopup();
                    L.DomEvent.stopPropagation(e);
                });
            }
        }
    });
    
    console.log(`ğŸ”„ å·²é‡æ–°ç¶å®š ${faultLineMarkers.length} å€‹æ•…éšœæ¨™è¨˜çš„é»æ“Šäº‹ä»¶ (${isMobile ? 'æ‰‹æ©Ÿç‰ˆ' : 'æ¡Œé¢ç‰ˆ'})`);
}
// ğŸ†• æ–°å¢ï¼šæª¢æ¸¬è£ç½®é¡å‹çš„è¼”åŠ©å‡½æ•¸
function isMobileDevice() {
    return window.innerWidth <= 768 || /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
}			  

// ğŸ†• æ–°å¢ï¼šé‡æ–°ç¶å®šæ•…éšœæ¨™è¨˜äº‹ä»¶
function rebindFaultMarkersEvents() {
    const isMobile = window.innerWidth <= 768;
    
    faultLineMarkers.forEach(marker => {
        // ç§»é™¤èˆŠçš„äº‹ä»¶ç›£è½å™¨
        marker.off('click');
        
        if (marker instanceof L.Polyline) {
            // é‡æ–°ç¶å®šç·šæ®µé»æ“Šäº‹ä»¶
            if (!isMobile) {
                // æ¡Œé¢ç‰ˆï¼šé¡¯ç¤ºæ‹–æ›³é¢æ¿
                marker.on('click', function(e) {
                    const clickPosition = e.latlng;
                    // é€™è£¡éœ€è¦å¾æ¨™è¨˜ä¸­å–å¾—æ•…éšœè³‡è¨Šï¼Œå¯ä»¥åœ¨å‰µå»ºæ™‚å„²å­˜
                    if (marker.faultInfo) {
                        showDraggableFaultInfoPanel([clickPosition.lat, clickPosition.lng], 'æ•…éšœå€é–“', '#ff0000', marker.faultInfo);
                    }
                    L.DomEvent.stopPropagation(e);
                });
            } else {
                // æ‰‹æ©Ÿç‰ˆï¼šåªé¡¯ç¤ºæç¤º
                marker.on('click', function(e) {
                    if (marker.faultInfo) {
                        showToast(`ğŸ“ ${marker.faultInfo.feeder} - ${marker.faultInfo.faultSection}`, 'info');
                    }
                    L.DomEvent.stopPropagation(e);
                });
            }
        } else if (marker instanceof L.Marker) {
            // é‡æ–°ç¶å®šæ¨™è¨˜é»æ“Šäº‹ä»¶
            if (!isMobile) {
                marker.on('click', function(e) {
                    if (marker.faultTitle && marker.faultColor) {
                        showDraggableFaultInfoPanel(marker.getLatLng(), marker.faultTitle, marker.faultColor);
                    }
                    L.DomEvent.stopPropagation(e);
                });
            } else {
                marker.on('click', function(e) {
                    if (marker.faultTitle) {
                        showToast(`ğŸ“ ${marker.faultTitle}`, 'info');
                    }
                    L.DomEvent.stopPropagation(e);
                });
            }
        }
    });
    
    console.log(`ğŸ”„ å·²é‡æ–°ç¶å®š ${faultLineMarkers.length} å€‹æ•…éšœæ¨™è¨˜çš„é»æ“Šäº‹ä»¶ (${isMobile ? 'æ‰‹æ©Ÿç‰ˆ' : 'æ¡Œé¢ç‰ˆ'})`);
}			  
// ğŸ†• ä¿®æ”¹å¾Œçš„åˆå§‹åŒ–ä¸‹æ‹‰é¸å–®å‡½æ•¸
// ğŸ”§ ä¿®æ­£ç‰ˆï¼šåˆå§‹åŒ–ä¸‹æ‹‰é¸å–®å‡½æ•¸ - æ”¯æ´æ‰‹æ©Ÿç‰ˆé‡æ–°åˆå§‹åŒ–
function initializeFeederDropdown() {
    const dropdown = document.getElementById('feederDropdown');
    const inputField = document.getElementById('feederInput');
    
    if (!dropdown || !inputField) {
        console.warn('âš ï¸ æ‰¾ä¸åˆ°é¥‹ç·šä¸‹æ‹‰é¸å–®æˆ–è¼¸å…¥æ¡†');
        return;
    }
    
    // æ¸…ç©ºç¾æœ‰é¸é …
    dropdown.innerHTML = '<option value="">é¸æ“‡é¥‹ç·š</option>';
    
    // åŠ å…¥é¥‹ç·šé¸é …
    feederList.forEach(feeder => {
        const option = document.createElement('option');
        option.value = feeder;
        option.textContent = feeder;
        dropdown.appendChild(option);
    });
    
    // ğŸ”§ é‡è¦ï¼šç§»é™¤èˆŠçš„äº‹ä»¶ç›£è½å™¨ï¼ˆé¿å…é‡è¤‡ç¶å®šï¼‰
    dropdown.removeEventListener('change', handleDropdownChange);
    inputField.removeEventListener('input', handleInputChange);
    
    // ğŸ”§ é‡è¦ï¼šé‡æ–°ç¶å®šäº‹ä»¶ç›£è½å™¨
    dropdown.addEventListener('change', handleDropdownChange);
    inputField.addEventListener('input', handleInputChange);
    
    console.log(`âœ… ä¸‹æ‹‰é¸å–®å·²åˆå§‹åŒ–ï¼ŒåŒ…å« ${feederList.length} å€‹é¥‹ç·š`);
}

// ğŸ†• æ–°å¢ï¼šä¸‹æ‹‰é¸å–®è®ŠåŒ–è™•ç†å‡½æ•¸
function handleDropdownChange(event) {
    const selectedFeeder = event.target.value;
    const inputField = document.getElementById('feederInput');
    
    console.log('ğŸ“‹ ä¸‹æ‹‰é¸å–®é¸æ“‡:', selectedFeeder);
    
    if (selectedFeeder && inputField) {
        inputField.value = selectedFeeder;
        console.log('âœ… å·²åŒæ­¥åˆ°è¼¸å…¥æ¡†:', selectedFeeder);
        
        // ğŸ†• é¡¯ç¤ºæç¤º
        showToast(`å·²é¸æ“‡é¥‹ç·š: ${selectedFeeder}`, 'info');
    }
}

// ğŸ†• æ–°å¢ï¼šè¼¸å…¥æ¡†è®ŠåŒ–è™•ç†å‡½æ•¸
function handleInputChange(event) {
    const inputValue = event.target.value.toUpperCase();
    const dropdown = document.getElementById('feederDropdown');
    
    console.log('âŒ¨ï¸ è¼¸å…¥æ¡†è®ŠåŒ–:', inputValue);
    
    if (dropdown) {
        // åŒæ­¥ä¸‹æ‹‰é¸å–®é¸æ“‡
        dropdown.value = feederList.includes(inputValue) ? inputValue : '';
        console.log('âœ… å·²åŒæ­¥åˆ°ä¸‹æ‹‰é¸å–®');
    }
}
// ğŸ†• å¾é›²ç«¯è¼‰å…¥é¥‹ç·šè³‡æ–™
// ğŸ”§ ä¿®æ­£ï¼šå¾é›²ç«¯è¼‰å…¥é¥‹ç·šè³‡æ–™ - æ”¹å–„ UI åé¥‹
// ğŸ”§ ä¿®æ­£ç‰ˆï¼šè¼‰å…¥å‡½æ•¸ä¸­åŠ å…¥æ›´å¥½çš„éŒ¯èª¤è™•ç†
async function loadFeederFromCloud() {
    const feederInput = document.getElementById('feederInput');
    const feederName = feederInput.value.trim().toUpperCase();
    const loadBtn = document.querySelector('.load-feeder-btn');
    const section = document.querySelector('.feeder-selection-section');
    
    if (!feederName) {
        showToast('è«‹è¼¸å…¥é¥‹ç·šåç¨±æˆ–å¾ä¸‹æ‹‰é¸å–®é¸æ“‡ï¼', 'error');
        feederInput.focus();
        return;
    }
    
    if (!feederList.includes(feederName)) {
        showToast(`æ‰¾ä¸åˆ°é¥‹ç·š "${feederName}"ï¼Œè«‹æª¢æŸ¥åç¨±æ˜¯å¦æ­£ç¢ºï¼`, 'error');
        feederInput.focus();
        return;
    }
    
    const fileName = `119_${feederName}.json`;
    
    try {
        // 1. æª¢æŸ¥æœ¬åœ°å„²å­˜
        let jsonData = localStorageManager.loadFromLocal(fileName);
        if (jsonData) {
            await processJsonDataAsync(jsonData, fileName);
            showToast('âš¡ ç¬é–“è¼‰å…¥ï¼(æœ¬åœ°)', 'success');
            return;
        }
        
        // 2. æª¢æŸ¥è¨˜æ†¶é«”å¿«å–
        jsonData = feederCache.get(fileName);
        if (jsonData) {
            await processJsonDataAsync(jsonData, fileName);
            showToast('âš¡ å¿«é€Ÿè¼‰å…¥ï¼(å¿«å–)', 'success');
            return;
        }
        
        // 3. å¾é›²ç«¯è¼‰å…¥
        loadBtn.disabled = true;
        loadBtn.textContent = 'âš¡ é¥‹ç·šè¼‰å…¥ä¸­...';
        section.classList.add('loading');
        
        const startTime = Date.now();
        updateProgress(0, 'æº–å‚™è¼‰å…¥...');
        
        // ğŸ”§ ä¿®æ­£ï¼šæª¢æŸ¥æª”æ¡ˆ ID æ˜¯å¦å­˜åœ¨
        let fileId;
        try {
            fileId = getFileIdByName(fileName);
        } catch (error) {
            throw new Error(`æ‰¾ä¸åˆ°æª”æ¡ˆ ${fileName}ï¼š${error.message}`);
        }
        
        const bestUrl = await getBestDownloadUrl(fileId);
        
        updateProgress(10, 'å»ºç«‹é€£ç·š...');
        
        // ğŸ”§ ä¿®æ­£ï¼šåŠ å…¥æ›´è©³ç´°çš„éŒ¯èª¤è™•ç†
        try {
            jsonData = await fastJsonLoader.loadJsonWithStream(bestUrl, (percent, text) => {
                updateProgress(10 + (percent * 0.7), text);
            });
        } catch (loadError) {
            console.error('è¼‰å…¥éŒ¯èª¤è©³æƒ…:', loadError);
            
            if (loadError.message.includes('HTML')) {
                throw new Error('Google Drive æª”æ¡ˆç„¡æ³•ç›´æ¥å­˜å–ï¼Œè«‹æª¢æŸ¥æª”æ¡ˆæ¬Šé™è¨­å®š');
            } else if (loadError.message.includes('HTTP 404')) {
                throw new Error(`æª”æ¡ˆä¸å­˜åœ¨æˆ–å·²è¢«åˆªé™¤ï¼š${fileName}`);
            } else if (loadError.message.includes('HTTP 403')) {
                throw new Error(`æª”æ¡ˆå­˜å–æ¬Šé™ä¸è¶³ï¼š${fileName}`);
            } else {
                throw new Error(`è¼‰å…¥å¤±æ•—ï¼š${loadError.message}`);
            }
        }
        
        updateProgress(85, 'è™•ç†è³‡æ–™...');
        
        // 4. å„²å­˜åˆ°å¿«å–å’Œæœ¬åœ°
        feederCache.set(fileName, jsonData);
        await localStorageManager.saveToLocal(fileName, jsonData);
        
        updateProgress(95, 'æ¸²æŸ“åœ°åœ–...');
        
        // 5. è™•ç†è³‡æ–™
        await processJsonDataAsync(jsonData, fileName);
        
        updateProgress(100, 'è¼‰å…¥å®Œæˆï¼');
        
        const loadTime = ((Date.now() - startTime) / 1000).toFixed(2);
        console.log(`ğŸ‰ é¥‹ç·šè¼‰å…¥å®Œæˆ: ${loadTime}ç§’`);
        // åœ¨ loadFeederFromCloud() æˆåŠŸè¼‰å…¥å¾ŒåŠ å…¥
		setTimeout(() => {
			highlightOppositeMarkers(feederName);
		}, 2000);
        section.classList.add('success');
        showToast(`ğŸš€ è¼‰å…¥å®Œæˆï¼(${loadTime}ç§’)`, 'success');
        
        // èƒŒæ™¯é è¼‰å…¥
        setTimeout(() => preloadAdjacentFeeders(feederName), 1000);
        
    } catch (error) {
        console.error('âŒ é¥‹ç·šè¼‰å…¥å¤±æ•—:', error);
        section.classList.add('error');
        updateProgress(0, 'è¼‰å…¥å¤±æ•—');
        showToast(`è¼‰å…¥å¤±æ•—: ${error.message}`, 'error');
        
    } finally {
        loadBtn.disabled = false;
        loadBtn.textContent = 'âš¡ è¼‰å…¥é¥‹ç·š';
        section.classList.remove('loading');
        
        setTimeout(() => {
            section.classList.remove('success', 'error');
        }, 3000);
    }
}
// ğŸ†• æ™ºæ…§é è¼‰å…¥ç›¸é„°é¥‹ç·š
async function preloadAdjacentFeeders(currentFeeder) {
    console.log(`ğŸ”® é–‹å§‹é è¼‰å…¥ ${currentFeeder} çš„ç›¸é„°é¥‹ç·š...`);
    
    const adjacentFeeders = getAdjacentFeeders(currentFeeder);
    const maxPreload = 3;
    const feedersToPreload = adjacentFeeders.slice(0, maxPreload);
    
    console.log(`ğŸ“‹ é è¼‰å…¥æ¸…å–®: ${feedersToPreload.join(', ')}`);
    
    feedersToPreload.forEach(async (feeder, index) => {
        try {
            await new Promise(resolve => setTimeout(resolve, index * 1000));
            
            const fileName = `119_${feeder}.json`;
            
            if (feederCache.get(fileName)) {
                console.log(`âš¡ ${feeder} å·²åœ¨å¿«å–ä¸­ï¼Œè·³éé è¼‰å…¥`);
                return;
            }
            
            console.log(`ğŸ”® é è¼‰å…¥: ${feeder}`);
            const fileId = getFileIdByName(fileName);
            const bestUrl = await getBestDownloadUrl(fileId);
            const jsonData = await fastJsonLoader.loadJsonWithStream(bestUrl);
            feederCache.set(fileName, jsonData);
            console.log(`âœ… é è¼‰å…¥å®Œæˆ: ${feeder}`);
            
        } catch (error) {
            console.log(`âš ï¸ é è¼‰å…¥å¤±æ•—: ${feeder} -`, error.message);
        }
    });
}

// ğŸ†• å–å¾—ç›¸é„°é¥‹ç·š
function getAdjacentFeeders(currentFeeder) {
    const adjacent = [];
    
    const match = currentFeeder.match(/^(\d+[A-Z]+)(\d+)$/);
    if (!match) return adjacent;
    
    const prefix = match[1];
    const number = parseInt(match[2]);
    
    for (let offset = -2; offset <= 2; offset++) {
        if (offset === 0) continue;
        
        const adjacentNumber = number + offset;
        if (adjacentNumber < 1 || adjacentNumber > 99) continue;
        
        const adjacentFeeder = `${prefix}${adjacentNumber.toString().padStart(2, '0')}`;
        
        if (feederList.includes(adjacentFeeder)) {
            adjacent.push(adjacentFeeder);
        }
    }
    
    return adjacent;
}


// ğŸ†• æª”æ¡ˆåç¨±å°æ‡‰åˆ° Google Drive æª”æ¡ˆ ID
// ğŸ†• ä¿®æ”¹å¾Œçš„ getFileIdByName å‡½æ•¸
function getFileIdByName(fileName) {
    const fileId = feederDataMap[fileName];
    if (!fileId) {
        throw new Error(`æ‰¾ä¸åˆ°æª”æ¡ˆ ${fileName} çš„ Google Drive ID`);
    }
    return fileId;
}

// ğŸ†• å¾ Google Sheet JSON API è¼‰å…¥é¥‹ç·šè³‡æ–™
async function loadFeederDataFromSheet() {
    // ğŸ”§ æ›¿æ›ç‚ºæ‚¨çš„ GAS Web App URL
    const gasWebAppUrl = 'https://script.google.com/macros/s/AKfycby6Bx8OuXitOT-6vWxBcOUrvHgWGQIK_DO9F_Db-10uEwKPjw-Hqd8ka5MvTq3Hh68/exec';
    
    try {
        console.log('ğŸ”„ æ­£åœ¨å¾ JSON API è¼‰å…¥é¥‹ç·šè³‡æ–™...');
        
        const response = await fetch(`${gasWebAppUrl}?action=getFeederData&_t=${Date.now()}`);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
        
        if (result.success) {
            feederDataMap = result.data.feederMap;
            feederList = result.data.feederList;
            
            console.log(`âœ… æˆåŠŸè¼‰å…¥ ${result.data.count} å€‹é¥‹ç·šè³‡æ–™`);
            console.log('ğŸ“‹ é¥‹ç·šæ¸…å–®:', feederList);
            console.log('ğŸ•’ æœ€å¾Œæ›´æ–°:', result.data.lastUpdate);
            
            // åˆå§‹åŒ–ä¸‹æ‹‰é¸å–®
            initializeFeederDropdown();
            
            // æ›´æ–°ç‹€æ…‹é¡¯ç¤º
            updateLoadStatus(`âœ… å·²è¼‰å…¥ ${result.data.count} å€‹é¥‹ç·šè³‡æ–™ (${new Date(result.data.lastUpdate).toLocaleString('zh-TW')})`);
            
            return true;
        } else {
            throw new Error(result.error || 'è¼‰å…¥å¤±æ•—');
        }
        
    } catch (error) {
        console.error('âŒ è¼‰å…¥é¥‹ç·šè³‡æ–™å¤±æ•—:', error);
        
        // ğŸ”„ ä½¿ç”¨å‚™ç”¨çš„éœæ…‹æ¸…å–®
        console.log('ğŸ”„ ä½¿ç”¨å‚™ç”¨é¥‹ç·šæ¸…å–®...');
        feederList = [
            '6A22', '6A23', '6A24', '6A25', '6A31', '6A32', '6A33', '6A34', '6A35',
            '6A41', '6A42', '6A43', '6A44', '6A45', '6A51', '6A52', '6A53', '6A54'
            // ... å…¶ä»–é¥‹ç·šåç¨±
        ];
        
        // å»ºç«‹å‚™ç”¨çš„æª”æ¡ˆ ID å°æ‡‰è¡¨ï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰
        feederDataMap = {};
        feederList.forEach(feeder => {
            feederDataMap[`119_${feeder}.json`] = 'backup_file_id'; // é€™è£¡éœ€è¦å¯¦éš›çš„æª”æ¡ˆ ID
        });
        
        initializeFeederDropdown();
        updateLoadStatus(`âš ï¸ ä½¿ç”¨å‚™ç”¨æ¸…å–® (${feederList.length} å€‹é¥‹ç·š)`);
        
        return false;
    }
}
// ğŸ†• æ–°å¢ï¼šæª¢æŸ¥ API å¥åº·ç‹€æ…‹
async function checkAPIHealth() {
    const gasWebAppUrl = 'https://script.google.com/macros/s/æ‚¨çš„GAS_DEPLOYMENT_ID/exec';
    
    try {
        const response = await fetch(`${gasWebAppUrl}?action=health`);
        const result = await response.json();
        
        if (result.success) {
            console.log('âœ… API å¥åº·ç‹€æ…‹è‰¯å¥½:', result.data);
            return true;
        } else {
            console.warn('âš ï¸ API å¥åº·æª¢æŸ¥å¤±æ•—:', result.error);
            return false;
        }
    } catch (error) {
        console.error('âŒ API å¥åº·æª¢æŸ¥éŒ¯èª¤:', error);
        return false;
    }
}

// ğŸ†• å»ºç«‹é€²åº¦æ¢
function createProgressBar() {
    const progressHtml = `
        <div id="loadProgress" style="display: none; margin: 10px 0;">
            <div style="background: #e9ecef; border-radius: 10px; overflow: hidden; height: 8px;">
                <div id="progressBar" style="background: linear-gradient(90deg, #28a745, #20c997); 
                     height: 100%; width: 0%; transition: width 0.3s ease;"></div>
            </div>
            <div id="progressText" style="text-align: center; font-size: 12px; color: #666; margin-top: 4px;">
                è¼‰å…¥ä¸­...
            </div>
        </div>
    `;
    
    const section = document.querySelector('.feeder-selection-section');
    if (section && !document.getElementById('loadProgress')) {
        section.insertAdjacentHTML('beforeend', progressHtml);
    }
}

// ğŸ†• æ›´æ–°é€²åº¦
function updateProgress(percent, text) {
    const progressDiv = document.getElementById('loadProgress');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    
    if (progressDiv && progressBar && progressText) {
        progressDiv.style.display = 'block';
        progressBar.style.width = `${percent}%`;
        progressText.textContent = text;
        
        if (percent >= 100) {
            setTimeout(() => {
                progressDiv.style.display = 'none';
            }, 1000);
        }
    }
}
// ğŸ†• å–å¾—æœ€ä½³ä¸‹è¼‰ URL
// ğŸ”§ ä¿®æ­£ç‰ˆï¼šå–å¾—æœ€ä½³ä¸‹è¼‰ URL
async function getBestDownloadUrl(fileId) {
    // ğŸ†• ä½¿ç”¨ GAS ä½œç‚ºä»£ç†ä¼ºæœå™¨
    const gasWebAppUrl = 'https://script.google.com/macros/s/AKfycby6Bx8OuXitOT-6vWxBcOUrvHgWGQIK_DO9F_Db-10uEwKPjw-Hqd8ka5MvTq3Hh68/exec';
    
    const proxyUrl = `${gasWebAppUrl}?action=getFileContent&fileId=${fileId}`;
    
    console.log(`ğŸ¯ ä½¿ç”¨ GAS ä»£ç†è¼‰å…¥: ${fileId}`);
    return proxyUrl;
}

// ğŸ†• éåŒæ­¥è™•ç† JSON è³‡æ–™
async function processJsonDataAsync(jsonData, fileName) {
    return new Promise((resolve) => {
        const processChunk = (deadline) => {
            const startTime = performance.now();
            
            try {
                processJsonData(jsonData, fileName);
                resolve();
            } catch (error) {
                if (performance.now() - startTime > 16) {
                    console.log('ğŸ”„ åˆ†å‰²è™•ç†å¤§å‹è³‡æ–™...');
                    setTimeout(() => processChunk({ timeRemaining: () => 50 }), 0);
                } else {
                    throw error;
                }
            }
        };
        
        if (window.requestIdleCallback) {
            requestIdleCallback(processChunk);
        } else {
            setTimeout(() => processChunk({ timeRemaining: () => 50 }), 0);
        }
    });
}
// ğŸ†• é è¼‰å…¥ç†±é–€é¥‹ç·š
async function preloadPopularFeeders() {
    const popularFeeders = ['6A22', '6A23', '6A24', '6A25'];
    
    console.log('ğŸ”¥ é è¼‰å…¥ç†±é–€é¥‹ç·š...');
    showToast('ğŸ”¥ é–‹å§‹é è¼‰å…¥ç†±é–€é¥‹ç·š...', 'info');
    
    let successful = 0;
    for (const feeder of popularFeeders) {
        try {
            const fileName = `119_${feeder}.json`;
            if (feederCache.get(fileName)) continue;
            
            const fileId = getFileIdByName(fileName);
            const bestUrl = await getBestDownloadUrl(fileId);
            const jsonData = await fastJsonLoader.loadJsonWithStream(bestUrl);
            feederCache.set(fileName, jsonData);
            successful++;
        } catch (error) {
            console.warn(`é è¼‰å…¥ ${feeder} å¤±æ•—:`, error);
        }
    }
    
    showToast(`ğŸ”¥ å·²é è¼‰å…¥ ${successful} å€‹ç†±é–€é¥‹ç·š`, 'success');
}

// ğŸ†• é¡¯ç¤ºå¿«å–ç‹€æ…‹
function showCacheStats() {
    const stats = feederCache.getStats();
    const localSize = localStorageManager.getStorageSize();
    
    const message = `ğŸ“Š å¿«å–ç‹€æ…‹å ±å‘Š\n\n` +
                   `è¨˜æ†¶é«”å¿«å–: ${stats.count} å€‹æª”æ¡ˆ\n` +
                   `å¿«å–å¤§å°: ${(stats.totalSize / 1024).toFixed(1)} KB\n` +
                   `æœ¬åœ°å„²å­˜: ${(localSize / 1024).toFixed(1)} KB\n\n` +
                   `å¿«å–æª”æ¡ˆ:\n${stats.items.join('\n')}`;
    
    alert(message);
}

// ğŸ†• å¿«å–ç®¡ç†ç³»çµ±
class FeederCache {
    constructor() {
        this.cache = new Map();
        this.maxCacheSize = 10;
        this.cacheExpiry = 30 * 60 * 1000; // 30åˆ†é˜éæœŸ
    }
    
    set(fileName, data) {
        const cacheData = {
            data: data,
            timestamp: Date.now(),
            size: JSON.stringify(data).length
        };
        
        if (this.cache.size >= this.maxCacheSize) {
            const oldestKey = this.cache.keys().next().value;
            this.cache.delete(oldestKey);
            console.log(`ğŸ—‘ï¸ ç§»é™¤èˆŠå¿«å–: ${oldestKey}`);
        }
        
        this.cache.set(fileName, cacheData);
        console.log(`ğŸ’¾ å¿«å–å·²å„²å­˜: ${fileName} (${(cacheData.size/1024).toFixed(1)}KB)`);
    }
    
    get(fileName) {
        const cached = this.cache.get(fileName);
        if (!cached) return null;
        
        if (Date.now() - cached.timestamp > this.cacheExpiry) {
            this.cache.delete(fileName);
            console.log(`â° å¿«å–å·²éæœŸ: ${fileName}`);
            return null;
        }
        
        console.log(`âš¡ ä½¿ç”¨å¿«å–: ${fileName}`);
        return cached.data;
    }
    
    clear() {
        this.cache.clear();
        console.log('ğŸ§¹ å·²æ¸…é™¤æ‰€æœ‰å¿«å–');
    }
    
    getStats() {
        const totalSize = Array.from(this.cache.values())
            .reduce((sum, item) => sum + item.size, 0);
        
        return {
            count: this.cache.size,
            totalSize: totalSize,
            items: Array.from(this.cache.keys())
        };
    }
}

// ğŸ†• é«˜æ•ˆ JSON è™•ç†é¡åˆ¥
// ğŸ”§ ä¿®æ­£ç‰ˆï¼šé«˜æ•ˆ JSON è™•ç†é¡åˆ¥
class FastJsonLoader {
    constructor() {
        this.chunkSize = 1024 * 64;
        this.timeout = 10000;
    }
    
    async loadJsonWithStream(url, onProgress = null) {
        console.log('ğŸŒŠ å•Ÿå‹•è¼‰å…¥...');
        const startTime = Date.now();
        
        try {
            // ğŸ”§ æª¢æŸ¥æ˜¯å¦ç‚º GAS ä»£ç† URL
            if (url.includes('script.google.com')) {
                return await this.loadFromGASProxy(url, onProgress);
            } else {
                return await this.loadDirectly(url, onProgress);
            }
            
        } catch (error) {
            console.error('âŒ è¼‰å…¥å¤±æ•—:', error);
            throw error;
        }
    }
    
    // ğŸ†• å¾ GAS ä»£ç†è¼‰å…¥
    async loadFromGASProxy(url, onProgress = null) {
        console.log('ğŸ”„ ä½¿ç”¨ GAS ä»£ç†è¼‰å…¥...');
        
        if (onProgress) onProgress(10, 'é€£æ¥ GAS ä»£ç†...');
        
        const response = await fetch(url, {
            method: 'GET',
            headers: {
                'Accept': 'application/json'
            }
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        if (onProgress) onProgress(50, 'æ¥æ”¶è³‡æ–™...');
        
        const result = await response.json();
        
        if (onProgress) onProgress(80, 'è§£æè³‡æ–™...');
        
        if (!result.success) {
            throw new Error(result.error || 'è¼‰å…¥å¤±æ•—');
        }
        
        if (onProgress) onProgress(100, 'è¼‰å…¥å®Œæˆ');
        
        console.log(`âœ… GAS ä»£ç†è¼‰å…¥æˆåŠŸ: ${result.data.fileName}`);
        return result.data.data; // è¿”å›å¯¦éš›çš„ JSON è³‡æ–™
    }
    
    // ğŸ†• ç›´æ¥è¼‰å…¥ï¼ˆå‚™ç”¨æ–¹æ¡ˆï¼‰
    async loadDirectly(url, onProgress = null) {
        console.log('ğŸ”„ ç›´æ¥è¼‰å…¥...');
        
        const response = await fetch(url, {
            headers: {
                'Cache-Control': 'no-cache',
                'Accept': 'application/json'
            }
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const contentLength = response.headers.get('content-length');
        const total = contentLength ? parseInt(contentLength) : 0;
        let loaded = 0;
        
        const reader = response.body.getReader();
        const chunks = [];
        
        while (true) {
            const { done, value } = await reader.read();
            
            if (done) break;
            
            chunks.push(value);
            loaded += value.length;
            
            if (onProgress && total > 0) {
                const percent = Math.round((loaded / total) * 100);
                onProgress(percent, `è¼‰å…¥ä¸­... ${this.formatBytes(loaded)}/${this.formatBytes(total)}`);
            }
        }
        
        const totalLength = chunks.reduce((sum, chunk) => sum + chunk.length, 0);
        const combined = new Uint8Array(totalLength);
        let offset = 0;
        
        for (const chunk of chunks) {
            combined.set(chunk, offset);
            offset += chunk.length;
        }
        
        const text = new TextDecoder().decode(combined);
        
        // ğŸ”§ æª¢æŸ¥æ˜¯å¦ç‚º HTMLï¼ˆGoogle Drive ç™»å…¥é é¢ï¼‰
        if (text.trim().startsWith('<!DOCTYPE') || text.trim().startsWith('<html')) {
            throw new Error('æ”¶åˆ° HTML å›æ‡‰è€Œé JSON æª”æ¡ˆï¼Œå¯èƒ½éœ€è¦ç™»å…¥ Google Drive');
        }
        
        const jsonData = JSON.parse(text);
        
        const loadTime = ((Date.now() - Date.now()) / 1000).toFixed(2);
        console.log(`âš¡ ç›´æ¥è¼‰å…¥å®Œæˆ: ${loadTime}ç§’, å¤§å°: ${this.formatBytes(totalLength)}`);
        
        return jsonData;
    }
    
    formatBytes(bytes) {
        if (bytes === 0) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
    }
}

// ğŸ†• æœ¬åœ°å„²å­˜ç®¡ç†
class LocalStorageManager {
    constructor() {
        this.prefix = 'feeder_';
        this.maxSize = 50 * 1024 * 1024; // 50MB é™åˆ¶
    }
    
    async saveToLocal(fileName, data) {
        try {
            const compressed = this.compressData(data);
            const key = this.prefix + fileName;
            
            if (this.getStorageSize() + compressed.length > this.maxSize) {
                this.cleanOldData();
            }
            
            localStorage.setItem(key, compressed);
            localStorage.setItem(key + '_timestamp', Date.now().toString());
            
            console.log(`ğŸ’¾ å·²å„²å­˜åˆ°æœ¬åœ°: ${fileName}`);
            
        } catch (error) {
            console.warn('âš ï¸ æœ¬åœ°å„²å­˜å¤±æ•—:', error);
        }
    }
    
    loadFromLocal(fileName) {
        try {
            const key = this.prefix + fileName;
            const compressed = localStorage.getItem(key);
            const timestamp = localStorage.getItem(key + '_timestamp');
            
            if (!compressed || !timestamp) return null;
            
            const age = Date.now() - parseInt(timestamp);
            if (age > 24 * 60 * 60 * 1000) {
                this.removeFromLocal(fileName);
                return null;
            }
            
            const data = this.decompressData(compressed);
            console.log(`ğŸ“± å¾æœ¬åœ°è¼‰å…¥: ${fileName}`);
            return data;
            
        } catch (error) {
            console.warn('âš ï¸ æœ¬åœ°è¼‰å…¥å¤±æ•—:', error);
            return null;
        }
    }
    
    compressData(data) {
        return JSON.stringify(data);
    }
    
    decompressData(compressed) {
        return JSON.parse(compressed);
    }
    
    getStorageSize() {
        let total = 0;
        for (let key in localStorage) {
            if (key.startsWith(this.prefix)) {
                total += localStorage[key].length;
            }
        }
        return total;
    }
    
    cleanOldData() {
        const items = [];
        for (let key in localStorage) {
            if (key.startsWith(this.prefix) && key.endsWith('_timestamp')) {
                const timestamp = parseInt(localStorage[key]);
                items.push({ key: key.replace('_timestamp', ''), timestamp });
            }
        }
        
        items.sort((a, b) => a.timestamp - b.timestamp);
        const toRemove = items.slice(0, Math.ceil(items.length / 3));
        
        toRemove.forEach(item => {
            localStorage.removeItem(item.key);
            localStorage.removeItem(item.key + '_timestamp');
        });
        
        console.log(`ğŸ§¹ æ¸…ç†äº† ${toRemove.length} å€‹èˆŠæª”æ¡ˆ`);
    }
    
    removeFromLocal(fileName) {
        const key = this.prefix + fileName;
        localStorage.removeItem(key);
        localStorage.removeItem(key + '_timestamp');
    }
}


let isFollowingLocation = false; // æ”¹å
let locationWatchId = null; // æ”¹å
let lastKnownPosition = null; // æ–°å¢

// æ–°å¢ï¼šæ¸¬é‡å·¥å…·ç›¸é—œè®Šæ•¸
let measureDistanceMode = false;
let measureMarkers = [];
let measureLines = [];


// ğŸ”§ ä¿®æ­£ç‰ˆï¼šè·Ÿéš¨è£ç½®ä½ç½®åˆ‡æ›å‡½æ•¸ - åŠ å…¥åœ–å±¤åˆ·æ–°
function toggleFollowLocation() {
    console.log('ğŸ“± åˆ‡æ›è·Ÿéš¨ä½ç½®ï¼Œç•¶å‰ç‹€æ…‹:', isFollowingLocation);
    
    if (!isFollowingLocation) {
        startFollowingLocation();
    } else {
        stopFollowingLocation();
    }
}

// ğŸ”§ ä¿®æ­£ç‰ˆï¼šè·Ÿéš¨ä½ç½®åŠŸèƒ½ - é¿å…é–ƒå±
function startFollowingLocation() {
    console.log('ğŸ“± é–‹å§‹è·Ÿéš¨è£ç½®ä½ç½®...');
    
    if (!navigator.geolocation) {
        showToast('âŒ æ‚¨çš„è£ç½®ä¸æ”¯æ´å®šä½åŠŸèƒ½', 'error');
        return;
    }
    
    isFollowingLocation = true;
    
    const btn = document.getElementById('followLocationBtn');
    if (btn) {
        btn.classList.add('active');
        btn.textContent = 'ğŸ›‘ åœæ­¢è·Ÿéš¨';
        btn.style.backgroundColor = '#dc3545';
        btn.style.color = 'white';
    }
    
    locationWatchId = navigator.geolocation.watchPosition(
        function(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            const accuracy = position.coords.accuracy;
            const currentPosition = L.latLng(lat, lng);
            
            console.log(`ğŸ“ ä½ç½®æ›´æ–°: ${lat.toFixed(6)}, ${lng.toFixed(6)}, ç²¾åº¦: ${accuracy}m`);
            
            // ğŸ”§ å¢åŠ è·é›¢é–¾å€¼ï¼Œæ¸›å°‘æ›´æ–°é »ç‡
            if (lastKnownPosition && lastKnownPosition.distanceTo(currentPosition) < 20) {
                return;
            }
            
            lastKnownPosition = currentPosition;
            
            // æ›´æ–°ä½ç½®æ¨™è¨˜
            if (!userLocationMarker) {
                const locationIcon = L.divIcon({
                    html: '<div class="location-marker"><div class="center-dot"></div></div>',
                    className: 'custom-location-icon',
                    iconSize: [40, 40],
                    iconAnchor: [20, 20]
                });
                
                userLocationMarker = L.marker([lat, lng], {
                    icon: locationIcon,
                    zIndexOffset: 1000
                }).addTo(map);
            } else {
                userLocationMarker.setLatLng([lat, lng]);
            }
            
            // ğŸ”§ é‡è¦ï¼šä½¿ç”¨å¹³æ»‘ç§»å‹•ï¼Œé¿å…åœ–å±¤åˆ·æ–°
            const targetZoom = Math.max(map.getZoom(), 16);
            
            // ä½¿ç”¨ flyTo è€Œä¸æ˜¯ setViewï¼Œæä¾›å¹³æ»‘å‹•ç•«
            map.flyTo([lat, lng], targetZoom, {
                animate: true,
                duration: 1.5
            });
            
            // ğŸ”§ ç§»é™¤å»¶é²åˆ·æ–°åœ–å±¤çš„é‚è¼¯
            // setTimeout(() => {
            //     refreshCurrentLayer();
            // }, 200);
            
        },
        function(error) {
            console.error('ä½ç½®ç›£æ§éŒ¯èª¤:', error);
            let errorMessage = 'âŒ ä½ç½®ç›£æ§å¤±æ•—';
            
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    errorMessage = 'âŒ å®šä½æ¬Šé™è¢«æ‹’çµ•';
                    break;
                case error.POSITION_UNAVAILABLE:
                    errorMessage = 'âŒ ä½ç½®è³‡è¨Šç„¡æ³•å–å¾—';
                    break;
                case error.TIMEOUT:
                    errorMessage = 'âŒ å®šä½è«‹æ±‚è¶…æ™‚';
                    break;
            }
            
            showToast(errorMessage, 'error');
            stopFollowingLocation();
        },
        {
            enableHighAccuracy: true,
            maximumAge: 10000,  // ğŸ”§ å¢åŠ å¿«å–æ™‚é–“
            timeout: 20000
        }
    );
    
    showToast('ğŸ“± é–‹å§‹è·Ÿéš¨è£ç½®ä½ç½®', 'success');
}

function stopFollowingLocation() {
    console.log('ğŸ›‘ åœæ­¢è·Ÿéš¨è£ç½®ä½ç½®...');
    
    if (locationWatchId) {
        navigator.geolocation.clearWatch(locationWatchId);
        locationWatchId = null;
    }
    
    isFollowingLocation = false;
    lastKnownPosition = null;
    
    // é‡ç½®æŒ‰éˆ•ç‹€æ…‹
    const btn = document.getElementById('followLocationBtn');
    if (btn) {
        btn.classList.remove('active');
        btn.textContent = 'ğŸ“± è·Ÿéš¨ä½ç½®';
        btn.style.backgroundColor = '';
        btn.style.color = '';
    }
    
    showToast('ğŸ›‘ å·²åœæ­¢è·Ÿéš¨è£ç½®ä½ç½®', 'info');
}




// æ–°å¢ï¼šåœ–å±¤åˆ‡æ›åŠŸèƒ½
function initializeLayerSwitcher() {
    const baseLayerRadios = document.querySelectorAll('input[name="baseLayer"]');
    
    baseLayerRadios.forEach(radio => {
        radio.addEventListener('change', function() {
            if (this.checked) {
                switchBaseLayer(this.value);
            }
        });
    });
}

function switchBaseLayer(layerName) {
    // ç§»é™¤ç•¶å‰åŸºç¤åœ–å±¤
    if (window.currentBaseLayer) {
        map.removeLayer(window.currentBaseLayer);
    }
    
    // åŠ å…¥æ–°çš„åŸºç¤åœ–å±¤
    if (window.mapLayers[layerName]) {
        window.currentBaseLayer = window.mapLayers[layerName].addTo(map);
        console.log(`ğŸ—ºï¸ åˆ‡æ›åˆ°åœ–å±¤: ${layerName}`);
        showToast(`ğŸ—ºï¸ å·²åˆ‡æ›åˆ° ${getLayerDisplayName(layerName)}`, 'success');
    }
}

function getLayerDisplayName(layerName) {
    const names = {
        googleStreets: 'Google è¡—æ™¯åœ–',
        googleSatellite: 'Google è¡›æ˜Ÿå½±åƒ',
        googleHybrid: 'Google æ··åˆåœ–',
        openStreetMap: 'OpenStreetMap',
        nlscMap: 'åœ‹åœŸæ¸¬ç¹ªé›»å­åœ°åœ–',
        nlscPhoto: 'åœ‹åœŸæ¸¬ç¹ªæ­£å°„å½±åƒ',
        cartoDB: 'CartoDB æ·¡è‰²',
        stamen: 'Stamen é»‘ç™½',
        esriSatellite: 'Esri è¡›æ˜Ÿå½±åƒ'
    };
    return names[layerName] || layerName;
}

// æ–°å¢ï¼šç–ŠåŠ åœ–å±¤æ§åˆ¶
function toggleTrafficLayer() {
    const checkbox = document.getElementById('trafficLayer');
    
    if (checkbox.checked) {
        // åŠ å…¥äº¤é€šè·¯æ³åœ–å±¤ï¼ˆä½¿ç”¨ Google äº¤é€šè³‡è¨Šï¼‰
        if (!window.overlayLayers.traffic) {
            window.overlayLayers.traffic = L.tileLayer('https://{s}.google.com/vt/lyrs=h@{time}&x={x}&y={y}&z={z}', {
                maxZoom: 22,
                subdomains: ['mt0', 'mt1', 'mt2', 'mt3'],
                time: Date.now(),
                opacity: 0.7
            });
        }
        window.overlayLayers.traffic.addTo(map);
        showToast('ğŸš¦ å·²é–‹å•Ÿäº¤é€šè·¯æ³', 'info');
    } else {
        if (window.overlayLayers.traffic) {
            map.removeLayer(window.overlayLayers.traffic);
        }
        showToast('ğŸš¦ å·²é—œé–‰äº¤é€šè·¯æ³', 'info');
    }
}

function toggleWeatherLayer() {
    const checkbox = document.getElementById('weatherLayer');
    
    if (checkbox.checked) {
        // åŠ å…¥å¤©æ°£é›·é”åœ–å±¤
        if (!window.overlayLayers.weather) {
            window.overlayLayers.weather = L.tileLayer('https://tile.openweathermap.org/map/precipitation_new/{z}/{x}/{y}.png?appid=YOUR_API_KEY', {
                maxZoom: 22,
                opacity: 0.6,
                attribution: 'Â© OpenWeatherMap'
            });
        }
        window.overlayLayers.weather.addTo(map);
        showToast('ğŸŒ§ï¸ å·²é–‹å•Ÿå¤©æ°£é›·é”', 'info');
    } else {
        if (window.overlayLayers.weather) {
            map.removeLayer(window.overlayLayers.weather);
        }
        showToast('ğŸŒ§ï¸ å·²é—œé–‰å¤©æ°£é›·é”', 'info');
    }
}

function toggleTerrainLayer() {
    const checkbox = document.getElementById('terrainLayer');
    
    if (checkbox.checked) {
        // åŠ å…¥åœ°å½¢ç­‰é«˜ç·šåœ–å±¤
        if (!window.overlayLayers.terrain) {
            window.overlayLayers.terrain = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
                maxZoom: 22,
                opacity: 0.5,
                attribution: 'Â© OpenTopoMap'
            });
        }
        window.overlayLayers.terrain.addTo(map);
        showToast('ğŸ”ï¸ å·²é–‹å•Ÿåœ°å½¢ç­‰é«˜ç·š', 'info');
    } else {
        if (window.overlayLayers.terrain) {
            map.removeLayer(window.overlayLayers.terrain);
        }
        showToast('ğŸ”ï¸ å·²é—œé–‰åœ°å½¢ç­‰é«˜ç·š', 'info');
    }
}

// æ–°å¢ï¼šèª¿æ•´åœ–å±¤é€æ˜åº¦
function adjustLayerOpacity(value) {
    const opacity = value / 100;
    document.getElementById('opacityValue').textContent = value + '%';
    
    if (window.currentBaseLayer) {
        window.currentBaseLayer.setOpacity(opacity);
    }
}

// ğŸ”§ ä¿®æ­£ç‰ˆï¼šå…¨è¢å¹•åŠŸèƒ½ - ç§»é™¤é‡æ–°è¼‰å…¥é‚è¼¯
function toggleFullscreen() {
    const btn = document.querySelector('.fullscreen-btn');
    
    if (!document.fullscreenElement && !document.webkitFullscreenElement && !document.mozFullScreenElement) {
        // é€²å…¥å…¨è¢å¹•
        const element = document.documentElement;
        
        if (element.requestFullscreen) {
            element.requestFullscreen();
        } else if (element.webkitRequestFullscreen) {
            element.webkitRequestFullscreen();
        } else if (element.mozRequestFullScreen) {
            element.mozRequestFullScreen();
        } else if (element.msRequestFullscreen) {
            element.msRequestFullscreen();
        }
        
    } else {
        // é€€å‡ºå…¨è¢å¹•
        if (document.exitFullscreen) {
            document.exitFullscreen();
        } else if (document.webkitExitFullscreen) {
            document.webkitExitFullscreen();
        } else if (document.mozCancelFullScreen) {
            document.mozCancelFullScreen();
        } else if (document.msExitFullscreen) {
            document.msExitFullscreen();
        }
    }
}

// ğŸ”§ ä¿®æ­£ç‰ˆï¼šå…¨è¢å¹•ç‹€æ…‹è®ŠåŒ–è™•ç† - ç§»é™¤é‡æ–°è¼‰å…¥
function handleFullscreenChange() {
    const btn = document.querySelector('.fullscreen-btn');
    const body = document.body;
    
    const isFullscreen = !!(document.fullscreenElement || 
                           document.webkitFullscreenElement || 
                           document.mozFullScreenElement || 
                           document.msFullscreenElement);
    
    if (isFullscreen) {
        // é€²å…¥å…¨è¢å¹•æ¨¡å¼
        btn.textContent = 'ğŸ”³ é€€å‡ºå…¨è¢å¹•';
        btn.title = 'é»æ“Šé€€å‡ºå…¨è¢å¹•æ¨¡å¼ (æˆ–æŒ‰ ESC)';
        body.classList.add('fullscreen-mode');
        showToast('ğŸ”² å·²é€²å…¥å…¨è¢å¹•æ¨¡å¼ï¼Œé»æ“Šå·¦ä¸Šè§’æŒ‰éˆ•æˆ–æŒ‰ ESC é€€å‡º', 'info');
        
        // ğŸ”§ èª¿æ•´åœ°åœ–å¤§å°ä½†ä¸é‡æ–°è¼‰å…¥
        setTimeout(() => {
            if (map) {
                map.invalidateSize();
                console.log('ğŸ—ºï¸ åœ°åœ–å¤§å°å·²èª¿æ•´ï¼ˆå…¨è¢å¹•æ¨¡å¼ï¼‰');
            }
        }, 100);
        
    } else {
        // é€€å‡ºå…¨è¢å¹•æ¨¡å¼
        btn.textContent = 'ğŸ”² å…¨è¢å¹•';
        btn.title = 'é»æ“Šé€²å…¥å…¨è¢å¹•æ¨¡å¼';
        body.classList.remove('fullscreen-mode');
        showToast('ğŸ”³ å·²é€€å‡ºå…¨è¢å¹•æ¨¡å¼', 'info');
        
        // ğŸ”§ èª¿æ•´åœ°åœ–å¤§å°ä½†ä¸é‡æ–°è¼‰å…¥
        setTimeout(() => {
            if (map) {
                map.invalidateSize();
                console.log('ğŸ—ºï¸ åœ°åœ–å¤§å°å·²èª¿æ•´ï¼ˆä¸€èˆ¬æ¨¡å¼ï¼‰');
            }
        }, 100);
    }
}


// ğŸ†• ç¶å®šå…¨è¢å¹•äº‹ä»¶ç›£è½å™¨
document.addEventListener('fullscreenchange', handleFullscreenChange);
document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
document.addEventListener('mozfullscreenchange', handleFullscreenChange);
document.addEventListener('MSFullscreenChange', handleFullscreenChange);

// ğŸ†• ESC éµé€€å‡ºå…¨è¢å¹•æç¤º
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && (document.fullscreenElement || document.webkitFullscreenElement)) {
        showToast('ğŸ”³ æŒ‰ ESC éµé€€å‡ºå…¨è¢å¹•', 'info');
    }
});
// æ–°å¢ï¼šæ¸¬é‡å·¥å…·åˆå§‹åŒ–
function initializeMeasureTools() {
    // åˆå§‹åŒ–æ¸¬é‡ç›¸é—œçš„åœ°åœ–äº‹ä»¶ç›£è½
    map.on('click', handleMapClick);
}

function toggleMeasureDistance() {
    const btn = document.getElementById('measureDistanceBtn');
    
    if (measureDistanceMode) {
        measureDistanceMode = false;
        btn.classList.remove('active');
        btn.textContent = 'ğŸ“ æ¸¬è·';
        map.getContainer().style.cursor = '';
    } else {
        measureDistanceMode = true;
        measureAreaMode = false;
        btn.classList.add('active');
        btn.textContent = 'â¹ï¸ åœæ­¢æ¸¬è·';
        document.getElementById('measureAreaBtn').classList.remove('active');
        document.getElementById('measureAreaBtn').textContent = 'ğŸ“ æ¸¬é¢ç©';
        map.getContainer().style.cursor = 'crosshair';
        showToast('ğŸ“ é»æ“Šåœ°åœ–é–‹å§‹æ¸¬è·', 'info');
    }
}

function handleMapClick(e) {
    if (measureDistanceMode) {
        addMeasurePoint(e.latlng, 'distance');
    }
}

function addMeasurePoint(latlng, type) {
    const marker = L.circleMarker(latlng, {
        radius: 5,
        fillColor: '#ff0000',
        color: '#ffffff',
        weight: 2,
        opacity: 1,
        fillOpacity: 0.8
    }).addTo(map);
    
    measureMarkers.push(marker);
    
    if (measureMarkers.length >= 2) {
        drawDistanceLine();
    }
}


function drawDistanceLine() {
    if (measureMarkers.length < 2) return;
    
    const points = measureMarkers.map(marker => marker.getLatLng());
    const line = L.polyline(points, {color: 'red', weight: 3}).addTo(map);
    measureLines.push(line);
    
    // è¨ˆç®—ç¸½è·é›¢
    let totalDistance = 0;
    for (let i = 1; i < points.length; i++) {
        totalDistance += points[i-1].distanceTo(points[i]);
    }
    
    const distanceText = totalDistance > 1000 ? 
        `${(totalDistance/1000).toFixed(2)} å…¬é‡Œ` : 
        `${totalDistance.toFixed(0)} å…¬å°º`;
    
    // åœ¨ç·šæ®µä¸­é»é¡¯ç¤ºè·é›¢
    const midpoint = points[Math.floor(points.length/2)];
    const popup = L.popup()
        .setLatLng(midpoint)
        .setContent(`ğŸ“ è·é›¢: ${distanceText}`)
        .openOn(map);
}



function clearMeasurements() {
    // æ¸…é™¤æ‰€æœ‰æ¸¬é‡æ¨™è¨˜
    measureMarkers.forEach(marker => map.removeLayer(marker));
    measureMarkers = [];
    
    // æ¸…é™¤æ‰€æœ‰æ¸¬é‡ç·šæ®µ
    measureLines.forEach(line => map.removeLayer(line));
    measureLines = [];
    
    // é—œé–‰æ¸¬é‡æ¨¡å¼
    measureDistanceMode = false;
    
    // é‡ç½®æŒ‰éˆ•ç‹€æ…‹
    document.getElementById('measureDistanceBtn').classList.remove('active');
    document.getElementById('measureDistanceBtn').textContent = 'ğŸ“ æ¸¬è·';
    
    // é‡ç½®æ»‘é¼ æ¸¸æ¨™
    map.getContainer().style.cursor = '';
    
    // é—œé–‰æ‰€æœ‰å½ˆå‡ºè¦–çª—
    map.closePopup();
    
    showToast('ğŸ—‘ï¸ å·²æ¸…é™¤æ‰€æœ‰æ¸¬é‡', 'info');
}






// æ–°å¢ï¼šå¾ URL è¼‰å…¥åœ°åœ–ä½ç½®
function loadMapFromURL() {
    const hash = window.location.hash.substring(1);
    if (hash) {
        const parts = hash.split('/');
        if (parts.length >= 3) {
            const zoom = parseFloat(parts[0]);
            const lat = parseFloat(parts[1]);
            const lng = parseFloat(parts[2]);
            const bearing = parts[3] ? parseFloat(parts[3]) : 0;
            
            if (!isNaN(zoom) && !isNaN(lat) && !isNaN(lng)) {
                map.setView([lat, lng], zoom);
                if (!isNaN(bearing)) {
                    setMapRotation(bearing);
                }
            }
        }
    }
}


// æ–°å¢ï¼šè‡ªè¨‚æ¨™è¨˜åŠŸèƒ½
let customMarkers = [];

function addCustomMarker(lat, lng) {
    const markerText = prompt('è«‹è¼¸å…¥æ¨™è¨˜åç¨±:', 'è‡ªè¨‚æ¨™è¨˜');
    if (markerText) {
        const marker = L.marker([lat, lng], {
            icon: L.icon({
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                shadowSize: [41, 41]
            })
        }).addTo(map);
        
        marker.bindPopup(`
            <div style="text-align: center;">
                <h4>ğŸ“Œ ${markerText}</h4>
                <p><strong>åº§æ¨™:</strong> ${lat.toFixed(6)}, ${lng.toFixed(6)}</p>
                <button onclick="removeCustomMarker(this)" data-marker-id="${customMarkers.length}"
                        style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer;">
                    ğŸ—‘ï¸ åˆªé™¤æ¨™è¨˜
                </button>
            </div>
        `).openPopup();
        
        customMarkers.push(marker);
        showToast(`ğŸ“Œ å·²æ–°å¢æ¨™è¨˜: ${markerText}`, 'success');
    }
}

function removeCustomMarker(button) {
    const markerId = parseInt(button.getAttribute('data-marker-id'));
    if (customMarkers[markerId]) {
        map.removeLayer(customMarkers[markerId]);
        customMarkers[markerId] = null;
        map.closePopup();
        showToast('ğŸ—‘ï¸ å·²åˆªé™¤æ¨™è¨˜', 'info');
    }
}

// æ–°å¢ï¼šæ‰¹æ¬¡æ¸…é™¤è‡ªè¨‚æ¨™è¨˜
function clearAllCustomMarkers() {
    customMarkers.forEach(marker => {
        if (marker) {
            map.removeLayer(marker);
        }
    });
    customMarkers = [];
    showToast('ğŸ—‘ï¸ å·²æ¸…é™¤æ‰€æœ‰è‡ªè¨‚æ¨™è¨˜', 'info');
}

// æ–°å¢ï¼šåŒ¯å‡ºåœ°åœ–ç‚ºåœ–ç‰‡åŠŸèƒ½
function exportMapAsImage() {
    // ä½¿ç”¨ html2canvas æˆ–é¡ä¼¼åº«ä¾†æˆªåœ–
    // é€™è£¡æä¾›ä¸€å€‹ç°¡åŒ–ç‰ˆæœ¬
    showToast('ğŸ“¸ åœ°åœ–æˆªåœ–åŠŸèƒ½é–‹ç™¼ä¸­...', 'info');
}

// æ–°å¢ï¼šåˆ†äº«åœ°åœ–ä½ç½®åŠŸèƒ½
function shareMapLocation() {
    const center = map.getCenter();
    const zoom = map.getZoom();
    const bearing = currentRotation;
    
    const shareUrl = `${window.location.origin}${window.location.pathname}#${zoom}/${center.lat.toFixed(6)}/${center.lng.toFixed(6)}/${bearing}`;
    
    if (navigator.share) {
        navigator.share({
            title: 'é¥‹ç·šåœ–åœ°åœ–ä½ç½®',
            text: `æŸ¥çœ‹é€™å€‹åœ°åœ–ä½ç½® (ç¸®æ”¾: ${zoom}, æ–¹ä½: ${Math.round(bearing)}Â°)`,
            url: shareUrl
        });
    } else {
        // å‚™ç”¨æ–¹æ¡ˆï¼šè¤‡è£½åˆ°å‰ªè²¼ç°¿
        navigator.clipboard.writeText(shareUrl).then(() => {
            showToast('ğŸ”— åœ°åœ–ä½ç½®é€£çµå·²è¤‡è£½åˆ°å‰ªè²¼ç°¿', 'success');
        });
    }
}

// é é¢è¼‰å…¥å®Œæˆå¾Œçš„é¡å¤–åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    // è¼‰å…¥ URL ä¸­çš„åœ°åœ–ä½ç½®
    setTimeout(loadMapFromURL, 1000);
    
    // ç›£è½å…¨è¢å¹•è®ŠåŒ–
    document.addEventListener('fullscreenchange', function() {
        setTimeout(() => {
            map.invalidateSize();
        }, 100);
    });
    
    // ç›£è½è¦–çª—å¤§å°è®ŠåŒ–
    window.addEventListener('resize', function() {
        setTimeout(() => {
            map.invalidateSize();
        }, 100);
    });
});

// åœ–å±¤é¸å–®æ§åˆ¶
function toggleLayerMenu() {
    const menu = document.getElementById('layerMenu');
    const isVisible = menu.style.display !== 'none';
    menu.style.display = isVisible ? 'none' : 'block';
}



// ğŸ†• æ–°å¢ï¼šç–ŠåŠ åœ–å±¤æ§åˆ¶å‡½æ•¸
// ğŸ”§ ä¿®æ”¹ï¼šç§»é™¤ checkbox ä¾è³´çš„ç‰ˆæœ¬
function toggleOverlayLayer(layerName, forceState = null) {
    const layer = window.overlayLayers[layerName];
    if (!layer) {
        console.warn(`æ‰¾ä¸åˆ°åœ–å±¤: ${layerName}`);
        showToast(`âŒ åœ–å±¤ ${layerName} æš«æ™‚ç„¡æ³•ä½¿ç”¨`, 'error');
        return;
    }
    
    // æª¢æŸ¥åœ–å±¤æ˜¯å¦å·²åœ¨åœ°åœ–ä¸Š
    const isLayerOnMap = map.hasLayer(layer);
    const shouldAdd = forceState !== null ? forceState : !isLayerOnMap;
    
    if (shouldAdd && !isLayerOnMap) {
        layer.addTo(map);
        showToast(`âœ… å·²é–‹å•Ÿ ${getOverlayDisplayName(layerName)}`, 'success');
        console.log(`ğŸ—ºï¸ é–‹å•Ÿåœ–å±¤: ${layerName}`);
    } else if (!shouldAdd && isLayerOnMap) {
        map.removeLayer(layer);
        showToast(`âŒ å·²é—œé–‰ ${getOverlayDisplayName(layerName)}`, 'info');
        console.log(`ğŸ—ºï¸ é—œé–‰åœ–å±¤: ${layerName}`);
    }
    
    return !isLayerOnMap; // å›å‚³æ–°çš„ç‹€æ…‹
}

// ğŸ†• æ–°å¢ï¼šç›´æ¥æ§åˆ¶åœ–å±¤çš„ä¾¿åˆ©å‡½å¼
function showOverlayLayer(layerName) {
    return toggleOverlayLayer(layerName, true);
}

function hideOverlayLayer(layerName) {
    return toggleOverlayLayer(layerName, false);
}

// ğŸ†• æ–°å¢ï¼šæ‰¹æ¬¡æ§åˆ¶åœ–å±¤
function toggleMultipleLayers(layerNames, state = null) {
    layerNames.forEach(layerName => {
        toggleOverlayLayer(layerName, state);
    });
}


// ğŸ†• æ–°å¢ï¼šå–å¾—ç–ŠåŠ åœ–å±¤é¡¯ç¤ºåç¨±
function getOverlayDisplayName(layerName) {
    const names = {
        roadNetwork: 'è·¯ç¶²åœ–å±¤',
        railway: 'éµè·¯åœ–å±¤',
        landmark: 'å…¬æœ‰åœŸåœ°åœ–',
        cadastre: 'è¡Œæ”¿å€ç•Œåœ–',
        section: 'æ®µç±åœ–',
        village: 'æ‘é‡Œç•Œåœ–',
        wayMeter: 'å…¬è·¯é‡Œç¨‹æ¨™èªŒ',
        kaohsiungSlope: 'é«˜é›„å±±å¡åœ°ç¯„åœ',
        urbanPlan: 'é«˜é›„å¸‚éƒ½å¸‚è¨ˆç•«åœ–',
        urbanPlanBoundary: 'é«˜é›„å¸‚éƒ½å¸‚è¨ˆç•«ç¯„åœåœ–',
        trafficNetwork: 'åœ‹åœŸè¨ˆç•«åœ–',
        cadastral: 'åœ°ç±åœ–åŠé‡åŠƒå€åœ–', // ğŸ†• åŠ å…¥é€™ä¸€è¡Œ
		sewerSystem: 'ä¸‹æ°´é“ç®¡ç·š',
		sewerManholes: 'é›¨æ°´ç«£å·¥äººå­”'
    };
    return names[layerName] || layerName;
}


// ğŸ†• æ‰‹æ©Ÿç‰ˆå°èˆªåŠŸèƒ½
// ğŸ”§ ä¿®æ­£ç‰ˆï¼šæ‰‹æ©Ÿç‰ˆå°èˆªåˆå§‹åŒ– - åŠ å…¥åœ–å±¤æ¨™ç±¤
function initMobileNavigation() {
  console.log('ğŸ“± åˆå§‹åŒ–æ‰‹æ©Ÿç‰ˆå°èˆª...');
  
  // æª¢æŸ¥æ˜¯å¦ç‚ºæ‰‹æ©Ÿç‰ˆ
  const isMobile = window.innerWidth <= 768;
  if (!isMobile) {
      console.log('ğŸ–¥ï¸ éæ‰‹æ©Ÿç‰ˆï¼Œè·³éæ‰‹æ©Ÿå°èˆªåˆå§‹åŒ–');
      return;
  }
  
  const mobileNav = document.querySelector('.mobile-nav');
  const sidebar = document.querySelector('.sidebar');
  const mapContainer = document.querySelector('.map-container');
  
  if (!mobileNav || !sidebar || !mapContainer) {
      console.error('âŒ æ‰‹æ©Ÿç‰ˆå°èˆªå…ƒç´ æœªæ‰¾åˆ°');
      return;
  }
  
  // ç«‹å³å•Ÿç”¨å°èˆªåŠŸèƒ½
  mobileNav.style.display = 'flex';
  
  // é è¨­é¡¯ç¤ºåœ°åœ–
  showMobileTab('map');
  
  // ç¶å®šå°èˆªæ¨™ç±¤é»æ“Šäº‹ä»¶
  const navTabs = mobileNav.querySelectorAll('.nav-tab');
  navTabs.forEach(tab => {
      // ğŸ”§ ç§»é™¤èˆŠçš„äº‹ä»¶ç›£è½å™¨ï¼ˆé¿å…é‡è¤‡ç¶å®šï¼‰
      tab.removeEventListener('click', handleTabClick);
      
      // é‡æ–°ç¶å®šäº‹ä»¶
      tab.addEventListener('click', handleTabClick);
  });
  
  console.log('âœ… æ‰‹æ©Ÿç‰ˆå°èˆªåˆå§‹åŒ–å®Œæˆï¼ˆåŒ…å«åœ–å±¤æ¨™ç±¤ï¼‰');
}
// ğŸ†• æ¨™ç±¤é»æ“Šè™•ç†å‡½æ•¸
function handleTabClick(event) {
    const tabName = event.target.dataset.tab;
    const navTabs = document.querySelectorAll('.nav-tab');
    
    // ç§»é™¤æ‰€æœ‰å•Ÿç”¨ç‹€æ…‹
    navTabs.forEach(t => t.classList.remove('active'));
    
    // å•Ÿç”¨ç•¶å‰æ¨™ç±¤
    event.target.classList.add('active');
    
    // é¡¯ç¤ºå°æ‡‰å…§å®¹
    showMobileTab(tabName);
    
    console.log(`ğŸ“± åˆ‡æ›åˆ°æ¨™ç±¤: ${tabName}`);
}

// ğŸ”§ ä¿®æ­£ç‰ˆï¼šé¡¯ç¤ºæ‰‹æ©Ÿç‰ˆæ¨™ç±¤å…§å®¹
function showMobileTab(tabName) {
  const sidebar = document.querySelector('.sidebar');
  const mapContainer = document.querySelector('.map-container');
  
  if (!sidebar || !mapContainer) return;
  
  // éš±è—æ‰€æœ‰å…§å®¹
  sidebar.style.display = 'none';
  mapContainer.style.display = 'none';
  
  switch(tabName) {
      case 'map':
          mapContainer.style.display = 'block';
          break;
          
      case 'controls':
          sidebar.style.display = 'block';
          // ğŸ”§ ä¿®æ­£ï¼šéš±è—åœ–å±¤æ§åˆ¶ï¼Œé¡¯ç¤ºä¸»è¦æ§åˆ¶åŠŸèƒ½
          hideLayerControlsInMobile();
          break;
          
      case 'layers':
          sidebar.style.display = 'block';
          // ğŸ”§ ä¿®æ­£ï¼šéš±è—ä¸»è¦æ§åˆ¶åŠŸèƒ½ï¼Œåªé¡¯ç¤ºåœ–å±¤æ§åˆ¶
          showLayerControlsInMobile();
          break;
          
      case 'info':
          sidebar.style.display = 'block';
          // é¡¯ç¤ºæ‰€æœ‰å…§å®¹
          resetAllElementsDisplay();
          if (currentFeederInfo) {
              const feederInfo = document.getElementById('feederInfo');
              if (feederInfo) {
                  feederInfo.scrollIntoView({ behavior: 'smooth' });
              }
          }
          break;
  }
}
// ğŸ”§ ä¿®æ­£ç‰ˆï¼šåœ¨æ‰‹æ©Ÿç‰ˆéš±è—åœ–å±¤æ§åˆ¶å…§å®¹ï¼Œä¿ç•™ä¸»è¦æ§åˆ¶åŠŸèƒ½
function hideLayerControlsInMobile() {
    const elementsToHide = [
        '#feederInfo',
        '.status-section',
        '.layer-controls',
        '.legend',
        '#highlightControls'
    ];
    
    elementsToHide.forEach(selector => {
        const element = document.querySelector(selector);
        if (element) {
            element.style.display = 'none';
        }
    });
    
    // ğŸ”§ é‡è¦ï¼šç¢ºä¿ä¸»è¦æ§åˆ¶åŠŸèƒ½é¡¯ç¤º
    const elementsToShow = [
        '.outage-data-section',
        '.disaster-report-section', 
        '.feeder-selection-section',
        '.nearby-search-section',
        '.coordinate-input-section'
    ];
    
    elementsToShow.forEach(selector => {
        const element = document.querySelector(selector);
        if (element) {
            element.style.display = 'block';
        }
    });
}
// ğŸ”§ ä¿®æ­£ç‰ˆï¼šåœ¨æ‰‹æ©Ÿç‰ˆåªé¡¯ç¤ºåœ–å±¤æ§åˆ¶å…§å®¹
function showLayerControlsInMobile() {
    // éš±è—ä¸»è¦æ§åˆ¶åŠŸèƒ½
    const elementsToHide = [
        '.outage-data-section',
        '.disaster-report-section', 
        '.feeder-selection-section',
        '.nearby-search-section',
        '.coordinate-input-section',
        '.file-upload-section'
    ];
    
    elementsToHide.forEach(selector => {
        const element = document.querySelector(selector);
        if (element) {
            element.style.display = 'none';
        }
    });
    
    // é¡¯ç¤ºåœ–å±¤æ§åˆ¶ç›¸é—œå…§å®¹
    const elementsToShow = [
        '#feederInfo',
        '.status-section',
        '.layer-controls', 
        '.legend',
        '#highlightControls'
    ];
    
    elementsToShow.forEach(selector => {
        const element = document.querySelector(selector);
        if (element) {
            element.style.display = 'block';
        }
    });
}

// ğŸ†• æ–°å¢ï¼šé‡ç½®æ‰€æœ‰å…ƒç´ é¡¯ç¤ºç‹€æ…‹ï¼ˆç”¨æ–¼åˆ‡æ›å›æ¡Œé¢ç‰ˆæ™‚ï¼‰
function resetAllElementsDisplay() {
    const allElements = [
        '.outage-data-section',
        '.disaster-report-section', 
        '.feeder-selection-section',
        '.nearby-search-section',
        '.coordinate-input-section',
        '.file-upload-section',
        '#feederInfo',
        '.status-section',
        '.layer-controls', 
        '.legend',
        '#highlightControls'
    ];
    
    allElements.forEach(selector => {
        const element = document.querySelector(selector);
        if (element) {
            element.style.display = 'block';
        }
    });
}

// ğŸ”§ ä¿®æ­£ç‰ˆï¼šé‡æ–°åˆå§‹åŒ–æ‰€æœ‰æ§åˆ¶é … - ç¢ºä¿äº‹ä»¶ç¶å®š
function reinitializeControls() {
    console.log('ğŸ”„ é–‹å§‹é‡æ–°åˆå§‹åŒ–æ§åˆ¶é …...');
    
    try {
        // 1. é‡æ–°åˆå§‹åŒ–é¥‹ç·šä¸‹æ‹‰é¸å–®
        if (typeof initializeFeederDropdown === 'function' && feederList && feederList.length > 0) {
            initializeFeederDropdown();
            console.log('âœ… é¥‹ç·šä¸‹æ‹‰é¸å–®å·²é‡æ–°åˆå§‹åŒ–');
        }
        
        // 2. é‡æ–°ç¶å®šæª”æ¡ˆä¸Šå‚³äº‹ä»¶
        const fileInput = document.getElementById('fileInput');
        if (fileInput && typeof handleFileInput === 'function') {
            fileInput.removeEventListener('change', handleFileInput);
            fileInput.addEventListener('change', handleFileInput);
            console.log('âœ… æª”æ¡ˆä¸Šå‚³äº‹ä»¶å·²é‡æ–°ç¶å®š');
        }
        
        // 3. æª¢æŸ¥é—œéµå…ƒç´ æ˜¯å¦å­˜åœ¨
        const feederInput = document.getElementById('feederInput');
        const feederDropdown = document.getElementById('feederDropdown');
        const loadButton = document.querySelector('.load-feeder-btn');
        
        console.log('ğŸ” é—œéµå…ƒç´ æª¢æŸ¥:');
        console.log('  - é¥‹ç·šè¼¸å…¥æ¡†:', feederInput ? 'âœ… å­˜åœ¨' : 'âŒ ä¸å­˜åœ¨');
        console.log('  - é¥‹ç·šä¸‹æ‹‰é¸å–®:', feederDropdown ? 'âœ… å­˜åœ¨' : 'âŒ ä¸å­˜åœ¨');
        console.log('  - è¼‰å…¥æŒ‰éˆ•:', loadButton ? 'âœ… å­˜åœ¨' : 'âŒ ä¸å­˜åœ¨');
        
        // 4. é‡æ–°ç¶å®šå…¶ä»–äº‹ä»¶ï¼ˆå¦‚æœéœ€è¦ï¼‰
        bindAdditionalEvents();
        
        console.log('âœ… æ‰€æœ‰æ§åˆ¶é …é‡æ–°åˆå§‹åŒ–å®Œæˆ');
        return true;
        
    } catch (error) {
        console.error('âŒ é‡æ–°åˆå§‹åŒ–æ§åˆ¶é …å¤±æ•—:', error);
        return false;
    }
}

// ğŸ†• ç¶å®šé¡å¤–çš„äº‹ä»¶
function bindAdditionalEvents() {
    // é‡æ–°ç¶å®šæœå°‹åŠå¾‘è®ŠåŒ–äº‹ä»¶ï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰
    const searchRadius = document.getElementById('searchRadius');
    if (searchRadius) {
        // å¯ä»¥åœ¨é€™è£¡æ·»åŠ åŠå¾‘è®ŠåŒ–çš„äº‹ä»¶è™•ç†
    }
    
    // é‡æ–°ç¶å®šå…¶ä»–æ§åˆ¶é …çš„äº‹ä»¶...
}
// ğŸ†• æª”æ¡ˆè¼¸å…¥è™•ç†å‡½æ•¸ï¼ˆå¾åŸæœ¬çš„åŒ¿åå‡½æ•¸æå–å‡ºä¾†ï¼‰
function handleFileInput(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    if (!file.name.toLowerCase().endsWith('.json')) {
        alert('è«‹é¸æ“‡ JSON æ ¼å¼çš„æª”æ¡ˆï¼');
        return;
    }
    
    // é¡¯ç¤ºè¼‰å…¥æŒ‡ç¤ºå™¨
    document.getElementById('loadingIndicator').classList.add('show');
    updateLoadStatus(`æ­£åœ¨è®€å–æª”æ¡ˆ: ${file.name}...`);
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const jsonData = JSON.parse(e.target.result);
            processJsonData(jsonData, file.name);
        } catch (error) {
            console.error('âŒ JSON è§£æéŒ¯èª¤:', error);
            updateLoadStatus('âŒ æª”æ¡ˆæ ¼å¼éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ JSON æ ¼å¼');
            alert('æª”æ¡ˆæ ¼å¼éŒ¯èª¤ï¼Œè«‹ç¢ºèªæ˜¯æœ‰æ•ˆçš„ JSON æª”æ¡ˆï¼');
        } finally {
            // éš±è—è¼‰å…¥æŒ‡ç¤ºå™¨
            document.getElementById('loadingIndicator').classList.remove('show');
        }
    };
    
    reader.onerror = function() {
        updateLoadStatus('âŒ æª”æ¡ˆè®€å–å¤±æ•—');
        document.getElementById('loadingIndicator').classList.remove('show');
    };
    
    reader.readAsText(file);
}
// ğŸ†• è³‡è¨Šé¢æ¿åŠŸèƒ½
// ğŸ”§ ä¿®æ­£ç‰ˆï¼šè³‡è¨Šé¢æ¿ - ä¸è¦†è“‹åŸå…§å®¹
function showInfoPanel() {
    const sidebar = document.querySelector('.sidebar');
    
    // ğŸ”§ é‡è¦ä¿®æ­£ï¼šå…ˆéš±è—åŸå…§å®¹ï¼Œè€Œä¸æ˜¯æ›¿æ›
    const originalContent = sidebar.innerHTML;
    
    // æš«å­˜åŸå…§å®¹åˆ° data å±¬æ€§
    sidebar.setAttribute('data-original-content', originalContent);
    
    const infoContent = `
        <div style="padding: 20px; background: white; height: 100%; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="color: #2c3e50; margin: 0;">ğŸ“‹ ç³»çµ±è³‡è¨Š</h3>
                <button onclick="restoreOriginalContent()" 
                        style="background: #6c757d; color: white; border: none; padding: 5px 10px; 
                               border-radius: 4px; cursor: pointer; font-size: 12px;">
                    âœ• é—œé–‰
                </button>
            </div>
            
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <h4 style="margin: 0 0 10px 0; color: #495057;">ğŸ”§ ç‰ˆæœ¬è³‡è¨Š</h4>
                <p style="margin: 5px 0;"><strong>ç‰ˆæœ¬ï¼š</strong>2.0.0</p>
                <p style="margin: 5px 0;"><strong>æ›´æ–°ï¼š</strong>${new Date().toLocaleDateString('zh-TW')}</p>
            </div>
            
            <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <h4 style="margin: 0 0 10px 0; color: #1976d2;">ğŸ“– åŠŸèƒ½èªªæ˜</h4>
                <ul style="margin: 0; padding-left: 20px;">
                    <li style="margin: 8px 0;">ğŸ—ºï¸ <strong>åœ°åœ–æª¢è¦–ï¼š</strong>ç€è¦½é¥‹ç·šåˆ†ä½ˆåœ–</li>
                    <li style="margin: 8px 0;">âš™ï¸ <strong>é¥‹ç·šæ§åˆ¶ï¼š</strong>è¼‰å…¥å’Œç®¡ç†é¥‹ç·šè³‡æ–™</li>
                    <li style="margin: 8px 0;">ğŸ“ <strong>æ¸¬è·å·¥å…·ï¼š</strong>æ¸¬é‡åœ°åœ–ä¸Šçš„è·é›¢</li>
                    <li style="margin: 8px 0;">ğŸ›ï¸ <strong>åœ–å±¤æ§åˆ¶ï¼š</strong>é¡¯ç¤º/éš±è—ä¸åŒåœ–å±¤</li>
                </ul>
            </div>
            
            <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <h4 style="margin: 0 0 10px 0; color: #856404;">ğŸ’¡ ä½¿ç”¨æç¤º</h4>
                <p style="margin: 5px 0; font-size: 14px;">â€¢ é»æ“Šç·šæ®µå¯ä»¥é«˜äº®é¡¯ç¤º</p>
                <p style="margin: 5px 0; font-size: 14px;">â€¢ é•·æŒ‰åœ°åœ–å¯ä»¥é–‹å•Ÿå³éµé¸å–®</p>
                <p style="margin: 5px 0; font-size: 14px;">â€¢ ä½¿ç”¨é›™æŒ‡ç¸®æ”¾èª¿æ•´åœ°åœ–å¤§å°</p>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px;">
                <button onclick="switchToControlsTab()" 
                        style="padding: 12px; background: linear-gradient(135deg, #28a745, #20c997); 
                               color: white; border: none; border-radius: 8px; cursor: pointer; 
                               font-size: 14px; font-weight: bold;
                               box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);">
                    âš™ï¸ æ§åˆ¶é¢æ¿
                </button>
                
                <button onclick="switchToMapTab()" 
                        style="padding: 12px; background: linear-gradient(135deg, #3498db, #2980b9); 
                               color: white; border: none; border-radius: 8px; cursor: pointer; 
                               font-size: 14px; font-weight: bold;
                               box-shadow: 0 4px 8px rgba(52, 152, 219, 0.3);">
                    ğŸ—ºï¸ è¿”å›åœ°åœ–
                </button>
            </div>
        </div>
    `;
    
    sidebar.innerHTML = infoContent;
}

// ğŸ”§ ä¿®æ­£ç‰ˆï¼šæ¢å¾©åŸå§‹å…§å®¹å‡½æ•¸ - ç¢ºä¿å®Œå…¨æ¢å¾©
function restoreOriginalContent() {
    console.log('ğŸ”„ æ¢å¾©åŸå§‹å…§å®¹...');
    
    const sidebar = document.querySelector('.sidebar');
    if (!sidebar) {
        console.error('âŒ æ‰¾ä¸åˆ°å´é‚Šæ¬„');
        return false;
    }
    
    const originalContent = sidebar.getAttribute('data-original-content');
    if (originalContent) {
        sidebar.innerHTML = originalContent;
        sidebar.removeAttribute('data-original-content');
        
        // ğŸ”§ é‡è¦ï¼šé‡æ–°åˆå§‹åŒ–æ§åˆ¶é …
        setTimeout(() => {
            reinitializeControls();
            console.log('âœ… åŸå§‹å…§å®¹å·²æ¢å¾©ä¸¦é‡æ–°åˆå§‹åŒ–');
        }, 100);
        
        return true;
    } else {
        console.warn('âš ï¸ æ²’æœ‰æ‰¾åˆ°åŸå§‹å…§å®¹å‚™ä»½');
        return false;
    }
}
// ğŸ†• åˆ‡æ›åˆ°åœ°åœ–æ¨™ç±¤
function switchToMapTab() {
    const mapTab = document.querySelector('[data-tab="map"]');
    if (mapTab) {
        mapTab.click();
    }
}
// ğŸ”§ ä¿®æ­£ç‰ˆï¼šåˆ‡æ›åˆ°æ§åˆ¶é¢æ¿
function switchToControlsTab() {
    // å…ˆæ¢å¾©åŸå§‹å…§å®¹
    restoreOriginalContent();
    
    // ç„¶å¾Œåˆ‡æ›åˆ°æ§åˆ¶æ¨™ç±¤
    const controlsTab = document.querySelector('[data-tab="controls"]');
    if (controlsTab) {
        controlsTab.click();
    }
}

// ğŸ†• åˆ‡æ›åˆ°åœ°åœ–æ¨™ç±¤
function switchToMapTab() {
    const mapTab = document.querySelector('[data-tab="map"]');
    if (mapTab) {
        mapTab.click();
    }
}

// ğŸ”§ ä¿®æ­£ç‰ˆï¼šç›£è½è¦–çª—å¤§å°è®ŠåŒ– - ç¢ºä¿æ¡Œé¢ç‰ˆæ­£å¸¸é¡¯ç¤º
window.addEventListener('resize', function() {
    initMobileOptimizations();
    
    // ğŸ”§ é‡è¦ï¼šç•¶å¾æ‰‹æ©Ÿåˆ‡æ›åˆ°æ¡Œé¢æ™‚ï¼Œé‡ç½®æ‰€æœ‰å…ƒç´ é¡¯ç¤º
    if (window.innerWidth > 768) {
        const sidebar = document.querySelector('.sidebar');
        const mapContainer = document.querySelector('.map-container');
        
        if (sidebar && mapContainer) {
            sidebar.style.display = 'block';
            mapContainer.style.display = 'block';
            
            // ğŸ”§ é‡è¦ï¼šé‡ç½®æ‰€æœ‰å…ƒç´ é¡¯ç¤ºç‹€æ…‹
            resetAllElementsDisplay();
            
            // æ¢å¾©åŸå§‹å´é‚Šæ¬„å…§å®¹ï¼ˆå¦‚æœè¢«ä¿®æ”¹éï¼‰
            const originalContent = sidebar.getAttribute('data-original-content');
            if (originalContent) {
                sidebar.innerHTML = originalContent;
                sidebar.removeAttribute('data-original-content');
                reinitializeControls();
            }
        }
    }
    
    // èª¿æ•´åœ°åœ–å¤§å°
    setTimeout(() => {
        if (map) {
            map.invalidateSize();
            console.log('ğŸ—ºï¸ è¦–çª—å¤§å°è®ŠåŒ–ï¼Œåœ°åœ–å·²èª¿æ•´');
        }
    }, 100);
});

// ğŸ”§ ä¿®æ­£ç‰ˆï¼šæ‰‹æ©Ÿç‰ˆæ§åˆ¶é¢æ¿ - éš±è—æª”æ¡ˆè¼‰å…¥åŠŸèƒ½
function initMobileOptimizations() {
    if (window.innerWidth <= 768) {
        // ğŸ”§ éš±è—æª”æ¡ˆè¼‰å…¥ç›¸é—œæ§åˆ¶é …
        const fileControls = document.querySelectorAll('#fileInput, label[for="fileInput"], .file-upload-section');
        fileControls.forEach(control => {
            if (control) {
                control.style.display = 'none';
            }
        });
        
        // ğŸ”§ éš±è—åŒ…å«"è¼‰å…¥é…é›»ç³»çµ±æª”æ¡ˆ"çš„æ•´å€‹å€å¡Š
        const uploadSections = document.querySelectorAll('.upload-section, .file-section');
        uploadSections.forEach(section => {
            if (section && section.textContent.includes('è¼‰å…¥é…é›»ç³»çµ±æª”æ¡ˆ')) {
                section.style.display = 'none';
            }
        });
        
        console.log('ğŸ“± æ‰‹æ©Ÿç‰ˆå„ªåŒ–ï¼šå·²éš±è—æª”æ¡ˆè¼‰å…¥åŠŸèƒ½');
    }
}

// ğŸ†• è¼‰å…¥åœé›»è³‡æ–™
// ğŸ”§ ä¿®æ”¹ï¼šè¼‰å…¥åœé›»è³‡æ–™å‡½æ•¸ - æ›´æ–°ç‹€æ…‹é¡¯ç¤ºé‚è¼¯
async function loadOutageData() {
    const outageApiUrl = 'https://script.google.com/macros/s/AKfycbygPaZiiAgb4gqSBP4rYDz8yqXMThTm7r6YyeJoFeRbv4tL57UWlc8YbQ5-SrkVfD-n/exec';
    
    try {
        console.log('ğŸ”„ æ­£åœ¨è¼‰å…¥åœé›»è³‡æ–™...');
        updateOutageStatus('æ­£åœ¨è¼‰å…¥åœé›»è³‡æ–™...');
        
        const response = await fetch(outageApiUrl);
        const result = await response.json();
        
        if (result && result.data) {
            outageData = result.data;
            
            // ğŸ”§ ä¿®æ”¹ï¼šçµ±è¨ˆæœ‰é¥‹ç·šè³‡æ–™çš„è¨˜éŒ„æ•¸é‡
            const validRecords = outageData.filter(record => 
                record.é¥‹ç·š && record.é¥‹ç·š.toString().trim() !== ''
            );
            
            console.log(`âœ… æˆåŠŸè¼‰å…¥ ${outageData.length} ç­†åœé›»è³‡æ–™ï¼Œå…¶ä¸­ ${validRecords.length} ç­†æœ‰é¥‹ç·šè³‡æ–™`);
            
            // ğŸ”§ ä¿®æ”¹ï¼šç‹€æ…‹é¡¯ç¤ºæ”¹ç‚ºçµ±è¨ˆæœ‰é¥‹ç·šè³‡æ–™çš„æ•¸é‡
            updateOutageStatus(`âœ… å·²è¼‰å…¥ ${validRecords.length} ç­†æœ‰é¥‹ç·šè³‡æ–™çš„åœé›»è¨˜éŒ„ (${new Date(result.meta.lastUpdate).toLocaleString('zh-TW')})`);
            
            // å»ºç«‹é¥‹ç·šè·³è„«æ¸…å–®
            createOutageFeederList();
            
            return true;
        } else {
            throw new Error('ç„¡æ•ˆçš„åœé›»è³‡æ–™æ ¼å¼');
        }
        
    } catch (error) {
        console.error('âŒ è¼‰å…¥åœé›»è³‡æ–™å¤±æ•—:', error);
        updateOutageStatus('âŒ åœé›»è³‡æ–™è¼‰å…¥å¤±æ•—');
        return false;
    }
}




// ğŸ†• æ›´æ–°åœé›»ç‹€æ…‹é¡¯ç¤º
function updateOutageStatus(message) {
    const statusElement = document.getElementById('outageStatus');
    if (statusElement) {
        statusElement.textContent = message;
    }
}

// ğŸ”§ ä¿®æ­£ç‰ˆï¼šå»ºç«‹é¥‹ç·šè·³è„«æ¸…å–® - ç¢ºä¿æ¯å€‹äº‹æ•…éƒ½åˆ†é–‹é¡¯ç¤º
function createOutageFeederList() {
const listContainer = document.getElementById('outageFeederList');
if (!listContainer || !outageData) return;

// ğŸ”§ ä¿®æ­£ï¼šçµ±è¨ˆæœ‰é¥‹ç·šè³‡æ–™çš„è¨˜éŒ„æ•¸é‡
const validRecords = outageData.filter(record => 
    record.é¥‹ç·š && record.é¥‹ç·š.toString().trim() !== ''
);

// æ›´æ–°ç‹€æ…‹é¡¯ç¤º
updateOutageStatus(`âœ… å·²è¼‰å…¥ ${validRecords.length} ç­†æœ‰é¥‹ç·šè³‡æ–™çš„åœé›»è¨˜éŒ„ (å…± ${outageData.length} ç­†åŸå§‹è³‡æ–™)`);

// ğŸ”§ é‡è¦ä¿®æ­£ï¼šä½¿ç”¨æ›´ç²¾ç¢ºçš„åˆ†çµ„é‚è¼¯ï¼Œç¢ºä¿æ¯å€‹äº‹æ•…éƒ½èƒ½åˆ†é–‹
const feederMap = new Map();

validRecords.forEach(record => {
    const feeder = record.é¥‹ç·š;
    if (feeder && feeder.trim() !== '') {
        // ğŸ”§ ä¿®æ­£ï¼šä½¿ç”¨æ›´ç²¾ç¢ºçš„ç¾¤çµ„éµï¼ŒåŒ…å«ç·¨è™Ÿç¢ºä¿å”¯ä¸€æ€§
        const groupKey = createFeederGroupKey(record, feeder);
        
        if (!feederMap.has(groupKey)) {
            feederMap.set(groupKey, {
                feeder: feeder,
                records: [],
                timeGroup: getDetailedTimeGroup(record.æ™‚é–“),
                numberRange: record.ç·¨è™Ÿ || 'unknown',
                primaryRecord: record // ğŸ†• åŠ å…¥ä¸»è¦è¨˜éŒ„åƒè€ƒ
            });
        }
        feederMap.get(groupKey).records.push(record);
    }
});

// å»ºç«‹æ¸…å–® HTML
let listHtml = '';

if (feederMap.size === 0) {
    listHtml = '<div style="text-align: center; color: #28a745; padding: 20px;">âœ… ç›®å‰ç„¡é¥‹ç·šè·³è„«</div>';
} else {
    // ğŸ”§ ä¿®æ­£ï¼šæŒ‰æ™‚é–“æ’åºï¼Œæœ€æ–°çš„åœ¨å‰é¢
    const sortedGroups = Array.from(feederMap.entries()).sort((a, b) => {
        const timeA = new Date(a[1].primaryRecord.æ™‚é–“).getTime();
        const timeB = new Date(b[1].primaryRecord.æ™‚é–“).getTime();
        return timeB - timeA; // é™åºæ’åˆ—ï¼Œæœ€æ–°åœ¨å‰
    });

    sortedGroups.forEach(([groupKey, groupData]) => {
        const records = groupData.records;
        const feeder = groupData.feeder;
        const recordCount = records.length;
        const latestRecord = records[0]; // å‡è¨­ç¬¬ä¸€ç­†æ˜¯æœ€æ–°çš„
        
        // åˆ¤æ–·é¥‹ç·šç‹€æ…‹é¡è‰²
        const statusColor = getFeederStatusColor(records);
        const statusText = getFeederStatusText(records);
        
        // ğŸ”§ ä¿®æ­£ï¼šç”¢ç”Ÿæ›´ç²¾ç¢ºçš„é¡¯ç¤ºæ¨™é¡Œ
        const displayTitle = generateDisplayTitle(feeder, groupData, records);
        
        listHtml += `
            <div class="outage-feeder-item" style="margin-bottom: 10px; padding: 12px; background: white; border-radius: 6px; border-left: 4px solid ${statusColor}; cursor: pointer;"
                 onclick="selectOutageFeeder('${feeder}', '${groupKey}')">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <strong style="color: ${statusColor}; font-size: 14px;">âš¡ ${displayTitle}</strong>
                        <div style="font-size: 11px; color: #666; margin-top: 2px;">
                            ${latestRecord.æ™‚é–“} | ${latestRecord.è™•ç†éƒ¨é–€}
                        </div>
                        <div style="font-size: 10px; color: ${statusColor}; margin-top: 2px; font-weight: bold;">
                            ${statusText}
                        </div>
                        ${getGroupDescription(groupData, recordCount)}
                    </div>
                    <div style="text-align: right;">
                        <span style="background: ${statusColor}; color: white; padding: 2px 6px; border-radius: 12px; font-size: 10px;">
                            ${recordCount === 1 ? 'å–®ç­†' : recordCount + ' ç­†'}
                        </span>
                    </div>
                </div>
                <div style="font-size: 11px; color: #666; margin-top: 4px;">
                    ${latestRecord.æ•…éšœå€é–“ || 'æŸ¥è©¢ä¸­...'}
                </div>
            </div>
        `;
    });
}

listContainer.innerHTML = listHtml;

console.log(`âœ… é¥‹ç·šè·³è„«æ¸…å–®å·²æ›´æ–°ï¼Œå…± ${feederMap.size} å€‹ç¨ç«‹äº‹æ•…ç¾¤çµ„`);
}


// ğŸ†• æŒ‰ä¸»å¹¹å¾©é›»ç‹€æ…‹ç¯©é¸åœé›»é¥‹ç·š
function filterOutageByStatus() {
    const filter = document.getElementById('outageFilter').value;
    console.log(`ğŸ” ç¯©é¸åœé›»ç‹€æ…‹: ${filter}`);
    
    if (!outageData || outageData.length === 0) {
        updateOutageStatus('âŒ ç„¡åœé›»è³‡æ–™å¯ç¯©é¸');
        return;
    }
    
    // ğŸ”§ ä¿®æ­£ï¼šçµ±è¨ˆæœ‰é¥‹ç·šè³‡æ–™çš„è¨˜éŒ„æ•¸é‡
    let validRecords = outageData.filter(record =>
        record.é¥‹ç·š && record.é¥‹ç·š.toString().trim() !== ''
    );
    
    // æ ¹æ“šç¯©é¸æ¢ä»¶éæ¿¾
    let filteredRecords = validRecords;
    if (filter === 'restored') {
        // ä¸»å¹¹å·²å¾©é›»ï¼šæœ‰ä¸»å¹¹å¾©é›»è³‡æ–™çš„è¨˜éŒ„
        filteredRecords = validRecords.filter(record => 
            record.ä¸»å¹¹å¾©é›» && record.ä¸»å¹¹å¾©é›».toString().trim() !== ''
        );
    } else if (filter === 'not_restored') {
        // ä¸»å¹¹æœªå¾©é›»ï¼šæ²’æœ‰ä¸»å¹¹å¾©é›»è³‡æ–™çš„è¨˜éŒ„
        filteredRecords = validRecords.filter(record => 
            !record.ä¸»å¹¹å¾©é›» || record.ä¸»å¹¹å¾©é›».toString().trim() === ''
        );
    }
    
    console.log(`âœ… ç¯©é¸çµæœ: ${filteredRecords.length} ç­†è³‡æ–™`);
    
    // ğŸ”§ é‡è¦ï¼šæš«æ™‚æ›¿æ›å…¨åŸŸè³‡æ–™é€²è¡Œé¡¯ç¤º
    const originalData = outageData;
    outageData = filteredRecords;
    
    // é‡æ–°å»ºç«‹æ¸…å–®
    createOutageFeederList();
    
    // ğŸ”§ é‡è¦ï¼šæ¢å¾©åŸå§‹è³‡æ–™
    outageData = originalData;
    
    // æ›´æ–°ç‹€æ…‹é¡¯ç¤º
    const filterText = getFilterDisplayText(filter);
    updateOutageStatus(`âœ… é¡¯ç¤º ${filteredRecords.length} ç­† ${filterText} è³‡æ–™`);
    showToast(`ğŸ” å·²ç¯©é¸é¡¯ç¤ºï¼š${filterText} (${filteredRecords.length} ç­†)`, 'info');
}

// ğŸ†• å–å¾—ç¯©é¸æ¢ä»¶é¡¯ç¤ºæ–‡å­—
function getFilterDisplayText(filter) {
    switch(filter) {
        case 'restored': return 'ä¸»å¹¹å·²å¾©é›»';
        case 'not_restored': return 'ä¸»å¹¹æœªå¾©é›»';
        default: return 'å…¨éƒ¨äº‹æ•…é¥‹ç·š';
    }
}
// ğŸ”§ ä¿®æ­£ç‰ˆï¼šå»ºç«‹é¥‹ç·šç¾¤çµ„éµ - ä½¿ç”¨æ›´ç²¾ç¢ºçš„æ™‚é–“åˆ†çµ„
function createFeederGroupKey(record, feeder) {
const time = record.æ™‚é–“ || '';
const number = record.ç·¨è™Ÿ || '';
const department = record.è™•ç†éƒ¨é–€ || '';

// ğŸ”§ é‡è¦ä¿®æ­£ï¼šä½¿ç”¨å®Œæ•´æ™‚é–“æˆ³è¨˜è€Œéå°æ™‚åˆ†çµ„
const timeGroup = getDetailedTimeGroup(time);

// æå–ç·¨è™Ÿç¯„åœï¼ˆä¿æŒåŸæœ‰é‚è¼¯ï¼‰
const numberRange = getNumberRange(number);

// ğŸ”§ ä¿®æ­£ï¼šçµ„åˆæˆæ›´ç²¾ç¢ºçš„å”¯ä¸€éµï¼ŒåŠ å…¥ç·¨è™Ÿç¢ºä¿å”¯ä¸€æ€§
return `${feeder}_${timeGroup}_${number}_${department}`;
}

// ğŸ”§ æ–°å¢ï¼šæ›´ç²¾ç¢ºçš„æ™‚é–“ç¾¤çµ„å‡½æ•¸
function getDetailedTimeGroup(timeStr) {
if (!timeStr) return 'unknown';

try {
    // ğŸ”§ é‡è¦ï¼šä½¿ç”¨å®Œæ•´çš„æ™‚é–“å­—ä¸²ï¼ŒåŒ…å«åˆ†é˜å’Œç§’æ•¸
    // ä¾‹å¦‚ "2024/01/15 14:30:25" -> "2024/01/15_14:30:25"
    const match = timeStr.match(/(\d{4}\/\d{2}\/\d{2})\s+(\d{2}:\d{2}:\d{2})/);
    if (match) {
        return `${match[1]}_${match[2]}`; // ä¾‹å¦‚ "2024/01/15_14:30:25"
    }
    
    // ğŸ”§ å‚™ç”¨æ–¹æ¡ˆï¼šå¦‚æœåªæœ‰åˆ°åˆ†é˜çš„æ ¼å¼
    const minuteMatch = timeStr.match(/(\d{4}\/\d{2}\/\d{2})\s+(\d{2}:\d{2})/);
    if (minuteMatch) {
        return `${minuteMatch[1]}_${minuteMatch[2]}:00`; // è£œä¸Šç§’æ•¸
    }
    
    // å¦‚æœç„¡æ³•è§£æï¼Œä½¿ç”¨åŸå§‹æ™‚é–“
    return timeStr.replace(/[^\w\d]/g, '_');
} catch (error) {
    return timeStr.substring(0, 20).replace(/[^\w\d]/g, '_');
}
}

// ğŸ†• å–å¾—æ™‚é–“ç¾¤çµ„ï¼ˆæŒ‰å°æ™‚åˆ†çµ„ï¼‰
function getTimeGroup(timeStr) {
  if (!timeStr) return 'unknown';
  
  try {
      // å˜—è©¦è§£ææ™‚é–“æ ¼å¼ï¼Œä¾‹å¦‚ "2024/01/15 14:30:25"
      const match = timeStr.match(/(\d{4}\/\d{2}\/\d{2})\s+(\d{2}):/);
      if (match) {
          return `${match[1]}_${match[2]}h`; // ä¾‹å¦‚ "2024/01/15_14h"
      }
      
      // å¦‚æœç„¡æ³•è§£æï¼Œä½¿ç”¨åŸå§‹æ™‚é–“çš„å‰16å€‹å­—ç¬¦
      return timeStr.substring(0, 16);
  } catch (error) {
      return timeStr.substring(0, 10);
  }
}

// ğŸ†• å–å¾—ç·¨è™Ÿç¯„åœï¼ˆæŒ‰ç·¨è™Ÿå‰å¹¾ä½åˆ†çµ„ï¼‰
function getNumberRange(numberStr) {
  if (!numberStr) return 'unknown';
  
  const num = parseInt(numberStr);
  if (isNaN(num)) return 'unknown';
  
  // æŒ‰100ç‚ºå–®ä½åˆ†çµ„ï¼Œä¾‹å¦‚ 1-99, 100-199, 200-299
  const rangeStart = Math.floor(num / 100) * 100;
  return `${rangeStart}-${rangeStart + 99}`;
}

// ğŸ”§ ä¿®æ­£ç‰ˆï¼šç”¢ç”Ÿé¡¯ç¤ºæ¨™é¡Œ - é‡å°åˆ†é›¢å¾Œçš„è¨˜éŒ„
function generateDisplayTitle(feeder, groupData, records) {
const recordCount = records.length;

if (recordCount === 1) {
    // å–®ä¸€è¨˜éŒ„ï¼Œé¡¯ç¤ºå®Œæ•´è³‡è¨ŠåŒ…å«æ™‚é–“
    const record = records[0];
    const shortTime = record.æ™‚é–“ ? record.æ™‚é–“.substring(11, 16) : ''; // åªå– HH:MM
    return `${feeder} (#${record.ç·¨è™Ÿ}${shortTime ? ` ${shortTime}` : ''})`;
} else {
    // å¤šç­†è¨˜éŒ„ï¼ˆç¾åœ¨æ‡‰è©²å¾ˆå°‘å‡ºç¾ï¼‰
    const firstRecord = records[0];
    const shortTime = firstRecord.æ™‚é–“ ? firstRecord.æ™‚é–“.substring(11, 16) : '';
    return `${feeder} (${recordCount}ç­†${shortTime ? ` ${shortTime}` : ''})`;
}
}

// ğŸ”§ ä¿®æ­£ç‰ˆï¼šå–å¾—ç¾¤çµ„æè¿° - é‡å°åˆ†é›¢å¾Œçš„è¨˜éŒ„
function getGroupDescription(groupData, recordCount) {
if (recordCount <= 1) return '';

// ç¾åœ¨å¤§éƒ¨åˆ†æ‡‰è©²æ˜¯å–®ä¸€è¨˜éŒ„ï¼Œå¦‚æœé‚„æœ‰ç¾¤çµ„å‰‡é¡¯ç¤ºè©³ç´°æ™‚é–“
const records = groupData.records || [];
if (records.length > 1) {
    const timeRange = getTimeRange(records);
    return `<div style="font-size: 9px; color: #999; margin-top: 3px;">æ™‚é–“ç¯„åœ: ${timeRange}</div>`;
}

return '';
}
// ğŸ†• æ–°å¢ï¼šå–å¾—æ™‚é–“ç¯„åœ
function getTimeRange(records) {
if (!records || records.length <= 1) return '';

const times = records.map(r => r.æ™‚é–“).filter(t => t).sort();
if (times.length < 2) return '';

const startTime = times[0].substring(11, 16); // HH:MM
const endTime = times[times.length - 1].substring(11, 16); // HH:MM

return `${startTime} - ${endTime}`;
}


// ğŸ†• åˆ¤æ–·é¥‹ç·šç‹€æ…‹é¡è‰²
function getFeederStatusColor(records) {
    // æª¢æŸ¥æ˜¯å¦æœ‰ä»»ä½•è¨˜éŒ„æœ‰"ä¸»å¹¹å¾©é›»"æ–‡å­—
    const hasMainPowerRestored = records.some(record => 
        record.ä¸»å¹¹å¾©é›» && record.ä¸»å¹¹å¾©é›».toString().trim() !== ''
    );
    
    if (hasMainPowerRestored) {
        return '#28a745'; // ç¶ è‰² - ä¸»å¹¹å·²å¾©é›»
    }
    
    // æª¢æŸ¥æ˜¯å¦æœ‰ä»»ä½•è¨˜éŒ„æœ‰"æŸ¥å ±å®Œæˆ"æ–‡å­—
    const hasInvestigationCompleted = records.some(record => 
        record.æŸ¥å ±å®Œæˆ && record.æŸ¥å ±å®Œæˆ.toString().trim() !== ''
    );
    
    if (hasInvestigationCompleted) {
        return '#6c757d'; // ç°è‰² - æŸ¥å ±å®Œæˆ
    }
    
    return '#dc3545'; // ç´…è‰² - æ•…éšœä¸­
}
// ğŸ†• å–å¾—é¥‹ç·šç‹€æ…‹æ–‡å­—
function getFeederStatusText(records) {
    // æª¢æŸ¥æ˜¯å¦æœ‰ä»»ä½•è¨˜éŒ„æœ‰"ä¸»å¹¹å¾©é›»"æ–‡å­—
    const hasMainPowerRestored = records.some(record => 
        record.ä¸»å¹¹å¾©é›» && record.ä¸»å¹¹å¾©é›».toString().trim() !== ''
    );
    
    if (hasMainPowerRestored) {
        return 'âœ… ä¸»å¹¹å·²å¾©é›»';
    }
    
    // æª¢æŸ¥æ˜¯å¦æœ‰ä»»ä½•è¨˜éŒ„æœ‰"æŸ¥å ±å®Œæˆ"æ–‡å­—
    const hasInvestigationCompleted = records.some(record => 
        record.æŸ¥å ±å®Œæˆ && record.æŸ¥å ±å®Œæˆ.toString().trim() !== ''
    );
    
    if (hasInvestigationCompleted) {
        return 'ğŸ“‹ æŸ¥å ±å®Œæˆ';
    }
    
    return 'ğŸ”´ æ•…éšœä¸­';
}
// ğŸ”§ ä¿®æ”¹ï¼šé¸æ“‡åœé›»é¥‹ç·š - æ”¯æ´ç¾¤çµ„éµ
function selectOutageFeeder(feeder, groupKey = null) {
  console.log(`ğŸ” é¸æ“‡åœé›»é¥‹ç·š: ${feeder}${groupKey ? ` (ç¾¤çµ„: ${groupKey})` : ''}`);
  
  let feederRecords;
  
  if (groupKey) {
      // ä½¿ç”¨ç¾¤çµ„éµç¯©é¸ç‰¹å®šç¾¤çµ„çš„è¨˜éŒ„
      feederRecords = outageData.filter(record => {
          if (record.é¥‹ç·š !== feeder) return false;
          const recordGroupKey = createFeederGroupKey(record, feeder);
          return recordGroupKey === groupKey;
      });
  } else {
      // å‚³çµ±æ–¹å¼ï¼šå–å¾—è©²é¥‹ç·šçš„æ‰€æœ‰è¨˜éŒ„
      feederRecords = outageData.filter(record => record.é¥‹ç·š === feeder);
  }

  if (feederRecords.length === 0) {
      showToast(`æ‰¾ä¸åˆ°é¥‹ç·š ${feeder} çš„åœé›»è¨˜éŒ„`, 'error');
      return;
  }

  // é¡¯ç¤ºè©³ç´°è³‡è¨Šå½ˆçª—
  showFeederOutageDetails(feeder, feederRecords);
}

// ğŸ†• é¡¯ç¤ºé¥‹ç·šåœé›»è©³ç´°è³‡è¨Š
// ğŸ”§ ä¿®æ”¹ï¼šé¡¯ç¤ºé¥‹ç·šåœé›»è©³ç´°è³‡è¨Š - æ”¹ç‚ºå´é‚Šæ¬„é¡¯ç¤º
function showFeederOutageDetails(feeder, records) {
    const statusColor = getFeederStatusColor(records);
    const statusText = getFeederStatusText(records);
    
    // ğŸ†• æª¢æŸ¥æ˜¯å¦ç‚ºæ‰‹æ©Ÿç‰ˆ
    const isMobile = window.innerWidth <= 768;
    
    if (isMobile) {
        // æ‰‹æ©Ÿç‰ˆï¼šåœ¨å´é‚Šæ¬„é¡¯ç¤º
        showFeederDetailsInSidebar(feeder, records, statusColor, statusText);
    } else {
        // æ¡Œé¢ç‰ˆï¼šä¿æŒåŸæœ‰çš„åœ°åœ–å½ˆçª—
        showFeederDetailsInPopup(feeder, records, statusColor, statusText);
    }
}

// ğŸ†• æ¡Œé¢ç‰ˆå½ˆçª—é¡¯ç¤ºï¼ˆä¿æŒåŸæœ‰åŠŸèƒ½ï¼‰
// ğŸ”§ ä¿®æ”¹ï¼šæ¡Œé¢ç‰ˆå½ˆçª—é¡¯ç¤º - æ›´æ–°æ¨™é¡Œé¡¯ç¤º
function showFeederDetailsInPopup(feeder, records, statusColor, statusText) {
  // ğŸ†• å¦‚æœæ˜¯ç¾¤çµ„è¨˜éŒ„ï¼Œé¡¯ç¤ºæ›´è©³ç´°çš„æ¨™é¡Œ
  const isGrouped = records.length > 1;
  const displayTitle = isGrouped ? 
      `${feeder} (${records.length}å€‹ç›¸é—œäº‹æ•…)` : 
      `${feeder} (#${records[0].ç·¨è™Ÿ})`;
  
  let detailHtml = `
      <div style="min-width: 400px; max-width: 500px; font-family: Arial, sans-serif;">
          <div style="background: linear-gradient(135deg, ${statusColor}, ${adjustColor(statusColor, -20)}); color: white; padding: 15px; margin: -10px -10px 15px -10px; border-radius: 8px 8px 0 0;">
              <h3 style="margin: 0; font-size: 18px;">âš¡ ${displayTitle}</h3>
              <div style="font-size: 12px; opacity: 0.9; margin-top: 5px;">${statusText}</div>
          </div>

          <!-- ğŸ†• å¿«é€Ÿè¼‰å…¥é¥‹ç·šæŒ‰éˆ• -->
          <div style="margin-bottom: 15px;">
              <button onclick="loadFeederDirectly('${feeder}')" 
                      style="width: 100%; padding: 10px; background: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: bold;">
                  ğŸ—ºï¸ ç›´æ¥è¼‰å…¥ ${feeder} é¥‹ç·šåœ–
              </button>
          </div>
  `;

  records.forEach((record, index) => {
      const hasCoordinates = record.æ•…éšœå€é–“åœ–è™Ÿåº§æ¨™1 && record.æ•…éšœå€é–“åœ–è™Ÿåº§æ¨™2;
      const recordStatusColor = getRecordStatusColor(record);
      
      detailHtml += `
          <div style="margin-bottom: 15px; padding: 12px; background: #f8f9fa; border-radius: 6px; border-left: 3px solid ${recordStatusColor};">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                  <strong style="color: ${recordStatusColor};">äº‹æ•… #${record.ç·¨è™Ÿ}</strong>
                  <span style="font-size: 11px; color: #666;">${record.æ™‚é–“}</span>
              </div>
              
              <div style="font-size: 12px; line-height: 1.4;">
                  <p><strong>äº‹æ•…åˆ¥:</strong> ${record.äº‹æ•…åˆ¥}</p>
                  <p><strong>æ•…éšœå€é–“:</strong> ${record.æ•…éšœå€é–“ || 'N/A'}</p>
                  <p><strong>è™•ç†éƒ¨é–€:</strong> ${record.è™•ç†éƒ¨é–€}</p>
                  <p><strong>æ´¾æŸ¥ç‹€æ…‹:</strong> ${record.æ´¾æŸ¥ç‹€æ…‹ || 'N/A'}</p>
                  <p><strong>æ´¾æŸ¥äººå“¡:</strong> ${record.æ´¾æŸ¥äººå“¡ || 'N/A'}</p>
                  ${record.äº‹æ•…åŸå›  ? `<p><strong>äº‹æ•…åŸå› :</strong> ${record.äº‹æ•…åŸå› }</p>` : ''}
                  ${record.ä¸»å¹¹å¾©é›» ? `<p style="color: #28a745;"><strong>âœ… ä¸»å¹¹å¾©é›»:</strong> ${record.ä¸»å¹¹å¾©é›»}</p>` : ''}
                  ${record.æŸ¥å ±å®Œæˆ ? `<p style="color: #6c757d;"><strong>ğŸ“‹ æŸ¥å ±å®Œæˆ:</strong> ${record.æŸ¥å ±å®Œæˆ}</p>` : ''}
              </div>
              
              <!-- æ“ä½œæŒ‰éˆ• -->
              <div style="margin: 10px -8px 5px -8px;">
                  ${hasCoordinates ? `
                      <button onclick="showFaultLocation('${record.æ•…éšœå€é–“åœ–è™Ÿåº§æ¨™1}', '${record.æ•…éšœå€é–“åœ–è™Ÿåº§æ¨™2}', '${feeder}', '${record.æ•…éšœå€é–“}')" 
                              style="padding: 18px 24px; background: linear-gradient(135deg, #ff6b35, #f7931e); color: white; border: none; border-radius: 10px; cursor: pointer; font-size: 18px; font-weight: bold; width: calc(100% + 16px); transition: all 0.3s ease; box-shadow: 0 6px 12px rgba(255, 107, 53, 0.4); text-shadow: 0 2px 4px rgba(0,0,0,0.3); display: block; position: relative; letter-spacing: 0.5px;"
                              onmouseover="this.style.transform='translateY(-4px) scale(1.03)'; this.style.boxShadow='0 8px 20px rgba(255, 107, 53, 0.5)';"
                              onmouseout="this.style.transform='translateY(0) scale(1)'; this.style.boxShadow='0 6px 12px rgba(255, 107, 53, 0.4)';">
                          ğŸ¯ æŸ¥çœ‹æ•…éšœå€é–“ä¸¦è¼‰å…¥é¥‹ç·š
                      </button>
                  ` : `
                      <button onclick="loadFeederWithRecord('${feeder}', '${record.æ•…éšœå€é–“}', ${index})" 
                              style="padding: 15px 20px; background: linear-gradient(135deg, #17a2b8, #138496); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; width: calc(100% + 16px); transition: all 0.3s ease; box-shadow: 0 4px 8px rgba(23, 162, 184, 0.3); text-shadow: 0 1px 2px rgba(0,0,0,0.2);"
                              onmouseover="this.style.transform='translateY(-2px) scale(1.02)'; this.style.boxShadow='0 6px 12px rgba(23, 162, 184, 0.4)';"
                              onmouseout="this.style.transform='translateY(0) scale(1)'; this.style.boxShadow='0 4px 8px rgba(23, 162, 184, 0.3)';">
                          ğŸ—ºï¸ è¼‰å…¥é¥‹ç·šä¸¦æŸ¥çœ‹æ•…éšœå€é–“
                      </button>
                  `}
              </div>
          </div>
      `;
  });

  detailHtml += `
          <div style="margin-top: 15px; text-align: center;">
              <button onclick="map.closePopup()" 
                      style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">
                  é—œé–‰
              </button>
          </div>
      </div>
  `;

  const popup = L.popup({
      maxWidth: 500,
      closeButton: true
  })
  .setLatLng(map.getCenter())
  .setContent(detailHtml)
  .openOn(map);
}

// ğŸ”§ ä¿®æ”¹ï¼šåœ¨å´é‚Šæ¬„é¡¯ç¤ºé¥‹ç·šè©³æƒ…ï¼ˆæ‰‹æ©Ÿç‰ˆï¼‰- åŠ å…¥ç„¡åº§æ¨™èª¿é–±åŠŸèƒ½
function showFeederDetailsInSidebar(feeder, records, statusColor, statusText) {
    const sidebar = document.querySelector('.sidebar');
    if (!sidebar) return;
    
    // å»ºç«‹è©³æƒ…å®¹å™¨
    const detailsContainer = document.createElement('div');
    detailsContainer.id = 'feederDetailsContainer';
    detailsContainer.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: white;
        z-index: 2000;
        overflow-y: auto;
        padding: 20px;
        box-sizing: border-box;
    `;
    
    let detailHtml = `
        <div style="margin-bottom: 20px;">
            <!-- æ¨™é¡Œåˆ— -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #eee;">
                <div>
                    <h2 style="color: ${statusColor}; margin: 0; font-size: 20px;">âš¡ ${feeder}</h2>
                    <span style="background: ${statusColor}; color: white; padding: 6px 12px; border-radius: 15px; font-size: 12px; font-weight: bold; margin-top: 8px; display: inline-block;">
                        ${statusText}
                    </span>
                </div>
                <button onclick="closeFeederDetails()" 
                        style="background: #dc3545; color: white; border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                    âœ•
                </button>
            </div>
            
            <!-- çµ±è¨ˆè³‡è¨Š -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px;">
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 24px; font-weight: bold; color: ${statusColor};">${records.length}</div>
                    <div style="font-size: 12px; color: #666;">äº‹æ•…ç­†æ•¸</div>
                </div>
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 14px; font-weight: bold; color: #666;">${records[0].è™•ç†éƒ¨é–€}</div>
                    <div style="font-size: 12px; color: #666;">è™•ç†éƒ¨é–€</div>
                </div>
            </div>
            
            <!-- ğŸ†• å¿«é€Ÿè¼‰å…¥é¥‹ç·šæŒ‰éˆ• -->
            <div style="margin-bottom: 20px;">
                <button onclick="loadFeederDirectlyMobile('${feeder}')" 
                        style="width: 100%; padding: 15px; background: linear-gradient(135deg, #007bff, #0056b3); color: white; border: none; border-radius: 10px; cursor: pointer; font-size: 16px; font-weight: bold; box-shadow: 0 4px 8px rgba(0,123,255,0.3);">
                    ğŸ—ºï¸ ç›´æ¥è¼‰å…¥ ${feeder} é¥‹ç·šåœ–
                </button>
            </div>
        </div>
        
        <!-- äº‹æ•…æ¸…å–® -->
        <div style="margin-bottom: 20px;">
            <h3 style="color: #333; margin-bottom: 15px; font-size: 16px;">ğŸ“‹ äº‹æ•…è©³æƒ…</h3>
    `;
    
    records.forEach((record, index) => {
        const hasCoordinates = record.æ•…éšœå€é–“åœ–è™Ÿåº§æ¨™1 && record.æ•…éšœå€é–“åœ–è™Ÿåº§æ¨™2;
        const recordStatusColor = getRecordStatusColor(record);
        
        detailHtml += `
            <div style="margin-bottom: 15px; padding: 15px; background: white; border-radius: 10px; border: 1px solid #eee; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                <!-- äº‹æ•…æ¨™é¡Œ -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <div>
                        <strong style="color: ${recordStatusColor}; font-size: 16px;">äº‹æ•… #${record.ç·¨è™Ÿ}</strong>
                        <div style="font-size: 12px; color: #666; margin-top: 2px;">${record.æ™‚é–“}</div>
                    </div>
                    <div style="width: 8px; height: 40px; background: ${recordStatusColor}; border-radius: 4px;"></div>
                </div>
                
                <!-- äº‹æ•…è³‡è¨Š -->
                <div style="font-size: 14px; line-height: 1.6; margin-bottom: 12px;">
                    <div style="margin-bottom: 8px;">
                        <span style="color: #666; font-size: 12px;">äº‹æ•…åˆ¥</span><br>
                        <strong>${record.äº‹æ•…åˆ¥}</strong>
                    </div>
                    <div style="margin-bottom: 8px;">
                        <span style="color: #666; font-size: 12px;">æ•…éšœå€é–“</span><br>
                        <strong>${record.æ•…éšœå€é–“ || 'N/A'}</strong>
                    </div>
                    <div style="margin-bottom: 8px;">
                        <span style="color: #666; font-size: 12px;">æ´¾æŸ¥ç‹€æ…‹</span><br>
                        <strong>${record.æ´¾æŸ¥ç‹€æ…‹ || 'N/A'}</strong>
                    </div>
                    ${record.æ´¾æŸ¥äººå“¡ ? `
                        <div style="margin-bottom: 8px;">
                            <span style="color: #666; font-size: 12px;">æ´¾æŸ¥äººå“¡</span><br>
                            <strong>${record.æ´¾æŸ¥äººå“¡}</strong>
                        </div>
                    ` : ''}
                    ${record.äº‹æ•…åŸå›  ? `
                        <div style="margin-bottom: 8px;">
                            <span style="color: #666; font-size: 12px;">äº‹æ•…åŸå› </span><br>
                            <strong>${record.äº‹æ•…åŸå› }</strong>
                        </div>
                    ` : ''}
                    ${record.ä¸»å¹¹å¾©é›» ? `
                        <div style="margin-bottom: 8px; padding: 8px; background: #d4edda; border-radius: 6px;">
                            <span style="color: #155724; font-size: 12px;">âœ… ä¸»å¹¹å¾©é›»</span><br>
                            <strong style="color: #155724;">${record.ä¸»å¹¹å¾©é›»}</strong>
                        </div>
                    ` : ''}
                    ${record.æŸ¥å ±å®Œæˆ ? `
                        <div style="margin-bottom: 8px; padding: 8px; background: #f8f9fa; border-radius: 6px;">
                            <span style="color: #6c757d; font-size: 12px;">ğŸ“‹ æŸ¥å ±å®Œæˆ</span><br>
                            <strong style="color: #6c757d;">${record.æŸ¥å ±å®Œæˆ}</strong>
                        </div>
                    ` : ''}
                </div>
                
                <!-- ğŸ”§ ä¿®æ”¹ï¼šæ“ä½œæŒ‰éˆ• - æœ‰åº§æ¨™å’Œç„¡åº§æ¨™éƒ½èƒ½æ“ä½œ -->
				<div style="margin-top: 8px;">
					${hasCoordinates ? `
						<button onclick="showFaultLocationMobile('${record.æ•…éšœå€é–“åœ–è™Ÿåº§æ¨™1}', '${record.æ•…éšœå€é–“åœ–è™Ÿåº§æ¨™2}', '${feeder}', '${record.æ•…éšœå€é–“}')" 
								style="padding: 16px 20px; background: linear-gradient(135deg, #ff6b35, #f7931e); color: white; border: none; border-radius: 10px; cursor: pointer; font-size: 16px; font-weight: bold; width: 100%; transition: all 0.3s ease; box-shadow: 0 4px 8px rgba(255, 107, 53, 0.3); text-shadow: 0 1px 2px rgba(0,0,0,0.2); letter-spacing: 0.5px;"
								onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 12px rgba(255, 107, 53, 0.4)';"
								onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 8px rgba(255, 107, 53, 0.3)';">
							ğŸ¯ æŸ¥çœ‹æ•…éšœå€é–“ä¸¦è¼‰å…¥é¥‹ç·š
						</button>
					` : `
						<button onclick="loadFeederWithRecordMobile('${feeder}', '${record.æ•…éšœå€é–“}', ${index})" 
								style="padding: 14px 18px; background: linear-gradient(135deg, #17a2b8, #138496); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 15px; font-weight: bold; width: 100%; transition: all 0.3s ease; box-shadow: 0 4px 8px rgba(23, 162, 184, 0.3);"
								onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 6px 10px rgba(23, 162, 184, 0.4)';"
								onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 8px rgba(23, 162, 184, 0.3)';">
							ğŸ—ºï¸ è¼‰å…¥é¥‹ç·šä¸¦æŸ¥çœ‹æ•…éšœå€é–“
						</button>
					`}
				</div>
            </div>
        `;
    });
    
    detailHtml += `
        </div>
        
        <!-- åº•éƒ¨æ“ä½œå€ -->
        <div style="position: sticky; bottom: 0; background: white; padding: 15px 0; border-top: 1px solid #eee; margin-top: 20px;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <button onclick="closeFeederDetails()" 
                        style="padding: 12px; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px;">
                    â† è¿”å›æ¸…å–®
                </button>
                <button onclick="showOutageMapMobile('${feeder}')" 
                        style="padding: 12px; background: #dc3545; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px;">
                    ğŸ—ºï¸ æŸ¥çœ‹åœ°åœ–
                </button>
            </div>
        </div>
    `;
    
    detailsContainer.innerHTML = detailHtml;
    document.body.appendChild(detailsContainer);
    
    // é˜²æ­¢èƒŒæ™¯æ»¾å‹•
    document.body.style.overflow = 'hidden';
}

// ğŸ”§ ä¿®æ­£ç‰ˆï¼šè¼‰å…¥é¥‹ç·šä¸¦æ¨™è¨»æ•…éšœå€é–“ï¼ˆæ‰‹æ©Ÿç‰ˆï¼‰
function loadFeederWithRecordMobile(feeder, faultSection, recordIndex) {
    closeFeederDetails();
    
    setTimeout(() => {
        loadFeederWithRecord(feeder, faultSection, recordIndex);
    }, 300);
}
// ğŸ†• ç›´æ¥è¼‰å…¥é¥‹ç·šï¼ˆæ‰‹æ©Ÿç‰ˆï¼‰
function loadFeederDirectlyMobile(feeder) {
    closeFeederDetails();
    
    setTimeout(() => {
        loadFeederDirectly(feeder);
    }, 300);
}

// ğŸ†• ç›´æ¥è¼‰å…¥é¥‹ç·šï¼ˆé€šç”¨ï¼‰
function loadFeederDirectly(feeder) {
    const feederInput = document.getElementById('feederInput');
    if (feederInput) {
        if (feederList.includes(feeder)) {
            feederInput.value = feeder;
            showToast(`ğŸ”„ æ­£åœ¨è¼‰å…¥é¥‹ç·š ${feeder}...`, 'info');
            loadFeederFromCloud();
            
            // é—œé–‰å½ˆçª—ï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰
            if (map.getPopup()) {
                map.closePopup();
            }
        } else {
            showToast(`âš ï¸ é¥‹ç·š ${feeder} ä¸åœ¨å¯è¼‰å…¥æ¸…å–®ä¸­`, 'warning');
        }
    }
}
// ğŸ†• è¼‰å…¥é¥‹ç·šä¸¦æ¨™è¨»æ•…éšœå€é–“ï¼ˆé€šç”¨ï¼‰
function loadFeederWithRecord(feeder, faultSection, recordIndex) {
    const feederInput = document.getElementById('feederInput');
    if (feederInput) {
        if (feederList.includes(feeder)) {
            feederInput.value = feeder;
            showToast(`ğŸ”„ æ­£åœ¨è¼‰å…¥é¥‹ç·š ${feeder}...`, 'info');
            
            // è¼‰å…¥é¥‹ç·šå¾Œæ¨™è¨»æ•…éšœå€é–“
            loadFeederFromCloud().then(() => {
                // å»¶é²ä¸€ä¸‹è®“é¥‹ç·šè¼‰å…¥å®Œæˆ
                setTimeout(() => {
                    highlightFaultSection(feeder, faultSection, recordIndex);
                }, 1000);
            });
            
            // é—œé–‰å½ˆçª—ï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰
            if (map.getPopup()) {
                map.closePopup();
            }
        } else {
            showToast(`âš ï¸ é¥‹ç·š ${feeder} ä¸åœ¨å¯è¼‰å…¥æ¸…å–®ä¸­`, 'warning');
        }
    }
}
// ğŸ†• æ¨™è¨»æ•…éšœå€é–“ï¼ˆæ–‡å­—æœå°‹ï¼‰
function highlightFaultSection(feeder, faultSection, recordIndex) {
    if (!faultSection || faultSection === 'N/A') {
        showToast(`ğŸ“ å·²è¼‰å…¥é¥‹ç·š ${feeder}ï¼Œè«‹æ‰‹å‹•æŸ¥æ‰¾æ•…éšœä½ç½®`, 'info');
        return;
    }
    
    console.log(`ğŸ” æœå°‹æ•…éšœå€é–“: ${faultSection}`);
    
    // åœ¨åœ°åœ–ä¸Šæœå°‹åŒ…å«æ•…éšœå€é–“æ–‡å­—çš„æ¨™è¨˜æˆ–ç·šæ®µ
    let found = false;
    
    // æœå°‹æ‰€æœ‰åœ–å±¤
    map.eachLayer(function(layer) {
        if (layer.getPopup && layer.getPopup()) {
            const popupContent = layer.getPopup().getContent();
            if (popupContent && popupContent.includes(faultSection)) {
                // æ‰¾åˆ°ç›¸é—œçš„æ¨™è¨˜ï¼Œé«˜äº®é¡¯ç¤º
                if (layer.setStyle) {
                    layer.setStyle({
                        color: '#ff0000',
                        weight: 8,
                        opacity: 1,
                        dashArray: '10,5'
                    });
                }
                
                // ç§»å‹•åˆ°è©²ä½ç½®
                if (layer.getBounds) {
                    map.fitBounds(layer.getBounds(), { padding: [20, 20] });
                } else if (layer.getLatLng) {
                    map.setView(layer.getLatLng(), 16);
                }
                
                // é¡¯ç¤ºå½ˆçª—
                layer.openPopup();
                found = true;
                
                showToast(`ğŸ“ å·²æ‰¾åˆ°ä¸¦æ¨™è¨»æ•…éšœå€é–“: ${faultSection}`, 'success');
                return false; // åœæ­¢æœå°‹
            }
        }
        
        // æœå°‹æ¨™è¨˜çš„ tooltip æˆ–å…¶ä»–å±¬æ€§
        if (layer.getTooltip && layer.getTooltip()) {
            const tooltipContent = layer.getTooltip().getContent();
            if (tooltipContent && tooltipContent.includes(faultSection)) {
                if (layer.setStyle) {
                    layer.setStyle({
                        color: '#ff0000',
                        weight: 6,
                        opacity: 1
                    });
                }
                
                if (layer.getLatLng) {
                    map.setView(layer.getLatLng(), 16);
                } else if (layer.getBounds) {
                    map.fitBounds(layer.getBounds(), { padding: [20, 20] });
                }
                
                layer.openTooltip();
                found = true;
                
                showToast(`ğŸ“ å·²æ‰¾åˆ°ä¸¦æ¨™è¨»æ•…éšœå€é–“: ${faultSection}`, 'success');
                return false;
            }
        }
    });
    
    if (!found) {
        showToast(`ğŸ“ å·²è¼‰å…¥é¥‹ç·š ${feeder}ï¼Œä½†æœªæ‰¾åˆ°æ•…éšœå€é–“ "${faultSection}" çš„ç²¾ç¢ºä½ç½®`, 'warning');
        
        // å‰µå»ºä¸€å€‹é€šç”¨çš„æ•…éšœå€é–“æç¤º
        const centerPopup = L.popup()
            .setLatLng(map.getCenter())
            .setContent(`
                <div style="text-align: center;">
                    <h4 style="color: #dc3545;">âš¡ ${feeder}</h4>
                    <p><strong>æ•…éšœå€é–“:</strong> ${faultSection}</p>
                    <p style="font-size: 12px; color: #666;">
                        è«‹åœ¨åœ°åœ–ä¸Šæ‰‹å‹•æŸ¥æ‰¾ç›¸é—œä½ç½®
                    </p>
                    <button onclick="map.closePopup()" 
                            style="padding: 6px 12px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;">
                        é—œé–‰
                    </button>
                </div>
            `)
            .openOn(map);
    }
}

// ğŸ†• é—œé–‰é¥‹ç·šè©³æƒ…
function closeFeederDetails() {
    const detailsContainer = document.getElementById('feederDetailsContainer');
    if (detailsContainer) {
        detailsContainer.remove();
        document.body.style.overflow = 'auto'; // æ¢å¾©èƒŒæ™¯æ»¾å‹•
    }
}
// ğŸ”§ ä¿®æ­£ç‰ˆï¼šæ‰‹æ©Ÿç‰ˆæ•…éšœä½ç½®é¡¯ç¤º
function showFaultLocationMobile(coord1, coord2, feeder, faultSection) {
    // å…ˆé—œé–‰è©³æƒ…é é¢
    closeFeederDetails();
    
    // å»¶é²ä¸€é»å†åŸ·è¡Œåœ°åœ–æ“ä½œï¼Œè®“é é¢æœ‰æ™‚é–“åˆ‡æ›
    setTimeout(() => {
        showFaultLocation(coord1, coord2, feeder, faultSection);
    }, 300);
}
// ğŸ†• æ‰‹æ©Ÿç‰ˆåœ°åœ–é¡¯ç¤º
function showOutageMapMobile(feeder) {
    // å…ˆé—œé–‰è©³æƒ…é é¢
    closeFeederDetails();
    
    // å»¶é²ä¸€é»å†åŸ·è¡Œåœ°åœ–æ“ä½œ
    setTimeout(() => {
        // æ‰¾åˆ°è©²é¥‹ç·šçš„æ‰€æœ‰è¨˜éŒ„
        const feederRecords = outageData.filter(record => record.é¥‹ç·š === feeder);
        
        // æ¸…é™¤ç¾æœ‰æ¨™è¨˜
        clearFaultMarkers();
        
        let markerCount = 0;
        const bounds = L.latLngBounds();
        
        feederRecords.forEach(record => {
            const coord1 = record.æ•…éšœå€é–“åœ–è™Ÿåº§æ¨™1;
            const coord2 = record.æ•…éšœå€é–“åœ–è™Ÿåº§æ¨™2;
            
            if (coord1 && coord2) {
                try {
                    const pos1 = convertPowerCoordinate(coord1);
                    const pos2 = convertPowerCoordinate(coord2);
                    
                    const [lng1, lat1] = pos1.split(',').map(Number);
                    const [lng2, lat2] = pos2.split(',').map(Number);
                    
                    const faultLine = L.polyline([[lat1, lng1], [lat2, lng2]], {
                        color: getRecordStatusColor(record),
                        weight: 4,
                        opacity: 0.7
                    }).addTo(map);
                    
                    faultLine.bindPopup(`
                        <div style="text-align: center;">
                            <h4 style="color: ${getRecordStatusColor(record)};">âš¡ ${feeder}</h4>
                            <p><strong>æ•…éšœå€é–“:</strong> ${record.æ•…éšœå€é–“}</p>
                            <p><strong>æ™‚é–“:</strong> ${record.æ™‚é–“}</p>
                        </div>
                    `);
                    
                    faultLineMarkers.push(faultLine);
                    bounds.extend([[lat1, lng1], [lat2, lng2]]);
                    markerCount++;
                    
                } catch (error) {
                    console.warn(`åº§æ¨™è½‰æ›å¤±æ•—: ${coord1}, ${coord2}`, error);
                }
            }
        });
        
        if (markerCount > 0) {
            map.fitBounds(bounds, { padding: [20, 20] });
            showToast(`ğŸ—ºï¸ å·²é¡¯ç¤º ${feeder} çš„ ${markerCount} å€‹æ•…éšœä½ç½®`, 'success');
        } else {
            showToast('âŒ ç„¡æœ‰æ•ˆåº§æ¨™è³‡æ–™å¯é¡¯ç¤º', 'error');
        }
    }, 300);
}
// ğŸ†• å–å¾—å€‹åˆ¥è¨˜éŒ„çš„ç‹€æ…‹é¡è‰²
function getRecordStatusColor(record) {
    if (record.ä¸»å¹¹å¾©é›» && record.ä¸»å¹¹å¾©é›».toString().trim() !== '') {
        return '#28a745'; // ç¶ è‰² - ä¸»å¹¹å·²å¾©é›»
    }
    
    if (record.æŸ¥å ±å®Œæˆ && record.æŸ¥å ±å®Œæˆ.toString().trim() !== '') {
        return '#6c757d'; // ç°è‰² - æŸ¥å ±å®Œæˆ
    }
    
    return '#dc3545'; // ç´…è‰² - æ•…éšœä¸­
}

// ğŸ”§ ä¿®æ­£ç‰ˆï¼šé¡¯ç¤ºæ•…éšœä½ç½® - æ‰‹æ©Ÿç‰ˆåªä¿ç•™åŸå§‹å½ˆçª—
function showFaultLocation(coord1, coord2, feeder, faultSection) {
    try {
        console.log(`ğŸ—ºï¸ é¡¯ç¤ºæ•…éšœä½ç½®: ${coord1} - ${coord2}`);
        
        // è½‰æ›åº§æ¨™
        const pos1 = convertPowerCoordinate(coord1);
        const pos2 = convertPowerCoordinate(coord2);
        
        const [lng1, lat1] = pos1.split(',').map(Number);
        const [lng2, lat2] = pos2.split(',').map(Number);
        
        // æ¸…é™¤ä¹‹å‰çš„æ•…éšœæ¨™è¨˜
        clearFaultMarkers();
        
        // ğŸ”§ æª¢æŸ¥æ˜¯å¦ç‚ºæ‰‹æ©Ÿç‰ˆ
        const isMobile = window.innerWidth <= 768;
        
        // å»ºç«‹é–ƒçˆæ¨™è¨˜
        const marker1 = createBlinkingMarker([lat1, lng1], `æ•…éšœèµ·é»\n${coord1}`, '#ff0000', isMobile);
        const marker2 = createBlinkingMarker([lat2, lng2], `æ•…éšœçµ‚é»\n${coord2}`, '#ff0000', isMobile);
        
        // å»ºç«‹æ•…éšœç·šæ®µ
        const faultLine = L.polyline([[lat1, lng1], [lat2, lng2]], {
            color: '#ff0000',
            weight: 6,
            opacity: 0.8,
            dashArray: '10,10',
            className: 'fault-line-animation'
        }).addTo(map);
        
        // ğŸ”§ é‡è¦ä¿®æ­£ï¼šè¨ˆç®—ä¸­é–“é»ä½ç½®
        const midLat = (lat1 + lat2) / 2;
        const midLng = (lng1 + lng2) / 2;
        
        // ğŸ”§ æ ¹æ“šè£ç½®é¡å‹è¨­å®šä¸åŒçš„é»æ“Šè¡Œç‚º
        if (!isMobile) {
            // ğŸ–¥ï¸ æ¡Œé¢ç‰ˆï¼šé¡¯ç¤ºæ‹–æ›³é¢æ¿
            faultLine.on('click', function(e) {
                const clickPosition = e.latlng;
                const faultInfo = {
                    feeder: feeder,
                    faultSection: faultSection,
                    coord1: coord1,
                    coord2: coord2,
                    startPoint: [lat1, lng1],
                    endPoint: [lat2, lng2],
                    clickPoint: [clickPosition.lat, clickPosition.lng]
                };
                showDraggableFaultInfoPanel([clickPosition.lat, clickPosition.lng], 'æ•…éšœå€é–“', '#ff0000', faultInfo);
                L.DomEvent.stopPropagation(e);
            });
        } else {
            // ğŸ“± æ‰‹æ©Ÿç‰ˆï¼šé¡¯ç¤ºåŸå§‹çš„æ•…éšœå€é–“å½ˆçª—
            faultLine.on('click', function(e) {
                // ğŸ”§ é‡è¦ï¼šé¡¯ç¤ºåŸå§‹çš„æ•…éšœå€é–“å½ˆçª—
                const infoPopup = L.popup()
                    .setLatLng([midLat, midLng])
                    .setContent(`
                        <div style="text-align: center;">
                            <h4 style="color: #dc3545; margin: 0 0 8px 0;">âš¡ æ•…éšœå€é–“</h4>
                            <p style="margin: 4px 0;"><strong>é¥‹ç·š:</strong> ${feeder}</p>
                            <p style="margin: 4px 0;"><strong>å€é–“:</strong> ${faultSection}</p>
                            <p style="margin: 4px 0; font-size: 11px; color: #666;">
                                ${coord1} â†” ${coord2}
                            </p>
                            <button onclick="clearFaultMarkers()" 
                                    style="margin-top: 8px; padding: 4px 8px; background: #6c757d; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 11px;">
                                æ¸…é™¤æ¨™è¨˜
                            </button>
                        </div>
                    `)
                    .openOn(map);
                
                L.DomEvent.stopPropagation(e);
            });
        }
        
        // å„²å­˜æ¨™è¨˜ä»¥ä¾¿å¾ŒçºŒæ¸…é™¤
        faultLineMarkers.push(marker1, marker2, faultLine);
        
        // ç§»å‹•åœ°åœ–åˆ°æ•…éšœå€åŸŸ
        const bounds = L.latLngBounds([[lat1, lng1], [lat2, lng2]]);
        map.fitBounds(bounds, { padding: [50, 50] });
        
        // ğŸ”§ ä¿®æ­£ï¼šåªåœ¨ä¸€é–‹å§‹è¼‰å…¥æ™‚é¡¯ç¤ºä¸­é–“å½ˆçª—
        const infoPopup = L.popup()
            .setLatLng([midLat, midLng])
            .setContent(`
                <div style="text-align: center;">
                    <h4 style="color: #dc3545; margin: 0 0 8px 0;">âš¡ æ•…éšœå€é–“</h4>
                    <p style="margin: 4px 0;"><strong>é¥‹ç·š:</strong> ${feeder}</p>
                    <p style="margin: 4px 0;"><strong>å€é–“:</strong> ${faultSection}</p>
                    <p style="margin: 4px 0; font-size: 11px; color: #666;">
                        ${coord1} â†” ${coord2}
                    </p>
                    <button onclick="clearFaultMarkers()" 
                            style="margin-top: 8px; padding: 4px 8px; background: #6c757d; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 11px;">
                        æ¸…é™¤æ¨™è¨˜
                    </button>
                </div>
            `)
            .openOn(map);
        
        // è‡ªå‹•è¼‰å…¥è©²é¥‹ç·šè³‡æ–™
        const feederInput = document.getElementById('feederInput');
        if (feederInput && feederList.includes(feeder)) {
            feederInput.value = feeder;
            showToast(`ğŸ”„ æ­£åœ¨è¼‰å…¥é¥‹ç·š ${feeder}...`, 'info');
            loadFeederFromCloud();
        } else if (!feederList.includes(feeder)) {
            showToast(`âš ï¸ é¥‹ç·š ${feeder} ä¸åœ¨å¯è¼‰å…¥æ¸…å–®ä¸­`, 'warning');
        }
        
        // ğŸ”§ ä¿®æ­£ï¼šä¸åŒè£ç½®çš„æç¤ºè¨Šæ¯
        if (isMobile) {
            showToast(`ğŸ—ºï¸ å·²æ¨™è¨˜ ${feeder} æ•…éšœä½ç½®ï¼Œé»æ“Šç´…ç·šæŸ¥çœ‹è©³æƒ…`, 'success');
        } else {
            showToast(`ğŸ—ºï¸ å·²æ¨™è¨˜ ${feeder} æ•…éšœä½ç½®ï¼Œé»æ“Šç´…è‰²æ¨™è¨˜æˆ–ç·šæ®µæŸ¥çœ‹è©³æƒ…`, 'success');
        }
        
    } catch (error) {
        console.error('é¡¯ç¤ºæ•…éšœä½ç½®å¤±æ•—:', error);
        showToast(`âŒ åº§æ¨™è½‰æ›å¤±æ•—: ${error.message}`, 'error');
    }
}



// ğŸ†• å…¨åŸŸè®Šæ•¸ï¼šå„²å­˜å¯æ‹–æ›³é¢æ¿
let draggableFaultPanel = null;

// ğŸ”§ ä¿®æ­£ç‰ˆï¼šå»ºç«‹é–ƒçˆæ¨™è¨˜ - æ‰‹æ©Ÿç‰ˆä¸é¡¯ç¤ºæ‹–æ›³é¢æ¿

// ğŸ”§ ä¿®æ­£ç‰ˆï¼šå»ºç«‹é–ƒçˆæ¨™è¨˜ - æ‰‹æ©Ÿç‰ˆåªé¡¯ç¤ºç°¡å–®æç¤º
function createBlinkingMarker(position, title, color, isMobile = false) {
    const blinkingIcon = L.divIcon({
        html: `
            <div style="
                width: 20px; 
                height: 20px; 
                background: ${color}; 
                border: 3px solid white; 
                border-radius: 50%; 
                box-shadow: 0 0 10px rgba(255,0,0,0.6);
                animation: blink 1s infinite;
                cursor: pointer;
            "></div>
            <style>
                @keyframes blink {
                    0%, 50% { opacity: 1; transform: scale(1); }
                    25%, 75% { opacity: 0.3; transform: scale(1.2); }
                }
            </style>
        `,
        className: 'blinking-marker',
        iconSize: [20, 20],
        iconAnchor: [10, 10]
    });
    
    const marker = L.marker(position, { icon: blinkingIcon })
        .bindPopup(title)
        .addTo(map);
    
    // ğŸ”§ ä¿®æ­£ï¼šæ ¹æ“šè£ç½®é¡å‹è¨­å®šä¸åŒçš„é»æ“Šè¡Œç‚º
    if (!isMobile) {
        // ğŸ–¥ï¸ æ¡Œé¢ç‰ˆï¼šé¡¯ç¤ºæ‹–æ›³é¢æ¿
        marker.on('click', function(e) {
            showDraggableFaultInfoPanel(position, title, color);
            L.DomEvent.stopPropagation(e);
        });
    } else {
        // ğŸ“± æ‰‹æ©Ÿç‰ˆï¼šé¡¯ç¤ºåŸæœ¬çš„ popup
        marker.on('click', function(e) {
            marker.openPopup();
            L.DomEvent.stopPropagation(e);
        });
    }
    
    return marker;
}

// ğŸ†• æ–°å¢ï¼šé¡¯ç¤ºå¯æ‹–æ›³çš„æ•…éšœè³‡è¨Šé¢æ¿ - æ”¯æ´æ–‡å­—é¸å–
function showDraggableFaultInfoPanel(position, title, color, faultInfo = null) {
    // ç§»é™¤ç¾æœ‰é¢æ¿
    if (draggableFaultPanel) {
        draggableFaultPanel.remove();
        draggableFaultPanel = null;
    }
    
    // ğŸ”§ ä¿®æ­£ï¼šè¨ˆç®—é¢æ¿é¡¯ç¤ºä½ç½®ï¼ˆåœ¨é»æ“Šä½ç½®é™„è¿‘ï¼‰
    const point = map.latLngToContainerPoint(position);
    let panelLeft = point.x + 20; // åç§»ä¸€é»é¿å…é®æ“‹
    let panelTop = point.y - 100;  // åœ¨é»æ“Šä½ç½®ä¸Šæ–¹
    
    // ç¢ºä¿é¢æ¿ä¸æœƒè¶…å‡ºè¦–çª—ç¯„åœ
    const panelWidth = 300;
    const panelHeight = 200;
    
    if (panelLeft + panelWidth > window.innerWidth) {
        panelLeft = point.x - panelWidth - 20; // æ”¾åˆ°å·¦å´
    }
    if (panelTop < 0) {
        panelTop = point.y + 20; // æ”¾åˆ°ä¸‹æ–¹
    }
    if (panelTop + panelHeight > window.innerHeight) {
        panelTop = window.innerHeight - panelHeight - 20;
    }
    
    // å‰µå»ºé¢æ¿
    const panel = document.createElement('div');
    panel.id = 'draggable-fault-info-panel';
    panel.style.cssText = `
        position: fixed;
        left: ${panelLeft}px;
        top: ${panelTop}px;
        width: 300px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        border: 2px solid ${color};
        z-index: 2500;
        font-family: Arial, sans-serif;
        overflow: hidden;
        cursor: move;
        animation: fadeInScale 0.2s ease-out;
    `;
    
    // å‰µå»ºé¢æ¿å…§å®¹
    let panelContent = `
        <!-- å¯æ‹–æ›³æ¨™é¡Œåˆ— -->
        <div class="fault-info-header" style="
            background: linear-gradient(135deg, ${color}, ${adjustColor(color, -20)}); 
            color: white; 
            padding: 8px 12px; 
            cursor: move;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        ">
            <div style="display: flex; align-items: center;">
                <i class="fas fa-grip-horizontal" style="margin-right: 6px; opacity: 0.7; font-size: 10px;"></i>
                <h4 style="margin: 0; font-size: 16px;">âš¡ æ•…éšœå€é–“è³‡è¨Š</h4>
            </div>
            <button onclick="closeDraggableFaultInfoPanel()" style="
                background: rgba(255,255,255,0.2); 
                color: white; 
                border: none; 
                border-radius: 50%; 
                width: 20px; 
                height: 20px; 
                font-size: 10px; 
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                user-select: none;
            ">âœ•</button>
        </div>
        
        <!-- é¢æ¿å…§å®¹ - ğŸ”§ é‡è¦ï¼šå…è¨±æ–‡å­—é¸å– -->
        <div class="fault-info-content" style="
            padding: 12px; 
            font-size: 12px;
            user-select: text;
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            cursor: text;
        ">
    `;
    
    if (faultInfo) {
        // ğŸ”§ ä¿®æ­£ï¼šé¡¯ç¤ºç°¡åŒ–çš„æ•…éšœè³‡è¨Š - æ”¯æ´æ–‡å­—é¸å–
        panelContent += `
            <div style="margin-bottom: 10px;">
                <div class="selectable-text" style="
                    background: #f8f9fa; 
                    padding: 8px; 
                    border-radius: 4px; 
                    margin-bottom: 8px;
                    user-select: text;
                    -webkit-user-select: text;
                    cursor: text;
                ">
                    <div style="font-weight: bold; color: #dc3545; margin-bottom: 3px; font-size: 16px; user-select: text;">
                        ğŸ­ ${faultInfo.feeder}
                    </div>
                    <div style="color: #666; font-size: 16px; user-select: text;">
                        ğŸ“ ${faultInfo.faultSection}
                    </div>
                </div>
                
                <!-- ğŸ”§ ä¿®æ­£ï¼šåº§æ¨™è³‡è¨Šå„ä¸€è¡Œ - æ”¯æ´æ–‡å­—é¸å– -->
                <div class="selectable-text" style="
                    background: #fff3cd; 
                    padding: 8px; 
                    border-radius: 4px; 
                    margin-bottom: 6px;
                    user-select: text;
                    -webkit-user-select: text;
                    cursor: text;
                ">
                    <div style="font-weight: bold; color: #856404; font-size: 16px; margin-bottom: 3px; user-select: text;">èµ·è¨–åœ–è™Ÿåº§æ¨™</div>
                    <div style="color: #666; font-size: 16px; user-select: text; word-break: break-all;">${faultInfo.coord1} â†” ${faultInfo.coord2}</div>
                </div>
                
                <div class="selectable-text" style="
                    background: #f8d7da; 
                    padding: 8px; 
                    border-radius: 4px; 
                    margin-bottom: 10px;
                    user-select: text;
                    -webkit-user-select: text;
                    cursor: text;
                ">
                    <div style="font-weight: bold; color: #721c24; font-size: 16px; margin-bottom: 3px; user-select: text;">ç¶“ç·¯åº¦åº§æ¨™</div>
                    <div style="color: #666; font-size: 11px; user-select: text; word-break: break-all;">
                        ${faultInfo.startPoint[0].toFixed(6)}, ${faultInfo.startPoint[1].toFixed(6)} â†” 
                        ${faultInfo.endPoint[0].toFixed(6)}, ${faultInfo.endPoint[1].toFixed(6)}
                    </div>
                </div>
                
                <!-- ğŸ†• æ–°å¢ï¼šä¸€éµè¤‡è£½æŒ‰éˆ• -->
                <div style="margin-bottom: 10px;">
                    <button onclick="copyFaultInfoText('${faultInfo.feeder}', '${faultInfo.faultSection}', '${faultInfo.coord1}', '${faultInfo.coord2}', ${faultInfo.startPoint[0]}, ${faultInfo.startPoint[1]}, ${faultInfo.endPoint[0]}, ${faultInfo.endPoint[1]})" 
                            style="width: 100%; padding: 8px; background: #17a2b8; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px; font-weight: bold; user-select: none;">
                        ğŸ“‹ è¤‡è£½æ•…éšœè³‡è¨Š
                    </button>
                </div>
            </div>
        `;
    } else {
        // é¡¯ç¤ºåŸºæœ¬ä½ç½®è³‡è¨Š - æ”¯æ´æ–‡å­—é¸å–
        panelContent += `
            <div style="margin-bottom: 10px;">
                <div class="selectable-text" style="
                    background: #f8f9fa; 
                    padding: 8px; 
                    border-radius: 4px; 
                    text-align: center; 
                    margin-bottom: 8px;
                    user-select: text;
                    -webkit-user-select: text;
                    cursor: text;
                ">
                    <div style="font-weight: bold; color: #dc3545; margin-bottom: 3px; user-select: text;">
                        ğŸ“ ${title}
                    </div>
                    <div style="color: #666; font-size: 11px; user-select: text;">
                        ${position[0].toFixed(6)}, ${position[1].toFixed(6)}
                    </div>
                </div>
            </div>
        `;
    }
    
    panelContent += `
            <div style="text-align: center; padding-top: 8px; border-top: 1px solid #eee;">
                <button onclick="closeDraggableFaultInfoPanel()" 
                        style="padding: 4px 8px; background: #6c757d; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 10px; user-select: none;">
                    é—œé–‰
                </button>
            </div>
        </div>
        
        <style>
            @keyframes fadeInScale {
                from {
                    opacity: 0;
                    transform: scale(0.8);
                }
                to {
                    opacity: 1;
                    transform: scale(1);
                }
            }
            
            /* ğŸ†• æ–°å¢ï¼šç¢ºä¿æ–‡å­—é¸å–æ¨£å¼ */
            .selectable-text::selection {
                background-color: #007bff;
                color: white;
            }
            
            .selectable-text::-moz-selection {
                background-color: #007bff;
                color: white;
            }
            
            /* ğŸ†• æ–°å¢ï¼šæ»‘é¼ æ‡¸åœæç¤º */
            .selectable-text:hover {
                background-color: rgba(0, 123, 255, 0.05) !important;
                transition: background-color 0.2s ease;
            }
        </style>
    `;
    
    panel.innerHTML = panelContent;
    document.body.appendChild(panel);
    draggableFaultPanel = panel;
    
    // ä½¿é¢æ¿å¯æ‹–æ›³
    makeFaultInfoPanelDraggable(panel);
}


// ğŸ†• æ–°å¢ï¼šè¤‡è£½æ•…éšœè³‡è¨Šæ–‡å­—åŠŸèƒ½
function copyFaultInfoText(feeder, faultSection, coord1, coord2, startLat, startLng, endLat, endLng) {
    const faultInfoText = `âš¡ æ•…éšœå€é–“è³‡è¨Š

ğŸ­ é¥‹ç·šï¼š${feeder}
ğŸ“ æ•…éšœå€é–“ï¼š${faultSection}

ğŸ“ èµ·è¨–åœ–è™Ÿåº§æ¨™ï¼š
${coord1} â†” ${coord2}

ğŸŒ ç¶“ç·¯åº¦åº§æ¨™ï¼š
${startLat.toFixed(6)}, ${startLng.toFixed(6)} â†” ${endLat.toFixed(6)}, ${endLng.toFixed(6)}

ğŸ“… è¤‡è£½æ™‚é–“ï¼š${new Date().toLocaleString('zh-TW')}`;

    // è¤‡è£½åˆ°å‰ªè²¼ç°¿
    if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(faultInfoText).then(() => {
            showToast('ğŸ“‹ æ•…éšœè³‡è¨Šå·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼', 'success');
        }).catch(err => {
            console.error('è¤‡è£½å¤±æ•—:', err);
            fallbackCopyText(faultInfoText);
        });
    } else {
        fallbackCopyText(faultInfoText);
    }
}

// ğŸ”§ ä¿®æ­£ç‰ˆï¼šä½¿æ•…éšœè³‡è¨Šé¢æ¿å¯æ‹–æ›³ - é¿å…æ‹–æ›³æ™‚é¸å–æ–‡å­—
function makeFaultInfoPanelDraggable(panel) {
    let isDragging = false;
    let currentX;
    let currentY;
    let initialX;
    let initialY;
    let xOffset = 0;
    let yOffset = 0;
    
    const header = panel.querySelector('.fault-info-header');
    if (!header) return;
    
    // ç²å–åˆå§‹ä½ç½®
    const rect = panel.getBoundingClientRect();
    xOffset = rect.left;
    yOffset = rect.top;
    
    header.addEventListener('mousedown', dragStart);
    document.addEventListener('mousemove', drag);
    document.addEventListener('mouseup', dragEnd);
    
    // è§¸æ§æ”¯æ´
    header.addEventListener('touchstart', dragStart, { passive: false });
    document.addEventListener('touchmove', drag, { passive: false });
    document.addEventListener('touchend', dragEnd);
    
    function dragStart(e) {
        e.preventDefault();
        
        if (e.type === "touchstart") {
            initialX = e.touches[0].clientX - xOffset;
            initialY = e.touches[0].clientY - yOffset;
        } else {
            initialX = e.clientX - xOffset;
            initialY = e.clientY - yOffset;
        }
        
        if (e.target === header || header.contains(e.target)) {
            isDragging = true;
            panel.style.cursor = 'grabbing';
            header.style.cursor = 'grabbing';
            
            // ğŸ”§ é‡è¦ï¼šæ‹–æ›³æ™‚æš«æ™‚ç¦ç”¨æ–‡å­—é¸å–
            panel.style.userSelect = 'none';
            panel.style.webkitUserSelect = 'none';
            panel.style.mozUserSelect = 'none';
            panel.style.msUserSelect = 'none';
        }
    }
    
    function drag(e) {
        if (isDragging) {
            e.preventDefault();
            
            if (e.type === "touchmove") {
                currentX = e.touches[0].clientX - initialX;
                currentY = e.touches[0].clientY - initialY;
            } else {
                currentX = e.clientX - initialX;
                currentY = e.clientY - initialY;
            }
            
            xOffset = currentX;
            yOffset = currentY;
            
            // é™åˆ¶æ‹–æ›³ç¯„åœåœ¨è¦–çª—å…§
            const rect = panel.getBoundingClientRect();
            const maxX = window.innerWidth - rect.width;
            const maxY = window.innerHeight - rect.height;
            
            xOffset = Math.max(0, Math.min(maxX, xOffset));
            yOffset = Math.max(0, Math.min(maxY, yOffset));
            
            panel.style.left = `${xOffset}px`;
            panel.style.top = `${yOffset}px`;
        }
    }
    
    function dragEnd(e) {
        initialX = currentX;
        initialY = currentY;
        isDragging = false;
        
        panel.style.cursor = 'move';
        header.style.cursor = 'move';
        
        // ğŸ”§ é‡è¦ï¼šæ‹–æ›³çµæŸå¾Œæ¢å¾©æ–‡å­—é¸å–åŠŸèƒ½
        setTimeout(() => {
            panel.style.userSelect = '';
            panel.style.webkitUserSelect = '';
            panel.style.mozUserSelect = '';
            panel.style.msUserSelect = '';
            
            // æ¢å¾©å…§å®¹å€åŸŸçš„æ–‡å­—é¸å–
            const content = panel.querySelector('.fault-info-content');
            if (content) {
                content.style.userSelect = 'text';
                content.style.webkitUserSelect = 'text';
                content.style.cursor = 'text';
            }
        }, 100);
    }
}
// ğŸ†• æ–°å¢ï¼šé—œé–‰å¯æ‹–æ›³æ•…éšœè³‡è¨Šé¢æ¿
function closeDraggableFaultInfoPanel() {
    if (draggableFaultPanel) {
        draggableFaultPanel.style.transition = 'all 0.2s ease';
        draggableFaultPanel.style.opacity = '0';
        draggableFaultPanel.style.transform = 'scale(0.8)';
        
        setTimeout(() => {
            if (draggableFaultPanel && draggableFaultPanel.parentNode) {
                draggableFaultPanel.remove();
            }
            draggableFaultPanel = null;
        }, 200);
    }
}



// ğŸ”§ ä¿®æ­£ç‰ˆï¼šæ¸…é™¤æ•…éšœæ¨™è¨˜ - åŒæ™‚é—œé–‰æ‹–æ›³é¢æ¿
function clearFaultMarkers() {
    faultLineMarkers.forEach(marker => {
        if (map.hasLayer(marker)) {
            map.removeLayer(marker);
        }
    });
    faultLineMarkers = [];
    map.closePopup();
    
    // é—œé–‰æ‹–æ›³é¢æ¿
    closeDraggableFaultInfoPanel();
    
    console.log('ğŸ§¹ å·²æ¸…é™¤æ•…éšœæ¨™è¨˜å’Œé¢æ¿');
}


// ğŸ”§ ä¿®æ­£ç‰ˆï¼šé‡æ–°æ•´ç†åœé›»è³‡æ–™ - ä¿æŒç¯©é¸ç‹€æ…‹
async function refreshOutageData() {
    updateOutageStatus('æ­£åœ¨é‡æ–°æ•´ç†...');
    
    // ğŸ”§ è¨˜ä½ç•¶å‰ç¯©é¸ç‹€æ…‹
    const currentFilter = document.getElementById('outageFilter')?.value || 'all';
    
    const success = await loadOutageData();
    if (success) {
        showToast('âœ… åœé›»è³‡æ–™å·²æ›´æ–°', 'success');
        
        // ğŸ†• é‡æ–°æ‡‰ç”¨ç¯©é¸
        if (currentFilter !== 'all') {
            setTimeout(() => {
                document.getElementById('outageFilter').value = currentFilter;
                filterOutageByStatus();
            }, 200);
        }
    } else {
        showToast('âŒ åœé›»è³‡æ–™æ›´æ–°å¤±æ•—', 'error');
    }
}

// ğŸ†• é¡¯ç¤ºåœé›»åœ°åœ–ç¸½è¦½
function showOutageMap() {
    if (!outageData || outageData.length === 0) {
        showToast('âŒ ç„¡åœé›»è³‡æ–™å¯é¡¯ç¤º', 'error');
        return;
    }
    
    // æ¸…é™¤ç¾æœ‰æ¨™è¨˜
    clearFaultMarkers();
    
    let markerCount = 0;
    const bounds = L.latLngBounds();
    
    outageData.forEach(record => {
        const coord1 = record.æ•…éšœå€é–“åœ–è™Ÿåº§æ¨™1;
        const coord2 = record.æ•…éšœå€é–“åœ–è™Ÿåº§æ¨™2;
        
        if (coord1 && coord2) {
            try {
                const pos1 = convertPowerCoordinate(coord1);
                const pos2 = convertPowerCoordinate(coord2);
                
                const [lng1, lat1] = pos1.split(',').map(Number);
                const [lng2, lat2] = pos2.split(',').map(Number);
                
                // å»ºç«‹æ•…éšœç·šæ®µ
                const faultLine = L.polyline([[lat1, lng1], [lat2, lng2]], {
                    color: '#dc3545',
                    weight: 4,
                    opacity: 0.7
                }).addTo(map);
                
                // åŠ å…¥å½ˆçª—è³‡è¨Š
                faultLine.bindPopup(`
                    <div style="text-align: center;">
                        <h4 style="color: #dc3545;">âš¡ ${record.é¥‹ç·š}</h4>
                        <p><strong>æ•…éšœå€é–“:</strong> ${record.æ•…éšœå€é–“}</p>
                        <p><strong>æ™‚é–“:</strong> ${record.æ™‚é–“}</p>
                        <p><strong>è™•ç†éƒ¨é–€:</strong> ${record.è™•ç†éƒ¨é–€}</p>
                    </div>
                `);
                
                faultLineMarkers.push(faultLine);
                bounds.extend([[lat1, lng1], [lat2, lng2]]);
                markerCount++;
                
            } catch (error) {
                console.warn(`åº§æ¨™è½‰æ›å¤±æ•—: ${coord1}, ${coord2}`, error);
            }
        }
    });
    
    if (markerCount > 0) {
        map.fitBounds(bounds, { padding: [20, 20] });
        showToast(`ğŸ—ºï¸ å·²é¡¯ç¤º ${markerCount} å€‹æ•…éšœä½ç½®`, 'success');
    } else {
        showToast('âŒ ç„¡æœ‰æ•ˆåº§æ¨™è³‡æ–™å¯é¡¯ç¤º', 'error');
    }
}

// è¼‰å…¥ç½æƒ…è³‡æ–™
// ğŸ”§ ä¿®æ­£ç‰ˆï¼šè¼‰å…¥ç½æƒ…è³‡æ–™ - å›å‚³ Promise
async function loadDisasterData() {
    const gasWebAppUrl = 'https://script.google.com/macros/s/AKfycbxWA8-1wYXphRX54QJwhTaE9T5A6eUZyQs2kYDfGw2fS5ELp75uY_P6SjYx1EuMtjFr/exec';
    
    try {
        console.log('ğŸ”„ æ­£åœ¨è¼‰å…¥ç½æƒ…è³‡æ–™...');
        updateDisasterStatus('æ­£åœ¨è¼‰å…¥ç½æƒ…è³‡æ–™...');
        
        const response = await fetch(`${gasWebAppUrl}?action=getData&_t=${Date.now()}`);
        const result = await response.json();
        
        if (result.success && Array.isArray(result.data)) {
            disasterData = result.data;
            console.log(`âœ… æˆåŠŸè¼‰å…¥ ${disasterData.length} ç­†ç½æƒ…è³‡æ–™`);
            
            updateDisasterStatus(`âœ… å·²è¼‰å…¥ ${disasterData.length} ç­†ç½æƒ…è³‡æ–™ (${new Date(result.meta.lastUpdate).toLocaleString('zh-TW')})`);
            createDisasterReportList();
            
            // ğŸ”§ é‡è¦ï¼šå›å‚³æˆåŠŸçš„ Promise
            return Promise.resolve(result.data);
        } else {
            throw new Error(result.error || 'ç„¡æ•ˆçš„ç½æƒ…è³‡æ–™æ ¼å¼');
        }
        
    } catch (error) {
        console.error('âŒ è¼‰å…¥ç½æƒ…è³‡æ–™å¤±æ•—:', error);
        updateDisasterStatus('âŒ ç½æƒ…è³‡æ–™è¼‰å…¥å¤±æ•—');
        
        // ğŸ”§ é‡è¦ï¼šå›å‚³å¤±æ•—çš„ Promise
        return Promise.reject(error);
    }
}

// æ›´æ–°ç½æƒ…ç‹€æ…‹é¡¯ç¤º
function updateDisasterStatus(message) {
    const statusElement = document.getElementById('disasterStatus');
    if (statusElement) {
        statusElement.textContent = message;
    }
}

// å»ºç«‹ç½æƒ…å ±å‘Šæ¸…å–®
function createDisasterReportList() {
    const listContainer = document.getElementById('disasterReportList');
    if (!listContainer || !disasterData) return;
    
    let listHtml = '';
    
    if (disasterData.length === 0) {
        listHtml = '<div style="text-align: center; color: #28a745; padding: 20px;">âœ… ç›®å‰ç„¡ç½æƒ…å ±å‘Š</div>';
    } else {
        disasterData.forEach((report, index) => {
            const repairStatus = report['ä¿®å¾©ç‹€æ…‹'] || 'æœªæ´¾ä¿®';
            const statusColor = getRepairStatusColor(repairStatus);
            const severityLevel = report['åš´é‡ç­‰ç´š'] || 'æœªå®šç¾©';
            
            listHtml += `
                <div class="disaster-report-item" style="margin-bottom: 10px; padding: 12px; background: white; border-radius: 6px; border-left: 4px solid ${statusColor}; cursor: pointer;"
                     onclick="selectDisasterReport('${report.id}')">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong style="color: ${statusColor}; font-size: 14px;">ğŸš¨ ${report.incidents?.[0]?.type || 'ç½æƒ…å ±å‘Š'}</strong>
                            <div style="font-size: 11px; color: #666; margin-top: 2px;">
                                ${report.timestamp} | ${report['å·¡ä¿®éƒ¨é–€'] || 'æœªæŒ‡å®š'}
                            </div>
                            <div style="font-size: 10px; color: ${statusColor}; margin-top: 2px; font-weight: bold;">
                                ${repairStatus}
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <span class="severity-badge severity-${severityLevel.replace(/\s+/g, '-')}">${severityLevel}</span>
                        </div>
                    </div>
                    <div style="font-size: 11px; color: #666; margin-top: 4px;">
                        ${report.location?.tpcMapNumber || report.location?.poleNumber || 'ä½ç½®è³‡è¨Šä¸å®Œæ•´'}
                    </div>
                </div>
            `;
        });
    }
    
    listContainer.innerHTML = listHtml;
}

// å–å¾—ä¿®å¾©ç‹€æ…‹é¡è‰²
function getRepairStatusColor(status) {
    switch(status) {
        case 'å·²ä¿®å¾©': return '#28a745';
        case 'å·²æ´¾ä¿®': return '#ffc107';
        default: return '#dc3545';
    }
}

// é¸æ“‡ç½æƒ…å ±å‘Š
function selectDisasterReport(reportId) {
    console.log(`ğŸ” é¸æ“‡ç½æƒ…å ±å‘Š: ${reportId}`);
    
    const report = disasterData.find(r => r.id === reportId);
    if (!report) {
        showToast(`æ‰¾ä¸åˆ°ç½æƒ…å ±å‘Š ${reportId}`, 'error');
        return;
    }
    
    showDisasterReportDetails(report);
}

// é¡¯ç¤ºç½æƒ…å ±å‘Šè©³æƒ…
function showDisasterReportDetails(report) {
    // æ¸…é™¤ç¾æœ‰ç½æƒ…æ¨™è¨˜
    clearDisasterMarkers();
    
    // åœ¨åœ°åœ–ä¸Šæ¨™è¨˜ä½ç½®
    if (report.location && report.location.latitude && report.location.longitude) {
        const marker = createDisasterMarker(report);
        disasterMarkers.push(marker);
        
        // ç§»å‹•åœ°åœ–åˆ°è©²ä½ç½®
        map.setView([report.location.latitude, report.location.longitude], 16);
        
        // æ‰“é–‹å½ˆå‡ºçª—å£
        marker.openPopup();
		showToast('å·²é¸æ“‡ç½æƒ…æ¨™ç±¤!', 'success')
    } else {
        showToast('è©²å ±å‘Šæ²’æœ‰æœ‰æ•ˆçš„ä½ç½®è³‡è¨Š', 'warning');
    }
}

// å»ºç«‹ç½æƒ…æ¨™è¨˜
// ğŸ”§ ä¿®æ­£ç‰ˆï¼šå»ºç«‹ç½æƒ…æ¨™è¨˜ - æ¢å¾©æ­£å¸¸å½ˆå‡ºè¦–çª—åŠŸèƒ½
function createDisasterMarker(report) {
    const repairStatus = report['ä¿®å¾©ç‹€æ…‹'] || 'æœªæ´¾ä¿®';
    const severityLevel = report['åš´é‡ç­‰ç´š'] || 'æœªå®šç¾©';
    
    // æ ¹æ“šç‹€æ…‹è¨­ç½®åœ–æ¨™é¡è‰²
    let iconUrl;
    if (repairStatus === 'å·²ä¿®å¾©') {
        iconUrl = 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png';
    } else {
        switch (severityLevel) {
            case 'æ¥µåš´é‡':
                iconUrl = 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-violet.png';
                break;
            case 'åš´é‡':
                iconUrl = 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png';
                break;
            case 'ä¸€èˆ¬':
                iconUrl = 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-orange.png';
                break;
            case 'è¼•å¾®':
                iconUrl = 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-yellow.png';
                break;
            case 'ä¸å½±éŸ¿':
                iconUrl = 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-grey.png';
                break;
            default:
                iconUrl = 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png';
        }
    }
    
    const customIcon = L.icon({
        iconUrl: iconUrl,
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
    });
    
    const marker = L.marker([report.location.latitude, report.location.longitude], {
        icon: customIcon
    }).addTo(map);
    
    // å»ºç«‹å½ˆå‡ºçª—å£å…§å®¹
    let popupContent = createDisasterPopupContent(report);
    
    // ğŸ”§ é‡è¦ä¿®æ­£ï¼šä½¿ç”¨æ¨™æº–çš„ Leaflet å½ˆå‡ºè¦–çª—ç¶å®šï¼Œä¸è¦è‡ªè¨‚é»æ“Šäº‹ä»¶
    marker.bindPopup(popupContent, {
        maxWidth: 320,
        minWidth: 280,
        className: 'disaster-popup'
    });
    
    return marker;
}

// ğŸ”§ ä¿®æ­£ç‰ˆï¼šå»ºç«‹ç½æƒ…å½ˆå‡ºçª—å£å…§å®¹ - æ–°å¢è¤‡è£½æ¨™ç±¤è³‡è¨ŠåŠŸèƒ½
function createDisasterPopupContent(report) {
    const repairStatus = report['ä¿®å¾©ç‹€æ…‹'] || 'æœªæ´¾ä¿®';
    const severityLevel = report['åš´é‡ç­‰ç´š'] || 'æœªå®šç¾©';
    
    let popupContent = `<div class="popup-content">`;
    
    // æ·»åŠ ä¿®å¾©ç‹€æ…‹æ¨™ç±¤
    if (repairStatus === 'å·²ä¿®å¾©') {
        popupContent += `<span class="repair-status-badge repair-status-completed">ä¿®å¾©è¨–</span>`;
    } else if (repairStatus === 'å·²æ´¾ä¿®') {
        popupContent += `<span class="repair-status-badge repair-status-dispatched">å·²æ´¾ä¿®</span>`;
        if (report['æ´¾ä¿®æ™‚é–“']) {
            popupContent += `
                <div style="margin-top: 5px; padding: 8px; background-color: #f8f9fa; border-radius: 5px; font-size: 12px;">
                    <p style="margin: 0;"><strong>æ´¾ä¿®äººå“¡:</strong> ${report['ä¿®å¾©äººå“¡'] || 'æœªæŒ‡å®š'}</p>
                    <p style="margin: 0;"><strong>æ´¾ä¿®æ™‚é–“:</strong> ${report['æ´¾ä¿®æ™‚é–“']}</p>
                </div>
            `;
        }
    } else {
        popupContent += `<span class="repair-status-badge repair-status-pending">æœªæ´¾ä¿®</span>`;
    }
    
    popupContent += `<h6>å ±å‘Šæ™‚é–“: ${report.timestamp || 'æœªçŸ¥'}</h6>`;
    
    // æ·»åŠ äº‹æ•…æ¸…å–®
    popupContent += `<p class="mt-2"><strong>äº‹æ•…:</strong> `;
    if (Array.isArray(report.incidents) && report.incidents.length > 0) {
        const incidentTexts = report.incidents.map(incident => 
            `${incident.type || 'æœªçŸ¥'} (${incident.quantity || 0} ${incident.unit || ''})`
        );
        popupContent += incidentTexts.join(', ');
    } else {
        popupContent += 'ç„¡äº‹æ•…æ•¸æ“š';
    }
    popupContent += `</p>`;
    
    // æ·»åŠ ä½ç½®è³‡è¨Š
    if (report.location?.tpcMapNumber) {
        popupContent += `<strong>å°é›»åœ–è™Ÿ:</strong> ${report.location.tpcMapNumber}<br>`;
    }
    if (report.location?.poleNumber) {
        popupContent += `<strong>æ¡¿è™Ÿ:</strong> ${report.location.poleNumber}<br>`;
    }
    
    // æ·»åŠ è¨­å‚™è³‡è¨Š
    if (report['é¥‹ç·šä»£è™Ÿ']) {
        popupContent += `<strong>é¥‹ç·šä»£è™Ÿ:</strong> ${report['é¥‹ç·šä»£è™Ÿ']}<br>`;
    }
    if (report['ç·šè·¯é¡å‹']) {
        popupContent += `<strong>ç·šè·¯é¡å‹:</strong> ${report['ç·šè·¯é¡å‹']}<br>`;
    }
    if (report['å·¡ä¿®éƒ¨é–€']) {
        popupContent += `<strong>å·¡ä¿®éƒ¨é–€:</strong> ${report['å·¡ä¿®éƒ¨é–€']}<br>`;
    }
    
    // æ·»åŠ å‚™è¨»
    if (report.remarks && report.remarks.trim() !== '') {
        popupContent += `<strong>å‚™è¨»:</strong> <span style="color: #dc3545;">${report.remarks}</span><br>`;
    }
    
    // ç…§ç‰‡é è¦½ï¼ˆä¿æŒåŸæœ‰åŠŸèƒ½ï¼‰
    if (Array.isArray(report.photos) && report.photos.length > 0) {
        popupContent += `<div class="popup-photos" style="margin-top: 10px;">
            <strong>ç…§ç‰‡ (${report.photos.length}):</strong><br>
            <div class="photo-gallery" style="display: flex; gap: 5px; flex-wrap: wrap; margin-top: 5px;">`;
        
        report.photos.forEach((photo, photoIndex) => {
            let photoUrl, photoName;
            
            if (typeof photo === 'string') {
                photoUrl = photo;
                photoName = `ç…§ç‰‡ ${photoIndex+1}`;
            } else if (photo && typeof photo === 'object') {
                photoUrl = photo.url || photo.src || photo.path || '';
                photoName = photo.name || `ç…§ç‰‡ ${photoIndex+1}`;
            } else {
                return;
            }
            
            if (!photoUrl) return;
            
            const thumbnailUrl = fixGoogleDrivePhotoUrl(photoUrl, false);
            
            popupContent += `
                <div style="position: relative; width: 60px; height: 60px; border: 1px solid #ddd; border-radius: 4px; overflow: hidden; background: #f8f9fa;">
                    <img src="${thumbnailUrl}" 
                         alt="${photoName}" 
                         onclick="openPhotoModalSafe('${photoUrl}', '${report.id}_${photoIndex}')" 
                         style="width: 100%; height: 100%; object-fit: cover; cursor: pointer; transition: transform 0.2s;"
                         onload="this.parentElement.style.background='transparent'"
                         onerror="handleThumbnailError(this, '${photoUrl}', '${photoIndex}')"
                         onmouseover="this.style.transform='scale(1.05)'"
                         onmouseout="this.style.transform='scale(1)'">
                    <div class="photo-placeholder" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #e9ecef; display: none; align-items: center; justify-content: center; font-size: 8px; color: #6c757d; text-align: center; line-height: 1.2;">
                        ğŸ“·<br>ç…§ç‰‡<br>${photoIndex + 1}
                    </div>
                </div>
            `;
        });
        
        popupContent += `</div>`;
        popupContent += `<div style="font-size: 10px; color: #6c757d; margin-top: 5px; text-align: center;">é»æ“Šç…§ç‰‡æ”¾å¤§æª¢è¦–</div></div>`;
    }
    
    // å°èˆªåŠŸèƒ½
    if (report.location?.latitude && report.location?.longitude) {
        const lat = report.location.latitude;
        const lng = report.location.longitude;
        const locationName = getDisasterLocationName(report);
        
        popupContent += `<div style="margin-top: 10px; display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">`;
        
        // è¡—æ™¯æŒ‰éˆ•
        popupContent += `
            <button onclick="openStreetView(${lat}, ${lng})" 
                    style="padding: 8px 6px; background: #4285f4; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px; font-weight: bold;"
                    title="é–‹å•Ÿ Google è¡—æ™¯åœ–">
                ğŸ—ºï¸ è¡—æ™¯
            </button>
        `;
        
        // å°èˆªæŒ‰éˆ•
        popupContent += `
            <button onclick="openNavigation(${lat}, ${lng}, '${encodeURIComponent(locationName)}')" 
                    style="padding: 8px 6px; background: #34a853; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px; font-weight: bold;"
                    title="é–‹å•Ÿ Google å°èˆª">
                ğŸ§­ å°èˆª
            </button>
        `;
        
        popupContent += `</div>`;
        
        // è¤‡è£½åº§æ¨™æŒ‰éˆ•
        popupContent += `
            <div style="margin-top: 8px;">
                <button onclick="copyCoordinates(${lat}, ${lng})" 
                        style="width: 100%; padding: 6px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 10px;"
                        title="è¤‡è£½ç¶“ç·¯åº¦åº§æ¨™">
                    ğŸ“‹ è¤‡è£½åº§æ¨™ (${lat.toFixed(6)}, ${lng.toFixed(6)})
                </button>
            </div>
        `;
        
        // ğŸ†• æ–°å¢ï¼šè¤‡è£½æ¨™ç±¤è³‡è¨ŠæŒ‰éˆ•
        popupContent += `
            <div style="margin-top: 6px;">
                <button onclick="copyDisasterMarkerInfo('${report.id}', ${lat}, ${lng})" 
                        style="width: 100%; padding: 6px; background: #17a2b8; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 10px;"
                        title="è¤‡è£½å¯åˆ†äº«çš„æ¨™ç±¤é€£çµ">
                    ğŸ”— è¤‡è£½æ¨™ç±¤è³‡è¨Š
                </button>
            </div>
        `;
        
    } else {
        // å¦‚æœæ²’æœ‰åº§æ¨™ï¼Œé¡¯ç¤ºç„¡æ³•å°èˆªçš„æç¤º
        popupContent += `
            <div style="margin-top: 10px; padding: 8px; background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 4px; text-align: center;">
                <span style="color: #721c24; font-size: 11px;">âŒ æ­¤ç½æƒ…ç„¡ä½ç½®è³‡è¨Šï¼Œç„¡æ³•æä¾›å°èˆªåŠŸèƒ½</span>
            </div>
        `;
    }
    
    popupContent += `</div>`;
    
    return popupContent;
}
// ğŸ”§ ä¿®æ­£ç‰ˆï¼šè¤‡è£½ç½æƒ…æ¨™ç±¤è³‡è¨ŠåŠŸèƒ½ - ä½¿ç”¨æŒ‡å®šçš„ç¶²å€
function copyDisasterMarkerInfo(reportId, lat, lng) {
    try {
        // æ‰¾åˆ°å°æ‡‰çš„ç½æƒ…å ±å‘Š
        const report = disasterData.find(r => r.id === reportId);
        if (!report) {
            showToast('âŒ æ‰¾ä¸åˆ°ç½æƒ…è³‡æ–™', 'error');
            return;
        }
        
        // ğŸ”§ ä¿®æ­£ï¼šä½¿ç”¨æŒ‡å®šçš„æ­£å¼ç¶²å€è€Œä¸æ˜¯ç•¶å‰é é¢ç¶²å€
        const baseUrl = 'https://feeder-map.vercel.app/';
        const shareUrl = `${baseUrl}#disaster/${reportId}/${lat.toFixed(6)}/${lng.toFixed(6)}`;
        
        // å»ºç«‹æ¨™ç±¤è³‡è¨Šæ–‡å­—
        const repairStatus = report['ä¿®å¾©ç‹€æ…‹'] || 'æœªæ´¾ä¿®';
        const severityLevel = report['åš´é‡ç­‰ç´š'] || 'æœªå®šç¾©';
        const incidentText = Array.isArray(report.incidents) && report.incidents.length > 0 
            ? report.incidents.map(incident => `${incident.type || 'æœªçŸ¥'} (${incident.quantity || 0} ${incident.unit || ''})`).join(', ')
            : 'ç„¡äº‹æ•…æ•¸æ“š';
        
        // ğŸ”§ ä¿®æ­£ï¼šæ ¼å¼åŒ–æ™‚é–“é¡¯ç¤º
        const formattedTime = formatDisasterTime(report.timestamp);
        
        const shareText = `ğŸš¨ ç½æƒ…æ¨™ç±¤è³‡è¨Š

ğŸ“… æ™‚é–“ï¼š${formattedTime}
ğŸ”§ ç‹€æ…‹ï¼š${repairStatus}
âš ï¸ ç­‰ç´šï¼š${severityLevel}
ğŸš¨ äº‹æ•…ï¼š${incidentText}
${report.location?.tpcMapNumber ? `ğŸ“ å°é›»åœ–è™Ÿï¼š${report.location.tpcMapNumber}` : ''}
${report.location?.poleNumber ? `ğŸ—ï¸ æ¡¿è™Ÿï¼š${report.location.poleNumber}` : ''}
${report['é¥‹ç·šä»£è™Ÿ'] ? `âš¡ é¥‹ç·šï¼š${report['é¥‹ç·šä»£è™Ÿ']}` : ''}
${report['å·¡ä¿®éƒ¨é–€'] ? `ğŸ¢ éƒ¨é–€ï¼š${report['å·¡ä¿®éƒ¨é–€']}` : ''}
${report.remarks ? `ğŸ’¬ å‚™è¨»ï¼š${report.remarks}` : ''}

ğŸ“ ä½ç½®ï¼š${lat.toFixed(6)}, ${lng.toFixed(6)}
ğŸ”— æŸ¥çœ‹è©³æƒ…ï¼š${shareUrl}

â€» é»æ“Šé€£çµå¯åœ¨åœ°åœ–ä¸Šé–‹å•Ÿæ­¤ç½æƒ…æ¨™ç±¤`;

        // è¤‡è£½åˆ°å‰ªè²¼ç°¿
        if (navigator.clipboard && window.isSecureContext) {
            navigator.clipboard.writeText(shareText).then(() => {
                showToast('ğŸ”— ç½æƒ…æ¨™ç±¤è³‡è¨Šå·²è¤‡è£½ï¼å¯åˆ†äº«çµ¦ä»–äººæŸ¥çœ‹', 'success');
                
                // åŒæ™‚å„²å­˜ URL ç‹€æ…‹
                window.history.pushState(
                    { type: 'disaster', reportId, lat, lng }, 
                    `ç½æƒ… ${reportId}`, 
                    shareUrl
                );
                
            }).catch(err => {
                console.error('è¤‡è£½å¤±æ•—:', err);
                fallbackCopyDisasterInfo(shareText);
            });
        } else {
            fallbackCopyDisasterInfo(shareText);
        }
        
    } catch (error) {
        console.error('âŒ è¤‡è£½ç½æƒ…æ¨™ç±¤è³‡è¨Šå¤±æ•—:', error);
        showToast('âŒ è¤‡è£½å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
    }
}
// ğŸ†• æ ¼å¼åŒ–ç½æƒ…æ™‚é–“é¡¯ç¤º
function formatDisasterTime(timestamp) {
    if (!timestamp) return 'æœªçŸ¥';
    
    try {
        // å¦‚æœå·²ç¶“æ˜¯æ ¼å¼åŒ–çš„å­—ä¸²ï¼Œç›´æ¥è¿”å›
        if (typeof timestamp === 'string' && !timestamp.includes('GMT')) {
            return timestamp;
        }
        
        // å¦‚æœæ˜¯ Date ç‰©ä»¶æˆ–æ™‚é–“æˆ³è¨˜ï¼Œæ ¼å¼åŒ–ç‚ºå°ç£æ™‚é–“
        const date = new Date(timestamp);
        if (isNaN(date.getTime())) {
            return timestamp; // å¦‚æœç„¡æ³•è§£æï¼Œè¿”å›åŸå§‹å€¼
        }
        
        // æ ¼å¼åŒ–ç‚º YYYY/MM/DD HH:mm:ss æ ¼å¼
        return date.toLocaleString('zh-TW', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit',
            hour12: false
        });
        
    } catch (error) {
        console.error('æ™‚é–“æ ¼å¼åŒ–éŒ¯èª¤:', error);
        return timestamp;
    }
}
// ğŸ†• å‚™ç”¨è¤‡è£½æ–¹æ³•
function fallbackCopyDisasterInfo(text) {
    const textArea = document.createElement('textarea');
    textArea.value = text;
    textArea.style.position = 'fixed';
    textArea.style.left = '-999999px';
    textArea.style.top = '-999999px';
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    
    try {
        document.execCommand('copy');
        showToast('ğŸ”— ç½æƒ…æ¨™ç±¤è³‡è¨Šå·²è¤‡è£½ï¼å¯åˆ†äº«çµ¦ä»–äººæŸ¥çœ‹', 'success');
    } catch (err) {
        console.error('è¤‡è£½å¤±æ•—:', err);
        showToast('âŒ è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½è³‡è¨Š', 'error');
        
        // é¡¯ç¤ºæ–‡å­—è®“ç”¨æˆ¶æ‰‹å‹•è¤‡è£½
        alert('è«‹æ‰‹å‹•è¤‡è£½ä»¥ä¸‹è³‡è¨Šï¼š\n\n' + text);
    }
    
    document.body.removeChild(textArea);
}

// ğŸ”§ ä¿®æ­£ç‰ˆï¼šè™•ç†åˆ†äº«é€£çµé–‹å•Ÿ - åŠ å…¥é‡è©¦æ©Ÿåˆ¶
function handleDisasterShareLink() {
    const hash = window.location.hash;
    
    // æª¢æŸ¥æ˜¯å¦ç‚ºç½æƒ…åˆ†äº«é€£çµæ ¼å¼ï¼š#disaster/reportId/lat/lng
    const disasterMatch = hash.match(/^#disaster\/([^\/]+)\/([0-9.-]+)\/([0-9.-]+)$/);
    
    if (disasterMatch) {
        const reportId = disasterMatch[1];
        const lat = parseFloat(disasterMatch[2]);
        const lng = parseFloat(disasterMatch[3]);
        
        console.log(`ğŸ”— æª¢æ¸¬åˆ°ç½æƒ…åˆ†äº«é€£çµ: ${reportId} at (${lat}, ${lng})`);
        
        // ğŸ”§ ç«‹å³å˜—è©¦é–‹å•Ÿï¼Œå¦‚æœå¤±æ•—æœƒè‡ªå‹•é‡è©¦
        openSharedDisasterMarker(reportId, lat, lng);
        
        return true;
    }
    
    return false;
}


// ğŸ”§ ä¿®æ­£ç‰ˆï¼šé–‹å•Ÿåˆ†äº«çš„ç½æƒ…æ¨™ç±¤ - åŠ å…¥æ™ºèƒ½é‡è©¦æ©Ÿåˆ¶
function openSharedDisasterMarker(reportId, lat, lng, retryCount = 0) {
    const maxRetries = 5; // æœ€å¤šé‡è©¦5æ¬¡
    const retryDelay = 1000; // æ¯æ¬¡é‡è©¦é–“éš”1ç§’
    
    console.log(`ğŸ”— å˜—è©¦é–‹å•Ÿç½æƒ…æ¨™ç±¤ (ç¬¬${retryCount + 1}æ¬¡): ${reportId}`);
    
    // ç¢ºä¿ç½æƒ…è³‡æ–™å·²è¼‰å…¥
    if (!disasterData || disasterData.length === 0) {
        if (retryCount < maxRetries) {
            console.log(`ğŸ”„ ç½æƒ…è³‡æ–™å°šæœªè¼‰å…¥ï¼Œ${retryDelay/1000}ç§’å¾Œé‡è©¦...`);
            showToast(`ğŸ”„ ç½æƒ…è³‡æ–™è¼‰å…¥ä¸­ï¼Œè«‹ç¨å€™... (${retryCount + 1}/${maxRetries})`, 'info');
            
            // ğŸ”§ å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡é‡è©¦ï¼Œå˜—è©¦è¼‰å…¥ç½æƒ…è³‡æ–™
            if (retryCount === 0) {
                loadDisasterData();
            }
            
            setTimeout(() => {
                openSharedDisasterMarker(reportId, lat, lng, retryCount + 1);
            }, retryDelay);
            return;
        } else {
            // ğŸ”§ é‡è©¦æ¬¡æ•¸ç”¨å®Œï¼Œé¡¯ç¤ºä½ç½®ä½†ç„¡è©³ç´°è³‡æ–™
            console.warn('âš ï¸ ç½æƒ…è³‡æ–™è¼‰å…¥å¤±æ•—ï¼Œé¡¯ç¤ºåŸºæœ¬ä½ç½®è³‡è¨Š');
            showBasicLocationMarker(reportId, lat, lng);
            return;
        }
    }
    
    // å°‹æ‰¾å°æ‡‰çš„ç½æƒ…å ±å‘Š
    const report = disasterData.find(r => r.id === reportId);
    
    if (report) {
        // ğŸ”§ æˆåŠŸæ‰¾åˆ°å ±å‘Š
        console.log(`âœ… æ‰¾åˆ°ç½æƒ…å ±å‘Š: ${reportId}`);
        
        // ç§»å‹•åœ°åœ–åˆ°æŒ‡å®šä½ç½®
        map.setView([lat, lng], 16);
        
        // å»ºç«‹ä¸¦é¡¯ç¤ºç½æƒ…æ¨™è¨˜
        const marker = createDisasterMarker(report);
        disasterMarkers.push(marker);
        
        // é–‹å•Ÿå½ˆå‡ºè¦–çª—
        setTimeout(() => {
            marker.openPopup();
            showToast(`âœ… å·²é–‹å•Ÿåˆ†äº«çš„ç½æƒ…æ¨™ç±¤ï¼š${report.id}`, 'success');
        }, 500);
        
    } else {
        // ğŸ”§ æ‰¾ä¸åˆ°å ±å‘Šï¼Œä½†æœ‰ç½æƒ…è³‡æ–™ï¼Œå¯èƒ½æ˜¯IDä¸åŒ¹é…
        console.warn(`âš ï¸ æ‰¾ä¸åˆ°ç½æƒ…å ±å‘Š ${reportId}ï¼Œä½†æœ‰ ${disasterData.length} ç­†ç½æƒ…è³‡æ–™`);
        
        if (retryCount < 2) {
            // ğŸ”§ å‰å…©æ¬¡é‡è©¦æ™‚ï¼Œç­‰å¾…æ›´é•·æ™‚é–“è®“è³‡æ–™å®Œå…¨è¼‰å…¥
            setTimeout(() => {
                openSharedDisasterMarker(reportId, lat, lng, retryCount + 1);
            }, 2000);
            return;
        }
        
        // ğŸ”§ æœ€çµ‚æ‰¾ä¸åˆ°ï¼Œé¡¯ç¤ºåŸºæœ¬ä½ç½®
        showBasicLocationMarker(reportId, lat, lng);
    }
}
// ğŸ†• é¡¯ç¤ºåŸºæœ¬ä½ç½®æ¨™è¨˜ï¼ˆç•¶æ‰¾ä¸åˆ°è©³ç´°ç½æƒ…è³‡æ–™æ™‚ï¼‰
function showBasicLocationMarker(reportId, lat, lng) {
    console.log(`ğŸ“ é¡¯ç¤ºåŸºæœ¬ä½ç½®æ¨™è¨˜: ${reportId} at (${lat}, ${lng})`);
    
    // ç§»å‹•åœ°åœ–åˆ°ä½ç½®
    map.setView([lat, lng], 16);
    
    // å»ºç«‹ä¸€å€‹åŸºæœ¬æ¨™è¨˜
    const tempMarker = L.marker([lat, lng], {
        icon: L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        })
    }).addTo(map);
    
    tempMarker.bindPopup(`
        <div style="text-align: center; min-width: 200px;">
            <h4 style="color: #dc3545; margin: 0 0 10px 0;">ğŸš¨ åˆ†äº«çš„ç½æƒ…ä½ç½®</h4>
            <p style="margin: 5px 0;"><strong>ç½æƒ…ID:</strong> ${reportId}</p>
            <p style="margin: 5px 0;"><strong>åº§æ¨™:</strong> ${lat.toFixed(6)}, ${lng.toFixed(6)}</p>
            <div style="background: #fff3cd; padding: 8px; border-radius: 4px; margin: 10px 0; font-size: 12px; color: #856404;">
                âš ï¸ ç½æƒ…è©³ç´°è³‡æ–™å¯èƒ½å·²æ›´æ–°æˆ–ç§»é™¤
            </div>
            <div style="margin-top: 15px;">
                <button onclick="refreshDisasterDataAndRetry('${reportId}', ${lat}, ${lng})" 
                        style="padding: 8px 12px; background: #17a2b8; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; margin-right: 8px;">
                    ğŸ”„ é‡æ–°è¼‰å…¥ç½æƒ…è³‡æ–™
                </button>
                <button onclick="map.removeLayer(this._source._popup._source)" 
                        style="padding: 8px 12px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                    é—œé–‰æ¨™è¨˜
                </button>
            </div>
        </div>
    `).openPopup();
    
    // å„²å­˜æ¨™è¨˜ä»¥ä¾¿æ¸…ç†
    disasterMarkers.push(tempMarker);
    
    showToast(`ğŸ“ å·²é¡¯ç¤ºç½æƒ…ä½ç½®ï¼Œä½†è©³ç´°è³‡æ–™å¯èƒ½å·²æ›´æ–°`, 'warning');
}
// ğŸ†• é‡æ–°è¼‰å…¥ç½æƒ…è³‡æ–™ä¸¦é‡è©¦é–‹å•Ÿæ¨™ç±¤
function refreshDisasterDataAndRetry(reportId, lat, lng) {
    showToast('ğŸ”„ æ­£åœ¨é‡æ–°è¼‰å…¥ç½æƒ…è³‡æ–™...', 'info');
    
    // æ¸…é™¤ç¾æœ‰æ¨™è¨˜
    clearDisasterMarkers();
    
    // é‡æ–°è¼‰å…¥ç½æƒ…è³‡æ–™
    loadDisasterData().then(() => {
        // è¼‰å…¥å®Œæˆå¾Œé‡è©¦é–‹å•Ÿæ¨™ç±¤
        setTimeout(() => {
            openSharedDisasterMarker(reportId, lat, lng, 0);
        }, 500);
    }).catch(error => {
        console.error('âŒ é‡æ–°è¼‰å…¥ç½æƒ…è³‡æ–™å¤±æ•—:', error);
        showToast('âŒ ç½æƒ…è³‡æ–™è¼‰å…¥å¤±æ•—', 'error');
    });
}

// ğŸ†• å–å¾—ç½æƒ…ä½ç½®åç¨±
function getDisasterLocationName(report) {
    let locationName = 'ç½æƒ…ä½ç½®';
    
    if (report.location?.tpcMapNumber) {
        locationName = `å°é›»åœ–è™Ÿ ${report.location.tpcMapNumber}`;
    } else if (report.location?.poleNumber) {
        locationName = `é›»æ¡¿ ${report.location.poleNumber}`;
    } else if (report['é¥‹ç·šä»£è™Ÿ']) {
        locationName = `é¥‹ç·š ${report['é¥‹ç·šä»£è™Ÿ']} ç½æƒ…`;
    } else if (Array.isArray(report.incidents) && report.incidents.length > 0) {
        locationName = `${report.incidents[0].type || 'ç½æƒ…'} ç¾å ´`;
    }
    
    return locationName;
}

// ğŸ†• é–‹å•Ÿ Google å°èˆª
function openNavigation(lat, lng, name) {
    // æª¢æ¸¬æ˜¯å¦ç‚ºè¡Œå‹•è£ç½®
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    
    if (isMobile) {
        // è¡Œå‹•è£ç½®å„ªå…ˆå˜—è©¦é–‹å•Ÿ Google Maps App
        const appUrl = `google.navigation:q=${lat},${lng}`;
        const fallbackUrl = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}&destination_place_id=${encodeURIComponent(name)}`;
        
        // å˜—è©¦é–‹å•Ÿ Appï¼Œå¤±æ•—å‰‡é–‹å•Ÿç¶²é ç‰ˆ
        const iframe = document.createElement('iframe');
        iframe.style.display = 'none';
        iframe.src = appUrl;
        document.body.appendChild(iframe);
        
        setTimeout(() => {
            document.body.removeChild(iframe);
            window.open(fallbackUrl, '_blank');
        }, 1000);
    } else {
        // æ¡Œé¢ç‰ˆç›´æ¥é–‹å•Ÿç¶²é ç‰ˆ Google Maps
        const googleMapsUrl = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}&destination_place_id=${encodeURIComponent(name)}`;
        window.open(googleMapsUrl, '_blank');
    }
    
    console.log(`ğŸ§­ é–‹å•Ÿå°èˆªè‡³: ${name} (${lat}, ${lng})`);
    showToast(`ğŸ§­ æ­£åœ¨é–‹å•Ÿå°èˆªè‡³ ${decodeURIComponent(name)}`, 'info');
}
// ğŸ†• ç¸®åœ–è¼‰å…¥éŒ¯èª¤è™•ç†
function handleThumbnailError(imgElement, originalUrl, photoIndex) {
    console.log(`âŒ ç¸®åœ– ${photoIndex} è¼‰å…¥å¤±æ•—ï¼Œé¡¯ç¤º placeholder`);
    
    // éš±è—åœ–ç‰‡ï¼Œé¡¯ç¤º placeholder
    imgElement.style.display = 'none';
    
    const placeholder = imgElement.parentElement.querySelector('.photo-placeholder');
    if (placeholder) {
        placeholder.style.display = 'flex';
        placeholder.style.background = '#fff3cd';
        placeholder.style.borderColor = '#ffc107';
        placeholder.innerHTML = `ğŸ“·<br>ç…§ç‰‡<br>${parseInt(photoIndex) + 1}<br><span style="font-size: 6px;">é»æ“Šå˜—è©¦è¼‰å…¥</span>`;
        
        // è®“ placeholder ä¹Ÿå¯ä»¥é»æ“Š
        placeholder.style.cursor = 'pointer';
        placeholder.onclick = function() {
            openPhotoModalSafe(originalUrl, `temp_${photoIndex}`);
        };
    }
}

// ç…§ç‰‡æ”¾å¤§åŠŸèƒ½
function openPhotoModal(photoUrl, photoId) {
    console.log(`æ‰“é–‹ç…§ç‰‡æ¨¡æ…‹æ¡†: ${photoId}, URL: ${photoUrl}`);
    
    const parts = photoId.split('_');
    const reportId = parts[0];
    const photoIndex = parseInt(parts[1] || 0);
    
    const report = disasterData.find(r => r.id === reportId);
    if (report && report.photos && Array.isArray(report.photos)) {
        currentReportId = reportId;
        currentReportPhotos = report.photos;
        currentPhotoIndex = Math.min(photoIndex, currentReportPhotos.length - 1);
        
        setupPhotoModal();
        updatePhotoCounter();
        showCurrentPhoto();
    } else {
        setupSimplePhotoModal(photoUrl);
    }
}

// è¨­ç½®ç…§ç‰‡æ¨¡æ…‹æ¡†
function setupPhotoModal(isSimpleMode = false) {
    let photoModal = document.getElementById('photo-modal');
    if (!photoModal) {
        photoModal = document.createElement('div');
        photoModal.id = 'photo-modal';
        photoModal.className = 'photo-modal';
        document.body.appendChild(photoModal);
    }
    
    let modalContent = `
        <span class="photo-modal-close" onclick="closePhotoModal()">&times;</span>
        <img class="photo-modal-content" id="modal-photo" 
             onerror="this.onerror=null; this.src='https://via.placeholder.com/400x300?text=ç…§ç‰‡è¼‰å…¥å¤±æ•—';">
    `;
    
    if (!isSimpleMode && currentReportPhotos.length > 1) {
        modalContent += `
            <div class="photo-navigation">
                <button class="photo-nav-btn" onclick="showPrevPhoto()">&lt;</button>
                <button class="photo-nav-btn" onclick="showNextPhoto()">&gt;</button>
            </div>
            <div class="photo-counter" id="photo-counter"></div>
        `;
    }
    
    photoModal.innerHTML = modalContent;
    photoModal.style.display = 'block';
    
    photoModal.onclick = function(event) {
        if (event.target === photoModal) {
            closePhotoModal();
        }
    };
}

// è¨­ç½®ç°¡å–®ç…§ç‰‡æ¨¡æ…‹æ¡†
function setupSimplePhotoModal(photoUrl) {
    currentReportId = null;
    currentReportPhotos = [photoUrl];
    currentPhotoIndex = 0;
    
    setupPhotoModal(true);
    
    const modalPhoto = document.getElementById('modal-photo');
    if (modalPhoto) {
        modalPhoto.src = photoUrl;
    }
}

// é¡¯ç¤ºç•¶å‰ç…§ç‰‡
function showCurrentPhoto() {
    if (!currentReportPhotos || currentReportPhotos.length === 0) return;
    
    const photo = currentReportPhotos[currentPhotoIndex];
    let photoUrl = typeof photo === 'string' ? photo : (photo.url || '');
    
    const modalPhoto = document.getElementById('modal-photo');
    if (modalPhoto && photoUrl) {
        modalPhoto.src = photoUrl;
    }
    
    updatePhotoCounter();
}

// æ›´æ–°ç…§ç‰‡è¨ˆæ•¸å™¨
function updatePhotoCounter() {
    const counterElement = document.getElementById('photo-counter');
    if (counterElement && currentReportPhotos.length > 1) {
        counterElement.textContent = `${currentPhotoIndex + 1} / ${currentReportPhotos.length}`;
    }
}
// ğŸ”§ ä¿®æ­£ç‰ˆï¼šä¸Šä¸€å¼µç…§ç‰‡ - åŠ å…¥é˜²æŠ–æ©Ÿåˆ¶
let photoSwitchTimeout = null;
function showPrevPhoto() {
    if (!currentReportPhotos || currentReportPhotos.length <= 1) return;
    
    // ğŸ”§ é˜²æŠ–æ©Ÿåˆ¶ï¼šé¿å…å¿«é€Ÿé€£çºŒé»æ“Š
    if (photoSwitchTimeout) {
        clearTimeout(photoSwitchTimeout);
    }
    
    photoSwitchTimeout = setTimeout(() => {
        currentPhotoIndex = (currentPhotoIndex - 1 + currentReportPhotos.length) % currentReportPhotos.length;
        showCurrentPhotoSafe();
        photoSwitchTimeout = null;
    }, 100); // 100ms é˜²æŠ–
}

// ğŸ”§ ä¿®æ­£ç‰ˆï¼šä¸‹ä¸€å¼µç…§ç‰‡ - åŠ å…¥é˜²æŠ–æ©Ÿåˆ¶
function showNextPhoto() {
    if (!currentReportPhotos || currentReportPhotos.length <= 1) return;
    
    // ğŸ”§ é˜²æŠ–æ©Ÿåˆ¶ï¼šé¿å…å¿«é€Ÿé€£çºŒé»æ“Š
    if (photoSwitchTimeout) {
        clearTimeout(photoSwitchTimeout);
    }
    
    photoSwitchTimeout = setTimeout(() => {
        currentPhotoIndex = (currentPhotoIndex + 1) % currentReportPhotos.length;
        showCurrentPhotoSafe();
        photoSwitchTimeout = null;
    }, 100); // 100ms é˜²æŠ–
}

// ğŸ”§ ä¿®æ­£ç‰ˆï¼šé—œé–‰ç…§ç‰‡æ¨¡æ…‹æ¡† - ç¢ºä¿å®Œå…¨æ¸…ç†
function closePhotoModal() {
    const photoModal = document.getElementById('photo-modal');
    if (photoModal) {
        // ğŸ”§ é‡è¦ï¼šæ¸…é™¤æ‰€æœ‰è¼‰å…¥ç‹€æ…‹
        const modalPhoto = document.getElementById('modal-photo');
        if (modalPhoto) {
            hidePhotoLoadingState(modalPhoto);
            clearPhotoEventHandlers(modalPhoto);
        }
        
        // ğŸ”§ æ¸…é™¤é˜²æŠ–è¨ˆæ™‚å™¨
        if (photoSwitchTimeout) {
            clearTimeout(photoSwitchTimeout);
            photoSwitchTimeout = null;
        }
        
        photoModal.style.display = 'none';
    }
    
    // ğŸ†• ç§»é™¤éµç›¤äº‹ä»¶ç›£è½å™¨
    document.removeEventListener('keydown', handlePhotoModalKeydown);
    
    currentPhotoIndex = 0;
    currentReportId = null;
    currentReportPhotos = [];
}

// æ‰“é–‹è¡—æ™¯åœ–
function openStreetView(lat, lng) {
    if (!lat || !lng || isNaN(parseFloat(lat)) || isNaN(parseFloat(lng))) {
        alert('ç„¡æ³•ç²å–æœ‰æ•ˆçš„ä½ç½®è³‡è¨Šï¼Œç„¡æ³•æŸ¥çœ‹è¡—æ™¯');
        return;
    }
    
    const streetViewUrl = `https://www.google.com/maps/@?api=1&map_action=pano&viewpoint=${lat},${lng}`;
    window.open(streetViewUrl, '_blank');
}

// æ´¾ä¿®æ¨¡æ…‹æ¡†åŠŸèƒ½ï¼ˆç°¡åŒ–ç‰ˆï¼‰
function openRepairModal(reportId) {
    const report = disasterData.find(r => r.id === reportId);
    if (!report) return;
    
    const newStatus = prompt(`ç›®å‰ç‹€æ…‹ï¼š${report['ä¿®å¾©ç‹€æ…‹'] || 'æœªæ´¾ä¿®'}\n\nè«‹é¸æ“‡æ–°ç‹€æ…‹ï¼š\n1. æœªæ´¾ä¿®\n2. å·²æ´¾ä¿®\n3. å·²ä¿®å¾©\n\nè«‹è¼¸å…¥æ•¸å­— 1-3:`);
    
    if (newStatus) {
        let status;
        switch(newStatus) {
            case '1': status = 'æœªæ´¾ä¿®'; break;
            case '2': status = 'å·²æ´¾ä¿®'; break;
            case '3': status = 'å·²ä¿®å¾©'; break;
            default: return;
        }
        
        // æ›´æ–°æœ¬åœ°è³‡æ–™
        report['ä¿®å¾©ç‹€æ…‹'] = status;
        if (status === 'å·²æ´¾ä¿®' || status === 'å·²ä¿®å¾©') {
            report['æ´¾ä¿®æ™‚é–“'] = new Date().toLocaleString('zh-TW');
            report['ä¿®å¾©äººå“¡'] = prompt('è«‹è¼¸å…¥æ´¾ä¿®äººå“¡å§“å:') || 'æœªæŒ‡å®š';
        }
        
        // é‡æ–°å»ºç«‹æ¸…å–®å’Œæ¨™è¨˜
        createDisasterReportList();
        showDisasterReportDetails(report);
        
        showToast(`âœ… å·²æ›´æ–°ç‚ºï¼š${status}`, 'success');
    }
}

// ğŸ”§ ä¿®æ­£ç‰ˆï¼šç¯©é¸ç½æƒ…å ±å‘Š - åŒæ­¥æ›´æ–°æ¸…å–®å’Œåœ°åœ–æ¨™ç±¤
function filterDisasterReports() {
    const filter = document.getElementById('disasterFilter').value;
    console.log(`ğŸ” ç¯©é¸ç½æƒ…ç‹€æ…‹: ${filter}`);
    
    // æ¸…é™¤ç¾æœ‰çš„ç½æƒ…æ¨™è¨˜
    clearDisasterMarkers();
    
    let filteredData = disasterData;
    if (filter !== 'all') {
        filteredData = disasterData.filter(report => {
            const repairStatus = report['ä¿®å¾©ç‹€æ…‹'] || 'æœªæ´¾ä¿®';
            return repairStatus === filter;
        });
    }
    
    console.log(`âœ… ç¯©é¸çµæœ: ${filteredData.length} ç­†è³‡æ–™`);
    
    // ğŸ”§ é‡è¦ï¼šæš«æ™‚æ›¿æ›å…¨åŸŸè³‡æ–™é€²è¡Œé¡¯ç¤º
    const originalData = disasterData;
    disasterData = filteredData;
    
    // é‡æ–°å»ºç«‹æ¸…å–®
    createDisasterReportList();
    
    // ğŸ†• å¦‚æœç½æƒ…åœ°åœ–æ­£åœ¨é¡¯ç¤ºï¼Œé‡æ–°é¡¯ç¤ºç¯©é¸å¾Œçš„æ¨™è¨˜
    if (disasterMapVisible && filteredData.length > 0) {
        displayFilteredDisasterMap(filteredData);
    }
    
    // ğŸ”§ é‡è¦ï¼šæ¢å¾©åŸå§‹è³‡æ–™
    disasterData = originalData;
    
    // æ›´æ–°ç‹€æ…‹é¡¯ç¤º
    const filterText = filter === 'all' ? 'æ‰€æœ‰ç½æƒ…' : filter;
    showToast(`ğŸ” å·²ç¯©é¸é¡¯ç¤ºï¼š${filterText} (${filteredData.length} ç­†)`, 'info');
    
    // æ›´æ–°ç‹€æ…‹æ–‡å­—
    updateDisasterStatus(`âœ… é¡¯ç¤º ${filteredData.length} ç­† ${filterText} è³‡æ–™`);
}
// ğŸ†• é¡¯ç¤ºç¯©é¸å¾Œçš„ç½æƒ…åœ°åœ–
function displayFilteredDisasterMap(filteredData) {
    console.log('ğŸ—ºï¸ é¡¯ç¤ºç¯©é¸å¾Œçš„ç½æƒ…åœ°åœ–...');
    
    // æ¸…é™¤ç¾æœ‰æ¨™è¨˜
    clearDisasterMarkers();
    
    let markerCount = 0;
    const bounds = L.latLngBounds();
    
    filteredData.forEach(report => {
        if (report.location && report.location.latitude && report.location.longitude) {
            const marker = createDisasterMarker(report);
            disasterMarkers.push(marker);
            bounds.extend([report.location.latitude, report.location.longitude]);
            markerCount++;
        }
    });
    
    if (markerCount > 0) {
        map.fitBounds(bounds, { padding: [20, 20] });
        console.log(`âœ… å·²é¡¯ç¤º ${markerCount} å€‹ç¯©é¸å¾Œçš„ç½æƒ…æ¨™è¨˜`);
    } else {
        console.log('âš ï¸ ç¯©é¸å¾Œç„¡å¯é¡¯ç¤ºçš„ç½æƒ…æ¨™è¨˜');
        disasterMapVisible = false;
        updateDisasterMapButton();
    }
}
// ğŸ”§ ä¿®æ­£ç‰ˆï¼šé‡æ–°æ•´ç†ç½æƒ…è³‡æ–™ - ä¿æŒç¯©é¸ç‹€æ…‹
async function refreshDisasterData() {
    updateDisasterStatus('æ­£åœ¨é‡æ–°æ•´ç†...');
    
    // ğŸ”§ è¨˜ä½ç•¶å‰ç¯©é¸ç‹€æ…‹
    const currentFilter = document.getElementById('disasterFilter')?.value || 'all';
    const wasVisible = disasterMapVisible;
    
    const success = await loadDisasterData();
    if (success) {
        showToast('âœ… ç½æƒ…è³‡æ–™å·²æ›´æ–°', 'success');
        
        // ğŸ†• é‡æ–°æ‡‰ç”¨ç¯©é¸
        if (currentFilter !== 'all') {
            setTimeout(() => {
                document.getElementById('disasterFilter').value = currentFilter;
                filterDisasterReports();
            }, 200);
        }
        
        // ğŸ”§ å¦‚æœä¹‹å‰åœ°åœ–æ˜¯é¡¯ç¤ºçš„ï¼Œé‡æ–°é¡¯ç¤º
        if (wasVisible) {
            setTimeout(() => {
                displayDisasterMap();
            }, 500);
        }
    } else {
        showToast('âŒ ç½æƒ…è³‡æ–™æ›´æ–°å¤±æ•—', 'error');
    }
}
// ğŸ”§ ä¿®æ­£ç‰ˆï¼šç½æƒ…åœ°åœ–ç‹€æ…‹ç®¡ç†
let disasterMapVisible = false; // è¿½è¹¤ç½æƒ…åœ°åœ–é¡¯ç¤ºç‹€æ…‹
// ğŸ”§ ä¿®æ­£ç‰ˆï¼šé¡¯ç¤º/éš±è—ç½æƒ…åœ°åœ– - åˆ‡æ›åŠŸèƒ½
function showDisasterMap() {
    if (!disasterData || disasterData.length === 0) {
        showToast('âŒ ç„¡ç½æƒ…è³‡æ–™å¯é¡¯ç¤º', 'error');
        return;
    }
    
    if (disasterMapVisible) {
        // ç›®å‰é¡¯ç¤ºä¸­ï¼ŒåŸ·è¡Œéš±è—
        hideDisasterMap();
    } else {
        // ç›®å‰éš±è—ä¸­ï¼ŒåŸ·è¡Œé¡¯ç¤º
        displayDisasterMap();
    }
}
// ğŸ”§ ä¿®æ­£ç‰ˆï¼šé¡¯ç¤ºç½æƒ…åœ°åœ– - è€ƒæ…®ç•¶å‰ç¯©é¸ç‹€æ…‹
function displayDisasterMap() {
    console.log('ğŸ—ºï¸ é¡¯ç¤ºç½æƒ…åœ°åœ–...');
    
    // ğŸ†• æª¢æŸ¥ç•¶å‰ç¯©é¸ç‹€æ…‹
    const filter = document.getElementById('disasterFilter')?.value || 'all';
    let dataToShow = disasterData;
    
    if (filter !== 'all') {
        dataToShow = disasterData.filter(report => {
            const repairStatus = report['ä¿®å¾©ç‹€æ…‹'] || 'æœªæ´¾ä¿®';
            return repairStatus === filter;
        });
        console.log(`ğŸ” æ‡‰ç”¨ç¯©é¸ "${filter}"ï¼Œé¡¯ç¤º ${dataToShow.length} ç­†è³‡æ–™`);
    }
    
    // æ¸…é™¤ç¾æœ‰æ¨™è¨˜ï¼ˆé˜²æ­¢é‡è¤‡ï¼‰
    clearDisasterMarkers();
    
    let markerCount = 0;
    const bounds = L.latLngBounds();
    
    dataToShow.forEach(report => {
        if (report.location && report.location.latitude && report.location.longitude) {
            const marker = createDisasterMarker(report);
            disasterMarkers.push(marker);
            bounds.extend([report.location.latitude, report.location.longitude]);
            markerCount++;
        }
    });
    
    if (markerCount > 0) {
        map.fitBounds(bounds, { padding: [20, 20] });
        disasterMapVisible = true;
        updateDisasterMapButton();
        
        const filterText = filter === 'all' ? '' : ` (${filter})`;
        showToast(`ğŸ—ºï¸ å·²é¡¯ç¤º ${markerCount} å€‹ç½æƒ…ä½ç½®${filterText}`, 'success');
    } else {
        const filterText = filter === 'all' ? '' : ` "${filter}"`;
        showToast(`âŒ ç„¡${filterText}ç½æƒ…è³‡æ–™å¯é¡¯ç¤º`, 'error');
    }
}
// ğŸ†• éš±è—ç½æƒ…åœ°åœ–
function hideDisasterMap() {
    console.log('ğŸ—ºï¸ éš±è—ç½æƒ…åœ°åœ–...');
    
    clearDisasterMarkers();
    disasterMapVisible = false;
    updateDisasterMapButton();
    showToast('âœ… å·²éš±è—æ‰€æœ‰ç½æƒ…æ¨™è¨˜', 'info');
}
// ğŸ†• æ›´æ–°ç½æƒ…åœ°åœ–æŒ‰éˆ•æ–‡å­—
function updateDisasterMapButton() {
    // ğŸ”§ å°‹æ‰¾ç½æƒ…åœ°åœ–æŒ‰éˆ•ä¸¦æ›´æ–°æ–‡å­—
    const disasterMapButtons = document.querySelectorAll('button[onclick="showDisasterMap()"]');
    
    disasterMapButtons.forEach(button => {
        if (disasterMapVisible) {
            button.textContent = 'ğŸ™ˆ éš±è—ç½æƒ…';
            button.style.background = '#6c757d';
            button.title = 'é»æ“Šéš±è—æ‰€æœ‰ç½æƒ…æ¨™è¨˜';
        } else {
            button.textContent = 'ğŸ—ºï¸ ç½æƒ…åœ°åœ–';
            button.style.background = '#28a745';
            button.title = 'é»æ“Šé¡¯ç¤ºæ‰€æœ‰ç½æƒ…æ¨™è¨˜';
        }
    });
    
    console.log(`ğŸ”„ ç½æƒ…åœ°åœ–æŒ‰éˆ•å·²æ›´æ–°: ${disasterMapVisible ? 'éš±è—æ¨¡å¼' : 'é¡¯ç¤ºæ¨¡å¼'}`);
}

// ğŸ”§ ä¿®æ­£ç‰ˆï¼šæ¸…é™¤ç½æƒ…æ¨™è¨˜ - åŠ å…¥ç‹€æ…‹é‡ç½®
function clearDisasterMarkers() {
    console.log(`ğŸ§¹ æ¸…é™¤ ${disasterMarkers.length} å€‹ç½æƒ…æ¨™è¨˜...`);
    
    disasterMarkers.forEach(marker => {
        if (map.hasLayer(marker)) {
            map.removeLayer(marker);
        }
    });
    disasterMarkers = [];
    
    // ğŸ”§ é—œé–‰ä»»ä½•é–‹å•Ÿçš„å½ˆå‡ºè¦–çª—
    map.closePopup();
}

// ğŸ†• ä¿®æ­£ Google Drive ç…§ç‰‡ URL
// ğŸ”§ å®Œå…¨ä¿®æ­£ç‰ˆï¼šGoogle Drive ç…§ç‰‡ URL è™•ç† - å¤šé‡å‚™æ´æ–¹æ¡ˆ
function fixGoogleDrivePhotoUrl(url, isModal = false) {
    if (!url) return '';
    
    console.log('ğŸ” è™•ç†ç…§ç‰‡ URL:', url, 'æ¨¡æ…‹æ¡†æ¨¡å¼:', isModal);
    
    // å¦‚æœæ˜¯ Google Drive é€£çµ
    if (url.includes('drive.google.com')) {
        // æå–æª”æ¡ˆ ID
        let fileId = '';
        
        // æ–¹æ³•1: å¾ /file/d/ æ ¼å¼æå–
        const fileMatch = url.match(/\/file\/d\/([a-zA-Z0-9_-]+)/);
        if (fileMatch) {
            fileId = fileMatch[1];
        }
        
        // æ–¹æ³•2: å¾ id= åƒæ•¸æå–
        if (!fileId) {
            const idMatch = url.match(/[?&]id=([a-zA-Z0-9_-]+)/);
            if (idMatch) {
                fileId = idMatch[1];
            }
        }
        
        if (fileId) {
            if (isModal) {
                // ğŸ”§ æ¨¡æ…‹æ¡†ä½¿ç”¨å¤šé‡å‚™æ´æ–¹æ¡ˆ
                // å„ªå…ˆä½¿ç”¨è¼ƒå¤§çš„ç¸®åœ–ï¼Œè€Œéç›´æ¥ä¸‹è¼‰
                const largeUrl = `https://drive.google.com/thumbnail?id=${fileId}&sz=w800-h600`;
                console.log('âœ… è½‰æ›ç‚ºå¤§å°ºå¯¸ç¸®åœ– URL:', largeUrl);
                return largeUrl;
            } else {
                // ğŸ”§ ç¸®åœ–é è¦½ä½¿ç”¨å°å°ºå¯¸
                const thumbnailUrl = `https://drive.google.com/thumbnail?id=${fileId}&sz=w200-h200`;
                console.log('âœ… è½‰æ›ç‚ºç¸®åœ– URL:', thumbnailUrl);
                return thumbnailUrl;
            }
        }
    }
    
    // å¦‚æœä¸æ˜¯ Google Drive æˆ–ç„¡æ³•æå– IDï¼Œç›´æ¥è¿”å›åŸ URL
    console.log('âš ï¸ ä½¿ç”¨åŸå§‹ URL:', url);
    return url;
}

// ğŸ†• ç…§ç‰‡è¼‰å…¥éŒ¯èª¤è™•ç†
function handlePhotoLoadError(imgElement, photoIndex) {
    console.log(`âŒ ç…§ç‰‡ ${photoIndex} è¼‰å…¥å¤±æ•—`);
    
    // éš±è—åœ–ç‰‡ï¼Œé¡¯ç¤º placeholder
    imgElement.style.display = 'none';
    
    const placeholder = imgElement.parentElement.querySelector('.photo-placeholder');
    if (placeholder) {
        placeholder.style.display = 'flex';
    }
    
    // è¨­å®šèƒŒæ™¯è‰²è¡¨ç¤ºè¼‰å…¥å¤±æ•—
    imgElement.parentElement.style.background = '#fff3cd';
    imgElement.parentElement.style.borderColor = '#ffc107';
}

// ğŸ”§ ä¿®æ­£ç‰ˆï¼šå®‰å…¨çš„ç…§ç‰‡æ¨¡æ…‹æ¡†é–‹å•Ÿ
function openPhotoModalSafe(originalUrl, photoId) {
    console.log(`ğŸ–¼ï¸ å®‰å…¨é–‹å•Ÿç…§ç‰‡æ¨¡æ…‹æ¡†: ${photoId}`);
    
    const parts = photoId.split('_');
    const reportId = parts[0];
    const photoIndex = parseInt(parts[1] || 0);
    
    const report = disasterData.find(r => r.id === reportId);
    if (report && report.photos && Array.isArray(report.photos)) {
        currentReportId = reportId;
        currentReportPhotos = report.photos;
        currentPhotoIndex = Math.min(photoIndex, currentReportPhotos.length - 1);
        
        setupPhotoModalSafe();
        updatePhotoCounter();
        showCurrentPhotoSafe();
    } else {
        // ç°¡å–®æ¨¡å¼ï¼šåªé¡¯ç¤ºå–®å¼µç…§ç‰‡
        setupSimplePhotoModalSafe(originalUrl);
    }
}

// ğŸ”§ ä¿®æ­£ç‰ˆï¼šå®‰å…¨çš„ç…§ç‰‡æ¨¡æ…‹æ¡†è¨­ç½® - æ”¹å–„å°ºå¯¸æ§åˆ¶
function setupPhotoModalSafe() {
    let photoModal = document.getElementById('photo-modal');
    if (!photoModal) {
        photoModal = document.createElement('div');
        photoModal.id = 'photo-modal';
        photoModal.className = 'photo-modal';
        document.body.appendChild(photoModal);
    }
    
    let modalContent = `
        <span class="photo-modal-close" onclick="closePhotoModal()">&times;</span>
        <div style="display: flex; align-items: center; justify-content: center; width: 100%; height: 100%; padding: 50px 20px 20px 20px; box-sizing: border-box;">
            <img class="photo-modal-content" id="modal-photo" 
                 style="max-width: 100%; max-height: 100%; object-fit: contain; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.5);"
                 onerror="handleModalPhotoError(this)">
        </div>
    `;
    
    if (currentReportPhotos && currentReportPhotos.length > 1) {
        modalContent += `
            <div class="photo-navigation">
                <button class="photo-nav-btn" onclick="showPrevPhoto()" 
                        style="position: absolute; left: 20px; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.7); color: white; border: none; border-radius: 50%; width: 50px; height: 50px; font-size: 20px; cursor: pointer; z-index: 2002;">
                    &#8249;
                </button>
                <button class="photo-nav-btn" onclick="showNextPhoto()"
                        style="position: absolute; right: 20px; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.7); color: white; border: none; border-radius: 50%; width: 50px; height: 50px; font-size: 20px; cursor: pointer; z-index: 2002;">
                    &#8250;
                </button>
            </div>
            <div class="photo-counter" id="photo-counter" 
                 style="position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.7); color: white; padding: 8px 16px; border-radius: 20px; font-size: 14px; z-index: 2001;">
            </div>
        `;
    }
    
    photoModal.innerHTML = modalContent;
    photoModal.style.display = 'block';
    
    // é»æ“ŠèƒŒæ™¯é—œé–‰
    photoModal.onclick = function(event) {
        if (event.target === photoModal) {
            closePhotoModal();
        }
    };
    
    // ğŸ†• éµç›¤æ§åˆ¶
    document.addEventListener('keydown', handlePhotoModalKeydown);
}
// ğŸ”§ ä¿®æ­£ç‰ˆï¼šéµç›¤æ§åˆ¶è™•ç† - åŠ å…¥é˜²æŠ–
function handlePhotoModalKeydown(event) {
    const photoModal = document.getElementById('photo-modal');
    if (!photoModal || photoModal.style.display === 'none') return;
    
    // ğŸ”§ é˜²æ­¢å¿«é€ŸæŒ‰éµ
    if (photoSwitchTimeout) return;
    
    switch(event.key) {
        case 'Escape':
            closePhotoModal();
            break;
        case 'ArrowLeft':
            event.preventDefault();
            showPrevPhoto();
            break;
        case 'ArrowRight':
            event.preventDefault();
            showNextPhoto();
            break;
    }
}
// ğŸ”§ ä¿®æ­£ç‰ˆï¼šç°¡å–®ç…§ç‰‡æ¨¡æ…‹æ¡†è¨­ç½®
function setupSimplePhotoModalSafe(photoUrl) {
    currentReportId = null;
    currentReportPhotos = [photoUrl];
    currentPhotoIndex = 0;
    
    setupPhotoModalSafe();
    
    const modalPhoto = document.getElementById('modal-photo');
    if (modalPhoto) {
        // ğŸ”§ é‡è¦ï¼šä½¿ç”¨åŸå°ºå¯¸ç…§ç‰‡
        const processedUrl = fixGoogleDrivePhotoUrl(photoUrl, true);
        modalPhoto.src = processedUrl;
        modalPhoto.style.opacity = '0.5';
        modalPhoto.onload = function() {
            this.style.opacity = '1';
        };
    }
}


// ğŸ”§ ä¿®æ­£ç‰ˆï¼šå®‰å…¨é¡¯ç¤ºç•¶å‰ç…§ç‰‡ - åŠ å…¥è¼‰å…¥ç‹€æ…‹ç®¡ç†
function showCurrentPhotoSafe() {
    if (!currentReportPhotos || currentReportPhotos.length === 0) return;
    
    const photo = currentReportPhotos[currentPhotoIndex];
    let photoUrl = typeof photo === 'string' ? photo : (photo.url || '');
    
    const modalPhoto = document.getElementById('modal-photo');
    if (modalPhoto && photoUrl) {
        // ğŸ”§ é‡è¦ï¼šå…ˆæ¸…é™¤ä¹‹å‰çš„è¼‰å…¥ç‹€æ…‹
        hidePhotoLoadingState(modalPhoto);
        clearPhotoEventHandlers(modalPhoto);
        
        // ğŸ†• é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
        showPhotoLoadingState(modalPhoto);
        
        // ğŸ”§ ä½¿ç”¨å¤§å°ºå¯¸ç¸®åœ–è€Œéç›´æ¥ä¸‹è¼‰
        const processedUrl = fixGoogleDrivePhotoUrl(photoUrl, true);
        
        // ğŸ”§ é‡è¦ï¼šè¨­ç½®è¼‰å…¥å®Œæˆå’ŒéŒ¯èª¤è™•ç†ï¼ˆåªè¨­ç½®ä¸€æ¬¡ï¼‰
        modalPhoto.onload = function() {
            hidePhotoLoadingState(this);
            console.log(`âœ… ç…§ç‰‡è¼‰å…¥æˆåŠŸ: ${processedUrl}`);
        };
        
        modalPhoto.onerror = function() {
            hidePhotoLoadingState(this);
            handleModalPhotoError(this);
        };
        
        // ğŸ”§ é‡è¦ï¼šæœ€å¾Œæ‰è¨­ç½® srcï¼Œé¿å…äº‹ä»¶è™•ç†å™¨æœªå°±ç·’
        modalPhoto.src = processedUrl;
        
        console.log(`ğŸ–¼ï¸ é–‹å§‹è¼‰å…¥ç…§ç‰‡: ${processedUrl}`);
    }
    
    updatePhotoCounter();
}
// ğŸ†• æ¸…é™¤ç…§ç‰‡äº‹ä»¶è™•ç†å™¨
function clearPhotoEventHandlers(imgElement) {
    imgElement.onload = null;
    imgElement.onerror = null;
}
// ğŸ†• é¡¯ç¤ºç…§ç‰‡è¼‰å…¥ç‹€æ…‹
// ğŸ”§ ä¿®æ­£ç‰ˆï¼šé¡¯ç¤ºç…§ç‰‡è¼‰å…¥ç‹€æ…‹ - é¿å…é‡è¤‡å‰µå»º
function showPhotoLoadingState(imgElement) {
    if (!imgElement || !imgElement.parentElement) return;
    
    // ğŸ”§ é‡è¦ï¼šå…ˆæ¸…é™¤ç¾æœ‰çš„è¼‰å…¥æŒ‡ç¤ºå™¨
    hidePhotoLoadingState(imgElement);
    
    imgElement.style.opacity = '0.3';
    imgElement.style.filter = 'blur(2px)';
    
    // ğŸ”§ é‡è¦ï¼šæª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨è¼‰å…¥æŒ‡ç¤ºå™¨
    if (document.getElementById('photo-loading')) {
        return; // å·²å­˜åœ¨ï¼Œä¸é‡è¤‡å‰µå»º
    }
    
    // å‰µå»ºè¼‰å…¥æŒ‡ç¤ºå™¨
    const loadingDiv = document.createElement('div');
    loadingDiv.id = 'photo-loading';
    loadingDiv.className = 'photo-loading-indicator'; // ğŸ†• åŠ å…¥ class ä¾¿æ–¼è­˜åˆ¥
    loadingDiv.style.cssText = `
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0,0,0,0.8);
        color: white;
        padding: 15px 25px;
        border-radius: 8px;
        font-size: 14px;
        z-index: 2003;
        display: flex;
        align-items: center;
        gap: 10px;
        pointer-events: none;
    `;
    
    loadingDiv.innerHTML = `
        <div style="width: 20px; height: 20px; border: 2px solid #fff; border-top: 2px solid transparent; border-radius: 50%; animation: spin 1s linear infinite;"></div>
        è¼‰å…¥ä¸­...
        <style>
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
        </style>
    `;
    
    imgElement.parentElement.appendChild(loadingDiv);
    
    // ğŸ†• å®‰å…¨æªæ–½ï¼š10ç§’å¾Œè‡ªå‹•æ¸…é™¤è¼‰å…¥ç‹€æ…‹
    setTimeout(() => {
        if (document.getElementById('photo-loading')) {
            console.log('â° è¼‰å…¥è¶…æ™‚ï¼Œè‡ªå‹•æ¸…é™¤è¼‰å…¥ç‹€æ…‹');
            hidePhotoLoadingState(imgElement);
        }
    }, 10000);
}

// ğŸ”§ ä¿®æ­£ç‰ˆï¼šéš±è—ç…§ç‰‡è¼‰å…¥ç‹€æ…‹ - ç¢ºä¿å®Œå…¨æ¸…é™¤
function hidePhotoLoadingState(imgElement) {
    if (!imgElement) return;
    
    imgElement.style.opacity = '1';
    imgElement.style.filter = 'none';
    
    // ğŸ”§ é‡è¦ï¼šæ¸…é™¤æ‰€æœ‰å¯èƒ½çš„è¼‰å…¥æŒ‡ç¤ºå™¨
    const existingLoading = document.querySelectorAll('#photo-loading');
    existingLoading.forEach(loading => loading.remove());
    
    // ğŸ”§ é¡å¤–æª¢æŸ¥çˆ¶å®¹å™¨ä¸­çš„è¼‰å…¥æŒ‡ç¤ºå™¨
    if (imgElement.parentElement) {
        const parentLoading = imgElement.parentElement.querySelectorAll('[id*="loading"], [class*="loading"]');
        parentLoading.forEach(loading => {
            if (loading.id === 'photo-loading' || loading.className.includes('photo-loading')) {
                loading.remove();
            }
        });
    }
}
// ğŸ”§ å¢å¼·ç‰ˆï¼šæ¨¡æ…‹æ¡†ç…§ç‰‡éŒ¯èª¤è™•ç† - å¤šé‡å‚™æ´
function handleModalPhotoError(imgElement) {
    console.log('âŒ æ¨¡æ…‹æ¡†ç…§ç‰‡è¼‰å…¥å¤±æ•—ï¼Œå˜—è©¦å‚™æ´æ–¹æ¡ˆ...');
    
    const originalSrc = imgElement.src;
    const currentReportPhoto = currentReportPhotos[currentPhotoIndex];
    let originalUrl = typeof currentReportPhoto === 'string' ? currentReportPhoto : (currentReportPhoto?.url || '');
    
    // ğŸ”§ å˜—è©¦ä¸åŒçš„å‚™æ´æ–¹æ¡ˆ
    if (originalSrc.includes('sz=w800-h600')) {
        // ç¬¬ä¸€æ¬¡å¤±æ•—ï¼Œå˜—è©¦æ›´å¤§çš„å°ºå¯¸
        const fileId = extractFileIdFromUrl(originalUrl);
        if (fileId) {
            const xlUrl = `https://drive.google.com/thumbnail?id=${fileId}&sz=w1200-h900`;
            console.log('ğŸ”„ å˜—è©¦è¶…å¤§å°ºå¯¸:', xlUrl);
            imgElement.src = xlUrl;
            imgElement.onerror = () => handleModalPhotoError2(imgElement, originalUrl);
            return;
        }
    }
    
    // å¦‚æœæ‰€æœ‰æ–¹æ¡ˆéƒ½å¤±æ•—ï¼Œé¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
    showPhotoErrorMessage(imgElement, originalUrl);
}
// ğŸ†• ç¬¬äºŒå±¤å‚™æ´è™•ç†
function handleModalPhotoError2(imgElement, originalUrl) {
    console.log('âŒ ç¬¬äºŒå±¤å‚™æ´ä¹Ÿå¤±æ•—ï¼Œå˜—è©¦åŸå§‹ URL...');
    
    // å˜—è©¦ä½¿ç”¨åŸå§‹ URL
    if (originalUrl && originalUrl !== imgElement.src) {
        imgElement.src = originalUrl;
        imgElement.onerror = () => showPhotoErrorMessage(imgElement, originalUrl);
    } else {
        showPhotoErrorMessage(imgElement, originalUrl);
    }
}
// ğŸ†• é¡¯ç¤ºç…§ç‰‡éŒ¯èª¤è¨Šæ¯
function showPhotoErrorMessage(imgElement, originalUrl) {
    console.log('âŒ æ‰€æœ‰ç…§ç‰‡è¼‰å…¥æ–¹æ¡ˆéƒ½å¤±æ•—');
    
    // å‰µå»ºéŒ¯èª¤æç¤º
    const errorDiv = document.createElement('div');
    errorDiv.style.cssText = `
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        width: 400px;
        height: 300px;
        background: #f8f9fa;
        border: 2px dashed #dee2e6;
        border-radius: 8px;
        color: #6c757d;
        font-size: 16px;
        text-align: center;
        margin: 20px;
    `;
    
    errorDiv.innerHTML = `
        <div style="font-size: 48px; margin-bottom: 15px;">ğŸ“·</div>
        <div style="font-weight: bold; margin-bottom: 10px;">ç…§ç‰‡æš«æ™‚ç„¡æ³•è¼‰å…¥</div>
        <div style="font-size: 14px; margin-bottom: 15px; color: #999;">
            å¯èƒ½æ˜¯ç¶²è·¯å•é¡Œæˆ–ç…§ç‰‡æ¬Šé™è¨­å®š
        </div>
        <button onclick="retryLoadPhoto('${originalUrl}')" 
                style="padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">
            ğŸ”„ é‡æ–°è¼‰å…¥
        </button>
        <button onclick="openOriginalPhotoLink('${originalUrl}')" 
                style="padding: 8px 16px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; margin-top: 8px;">
            ğŸ”— é–‹å•ŸåŸå§‹é€£çµ
        </button>
    `;
    
    // æ›¿æ›åœ–ç‰‡å…ƒç´ 
    imgElement.parentElement.replaceChild(errorDiv, imgElement);
}

// ğŸ†• é‡æ–°è¼‰å…¥ç…§ç‰‡
function retryLoadPhoto(originalUrl) {
    console.log('ğŸ”„ é‡æ–°è¼‰å…¥ç…§ç‰‡:', originalUrl);
    
    // é‡æ–°è¨­ç½®æ¨¡æ…‹æ¡†
    showCurrentPhotoSafe();
}

// ğŸ†• é–‹å•ŸåŸå§‹ç…§ç‰‡é€£çµ
function openOriginalPhotoLink(originalUrl) {
    if (originalUrl) {
        window.open(originalUrl, '_blank');
    } else {
        showToast('âŒ ç„¡æ³•å–å¾—åŸå§‹ç…§ç‰‡é€£çµ', 'error');
    }
}

// ğŸ†• å¾ URL æå–æª”æ¡ˆ ID
function extractFileIdFromUrl(url) {
    if (!url) return null;
    
    // æ–¹æ³•1: å¾ /file/d/ æ ¼å¼æå–
    const fileMatch = url.match(/\/file\/d\/([a-zA-Z0-9_-]+)/);
    if (fileMatch) {
        return fileMatch[1];
    }
    
    // æ–¹æ³•2: å¾ id= åƒæ•¸æå–
    const idMatch = url.match(/[?&]id=([a-zA-Z0-9_-]+)/);
    if (idMatch) {
        return idMatch[1];
    }
    
    return null;
}


// ğŸ†• ç½æƒ…åœ°åœ–å·¥å…·åˆ—åŠŸèƒ½
function createDisasterMapToolbar() {
    // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨å·¥å…·åˆ—
    let toolbar = document.getElementById('disaster-map-toolbar');
    if (toolbar) return;
    
    // å‰µå»ºå·¥å…·åˆ—
    toolbar = document.createElement('div');
    toolbar.id = 'disaster-map-toolbar';
    toolbar.style.cssText = `
        position: absolute;
        top: 60px;
        right: 10px;
        z-index: 1000;
        background: rgba(255, 255, 255, 0.95);
        border-radius: 8px;
        padding: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        display: none;
        flex-direction: column;
        gap: 8px;
        min-width: 140px;
    `;
    
    toolbar.innerHTML = `
        <button onclick="showDisasterMap()" 
                style="padding: 8px 12px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
            ğŸ—ºï¸ ç½æƒ…åœ°åœ–
        </button>
        <button onclick="filterDisasterByStatus('æœªæ´¾ä¿®')" 
                style="padding: 8px 12px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
            ğŸ”´ æœªæ´¾ä¿®
        </button>
        <button onclick="filterDisasterByStatus('å·²æ´¾ä¿®')" 
                style="padding: 8px 12px; background: #ffc107; color: #212529; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
            ğŸŸ¡ å·²æ´¾ä¿®
        </button>
        <button onclick="filterDisasterByStatus('å·²ä¿®å¾©')" 
                style="padding: 8px 12px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
            ğŸŸ¢ å·²ä¿®å¾©
        </button>
        <button onclick="hideDisasterMapToolbar()" 
                style="padding: 6px 12px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;">
            âœ• é—œé–‰
        </button>
    `;
    
    document.querySelector('.map-container').appendChild(toolbar);
}

// ğŸ†• é¡¯ç¤ºç½æƒ…åœ°åœ–å·¥å…·åˆ—
function showDisasterMapToolbar() {
    createDisasterMapToolbar();
    const toolbar = document.getElementById('disaster-map-toolbar');
    if (toolbar) {
        toolbar.style.display = 'flex';
    }
}

// ğŸ†• éš±è—ç½æƒ…åœ°åœ–å·¥å…·åˆ—
function hideDisasterMapToolbar() {
    const toolbar = document.getElementById('disaster-map-toolbar');
    if (toolbar) {
        toolbar.style.display = 'none';
    }
}

// ğŸ†• æŒ‰ç‹€æ…‹ç¯©é¸ç½æƒ…æ¨™è¨˜
function filterDisasterByStatus(status) {
    console.log(`ğŸ” ç¯©é¸ç½æƒ…ç‹€æ…‹: ${status}`);
    
    // å…ˆæ¸…é™¤ç¾æœ‰æ¨™è¨˜
    clearDisasterMarkers();
    
    if (!disasterData || disasterData.length === 0) {
        showToast('âŒ ç„¡ç½æƒ…è³‡æ–™å¯é¡¯ç¤º', 'error');
        return;
    }
    
    // ç¯©é¸è³‡æ–™
    const filteredData = disasterData.filter(report => {
        const repairStatus = report['ä¿®å¾©ç‹€æ…‹'] || 'æœªæ´¾ä¿®';
        return repairStatus === status;
    });
    
    if (filteredData.length === 0) {
        showToast(`âŒ æ²’æœ‰ "${status}" çš„ç½æƒ…è³‡æ–™`, 'warning');
        disasterMapVisible = false;
        updateDisasterMapButton();
        return;
    }
    
    // é¡¯ç¤ºç¯©é¸å¾Œçš„æ¨™è¨˜
    let markerCount = 0;
    const bounds = L.latLngBounds();
    
    filteredData.forEach(report => {
        if (report.location && report.location.latitude && report.location.longitude) {
            const marker = createDisasterMarker(report);
            disasterMarkers.push(marker);
            bounds.extend([report.location.latitude, report.location.longitude]);
            markerCount++;
        }
    });
    
    if (markerCount > 0) {
        map.fitBounds(bounds, { padding: [20, 20] });
        disasterMapVisible = true;
        updateDisasterMapButton();
        showToast(`ğŸ—ºï¸ å·²é¡¯ç¤º ${markerCount} å€‹ "${status}" ç½æƒ…`, 'success');
    }
}

// ğŸ†• ç½æƒ…åœ°åœ–å¿«æ·éµ
document.addEventListener('keydown', function(e) {
    // Ctrl + D: åˆ‡æ›ç½æƒ…åœ°åœ–
    if (e.ctrlKey && e.key === 'd') {
        e.preventDefault();
        showDisasterMap();
    }
    
    // Ctrl + Shift + D: é¡¯ç¤ºç½æƒ…å·¥å…·åˆ—
    if (e.ctrlKey && e.shiftKey && e.key === 'D') {
        e.preventDefault();
        showDisasterMapToolbar();
    }
});

// ğŸ”§ ä¿®æ­£ç‰ˆï¼šåˆå§‹åŒ–æ™‚è¨­ç½®æŒ‰éˆ•ç‹€æ…‹
document.addEventListener('DOMContentLoaded', function() {
    // å»¶é²è¨­ç½®æŒ‰éˆ•ç‹€æ…‹ï¼Œç¢ºä¿ DOM å®Œå…¨è¼‰å…¥
    setTimeout(() => {
        updateDisasterMapButton();
    }, 1000);
});

// ğŸ†• Supabase é…ç½®
// ğŸ”§ ä¿®æ­£ï¼šä½¿ç”¨æ‚¨çš„ Supabase é…ç½®
const SUPABASE_URL = 'https://ulxrlnlebuxforumrsxi.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVseHJsbmxlYnV4Zm9ydW1yc3hpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE2ODkxNjQsImV4cCI6MjA2NzI2NTE2NH0.xn9E81cq1-repD9ku-0UwTupqk-2e0f929Dnyl1OB6M';

let supabase;

// ğŸ”§ ä¿®æ­£ï¼šåˆå§‹åŒ– Supabase é€£æ¥
function initSupabase() {
    try {
        if (typeof window.supabase !== 'undefined' && typeof window.supabase.createClient === 'function') {
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            console.log('âœ… Supabase é€£æ¥æˆåŠŸ');
            return true;
        } else {
            console.error('âŒ Supabase SDK æœªè¼‰å…¥');
            return false;
        }
    } catch (error) {
        console.error('âŒ Supabase é€£æ¥å¤±æ•—:', error);
        return false;
    }
}

// ğŸ†• æœå°‹é„°è¿‘è¨­å‚™å’Œé¥‹ç·š
// ğŸ”§ ä¿®æ­£ç‰ˆï¼šæœå°‹é„°è¿‘è¨­å‚™å’Œé¥‹ç·š - é…åˆå¯¦éš›è³‡æ–™åº«çµæ§‹
async function searchNearbyFeatures(lat, lng, radiusKm = 2) {
    if (!supabase) {
        showToast('âŒ è³‡æ–™åº«é€£æ¥æœªåˆå§‹åŒ–', 'error');
        return null;
    }

    try {
        console.log(`ğŸ” æœå°‹ä½ç½® (${lat}, ${lng}) åŠå¾‘ ${radiusKm}km å…§çš„è¨­å‚™å’Œé¥‹ç·š...`);
        
        // ğŸ”§ è¨ˆç®—æœå°‹é‚Šç•Œï¼ˆç²—ç•¥ä¼°ç®—ï¼‰
        const latDelta = radiusKm * 0.009; // ç´„ 1km = 0.009åº¦
        const lngDelta = radiusKm * 0.009;
        
        // ğŸ”§ ä¿®æ­£ï¼šæœå°‹é„°è¿‘è¨­å‚™ - ä½¿ç”¨å¯¦éš›çš„è³‡æ–™åº«æ¬„ä½
        const { data: nearbyDevices, error: devicesError } = await supabase
            .from('devices')
            .select(`
                id,
                feeder_name,
                device_id,
                lat,
                lng,
                fsc,
                area,
                location_name,
                properties
            `)
            .gte('lat', lat - latDelta)
            .lte('lat', lat + latDelta)
            .gte('lng', lng - lngDelta)
            .lte('lng', lng + lngDelta)
            .limit(200); // é™åˆ¶çµæœæ•¸é‡

        if (devicesError) {
            console.error('è¨­å‚™æŸ¥è©¢éŒ¯èª¤:', devicesError);
            throw devicesError;
        }

        // ğŸ”§ ä¿®æ­£ï¼šæœå°‹é„°è¿‘é¥‹ç·š - ä½¿ç”¨å¯¦éš›çš„è³‡æ–™åº«æ¬„ä½
        const { data: nearbyFeeders, error: feedersError } = await supabase
            .from('feeders')
            .select(`
                id,
                name,
                center_lat,
                center_lng,
                device_count,
                line_count,
                total_length,
                areas
            `)
            .gte('center_lat', lat - latDelta)
            .lte('center_lat', lat + latDelta)
            .gte('center_lng', lng - lngDelta)
            .lte('center_lng', lng + lngDelta)
            .limit(50); // é™åˆ¶é¥‹ç·šæ•¸é‡

        if (feedersError) {
            console.error('é¥‹ç·šæŸ¥è©¢éŒ¯èª¤:', feedersError);
            throw feedersError;
        }

        // ğŸ”§ è¨ˆç®—ç²¾ç¢ºè·é›¢ä¸¦éæ¿¾
        const devicesWithDistance = (nearbyDevices || []).map(device => {
            const distance = calculateDistance(lat, lng, device.lat, device.lng);
            return { ...device, distance };
        }).filter(device => device.distance <= radiusKm)
          .sort((a, b) => a.distance - b.distance);

        const feedersWithDistance = (nearbyFeeders || []).map(feeder => {
            const distance = calculateDistance(lat, lng, feeder.center_lat, feeder.center_lng);
            return { ...feeder, distance };
        }).filter(feeder => feeder.distance <= radiusKm)
          .sort((a, b) => a.distance - b.distance);

        console.log(`âœ… æ‰¾åˆ° ${devicesWithDistance.length} å€‹é„°è¿‘è¨­å‚™, ${feedersWithDistance.length} æ¢é„°è¿‘é¥‹ç·š`);

        return {
            devices: devicesWithDistance,
            feeders: feedersWithDistance,
            searchLocation: { lat, lng },
            searchRadius: radiusKm
        };

    } catch (error) {
        console.error('âŒ æœå°‹é„°è¿‘è¨­å‚™å¤±æ•—:', error);
        showToast(`âŒ æœå°‹å¤±æ•—: ${error.message}`, 'error');
        return null;
    }
}

// ğŸ†• è¨ˆç®—å…©é»é–“è·é›¢ï¼ˆå…¬é‡Œï¼‰
function calculateDistance(lat1, lng1, lat2, lng2) {
    const R = 6371; // åœ°çƒåŠå¾‘ï¼ˆå…¬é‡Œï¼‰
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLng = (lng2 - lng1) * Math.PI / 180;
    const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
              Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
              Math.sin(dLng/2) * Math.sin(dLng/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
}
// ğŸ†• å…¨åŸŸè®Šæ•¸ï¼šå„²å­˜æœå°‹ç›¸é—œçš„åœ–å±¤
let searchMarkers = [];
let searchCircle = null;
let deviceMarkers = [];
// ğŸ†• é¡¯ç¤ºé„°è¿‘æœå°‹çµæœ
// ğŸ”§ ä¿®æ­£ç‰ˆï¼šé¡¯ç¤ºé„°è¿‘æœå°‹çµæœ - åŠ å…¥åœ“åœˆæ§åˆ¶å’Œè¨­å‚™é¡¯ç¤º
function displayNearbyResults(results) {
    if (!results) return;

    const { devices, feeders, searchLocation, searchRadius } = results;

    // æ¸…é™¤ä¹‹å‰çš„æœå°‹çµæœ
    clearSearchResults();

    // ğŸ”§ åœ¨åœ°åœ–ä¸Šæ¨™è¨˜æœå°‹ä¸­å¿ƒ
    const searchMarker = L.marker([searchLocation.lat, searchLocation.lng], {
        icon: L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        })
    }).addTo(map);

    searchMarker.bindPopup(`
        <div style="text-align: center;">
            <h4>ğŸ“ æœå°‹ä¸­å¿ƒ</h4>
            <p>åŠå¾‘: ${searchRadius < 1 ? (searchRadius * 1000) + 'm' : searchRadius + 'km'}</p>
            <p>æ‰¾åˆ° ${devices.length} å€‹è¨­å‚™</p>
            <p>æ‰¾åˆ° ${feeders.length} æ¢é¥‹ç·š</p>
        </div>
    `).openPopup();

    searchMarkers.push(searchMarker);

    // ğŸ”§ æ ¹æ“šè¨­å®šé¡¯ç¤ºæœå°‹ç¯„åœåœ“åœˆ
    const showCircle = document.getElementById('showSearchCircle')?.checked !== false;
    if (showCircle) {
        searchCircle = L.circle([searchLocation.lat, searchLocation.lng], {
            color: '#007bff',
            fillColor: '#007bff',
            fillOpacity: 0.1,
            radius: searchRadius * 1000 // è½‰æ›ç‚ºå…¬å°º
        }).addTo(map);
    }

    // ğŸ†• åœ¨åœ°åœ–ä¸Šé¡¯ç¤ºé™„è¿‘çš„è¨­å‚™
    displayDevicesOnMap(devices);

    // ğŸ”§ åœ¨å´é‚Šæ¬„é¡¯ç¤ºçµæœ
    showNearbyResultsInSidebar(results);

    // ğŸ”§ èª¿æ•´åœ°åœ–è¦–é‡
    const bounds = L.latLngBounds();
    bounds.extend([searchLocation.lat, searchLocation.lng]);
    
    devices.forEach(device => {
        bounds.extend([device.lat, device.lng]);
    });
    
    feeders.forEach(feeder => {
        if (feeder.center_lat && feeder.center_lng) {
            bounds.extend([feeder.center_lat, feeder.center_lng]);
        }
    });

    if (bounds.isValid()) {
        map.fitBounds(bounds, { padding: [20, 20] });
    }

    // ğŸ†• è‡ªå‹•è¼‰å…¥æœ€è¿‘çš„é¥‹ç·šï¼ˆå¦‚æœå•Ÿç”¨ï¼‰
    const autoLoad = document.getElementById('autoLoadFeeder')?.checked;
    if (autoLoad && feeders.length > 0) {
        const nearestFeeder = feeders[0];
        showToast(`ğŸ”„ è‡ªå‹•è¼‰å…¥æœ€è¿‘çš„é¥‹ç·š: ${nearestFeeder.name}`, 'info');
        setTimeout(() => {
            loadNearbyFeeder(nearestFeeder.name, nearestFeeder.distance);
        }, 1000);
    }

    const radiusText = searchRadius < 1 ? `${searchRadius * 1000}å…¬å°º` : `${searchRadius}å…¬é‡Œ`;
    showToast(`ğŸ¯ æ‰¾åˆ° ${devices.length} å€‹è¨­å‚™å’Œ ${feeders.length} æ¢é¥‹ç·š (åŠå¾‘${radiusText})`, 'success');
}

// ğŸ†• æ¸…é™¤æœå°‹çµæœ
// ğŸ”§ ä¿®æ­£ç‰ˆï¼šæ¸…é™¤æœå°‹çµæœ - ç¢ºä¿åœ“åœˆèƒ½æ­£ç¢ºç§»é™¤
function clearSearchResults() {
    console.log('ğŸ§¹ é–‹å§‹æ¸…é™¤æœå°‹çµæœ...');
    
    // æ¸…é™¤æœå°‹æ¨™è¨˜
    searchMarkers.forEach(marker => {
        if (map.hasLayer(marker)) {
            map.removeLayer(marker);
        }
    });
    searchMarkers = [];
    
    // ğŸ”§ é‡è¦ä¿®æ­£ï¼šç¢ºä¿æœå°‹åœ“åœˆèƒ½æ­£ç¢ºç§»é™¤
    if (searchCircle && map.hasLayer(searchCircle)) {
        map.removeLayer(searchCircle);
        searchCircle = null;
        console.log('âœ… æœå°‹åœ“åœˆå·²ç§»é™¤');
    }
    
    // æ¸…é™¤è¨­å‚™æ¨™è¨˜
    deviceMarkers.forEach(marker => {
        if (map.hasLayer(marker)) {
            map.removeLayer(marker);
        }
    });
    deviceMarkers = [];
    
    console.log('âœ… æœå°‹çµæœæ¸…é™¤å®Œæˆ');
}
// ğŸ†• åœ¨åœ°åœ–ä¸Šé¡¯ç¤ºè¨­å‚™
// ğŸ”§ ä¿®æ­£ç‰ˆï¼šåœ¨åœ°åœ–ä¸Šé¡¯ç¤ºè¨­å‚™ - é¿å… Leaflet éŒ¯èª¤
function displayDevicesOnMap(devices) {
    // æ¸…é™¤ä¹‹å‰çš„è¨­å‚™æ¨™è¨˜
    deviceMarkers.forEach(marker => {
        try {
            if (map.hasLayer(marker)) {
                map.removeLayer(marker);
            }
        } catch (error) {
            console.warn('æ¸…é™¤è¨­å‚™æ¨™è¨˜æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
        }
    });
    deviceMarkers = [];

    devices.forEach((device, index) => {
        try {
            const deviceIcon = getDeviceIcon(device.fsc);
            
            const marker = L.marker([device.lat, device.lng], {
                icon: L.icon({
                    iconUrl: deviceIcon.url,
                    iconSize: deviceIcon.size,
                    iconAnchor: deviceIcon.anchor,
                    popupAnchor: [1, -34]
                })
            });

            // ğŸ”§ é‡è¦ï¼šå…ˆåŠ å…¥åˆ°é™£åˆ—ï¼Œå†åŠ å…¥åˆ°åœ°åœ–
            deviceMarkers.push(marker);
            marker.addTo(map);

            // è¨­å‚™è³‡è¨Šå½ˆçª—
            marker.bindPopup(`
                <div style="min-width: 200px;">
                    <h4 style="margin: 0 0 10px 0; color: #007bff;">${getDeviceTypeName(device.fsc)}</h4>
                    <p style="margin: 5px 0;"><strong>è¨­å‚™ID:</strong> ${device.device_id || 'N/A'}</p>
                    <p style="margin: 5px 0;"><strong>é¥‹ç·š:</strong> ${device.feeder_name}</p>
                    <p style="margin: 5px 0;"><strong>ä½ç½®:</strong> ${device.location_name || 'N/A'}</p>
                    <p style="margin: 5px 0;"><strong>å€åŸŸ:</strong> ${device.area || 'N/A'}</p>
                    <p style="margin: 5px 0;"><strong>è·é›¢:</strong> ${device.distance.toFixed(2)} km</p>
                    <p style="margin: 5px 0;"><strong>åº§æ¨™:</strong> ${device.lat.toFixed(6)}, ${device.lng.toFixed(6)}</p>
                    <div style="margin-top: 10px;">
                        <button onclick="loadNearbyFeeder('${device.feeder_name}', 0)" 
                                style="width: 100%; padding: 8px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            è¼‰å…¥æ­¤è¨­å‚™çš„é¥‹ç·š
                        </button>
                    </div>
                </div>
            `);

        } catch (error) {
            console.error(`å‰µå»ºè¨­å‚™æ¨™è¨˜ ${index} æ™‚ç™¼ç”ŸéŒ¯èª¤:`, error, device);
        }
    });

    console.log(`âœ… æˆåŠŸé¡¯ç¤º ${deviceMarkers.length} å€‹è¨­å‚™æ¨™è¨˜`);
}

// ğŸ”§ èª¿è©¦ç‰ˆï¼šåœ¨å´é‚Šæ¬„é¡¯ç¤ºæœå°‹çµæœ - åŠ å…¥æ›´å¤šèª¿è©¦è³‡è¨Š
function showNearbyResultsInSidebar(results) {
    const sidebar = document.querySelector('.sidebar');
    if (!sidebar) {
        console.error('âŒ æ‰¾ä¸åˆ°å´é‚Šæ¬„');
        return;
    }

    console.log('ğŸ“‹ æº–å‚™åœ¨å´é‚Šæ¬„é¡¯ç¤ºæœå°‹çµæœ...');
    
    // ğŸ”§ é‡è¦ï¼šæš«å­˜åŸå§‹å…§å®¹å‰å…ˆæª¢æŸ¥
    if (!sidebar.getAttribute('data-original-content')) {
        const originalContent = sidebar.innerHTML;
        sidebar.setAttribute('data-original-content', originalContent);
        console.log('ğŸ’¾ å·²å‚™ä»½åŸå§‹å´é‚Šæ¬„å…§å®¹');
    }

    const { devices, feeders, searchLocation, searchRadius } = results;

    const resultsHtml = `
        <div style="padding: 20px; background: white; height: 100%; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="color: #2c3e50; margin: 0;">ğŸ¯ é„°è¿‘æœå°‹çµæœ</h3>
                <button onclick="restoreOriginalContentSafe()" 
                        style="background: #6c757d; color: white; border: none; padding: 5px 10px; 
                               border-radius: 4px; cursor: pointer; font-size: 12px;">
                    âœ• é—œé–‰
                </button>
            </div>

            <!-- ğŸ†• èª¿è©¦è³‡è¨Š -->
            <div style="background: #f8f9fa; padding: 10px; border-radius: 6px; margin-bottom: 15px; font-size: 11px; color: #666;">
                <strong>ğŸ”§ èª¿è©¦è³‡è¨Š:</strong><br>
                é¥‹ç·šè¼¸å…¥æ¡†: ${document.getElementById('feederInput') ? 'âœ… å­˜åœ¨' : 'âŒ ä¸å­˜åœ¨'}<br>
                è¼‰å…¥æŒ‰éˆ•: ${document.querySelector('.load-feeder-btn') ? 'âœ… å­˜åœ¨' : 'âŒ ä¸å­˜åœ¨'}
            </div>

            <!-- æœå°‹è³‡è¨Š -->
            <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <h4 style="margin: 0 0 10px 0; color: #1976d2;">ğŸ“ æœå°‹ç¯„åœ</h4>
                <p style="margin: 5px 0; font-size: 13px;">ä¸­å¿ƒ: ${searchLocation.lat.toFixed(6)}, ${searchLocation.lng.toFixed(6)}</p>
                <p style="margin: 5px 0; font-size: 13px;">åŠå¾‘: ${searchRadius} å…¬é‡Œ</p>
            </div>

            <!-- é¥‹ç·šæ¸…å–® -->
            <div style="margin-bottom: 25px;">
                <h4 style="color: #28a745; margin-bottom: 15px;">âš¡ é„°è¿‘é¥‹ç·š (${feeders.length})</h4>
                ${feeders.length === 0 ? 
                    '<p style="color: #666; text-align: center; padding: 20px;">ç„¡é„°è¿‘é¥‹ç·š</p>' :
                    feeders.map(feeder => `
                        <div style="margin-bottom: 12px; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #28a745;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong style="color: #28a745; font-size: 16px;">âš¡ ${feeder.name}</strong>
                                    <div style="font-size: 12px; color: #666; margin-top: 4px;">
                                        è¨­å‚™: ${feeder.device_count || 0} | ç·šæ®µ: ${feeder.line_count || 0}
                                    </div>
                                </div>
                                <span style="background: #28a745; color: white; padding: 4px 8px; border-radius: 12px; font-size: 11px;">
                                    ${feeder.distance.toFixed(2)} km
                                </span>
                            </div>
                            <div style="margin-top: 8px;">
                                <button onclick="loadNearbyFeederSafe('${feeder.name}', ${feeder.distance})" 
                                        style="width: 100%; padding: 8px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                    ğŸ—ºï¸ è¼‰å…¥æ­¤é¥‹ç·š
                                </button>
                            </div>
                        </div>
                    `).join('')
                }
            </div>

            <!-- è¨­å‚™æ¸…å–® -->
            <div style="margin-bottom: 25px;">
                <h4 style="color: #007bff; margin-bottom: 15px;">ğŸ“ é„°è¿‘è¨­å‚™ (${devices.length})</h4>
                ${devices.length === 0 ? 
                    '<p style="color: #666; text-align: center; padding: 20px;">ç„¡é„°è¿‘è¨­å‚™</p>' :
                    devices.slice(0, 10).map(device => `
                        <div style="margin-bottom: 10px; padding: 12px; background: #f8f9fa; border-radius: 6px; border-left: 3px solid #007bff;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong style="color: #007bff; font-size: 14px;">${getDeviceTypeName(device.fsc)}</strong>
                                    <div style="font-size: 11px; color: #666; margin-top: 2px;">
                                        é¥‹ç·š: ${device.feeder_name}
                                    </div>
                                </div>
                                <span style="background: #007bff; color: white; padding: 2px 6px; border-radius: 8px; font-size: 10px;">
                                    ${device.distance.toFixed(2)} km
                                </span>
                            </div>
                        </div>
                    `).join('')
                }
            </div>

            <!-- æ“ä½œæŒ‰éˆ• -->
            <div style="position: sticky; bottom: 0; background: white; padding: 15px 0; border-top: 1px solid #eee;">
                <button onclick="restoreOriginalContentSafe()" 
                        style="width: 100%; padding: 12px; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px;">
                    â† è¿”å›æ§åˆ¶é¢æ¿
                </button>
            </div>
        </div>
    `;

    sidebar.innerHTML = resultsHtml;
    console.log('âœ… æœå°‹çµæœå·²é¡¯ç¤ºåœ¨å´é‚Šæ¬„');
}
// ğŸ†• å®‰å…¨ç‰ˆæœ¬çš„æ¢å¾©å‡½æ•¸
function restoreOriginalContentSafe() {
    console.log('ğŸ”’ å®‰å…¨æ¢å¾©åŸå§‹å…§å®¹');
    
    if (restoreOriginalContent()) {
        showToast('âœ… å·²è¿”å›æ§åˆ¶é¢æ¿', 'success');
    } else {
        // å‚™ç”¨æ–¹æ¡ˆï¼šé‡æ–°è¼‰å…¥é é¢ï¼ˆæœ€å¾Œæ‰‹æ®µï¼‰
        if (confirm('ç„¡æ³•æ­£å¸¸è¿”å›æ§åˆ¶é¢æ¿ï¼Œæ˜¯å¦é‡æ–°è¼‰å…¥é é¢ï¼Ÿ')) {
            location.reload();
        }
    }
}
// ğŸ†• å®‰å…¨ç‰ˆæœ¬çš„è¼‰å…¥é¥‹ç·šå‡½æ•¸
function loadNearbyFeederSafe(feederName, distance) {
    console.log(`ğŸ”’ å®‰å…¨è¼‰å…¥é¥‹ç·š: ${feederName}`);
    
    // å…ˆå˜—è©¦æ¢å¾©åŸå§‹å…§å®¹
    if (restoreOriginalContent()) {
        // ç­‰å¾…DOMæ›´æ–°
        setTimeout(() => {
            loadNearbyFeeder(feederName, distance);
        }, 200);
    } else {
        // å¦‚æœæ¢å¾©å¤±æ•—ï¼Œç›´æ¥å˜—è©¦è¼‰å…¥
        loadNearbyFeeder(feederName, distance);
    }
}

// ğŸ”§ å®Œå…¨ä¿®æ­£ç‰ˆï¼šè¼‰å…¥é„°è¿‘é¥‹ç·š - å¤šé‡æª¢æŸ¥å’Œå‚™ç”¨æ–¹æ¡ˆ
function loadNearbyFeeder(feederName, distance) {
    console.log(`âš¡ è¼‰å…¥é„°è¿‘é¥‹ç·š: ${feederName} (è·é›¢: ${distance.toFixed(2)}km)`);
    
    // ğŸ”§ æ–¹æ³•1ï¼šç›´æ¥æŸ¥æ‰¾é¥‹ç·šè¼¸å…¥æ¡†
    let feederInput = document.getElementById('feederInput');
    
    if (feederInput) {
        executeFeederLoadDirect(feederInput, feederName);
        return;
    }
    
    // ğŸ”§ æ–¹æ³•2ï¼šå¦‚æœåœ¨æœå°‹çµæœé é¢ï¼Œå…ˆæ¢å¾©åŸå§‹å…§å®¹
    console.warn('âš ï¸ æœªæ‰¾åˆ°é¥‹ç·šè¼¸å…¥æ¡†ï¼Œå˜—è©¦æ¢å¾©åŸå§‹å…§å®¹...');
    restoreOriginalContent();
    
    // ç­‰å¾…DOMæ›´æ–°å¾Œå†æ¬¡å˜—è©¦
    setTimeout(() => {
        feederInput = document.getElementById('feederInput');
        if (feederInput) {
            executeFeederLoadDirect(feederInput, feederName);
        } else {
            // ğŸ”§ æ–¹æ³•3ï¼šæ‰‹å‹•åˆ‡æ›åˆ°æ§åˆ¶é¢æ¿ï¼ˆæ‰‹æ©Ÿç‰ˆï¼‰
            console.warn('âš ï¸ ä»æœªæ‰¾åˆ°ï¼Œå˜—è©¦åˆ‡æ›åˆ°æ§åˆ¶é¢æ¿...');
            switchToControlsPanel();
            
            setTimeout(() => {
                feederInput = document.getElementById('feederInput');
                if (feederInput) {
                    executeFeederLoadDirect(feederInput, feederName);
                } else {
                    // ğŸ”§ æ–¹æ³•4ï¼šæœ€å¾Œçš„å‚™ç”¨æ–¹æ¡ˆ
                    showFeederLoadFallback(feederName);
                }
            }, 500);
        }
    }, 300);
}

// ğŸ†• ç›´æ¥åŸ·è¡Œé¥‹ç·šè¼‰å…¥
function executeFeederLoadDirect(feederInput, feederName) {
    try {
        feederInput.value = feederName;
        
        // ğŸ”§ è§¸ç™¼ input äº‹ä»¶ä»¥åŒæ­¥ä¸‹æ‹‰é¸å–®
        const inputEvent = new Event('input', { bubbles: true });
        feederInput.dispatchEvent(inputEvent);
        
        showToast(`ğŸ”„ æ­£åœ¨è¼‰å…¥é¥‹ç·š ${feederName}...`, 'info');
        
        // ğŸ”§ ç¢ºä¿å‘¼å«è¼‰å…¥å‡½æ•¸
        if (typeof loadFeederFromCloud === 'function') {
            loadFeederFromCloud();
        } else {
            // å‚™ç”¨ï¼šç›´æ¥é»æ“Šè¼‰å…¥æŒ‰éˆ•
            const loadButton = document.querySelector('.load-feeder-btn');
            if (loadButton) {
                loadButton.click();
            } else {
                throw new Error('æ‰¾ä¸åˆ°è¼‰å…¥å‡½æ•¸å’ŒæŒ‰éˆ•');
            }
        }
        
        console.log(`âœ… æˆåŠŸè¨­å®šé¥‹ç·š: ${feederName}`);
        
    } catch (error) {
        console.error('âŒ åŸ·è¡Œé¥‹ç·šè¼‰å…¥å¤±æ•—:', error);
        showFeederLoadFallback(feederName);
    }
}
// ğŸ†• åˆ‡æ›åˆ°æ§åˆ¶é¢æ¿ï¼ˆè™•ç†æ‰‹æ©Ÿç‰ˆæƒ…æ³ï¼‰
function switchToControlsPanel() {
    // æª¢æŸ¥æ˜¯å¦ç‚ºæ‰‹æ©Ÿç‰ˆ
    const isMobile = window.innerWidth <= 768;
    
    if (isMobile) {
        // æ‰‹æ©Ÿç‰ˆï¼šé»æ“Šæ§åˆ¶æ¨™ç±¤
        const controlsTab = document.querySelector('.nav-tab[data-tab="controls"]');
        if (controlsTab) {
            controlsTab.click();
            console.log('ğŸ“± å·²åˆ‡æ›åˆ°æ‰‹æ©Ÿç‰ˆæ§åˆ¶é¢æ¿');
        }
    }
    
    // ç¢ºä¿å´é‚Šæ¬„é¡¯ç¤º
    const sidebar = document.querySelector('.sidebar');
    if (sidebar) {
        sidebar.style.display = 'block';
    }
}
// ğŸ†• å‚™ç”¨æ–¹æ¡ˆï¼šé¡¯ç¤ºæ‰‹å‹•è¼‰å…¥æç¤º
function showFeederLoadFallback(feederName) {
    console.error('âŒ æ‰€æœ‰è‡ªå‹•è¼‰å…¥æ–¹æ¡ˆéƒ½å¤±æ•—ï¼Œé¡¯ç¤ºæ‰‹å‹•æç¤º');
    
    // å‰µå»ºæç¤ºå½ˆçª—
    const fallbackPopup = L.popup({
        closeButton: true,
        autoClose: false,
        closeOnEscapeKey: true,
        className: 'feeder-load-fallback'
    })
    .setLatLng(map.getCenter())
    .setContent(`
        <div style="text-align: center; padding: 10px;">
            <h4 style="color: #dc3545; margin: 0 0 10px 0;">âš ï¸ è‡ªå‹•è¼‰å…¥å¤±æ•—</h4>
            <p style="margin: 5px 0; font-size: 14px;">è«‹æ‰‹å‹•è¼‰å…¥é¥‹ç·šï¼š</p>
            <div style="background: #f8f9fa; padding: 10px; border-radius: 4px; margin: 10px 0;">
                <strong style="font-size: 16px; color: #007bff;">${feederName}</strong>
            </div>
            <div style="font-size: 12px; color: #666; line-height: 1.4;">
                1. é—œé–‰æ­¤å½ˆçª—<br>
                2. åœ¨å·¦å´æ§åˆ¶é¢æ¿æ‰¾åˆ°ã€Œé¥‹ç·šè¼¸å…¥æ¡†ã€<br>
                3. è¼¸å…¥ã€Œ${feederName}ã€<br>
                4. é»æ“Šã€Œè¼‰å…¥é¥‹ç·šè³‡æ–™ã€æŒ‰éˆ•
            </div>
            <div style="margin-top: 15px;">
                <button onclick="copyFeederName('${feederName}')" 
                        style="padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 8px;">
                    ğŸ“‹ è¤‡è£½é¥‹ç·šåç¨±
                </button>
                <button onclick="map.closePopup()" 
                        style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    é—œé–‰
                </button>
            </div>
        </div>
    `)
    .openOn(map);
    
    // åŒæ™‚é¡¯ç¤º toast æç¤º
    showToast(`âš ï¸ è«‹æ‰‹å‹•è¼‰å…¥é¥‹ç·šï¼š${feederName}`, 'warning');
}

// ğŸ†• è¤‡è£½é¥‹ç·šåç¨±åˆ°å‰ªè²¼ç°¿
function copyFeederName(feederName) {
    if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(feederName).then(() => {
            showToast(`ğŸ“‹ å·²è¤‡è£½é¥‹ç·šåç¨±ï¼š${feederName}`, 'success');
            map.closePopup();
        }).catch(err => {
            console.error('è¤‡è£½å¤±æ•—:', err);
            fallbackCopyFeederName(feederName);
        });
    } else {
        fallbackCopyFeederName(feederName);
    }
}

// ğŸ†• å‚™ç”¨è¤‡è£½æ–¹æ³•
function fallbackCopyFeederName(feederName) {
    const textArea = document.createElement('textarea');
    textArea.value = feederName;
    textArea.style.position = 'fixed';
    textArea.style.left = '-999999px';
    textArea.style.top = '-999999px';
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    
    try {
        document.execCommand('copy');
        showToast(`ğŸ“‹ å·²è¤‡è£½é¥‹ç·šåç¨±ï¼š${feederName}`, 'success');
        map.closePopup();
    } catch (err) {
        console.error('è¤‡è£½å¤±æ•—:', err);
        showToast('âŒ è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¨˜ä½é¥‹ç·šåç¨±', 'error');
    }
    
    document.body.removeChild(textArea);
}
// ğŸ†• åŸ·è¡Œé¥‹ç·šè¼‰å…¥çš„è¼”åŠ©å‡½æ•¸
function executeFeederLoad(feederInput, feederName) {
    feederInput.value = feederName;
    showToast(`ğŸ”„ æ­£åœ¨è¼‰å…¥é¥‹ç·š ${feederName}...`, 'info');
    
    // ğŸ”§ ç¢ºä¿å‘¼å«æ­£ç¢ºçš„è¼‰å…¥å‡½æ•¸
    if (typeof loadFeederFromCloud === 'function') {
        loadFeederFromCloud();
    } else {
        // ğŸ”§ å‚™ç”¨æ–¹æ¡ˆï¼šç›´æ¥è§¸ç™¼è¼‰å…¥æŒ‰éˆ•é»æ“Š
        const loadButton = document.querySelector('.load-feeder-btn') || 
                          document.querySelector('button[onclick*="loadFeeder"]');
        if (loadButton) {
            loadButton.click();
        } else {
            showToast('âŒ æ‰¾ä¸åˆ°è¼‰å…¥æŒ‰éˆ•', 'error');
            return;
        }
    }
    
    // å»¶é²æ¢å¾©æ§åˆ¶é¢æ¿
    setTimeout(() => {
        restoreOriginalContent();
    }, 1500);
}
// ğŸ†• é‡æ–°æœå°‹é„°è¿‘è¨­å‚™
function searchNearbyAgain() {
    restoreOriginalContent();
    
    setTimeout(() => {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                position => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    performNearbySearch(lat, lng);
                },
                error => {
                    showToast('âŒ ç„¡æ³•å–å¾—ä½ç½®ï¼Œè«‹æ‰‹å‹•é»é¸åœ°åœ–', 'error');
                    enableMapClickForSearch();
                }
            );
        } else {
            showToast('âŒ ç€è¦½å™¨ä¸æ”¯æ´å®šä½ï¼Œè«‹æ‰‹å‹•é»é¸åœ°åœ–', 'error');
            enableMapClickForSearch();
        }
    }, 300);
}

// ğŸ”§ ä¿®æ­£ç‰ˆï¼šå•Ÿç”¨åœ°åœ–é»é¸æœå°‹ - ä½¿ç”¨é¸ä¸­çš„åŠå¾‘
function enableMapClickForSearch() {
    showToast('ğŸ“ è«‹é»é¸åœ°åœ–ä¸Šçš„ä½ç½®é€²è¡Œæœå°‹', 'info');
    
    map.getContainer().style.cursor = 'crosshair';
    
    const clickHandler = function(e) {
        map.off('click', clickHandler);
        map.getContainer().style.cursor = '';
        
        const lat = e.latlng.lat;
        const lng = e.latlng.lng;
        
        // ğŸ”§ é‡è¦ä¿®æ­£ï¼šä½¿ç”¨é¸ä¸­çš„åŠå¾‘ï¼Œè€Œä¸æ˜¯å›ºå®šçš„2å…¬é‡Œ
        const radiusSelect = document.getElementById('searchRadius');
        const radius = parseFloat(radiusSelect.value);
        
        performNearbySearch(lat, lng, radius);
    };
    
    map.on('click', clickHandler);
}

// ğŸ†• åŸ·è¡Œé„°è¿‘æœå°‹
// ğŸ”§ ä¿®æ­£ç‰ˆï¼šåŸ·è¡Œé„°è¿‘æœå°‹ - åŠ å…¥è¨­å‚™é¡¯ç¤ºé¸é …
async function performNearbySearch(lat, lng, radius = 2) {
    showToast('ğŸ” æ­£åœ¨æœå°‹é„°è¿‘è¨­å‚™å’Œé¥‹ç·š...', 'info');
    
    const results = await searchNearbyFeatures(lat, lng, radius);
    if (results) {
        // ğŸ†• æª¢æŸ¥æ˜¯å¦åªé¡¯ç¤ºè¨­å‚™
        const showDevicesOnly = document.getElementById('showDevicesOnly')?.checked;
        
        if (showDevicesOnly) {
            // åªé¡¯ç¤ºè¨­å‚™ï¼Œä¸é¡¯ç¤ºå´é‚Šæ¬„
            clearSearchResults();
            displayDevicesOnMap(results.devices);
            
            // èª¿æ•´åœ°åœ–è¦–é‡
            const bounds = L.latLngBounds();
            bounds.extend([lat, lng]);
            results.devices.forEach(device => {
                bounds.extend([device.lat, device.lng]);
            });
            
            if (bounds.isValid()) {
                map.fitBounds(bounds, { padding: [20, 20] });
            }
            
            const radiusText = radius < 1 ? `${radius * 1000}å…¬å°º` : `${radius}å…¬é‡Œ`;
            showToast(`ğŸ“ é¡¯ç¤º ${results.devices.length} å€‹é™„è¿‘è¨­å‚™ (åŠå¾‘${radiusText})`, 'success');
        } else {
            // æ­£å¸¸é¡¯ç¤ºï¼ˆåŒ…å«å´é‚Šæ¬„ï¼‰
            displayNearbyResults(results);
        }
    }
}

// ğŸ†• å¾ç•¶å‰ä½ç½®æœå°‹
function searchNearbyFromLocation() {
    const radiusSelect = document.getElementById('searchRadius');
    const radius = parseFloat(radiusSelect.value);
    
    if (navigator.geolocation) {
        showToast('ğŸ“ æ­£åœ¨å–å¾—æ‚¨çš„ä½ç½®...', 'info');
        
        navigator.geolocation.getCurrentPosition(
            position => {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                performNearbySearch(lat, lng, radius);
            },
            error => {
                console.error('å®šä½å¤±æ•—:', error);
                showToast('âŒ ç„¡æ³•å–å¾—ä½ç½®ï¼Œè«‹æª¢æŸ¥å®šä½æ¬Šé™', 'error');
            },
            {
                enableHighAccuracy: true,
                timeout: 15000,
                maximumAge: 60000
            }
        );
    } else {
        showToast('âŒ æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´å®šä½åŠŸèƒ½', 'error');
    }
}

// ğŸ†• åªé¡¯ç¤ºé™„è¿‘è¨­å‚™ï¼ˆä¸é¡¯ç¤ºé¥‹ç·šåˆ—è¡¨ï¼‰
async function showNearbyDevicesOnly() {
    const radiusSelect = document.getElementById('searchRadius');
    const radius = parseFloat(radiusSelect.value);
    
    if (navigator.geolocation) {
        showToast('ğŸ“ æ­£åœ¨å–å¾—æ‚¨çš„ä½ç½®ä¸¦é¡¯ç¤ºé™„è¿‘è¨­å‚™...', 'info');
        
        navigator.geolocation.getCurrentPosition(
            async position => {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                
                const results = await searchNearbyFeatures(lat, lng, radius);
                if (results && results.devices.length > 0) {
                    // æ¸…é™¤ä¹‹å‰çš„çµæœ
                    clearSearchResults();
                    
                    // åªé¡¯ç¤ºè¨­å‚™ï¼Œä¸é¡¯ç¤ºå´é‚Šæ¬„çµæœ
                    displayDevicesOnMap(results.devices);
                    
                    // èª¿æ•´åœ°åœ–è¦–é‡åˆ°è¨­å‚™ç¯„åœ
                    const bounds = L.latLngBounds();
                    bounds.extend([lat, lng]);
                    results.devices.forEach(device => {
                        bounds.extend([device.lat, device.lng]);
                    });
                    
                    if (bounds.isValid()) {
                        map.fitBounds(bounds, { padding: [20, 20] });
                    }
                    
                    const radiusText = radius < 1 ? `${radius * 1000}å…¬å°º` : `${radius}å…¬é‡Œ`;
                    showToast(`ğŸ“ é¡¯ç¤º ${results.devices.length} å€‹é™„è¿‘è¨­å‚™ (åŠå¾‘${radiusText})`, 'success');
                } else {
                    showToast('âŒ é™„è¿‘æ²’æœ‰æ‰¾åˆ°è¨­å‚™', 'warning');
                }
            },
            error => {
                console.error('å®šä½å¤±æ•—:', error);
                showToast('âŒ ç„¡æ³•å–å¾—ä½ç½®ï¼Œè«‹æª¢æŸ¥å®šä½æ¬Šé™', 'error');
            }
        );
    } else {
        showToast('âŒ æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´å®šä½åŠŸèƒ½', 'error');
    }
}
// ğŸ†• æŒ‡åŒ—é‡åŠŸèƒ½
function toggleCompass() {
    isCompassActive = !isCompassActive;
    
    if (isCompassActive) {
        startCompass();
    } else {
        stopCompass();
    }
}

function startCompass() {
    const compassBtn = document.getElementById('compassBtn');
    compassBtn.classList.add('active');
    
    // æª¢æŸ¥è¨­å‚™æ˜¯å¦æ”¯æ´æ–¹å‘æ„Ÿæ¸¬
    if (window.DeviceOrientationEvent) {
        // iOS 13+ éœ€è¦è«‹æ±‚æ¬Šé™
        if (typeof DeviceOrientationEvent.requestPermission === 'function') {
            DeviceOrientationEvent.requestPermission()
                .then(response => {
                    if (response === 'granted') {
                        orientationHandler = handleOrientation;
                        window.addEventListener("deviceorientation", orientationHandler, true);
                        console.log('æŒ‡åŒ—é‡å·²å•Ÿå‹•');
                        showToast('ğŸ§­ æŒ‡åŒ—é‡å·²å•Ÿå‹•', 'success');
                    } else {
                        showToast('éœ€è¦æ–¹å‘æ„Ÿæ¸¬æ¬Šé™æ‰èƒ½ä½¿ç”¨æŒ‡åŒ—é‡åŠŸèƒ½', 'error');
                        stopCompass();
                    }
                })
                .catch(error => {
                    console.error('æ¬Šé™è«‹æ±‚å¤±æ•—:', error);
                    showToast('ç„¡æ³•å•Ÿå‹•æŒ‡åŒ—é‡åŠŸèƒ½', 'error');
                    stopCompass();
                });
        } else {
            // é iOS è¨­å‚™æˆ–è¼ƒèˆŠç‰ˆæœ¬
            orientationHandler = handleOrientation;
            window.addEventListener("deviceorientation", orientationHandler, true);
            console.log('æŒ‡åŒ—é‡å·²å•Ÿå‹•');
            showToast('ğŸ§­ æŒ‡åŒ—é‡å·²å•Ÿå‹•', 'success');
        }
    } else {
        showToast('æ‚¨çš„è¨­å‚™ä¸æ”¯æ´æ–¹å‘æ„Ÿæ¸¬åŠŸèƒ½', 'error');
        stopCompass();
    }
}

function stopCompass() {
    isCompassActive = false;
    const compassBtn = document.getElementById('compassBtn');
    compassBtn.classList.remove('active');
    
    // ç§»é™¤äº‹ä»¶ç›£è½å™¨
    if (orientationHandler) {
        window.removeEventListener("deviceorientation", orientationHandler, true);
        orientationHandler = null;
    }
    
    // é‡ç½®åœ°åœ–æ–¹å‘
    if (map && map.setBearing) {
        map.setBearing(0);
    }
    lastHeading = null;
    
    console.log('æŒ‡åŒ—é‡å·²é—œé–‰ï¼Œåœ°åœ–æ–¹å‘å·²é‡ç½®');
    showToast('ğŸ§­ æŒ‡åŒ—é‡å·²é—œé–‰', 'info');
}

function handleOrientation(event) {
    if (!isCompassActive) return;
    
    // ç²å–æ–¹ä½è§’ (alphaå€¼)
    let alpha = event.webkitCompassHeading || event.alpha;
    
    if (alpha !== null) {
        // å°‡ alpha å€¼è½‰æ›ç‚ºä»¥æ­£åŒ—ç‚º 0 åº¦çš„æ–¹ä½è§’
        let heading = alpha;
        if (event.alpha !== undefined) {
            heading = 360 - alpha; // å°æ–¼ä½¿ç”¨ alpha çš„è¨­å‚™ï¼Œéœ€è¦åè½‰æ–¹å‘
        }
        
        // åªæœ‰æ–¹å‘è®ŠåŒ–è¶…é1åº¦æ‰æ›´æ–°åœ°åœ–ï¼Œé¿å…éåº¦æ›´æ–°
        if (lastHeading === null || Math.abs(heading - lastHeading) > 1) {
            rotateMap(heading);
            lastHeading = heading;
        }
    }
}

function rotateMap(heading) {
    // è¨­ç½®åœ°åœ–æ–¹ä½è§’ (å¹³æ»‘æ—‹è½‰)
    if (map && map.setBearing) {
        map.setBearing(heading);
    }
}

// ğŸ†• ä¿®æ”¹ï¼šç§»é™¤é‡ç½®æŒ‰éˆ•ç›¸é—œå‡½æ•¸ï¼Œæ•´åˆåˆ° stopCompass ä¸­
function resetMapRotation() {
    if (map && map.setBearing) {
        map.setBearing(0);
    }
    lastHeading = null;
    console.log('åœ°åœ–æ–¹å‘å·²é‡ç½®');
    showToast('ğŸ”„ åœ°åœ–æ–¹å‘å·²é‡ç½®', 'info');
}

// ğŸ†• è™•ç†é é¢å¯è¦‹æ€§è®ŠåŒ–
document.addEventListener('visibilitychange', function() {
    if (document.hidden) {
        // é é¢éš±è—æ™‚æš«åœåŠŸèƒ½
        if (isCompassActive && orientationHandler) {
            window.removeEventListener("deviceorientation", orientationHandler, true);
        }
    } else if (!document.hidden) {
        // é é¢é¡¯ç¤ºæ™‚æ¢å¾©åŠŸèƒ½
        if (isCompassActive && orientationHandler) {
            window.addEventListener("deviceorientation", orientationHandler, true);
        }
    }
});

// ğŸš¨ ç½æƒ…æŸ¥å ±ç³»çµ± - å®Œæ•´ç‰ˆ
// ==========================================

// ç½æƒ…æŸ¥å ±å…¨åŸŸè®Šæ•¸
let disasterCurrentPosition = { lat: null, lng: null };
let disasterWatchPositionId = null;
let disasterIncidentItems = [];
let disasterSelectedFiles = [];
let disasterReportContainer = null;

// ImgBB API Key
const DISASTER_IMGBB_API_KEY = '49d924e357e6c46ab2044cb23991111e';

// Google Apps Script URL - è«‹æ›¿æ›ç‚ºæ‚¨çš„å¯¦éš› URL
const DISASTER_GAS_URL = 'https://script.google.com/macros/s/AKfycbxgPjSqdU144imUFunwviMdoIXgBhiQ8wAUf0F2FGEFbxsM4rqV8Mz2uFo_zQcTEQY/exec';

// ğŸ†• é–‹å•Ÿç½æƒ…æŸ¥å ±ç³»çµ±
// ğŸ†• ä¿®æ”¹é–‹å•Ÿç½æƒ…æŸ¥å ±ç³»çµ±å‡½æ•¸ï¼ŒåŠ å…¥ Tpclid èª¿è©¦
function openDisasterReportSystem(lat, lng, locationName = 'é¸å®šä½ç½®', deviceInfo = null) {
    console.log(`ğŸš¨ é–‹å•Ÿç½æƒ…æŸ¥å ±ç³»çµ±: ${locationName} (${lat}, ${lng})`);
    
    if (deviceInfo) {
        console.log('ğŸ“‹ å®Œæ•´è¨­å‚™è³‡è¨Š:', deviceInfo);
        console.log('ğŸ¢ Tpclid (å°é›»ID):', deviceInfo.tpcId || 'âŒ ç„¡ Tpclid');
        console.log('ğŸ“ è¨­å‚™ID:', deviceInfo.deviceId || 'âŒ ç„¡è¨­å‚™ID');
        
        // æª¢æŸ¥ Tpclid æ˜¯å¦å­˜åœ¨
        if (!deviceInfo.tpcId) {
            console.warn('âš ï¸ è­¦å‘Šï¼šè©²è¨­å‚™æ²’æœ‰ Tpclidï¼ˆå°é›»IDï¼‰ï¼Œè«‹æª¢æŸ¥è³‡æ–™ä¾†æº');
        } else {
            console.log('âœ… æˆåŠŸå–å¾— Tpclidï¼Œå°‡è‡ªå‹•å¡«å…¥å°é›»åœ–è™Ÿæ¬„ä½');
        }
    }
    
    // è¨­å®šåˆå§‹ä½ç½®
    disasterCurrentPosition.lat = lat;
    disasterCurrentPosition.lng = lng;
    
    // å„²å­˜è¨­å‚™è³‡è¨Šä¾›å¾ŒçºŒä½¿ç”¨
    window.disasterDeviceInfo = deviceInfo;
    
    // æª¢æŸ¥æ˜¯å¦ç‚ºæ‰‹æ©Ÿç‰ˆ
    const isMobile = window.innerWidth <= 768;
    
    if (isMobile) {
        openDisasterReportMobile(lat, lng, locationName);
    } else {
        openDisasterReportDesktop(lat, lng, locationName);
    }
}

// ğŸ–¥ï¸ æ¡Œé¢ç‰ˆç½æƒ…æŸ¥å ±
function openDisasterReportDesktop(lat, lng, locationName) {
    // å‰µå»ºå…¨è¢å¹•è¦†è“‹å±¤
    disasterReportContainer = document.createElement('div');
    disasterReportContainer.id = 'disaster-report-container';
    disasterReportContainer.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.8);
        z-index: 3000;
        display: flex;
        justify-content: center;
        align-items: center;
        overflow-y: auto;
        padding: 20px;
        box-sizing: border-box;
    `;
    
    disasterReportContainer.innerHTML = createDisasterReportHTML(lat, lng, locationName, false);
    document.body.appendChild(disasterReportContainer);
    document.body.style.overflow = 'hidden';
    
    // åˆå§‹åŒ–ç½æƒ…æŸ¥å ±åŠŸèƒ½
    initializeDisasterReportSystem();
}

// ğŸ“± æ‰‹æ©Ÿç‰ˆç½æƒ…æŸ¥å ±
function openDisasterReportMobile(lat, lng, locationName) {
    // å‰µå»ºå…¨è¢å¹•è¡¨å–®
    disasterReportContainer = document.createElement('div');
    disasterReportContainer.id = 'disaster-report-container';
    disasterReportContainer.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: white;
        z-index: 3000;
        overflow-y: auto;
        padding: 0;
    `;
    
    disasterReportContainer.innerHTML = createDisasterReportHTML(lat, lng, locationName, true);
    document.body.appendChild(disasterReportContainer);
    document.body.style.overflow = 'hidden';
    
    // åˆå§‹åŒ–ç½æƒ…æŸ¥å ±åŠŸèƒ½
    initializeDisasterReportSystem();
}

// ğŸ—ï¸ å»ºç«‹ç½æƒ…æŸ¥å ± HTML
function createDisasterReportHTML(lat, lng, locationName, isMobile) {
    const containerClass = isMobile ? 'mobile-disaster-form' : 'desktop-disaster-form';
    const maxWidth = isMobile ? '100%' : '800px';
    
    return `
        <div class="${containerClass}" style="max-width: ${maxWidth}; margin: 0 auto; background: white; border-radius: ${isMobile ? '0' : '10px'}; box-shadow: ${isMobile ? 'none' : '0 0 20px rgba(0,0,0,0.3)'}; overflow: hidden;">
            <!-- æ¨™é¡Œåˆ— -->
            <div style="background: linear-gradient(135deg, #dc3545, #c82333); color: white; padding: 20px; display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h2 style="margin: 0; font-size: ${isMobile ? '20px' : '24px'};">
                        <i class="fas fa-exclamation-triangle"></i> ç½æƒ…æŸ¥å ±ç³»çµ±
                    </h2>
                    <p style="margin: 5px 0 0 0; opacity: 0.9; font-size: ${isMobile ? '14px' : '16px'};">è«‹å¡«å¯«å®Œæ•´çš„ç½æƒ…è³‡è¨Šä¸¦ä¸Šå‚³ç›¸é—œç…§ç‰‡</p>
                </div>
                <button onclick="closeDisasterReportSystem()" 
                        style="background: rgba(255,255,255,0.2); color: white; border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 18px; cursor: pointer; transition: all 0.3s ease;"
                        onmouseover="this.style.background='rgba(255,255,255,0.3)'"
                        onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                    âœ•
                </button>
            </div>
            
            <!-- è¡¨å–®å…§å®¹ -->
            <div style="padding: 30px; max-height: ${isMobile ? 'calc(100vh - 80px)' : '70vh'}; overflow-y: auto;">
                <form id="disaster-report-form" novalidate>
                    <!-- äº‹æ•…è³‡è¨Šå€å¡Š -->
                    <div class="disaster-form-section" style="margin-bottom: 30px; padding: 20px; border: 1px solid #e9ecef; border-radius: 8px; background-color: #fdfdfd;">
                        <h5 style="color: #007bff; font-weight: 600; margin-bottom: 15px; padding-bottom: 8px; border-bottom: 2px solid #e9ecef;">
                            <i class="fas fa-clipboard-data"></i> äº‹æ•…è³‡è¨Š
                        </h5>
                        
                        <div style="display: grid; grid-template-columns: ${isMobile ? '1fr' : '2fr 100px 100px'}; gap: 15px; margin-bottom: 15px;">
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">äº‹æ•…é¡å‹</label>
                                <select id="disaster-incident-type-select" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                                    <option value="">è«‹é¸æ“‡äº‹æ•…é¡å‹</option>
                                    <option value="é›»æ¡¿æŠ˜æ–·">é›»æ¡¿æŠ˜æ–· (æ¡¿)</option>
                                    <option value="é›»æ¡¿æµå¤±">é›»æ¡¿æµå¤± (æ¡¿)</option>
                                    <option value="é›»æ¡¿å…¨å€’">é›»æ¡¿å…¨å€’ (æ¡¿)</option>
                                    <option value="é›»æ¡¿å‚¾æ–œ">é›»æ¡¿å‚¾æ–œ (æ¡¿)</option>
                                    <option value="é›»ç·šæ–·ç·š">é›»ç·šæ–·ç·š (æ¢æª”)</option>
                                    <option value="é›»ç·šè„«è½">é›»ç·šè„«è½ (è™•)</option>
                                    <option value="æ¥æˆ¶ç·šæ–·è½">æ¥æˆ¶ç·šæ–·è½ (æˆ¶)</option>
                                    <option value="é–‹é—œæå£">é–‹é—œæå£ (å…·)</option>
                                    <option value="è®Šå£“å™¨æå£">è®Šå£“å™¨æå£ (å…·)</option>
                                    <option value="å¤–ç‰©ç¢°è§¸">å¤–ç‰©ç¢°è§¸ (æ¡¿)</option>
                                    <option value="é…é›»å®¤æ·¹æ°´">é…é›»å®¤æ·¹æ°´ (è™•)</option>
                                    <option value="ç†”çµ²éˆè·³è„«">ç†”çµ²éˆè·³è„« (è™•)</option>
                                    <option value="å…¶ä»–é¡å‹">å…¶ä»–é¡å‹ (è™•)</option>
                                    <option value="é é˜²æ€§ç¶­è­·å·¥ä½œ">é é˜²æ€§ç¶­è­·å·¥ä½œ (é …)</option>
                                </select>
                            </div>
                            
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">æ•¸é‡</label>
                                <input type="number" id="disaster-incident-quantity" min="1" value="1" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">&nbsp;</label>
                                <button type="button" id="disaster-add-incident-btn" style="width: 100%; padding: 10px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">
                                    <i class="fas fa-plus-circle"></i> æ–°å¢
                                </button>
                            </div>
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: bold;">å·²é¸äº‹æ•…é¡å‹</label>
                            <div id="disaster-incident-list" style="min-height: 40px; padding: 10px; background: #f8f9fa; border-radius: 4px;">
                                <div style="color: #666; font-style: italic;">å°šæœªé¸æ“‡äº‹æ•…é¡å‹</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ç…§ç‰‡ä¸Šå‚³å€å¡Š -->
                    <div class="disaster-form-section" style="margin-bottom: 30px; padding: 20px; border: 1px solid #e9ecef; border-radius: 8px; background-color: #fdfdfd;">
                        <h5 style="color: #007bff; font-weight: 600; margin-bottom: 15px; padding-bottom: 8px; border-bottom: 2px solid #e9ecef;">
                            <i class="fas fa-camera"></i> ç…§ç‰‡ä¸Šå‚³ (ImgBB)
                        </h5>
                        
                        <div id="disaster-drag-area" style="border: 2px dashed #007bff; border-radius: 10px; padding: 40px; text-align: center; background-color: #f8f9fa; transition: all 0.3s ease; cursor: pointer;">
                            <div style="font-size: 3rem; color: #007bff; margin-bottom: 15px;">
                                <i class="fas fa-cloud-upload-alt"></i>
                            </div>
                            <div style="font-size: 1.2rem; font-weight: 500; margin-bottom: 10px;">æ‹–æ‹½ç…§ç‰‡åˆ°æ­¤è™•æˆ–é»æ“Šé¸æ“‡</div>
                            <span style="color: #666;">æ”¯æ´ JPGã€PNG æ ¼å¼ï¼Œå–®æª”æœ€å¤§ 32MB</span>
                            <input type="file" id="disaster-file-input" multiple accept="image/*" style="display: none;">
                        </div>
                        
                        <div id="disaster-image-preview" style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px;"></div>
                    </div>
                    
                    <!-- ä½ç½®è³‡è¨Šå€å¡Š -->
                    <div class="disaster-form-section" style="margin-bottom: 30px; padding: 20px; border: 1px solid #e9ecef; border-radius: 8px; background-color: #fdfdfd;">
                        <h5 style="color: #007bff; font-weight: 600; margin-bottom: 15px; padding-bottom: 8px; border-bottom: 2px solid #e9ecef;">
                            <i class="fas fa-map-marker-alt"></i> ä½ç½®è³‡è¨Š
                        </h5>
                        
                        // åœ¨ä½ç½®è³‡è¨Šå€å¡Šä¸­åŠ å…¥è¨­å‚™è³‡è¨Šé¡¯ç¤º
					<div style="background-color: #e9ecef; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
						<div style="margin-bottom: 15px;">
							<strong>GPS å®šä½ï¼š</strong>
							<span id="disaster-latitude">${lat.toFixed(6)}</span>, <span id="disaster-longitude">${lng.toFixed(6)}</span>
							<button type="button" id="disaster-get-location-btn" style="margin-left: 10px; padding: 5px 10px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
								<i class="fas fa-crosshairs"></i> é‡æ–°å®šä½
							</button>
						</div>
						<div style="margin-bottom: 10px;">
							<strong>åˆå§‹ä½ç½®ï¼š</strong> ${decodeURIComponent(locationName)}
						</div>
						<!-- ğŸ†• è¨­å‚™è³‡è¨Šé¡¯ç¤ºå€åŸŸ -->
						<div id="disaster-device-info-display" style="margin-bottom: 10px; padding: 10px; background: rgba(0,123,255,0.1); border-radius: 4px; border-left: 3px solid #007bff; display: none;">
							<strong>ğŸ“ é—œè¯è¨­å‚™ï¼š</strong>
							<div id="disaster-device-details" style="font-size: 14px; margin-top: 5px; color: #495057;"></div>
						</div>
						<div>
							<input type="checkbox" id="disaster-auto-location" style="margin-right: 8px;">
							<label for="disaster-auto-location">è‡ªå‹•æ›´æ–°ä½ç½®</label>
						</div>
					</div>
                        
                        <div style="display: grid; grid-template-columns: ${isMobile ? '1fr' : '1fr 1fr'}; gap: 15px; margin-bottom: 15px;">
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">å°é›»åœ–è™Ÿ</label>
                                <input type="text" id="disaster-tpc-map-number" placeholder="ä¾‹ï¼šT1583EC06" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">æ¡¿è™Ÿ</label>
                                <input type="text" id="disaster-pole-number" placeholder="ä¾‹ï¼šé³³é³´#47å³1å³1" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: ${isMobile ? '1fr' : '1fr 1fr 1fr'}; gap: 15px;">
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">é¥‹ç·šä»£è™Ÿ</label>
                                <input type="text" id="disaster-feeder-code" placeholder="ä¾‹ï¼šBU24" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">ç·šè·¯é¡å‹</label>
                                <select id="disaster-line-type" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                                    <option value="">è«‹é¸æ“‡</option>
                                    <option value="ä¸»å¹¹">ä¸»å¹¹</option>
                                    <option value="åˆ†æ­§">åˆ†æ­§</option>
                                    <option value="ä½å£“">ä½å£“</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">å·¡ä¿®éƒ¨é–€</label>
                                <select id="disaster-department" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                                    <option value="">è«‹é¸æ“‡</option>
                                    <option value="å¸‚å·¡">å¸‚å·¡</option>
                                    <option value="å°å·¡">å°å·¡</option>
                                    <option value="æ——å·¡">æ——å·¡</option>
                                    <option value="æ¡ƒå…­ç”²">æ¡ƒå…­ç”²</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- å‚™è¨»å€å¡Š -->
                    <div class="disaster-form-section" style="margin-bottom: 30px; padding: 20px; border: 1px solid #e9ecef; border-radius: 8px; background-color: #fdfdfd;">
                        <h5 style="color: #007bff; font-weight: 600; margin-bottom: 15px; padding-bottom: 8px; border-bottom: 2px solid #e9ecef;">
                            <i class="fas fa-comment-alt"></i> å‚™è¨»è³‡è¨Š
                        </h5>
                        
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: bold;">å‚™è¨»</label>
                            <textarea id="disaster-remarks" rows="4" placeholder="è«‹è¼¸å…¥å…¶ä»–ç›¸é—œè³‡è¨Šæˆ–å‚™è¨»" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; resize: vertical; box-sizing: border-box;"></textarea>
                        </div>
                    </div>
                    
                    <!-- æäº¤æŒ‰éˆ• -->
                    <div style="text-align: center; margin-top: 30px;">
                        <button type="submit" style="background: linear-gradient(45deg, #dc3545, #c82333); color: white; border: none; padding: 15px 40px; font-size: 18px; font-weight: bold; border-radius: 8px; cursor: pointer; box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3); transition: all 0.3s ease;"
                                onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(220, 53, 69, 0.4)'"
                                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(220, 53, 69, 0.3)'">
                            <i class="fas fa-paper-plane"></i> æäº¤ç½æƒ…å ±å‘Š
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- è¼‰å…¥ä¸­è¦†è“‹å±¤ -->
        <div id="disaster-loading-overlay" style="display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); z-index: 10; justify-content: center; align-items: center;">
            <div style="text-align: center; color: white;">
                <div style="width: 3rem; height: 3rem; border: 4px solid #f3f3f3; border-top: 4px solid #007bff; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 15px;"></div>
                <p style="font-size: 16px;">æ­£åœ¨è™•ç†è³‡æ–™ï¼Œè«‹ç¨å€™...</p>
            </div>
        </div>
        
        <!-- ç…§ç‰‡ä¸Šå‚³é€²åº¦ -->
        <div id="disaster-upload-progress-container" style="display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: white; padding: 30px; border-radius: 10px; box-shadow: 0 0 20px rgba(0,0,0,0.3); z-index: 11; min-width: 350px; text-align: center;">
            <h5 style="color: #007bff; margin-bottom: 15px;">
                <i class="fas fa-cloud-upload-alt"></i> ç…§ç‰‡ä¸Šå‚³ä¸­
            </h5>
            <div style="margin-bottom: 15px;">
                <span id="disaster-upload-status">æº–å‚™ä¸Šå‚³...</span>
            </div>
            <div style="width: 100%; height: 8px; background: #e0e0e0; border-radius: 4px; overflow: hidden; margin: 15px 0;">
                <div id="disaster-upload-progress-fill" style="height: 100%; background: linear-gradient(45deg, #007bff, #0056b3); width: 0%; transition: width 0.3s ease;"></div>
            </div>
            <div id="disaster-upload-progress-text">0 / 0</div>
        </div>
        
        <style>
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
        </style>
    `;
}

// ğŸ”§ ä¿®æ”¹åˆå§‹åŒ–ç½æƒ…æŸ¥å ±ç³»çµ±
function initializeDisasterReportSystem() {
    console.log('ğŸ”§ åˆå§‹åŒ–ç½æƒ…æŸ¥å ±ç³»çµ±...');
    
    // é‡ç½®å…¨åŸŸè®Šæ•¸
    disasterIncidentItems = [];
    disasterSelectedFiles = [];
    
    // ç¶å®šäº‹ä»¶ç›£è½å™¨
    bindDisasterEventListeners();
    
    // ğŸ†• è‡ªå‹•å¡«å…¥è¨­å‚™è³‡è¨Š
    autoFillDeviceInfo();
    
    console.log('âœ… ç½æƒ…æŸ¥å ±ç³»çµ±åˆå§‹åŒ–å®Œæˆ');
}
// ğŸ†• ä¿®æ”¹è‡ªå‹•å¡«å…¥è¨­å‚™è³‡è¨Šå‡½æ•¸ - ä½¿ç”¨ Tpclid ä½œç‚ºå°é›»ID
function autoFillDeviceInfo() {
    const deviceInfo = window.disasterDeviceInfo;
    
    if (!deviceInfo) {
        console.log('ğŸ“‹ ç„¡è¨­å‚™è³‡è¨Šï¼Œè·³éè‡ªå‹•å¡«å…¥');
        return;
    }
    
    console.log('ğŸ“‹ é–‹å§‹è‡ªå‹•å¡«å…¥è¨­å‚™è³‡è¨Š:', deviceInfo);
    console.log('ğŸ¢ Tpclid (å°é›»ID):', deviceInfo.tpcId);
    
    // ğŸ”¥ é‡é»ï¼šè‡ªå‹•å¡«å…¥å°é›»åœ–è™Ÿï¼ˆä½¿ç”¨ Tpclidï¼‰
    const tpcMapNumberInput = document.getElementById('disaster-tpc-map-number');
    if (tpcMapNumberInput && deviceInfo.tpcId) {
        tpcMapNumberInput.value = deviceInfo.tpcId;
        console.log(`âœ… å·²å¡«å…¥å°é›»åœ–è™Ÿï¼ˆTpclidï¼‰: ${deviceInfo.tpcId}`);
        
        // é«˜äº®é¡¯ç¤ºå·²è‡ªå‹•å¡«å…¥çš„æ¬„ä½
        tpcMapNumberInput.style.backgroundColor = '#e8f5e8';
        tpcMapNumberInput.style.border = '2px solid #28a745';
        setTimeout(() => {
            tpcMapNumberInput.style.backgroundColor = '';
            tpcMapNumberInput.style.border = '';
        }, 3000);
    } else if (tpcMapNumberInput && !deviceInfo.tpcId) {
        console.warn('âš ï¸ è©²è¨­å‚™æ²’æœ‰ Tpclidï¼ˆå°é›»IDï¼‰è³‡è¨Š');
        showToast('âš ï¸ è©²è¨­å‚™æ²’æœ‰å°é›»IDè³‡è¨Š', 'warning');
    }
    
    // è‡ªå‹•å¡«å…¥é¥‹ç·šä»£è™Ÿ
    const feederCodeInput = document.getElementById('disaster-feeder-code');
    if (feederCodeInput && deviceInfo.feederCode) {
        feederCodeInput.value = deviceInfo.feederCode;
        console.log(`âœ… å·²å¡«å…¥é¥‹ç·šä»£è™Ÿ: ${deviceInfo.feederCode}`);
        
        // é«˜äº®é¡¯ç¤ºå·²è‡ªå‹•å¡«å…¥çš„æ¬„ä½
        feederCodeInput.style.backgroundColor = '#e8f5e8';
        feederCodeInput.style.border = '2px solid #28a745';
        setTimeout(() => {
            feederCodeInput.style.backgroundColor = '';
            feederCodeInput.style.border = '';
        }, 3000);
    }
    
    // æ ¹æ“šè¨­å‚™é¡å‹è‡ªå‹•é¸æ“‡ç·šè·¯é¡å‹
    const lineTypeSelect = document.getElementById('disaster-line-type');
    if (lineTypeSelect && deviceInfo.deviceType) {
        const deviceType = deviceInfo.deviceType.toLowerCase();
        
        if (deviceType.includes('ä¸»å¹¹') || deviceType.includes('main')) {
            lineTypeSelect.value = 'ä¸»å¹¹';
        } else if (deviceType.includes('åˆ†æ­§') || deviceType.includes('branch')) {
            lineTypeSelect.value = 'åˆ†æ­§';
        } else if (deviceType.includes('ä½å£“') || deviceType.includes('low')) {
            lineTypeSelect.value = 'ä½å£“';
        }
        
        if (lineTypeSelect.value) {
            console.log(`âœ… å·²é¸æ“‡ç·šè·¯é¡å‹: ${lineTypeSelect.value}`);
            
            // é«˜äº®é¡¯ç¤ºå·²è‡ªå‹•é¸æ“‡çš„æ¬„ä½
            lineTypeSelect.style.backgroundColor = '#e8f5e8';
            lineTypeSelect.style.border = '2px solid #28a745';
            setTimeout(() => {
                lineTypeSelect.style.backgroundColor = '';
                lineTypeSelect.style.border = '';
            }, 3000);
        }
    }
    
    // åœ¨å‚™è¨»æ¬„ä½è‡ªå‹•åŠ å…¥è¨­å‚™è³‡è¨Šï¼ˆä½¿ç”¨ Tpclidï¼‰
    const remarksTextarea = document.getElementById('disaster-remarks');
    if (remarksTextarea && deviceInfo) {
        let autoRemarks = [];
        
        // ğŸ”¥ é‡é»ï¼šä½¿ç”¨ Tpclid ä½œç‚ºå°é›»ID
        if (deviceInfo.tpcId) {
            autoRemarks.push(`å°é›»ID (Tpclid): ${deviceInfo.tpcId}`);
        }
        
        if (deviceInfo.deviceId && deviceInfo.deviceId !== deviceInfo.tpcId) {
            autoRemarks.push(`è¨­å‚™ID: ${deviceInfo.deviceId}`);
        }
        
        if (deviceInfo.feederCode) {
            autoRemarks.push(`é¥‹ç·šä»£è™Ÿ: ${deviceInfo.feederCode}`);
        }
        
        if (deviceInfo.deviceType) {
            autoRemarks.push(`è¨­å‚™é¡å‹: ${deviceInfo.deviceType}`);
        }
        
        if (deviceInfo.voltage) {
            autoRemarks.push(`é›»å£“ç­‰ç´š: ${deviceInfo.voltage}`);
        }
        
        if (autoRemarks.length > 0) {
            //remarksTextarea.value = `[è‡ªå‹•å¡«å…¥è¨­å‚™è³‡è¨Š]\n${autoRemarks.join('\n')}\n\n`;
            console.log(`âœ… å·²å¡«å…¥è¨­å‚™è³‡è¨Šåˆ°å‚™è¨»æ¬„ä½`);
            
            // é«˜äº®é¡¯ç¤ºå·²è‡ªå‹•å¡«å…¥çš„æ¬„ä½
            remarksTextarea.style.backgroundColor = '#e8f5e8';
            remarksTextarea.style.border = '2px solid #28a745';
            setTimeout(() => {
                remarksTextarea.style.backgroundColor = '';
                remarksTextarea.style.border = '';
            }, 3000);
        }
    }
    
    // ğŸ†• é¡¯ç¤ºè¨­å‚™è³‡è¨Šåœ¨ä½ç½®å€å¡Š
    displayDeviceInfoInLocationSection(deviceInfo);
    
    // é¡¯ç¤ºè‡ªå‹•å¡«å…¥å®Œæˆçš„æç¤º
    setTimeout(() => {
        if (deviceInfo.tpcId) {
            showToast(`âœ… å·²è‡ªå‹•å¡«å…¥å°é›»ID: ${deviceInfo.tpcId}`, 'success');
        } else {
            showToast('âš ï¸ è©²è¨­å‚™ç„¡ Tpclid è³‡è¨Š', 'warning');
        }
    }, 500);
}
// ğŸ†• åœ¨ä½ç½®å€å¡Šé¡¯ç¤ºè¨­å‚™è³‡è¨Šï¼ˆä½¿ç”¨ Tpclidï¼‰
function displayDeviceInfoInLocationSection(deviceInfo) {
    const deviceInfoDisplay = document.getElementById('disaster-device-info-display');
    const deviceDetails = document.getElementById('disaster-device-details');
    
    if (!deviceInfoDisplay || !deviceDetails) return;
    
    let infoHtml = '';
    
    // ğŸ”¥ é‡é»ï¼šå„ªå…ˆé¡¯ç¤º Tpclidï¼ˆå°é›»IDï¼‰
    if (deviceInfo.tpcId) {
        infoHtml += `<div style="margin-bottom: 5px;">
                        <strong>ğŸ¢ å°é›»ID (Tpclid):</strong> 
                        <span style="color: #007bff; font-weight: bold; background: #e3f2fd; padding: 2px 6px; border-radius: 4px;">
                            ${deviceInfo.tpcId}
                        </span>
                     </div>`;
    } else {
        infoHtml += `<div style="margin-bottom: 5px; color: #dc3545;">
                        <strong>âš ï¸ å°é›»ID (Tpclid):</strong> 
                        <span style="font-style: italic;">ç„¡è³‡æ–™</span>
                     </div>`;
    }
    
    // å¦‚æœè¨­å‚™IDèˆ‡å°é›»IDä¸åŒï¼Œä¹Ÿé¡¯ç¤ºè¨­å‚™ID
    if (deviceInfo.deviceId && deviceInfo.deviceId !== deviceInfo.tpcId) {
        infoHtml += `<div style="margin-bottom: 5px;"><strong>ğŸ“ è¨­å‚™ID:</strong> ${deviceInfo.deviceId}</div>`;
    }
    
    if (deviceInfo.feederCode) {
        infoHtml += `<div style="margin-bottom: 5px;"><strong>âš¡ é¥‹ç·š:</strong> ${deviceInfo.feederCode}</div>`;
    }
    
    if (deviceInfo.deviceType) {
        infoHtml += `<div style="margin-bottom: 5px;"><strong>ğŸ”§ é¡å‹:</strong> ${deviceInfo.deviceType}</div>`;
    }
    
    if (deviceInfo.voltage) {
        infoHtml += `<div style="margin-bottom: 5px;"><strong>ğŸ”Œ é›»å£“:</strong> ${deviceInfo.voltage}</div>`;
    }
    
    if (infoHtml) {
        deviceDetails.innerHTML = infoHtml;
        deviceInfoDisplay.style.display = 'block';
        console.log('âœ… å·²é¡¯ç¤ºè¨­å‚™è³‡è¨Šåœ¨ä½ç½®å€å¡Š');
    }
}
// ğŸ”— ç¶å®šç½æƒ…æŸ¥å ±äº‹ä»¶ç›£è½å™¨
function bindDisasterEventListeners() {
    // GPS å®šä½æŒ‰éˆ•
    const getLocationBtn = document.getElementById('disaster-get-location-btn');
    if (getLocationBtn) {
        getLocationBtn.addEventListener('click', disasterGetLocation);
    }
    
    // è‡ªå‹•å®šä½é–‹é—œ
    const autoLocationCheckbox = document.getElementById('disaster-auto-location');
    if (autoLocationCheckbox) {
        autoLocationCheckbox.addEventListener('change', disasterToggleAutoLocation);
    }
    
    // æ–°å¢äº‹æ•…é¡å‹æŒ‰éˆ•
    const addIncidentBtn = document.getElementById('disaster-add-incident-btn');
    if (addIncidentBtn) {
        addIncidentBtn.addEventListener('click', disasterAddIncidentItem);
    }
    
    // è¡¨å–®æäº¤
    const form = document.getElementById('disaster-report-form');
    if (form) {
        form.addEventListener('submit', disasterHandleFormSubmit);
    }
	  // ç…§ç‰‡ä¸Šå‚³ç›¸é—œ
    const dragArea = document.getElementById('disaster-drag-area');
    const fileInput = document.getElementById('disaster-file-input');
    
    if (dragArea && fileInput) {
        dragArea.addEventListener('click', () => fileInput.click());
        dragArea.addEventListener('dragover', disasterHandleDragOver);
        dragArea.addEventListener('dragleave', disasterHandleDragLeave);
        dragArea.addEventListener('drop', disasterHandleDrop);
        fileInput.addEventListener('change', disasterHandleFileSelect);
    }
}

// ğŸ“ ç½æƒ…æŸ¥å ±å®šä½åŠŸèƒ½
function disasterGetLocation() {
    if (!navigator.geolocation) {
        alert('æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´åœ°ç†ä½ç½®åŠŸèƒ½');
        return;
    }
    
    const btn = document.getElementById('disaster-get-location-btn');
    if (btn) {
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> å®šä½ä¸­...';
    }
    
    navigator.geolocation.getCurrentPosition(
        function(position) {
            disasterUpdateLocationDisplay(position.coords.latitude, position.coords.longitude);
            if (btn) {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-crosshairs"></i> é‡æ–°å®šä½';
            }
        },
        function(error) {
            console.error('å®šä½éŒ¯èª¤:', error);
            alert('ç„¡æ³•ç²å–ä½ç½®ï¼Œè«‹æª¢æŸ¥ä½ç½®æ¬Šé™');
            if (btn) {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-crosshairs"></i> é‡è©¦å®šä½';
            }
        },
        {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 0
        }
    );
}

function disasterUpdateLocationDisplay(lat, lng) {
    disasterCurrentPosition.lat = lat;
    disasterCurrentPosition.lng = lng;
    
    const latElement = document.getElementById('disaster-latitude');
    const lngElement = document.getElementById('disaster-longitude');
    
    if (latElement) latElement.textContent = lat.toFixed(6);
    if (lngElement) lngElement.textContent = lng.toFixed(6);
}

function disasterToggleAutoLocation() {
    const checkbox = document.getElementById('disaster-auto-location');
    
    if (checkbox && checkbox.checked) {
        if (navigator.geolocation) {
            disasterWatchPositionId = navigator.geolocation.watchPosition(
                function(position) {
                    disasterUpdateLocationDisplay(position.coords.latitude, position.coords.longitude);
                },
                function(error) {
                    console.error('ç›£è¦–ä½ç½®éŒ¯èª¤:', error);
                    checkbox.checked = false;
                }
            );
        }
    } else {
        if (disasterWatchPositionId !== null) {
            navigator.geolocation.clearWatch(disasterWatchPositionId);
            disasterWatchPositionId = null;
        }
    }
}

// ğŸ“‹ ç½æƒ…äº‹æ•…é …ç›®ç®¡ç†
function disasterAddIncidentItem() {
    const typeSelect = document.getElementById('disaster-incident-type-select');
    const quantityInput = document.getElementById('disaster-incident-quantity');
    
    if (!typeSelect || !quantityInput) return;
    
    const typeWithUnit = typeSelect.value;
    const quantity = parseInt(quantityInput.value) || 1;
    
    if (!typeWithUnit) {
        alert('è«‹å…ˆé¸æ“‡äº‹æ•…é¡å‹');
        typeSelect.focus();
        return;
    }
    
    // è§£æäº‹æ•…é¡å‹å’Œå–®ä½
    const match = typeWithUnit.match(/^(.+?)\s*\((.+?)\)$/);
    let type, unit;
    
    if (match) {
        type = match[1].trim();
        unit = match[2].trim();
    } else {
        type = typeWithUnit;
        unit = 'è™•';
    }
    
    // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒé¡å‹
    const existingIndex = disasterIncidentItems.findIndex(item => item.type === type);
    if (existingIndex !== -1) {
        disasterIncidentItems[existingIndex].quantity = quantity;
        showToast(`å·²æ›´æ–°ã€Œ${type}ã€çš„æ•¸é‡ç‚º ${quantity}`, 'info');
    } else {
        disasterIncidentItems.push({ type, quantity, unit });
        showToast(`å·²æ–°å¢ã€Œ${type}ã€åˆ°äº‹æ•…æ¸…å–®`, 'success');
    }
    
    disasterRenderIncidentItems();
    
    // é‡ç½®è¼¸å…¥
    typeSelect.value = '';
    quantityInput.value = '1';
    typeSelect.focus();
}

function disasterRenderIncidentItems() {
    const container = document.getElementById('disaster-incident-list');
    if (!container) return;
    
    if (disasterIncidentItems.length === 0) {
        container.innerHTML = '<div style="color: #666; font-style: italic;">å°šæœªé¸æ“‡äº‹æ•…é¡å‹</div>';
        return;
    }
    
    let html = '';
    disasterIncidentItems.forEach((item, index) => {
        html += `
            <div style="display: flex; align-items: center; background-color: #e9ecef; padding: 10px 15px; border-radius: 6px; margin-bottom: 10px; border-left: 4px solid #007bff;">
                <span style="font-weight: 500; color: #495057; flex: 1;">${item.type}: ${item.quantity} ${item.unit}</span>
                <i class="fas fa-times-circle" style="color: #dc3545; cursor: pointer; font-size: 1.2rem; margin-left: 10px;" onclick="disasterRemoveIncidentItem(${index})"></i>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

function disasterRemoveIncidentItem(index) {
    disasterIncidentItems.splice(index, 1);
    disasterRenderIncidentItems();
}

// ğŸ“· ç½æƒ…ç…§ç‰‡è™•ç†
function disasterHandleDragOver(e) {
    e.preventDefault();
    document.getElementById('disaster-drag-area').style.borderColor = '#0056b3';
    document.getElementById('disaster-drag-area').style.backgroundColor = 'rgba(0, 123, 255, 0.05)';
}

function disasterHandleDragLeave(e) {
    e.preventDefault();
    document.getElementById('disaster-drag-area').style.borderColor = '#007bff';
    document.getElementById('disaster-drag-area').style.backgroundColor = '#f8f9fa';
}

function disasterHandleDrop(e) {
    e.preventDefault();
    document.getElementById('disaster-drag-area').style.borderColor = '#007bff';
    document.getElementById('disaster-drag-area').style.backgroundColor = '#f8f9fa';
    const files = Array.from(e.dataTransfer.files);
    disasterHandleFiles(files);
}

function disasterHandleFileSelect(e) {
    const files = Array.from(e.target.files);
    disasterHandleFiles(files);
}

function disasterHandleFiles(files) {
    const imageFiles = files.filter(file => file.type.startsWith('image/'));
    
    if (imageFiles.length === 0) {
        alert('è«‹é¸æ“‡åœ–ç‰‡æª”æ¡ˆ');
        return;
    }
    
    // æª¢æŸ¥æ–‡ä»¶å¤§å° (32MB é™åˆ¶)
    const oversizedFiles = imageFiles.filter(file => file.size > 32 * 1024 * 1024);
    if (oversizedFiles.length > 0) {
        alert(`ä»¥ä¸‹æ–‡ä»¶è¶…é 32MB é™åˆ¶ï¼š${oversizedFiles.map(f => f.name).join(', ')}`);
        return;
    }
    
    imageFiles.forEach(file => {
        if (disasterSelectedFiles.length >= 10) {
            alert('æœ€å¤šåªèƒ½ä¸Šå‚³10å¼µç…§ç‰‡');
            return;
        }
        
        disasterSelectedFiles.push(file);
        disasterDisplayImagePreview(file);
    });
}

function disasterDisplayImagePreview(file) {
    const reader = new FileReader();
    reader.onload = function(e) {
        const preview = document.getElementById('disaster-image-preview');
        if (!preview) return;
        
        const imgContainer = document.createElement('div');
        imgContainer.style.cssText = 'position: relative; width: 100px; height: 100px;';
        
        const img = document.createElement('img');
        img.src = e.target.result;
        img.style.cssText = 'width: 100%; height: 100%; object-fit: cover; border-radius: 8px; border: 2px solid #dee2e6;';
        
        const removeBtn = document.createElement('div');
        removeBtn.style.cssText = 'position: absolute; top: -8px; right: -8px; background-color: #dc3545; color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; justify-content: center; align-items: center; font-size: 14px; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.2);';
        removeBtn.innerHTML = 'Ã—';
        removeBtn.onclick = function() {
            const index = disasterSelectedFiles.indexOf(file);
            if (index > -1) {
                disasterSelectedFiles.splice(index, 1);
            }
            imgContainer.remove();
        };
        
        imgContainer.appendChild(img);
        imgContainer.appendChild(removeBtn);
        preview.appendChild(imgContainer);
    };
    reader.readAsDataURL(file);
}

// ğŸ“¤ ä¸Šå‚³ç…§ç‰‡åˆ° ImgBB
async function disasterUploadToImgBB(file) {
    const formData = new FormData();
    formData.append('image', file);
    
    try {
        const response = await fetch(`https://api.imgbb.com/1/upload?key=${DISASTER_IMGBB_API_KEY}`, {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            return { success: true, url: data.data.url };
        } else {
            throw new Error(data.error?.message || 'ä¸Šå‚³å¤±æ•—');
        }
    } catch (error) {
        console.error('ImgBB ä¸Šå‚³éŒ¯èª¤:', error);
        throw new Error('ç¶²è·¯éŒ¯èª¤æˆ–æœå‹™ä¸å¯ç”¨: ' + error.message);
    }
}

// ğŸ“Š é¡¯ç¤ºä¸Šå‚³é€²åº¦
function disasterShowUploadProgress(show) {
    const container = document.getElementById('disaster-upload-progress-container');
    if (container) {
        container.style.display = show ? 'block' : 'none';
    }
}

function disasterUpdateUploadProgress(current, total, fileName) {
    const progress = (current / total) * 100;
    const progressFill = document.getElementById('disaster-upload-progress-fill');
    const progressText = document.getElementById('disaster-upload-progress-text');
    const uploadStatus = document.getElementById('disaster-upload-status');
    
    if (progressFill) progressFill.style.width = progress + '%';
    if (progressText) progressText.textContent = `${current} / ${total}`;
    if (uploadStatus) uploadStatus.textContent = `æ­£åœ¨ä¸Šå‚³: ${fileName}`;
}

// ğŸ“ è¡¨å–®æäº¤è™•ç†
function disasterHandleFormSubmit(e) {
    e.preventDefault();
    
    if (!disasterValidateForm()) {
        return;
    }
    
    disasterShowLoading(true);
    
    // å¦‚æœæœ‰ç…§ç‰‡ï¼Œå…ˆä¸Šå‚³ç…§ç‰‡
    if (disasterSelectedFiles.length > 0) {
        disasterUploadPhotosAndSubmit();
    } else {
        // æ²’æœ‰ç…§ç‰‡ï¼Œç›´æ¥æäº¤
        const reportId = disasterGenerateReportId();
        const formData = disasterCollectFormData(reportId, []);
        disasterSubmitToGoogleSheets(formData);
    }
}

async function disasterUploadPhotosAndSubmit() {
    console.log(`é–‹å§‹ä¸Šå‚³ ${disasterSelectedFiles.length} å¼µç…§ç‰‡åˆ° ImgBB`);
    disasterShowUploadProgress(true);
    
    const photoUrls = [];
    
    try {
        // åºåˆ—ä¸Šå‚³ç…§ç‰‡
        for (let i = 0; i < disasterSelectedFiles.length; i++) {
            const file = disasterSelectedFiles[i];
            disasterUpdateUploadProgress(i + 1, disasterSelectedFiles.length, file.name);
            
            console.log(`æ­£åœ¨ä¸Šå‚³ç¬¬ ${i + 1} å¼µç…§ç‰‡: ${file.name}`);
            
            const result = await disasterUploadToImgBB(file);
            if (result.success && result.url) {
                photoUrls.push(result.url);
                console.log(`ç…§ç‰‡ ${file.name} ä¸Šå‚³æˆåŠŸ: ${result.url}`);
            } else {
                console.error(`ç…§ç‰‡ ${file.name} ä¸Šå‚³å¤±æ•—`);
            }
            
            // æ·»åŠ å»¶é²é¿å…è«‹æ±‚éæ–¼é »ç¹
            if (i < disasterSelectedFiles.length - 1) {
                await new Promise(resolve => setTimeout(resolve, 1000));
            }
        }
        
        disasterShowUploadProgress(false);
        console.log(`ç…§ç‰‡ä¸Šå‚³å®Œæˆï¼ŒæˆåŠŸä¸Šå‚³ ${photoUrls.length} å¼µ`);
        
        // æäº¤å ±å‘Š
        const reportId = disasterGenerateReportId();
        const formData = disasterCollectFormData(reportId, photoUrls);
        disasterSubmitToGoogleSheets(formData);
        
    } catch (error) {
        console.error('ç…§ç‰‡ä¸Šå‚³éç¨‹å‡ºéŒ¯:', error);
        disasterShowUploadProgress(false);
        disasterShowLoading(false);
        alert('ç…§ç‰‡ä¸Šå‚³å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦: ' + error.toString());
    }
}

// ğŸ“‹ é©—è­‰è¡¨å–®
function disasterValidateForm() {
    // æª¢æŸ¥äº‹æ•…é¡å‹æ¸…å–®
    if (disasterIncidentItems.length === 0) {
        alert('è«‹è‡³å°‘é¸æ“‡ä¸€ç¨®äº‹æ•…é¡å‹');
        return false;
    }
    
    // æª¢æŸ¥ä½ç½®è³‡è¨Š
    if (!disasterCurrentPosition.lat || !disasterCurrentPosition.lng) {
        const tpcMapNumber = document.getElementById('disaster-tpc-map-number')?.value.trim();
        const poleNumber = document.getElementById('disaster-pole-number')?.value.trim();
        
        if (!tpcMapNumber && !poleNumber) {
            const confirm = window.confirm('å°šæœªå–å¾— GPS ä½ç½®ä¸”æœªå¡«å¯«å°é›»åœ–è™Ÿæˆ–æ¡¿è™Ÿï¼Œæ˜¯å¦ç¹¼çºŒæäº¤ï¼Ÿ');
            if (!confirm) {
                return false;
            }
        }
    }
    
    return true;
}

// ğŸ“Š æ”¶é›†è¡¨å–®è³‡æ–™
function disasterCollectFormData(reportId, photoUrls) {
    const now = new Date();
    
    const timestamp = now.toLocaleString('zh-TW', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        hour12: false
    });
    
    return {
        reportId: reportId,
        timestamp: timestamp,
        incidentData: JSON.stringify(disasterIncidentItems),
        gpsLocation: disasterCurrentPosition.lat && disasterCurrentPosition.lng ? 
            `${disasterCurrentPosition.lat},${disasterCurrentPosition.lng}` : '',
        tpcMapNumber: document.getElementById('disaster-tpc-map-number')?.value.trim() || '',
        poleNumber: document.getElementById('disaster-pole-number')?.value.trim() || '',
        remarks: document.getElementById('disaster-remarks')?.value.trim() || '',
        photoUrls: photoUrls.length > 0 ? photoUrls.join(',') : '',
        feederCode: document.getElementById('disaster-feeder-code')?.value.trim() || '',
        lineType: document.getElementById('disaster-line-type')?.value || '',
        department: document.getElementById('disaster-department')?.value || '',
        source: 'feeder-map-system'
    };
}

// ğŸ†” ç”Ÿæˆå ±å‘ŠID
function disasterGenerateReportId() {
    return Date.now().toString();
}

// ğŸ“¤ æäº¤åˆ° Google Sheets
function disasterSubmitToGoogleSheets(formData) {
    const iframe = document.createElement('iframe');
    iframe.name = 'disaster-submit-iframe';
    iframe.style.display = 'none';
    document.body.appendChild(iframe);
    
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = DISASTER_GAS_URL;
    form.target = 'disaster-submit-iframe';
    
    const input = document.createElement('input');
    input.type = 'hidden';
    input.name = 'formData';
    input.value = JSON.stringify(formData);
    
    form.appendChild(input);
    document.body.appendChild(form);
    
    iframe.onload = function() {
        try {
            const response = iframe.contentDocument.body.textContent;
            let result;
            
            try {
                result = JSON.parse(response);
            } catch (e) {
                result = { success: true, message: 'æäº¤æˆåŠŸ' };
            }
            
            disasterHandleSubmitSuccess(result);
        } catch (error) {
            console.log('è¡¨å–®å·²æäº¤ï¼Œä½†ç„¡æ³•è®€å–å›æ‡‰');
            disasterHandleSubmitSuccess({ success: true, message: 'è¡¨å–®å·²æäº¤' });
        }
        
        // æ¸…ç†
        document.body.removeChild(form);
        document.body.removeChild(iframe);
    };
    
    // æäº¤è¡¨å–®
    form.submit();
}

// âœ… è™•ç†æäº¤æˆåŠŸ
function disasterHandleSubmitSuccess(result) {
    disasterShowLoading(false);
    
    if (result && result.success === false) {
        alert('æäº¤å¤±æ•—ï¼š' + (result.error || result.message || 'æœªçŸ¥éŒ¯èª¤'));
        return;
    }
    
    // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
    const reportId = result.reportId || disasterGenerateReportId();
    let successMessage = `ç½æƒ…å ±å‘Šå·²æˆåŠŸæäº¤ï¼\n\nå ±å‘Šç·¨è™Ÿï¼š${reportId}\næäº¤æ™‚é–“ï¼š${new Date().toLocaleString()}`;
    
    if (disasterSelectedFiles.length > 0) {
        successMessage += `\nå·²ä¸Šå‚³ç…§ç‰‡ï¼š${disasterSelectedFiles.length} å¼µ (ImgBB)`;
    }
    
    successMessage += '\n\næ„Ÿè¬æ‚¨çš„å›å ±ï¼';
    
    showToast('âœ… ç½æƒ…å ±å‘Šæäº¤æˆåŠŸï¼', 'success');
    alert(successMessage);
    
    // é—œé–‰ç½æƒ…æŸ¥å ±ç³»çµ±
    closeDisasterReportSystem();
}

// ğŸ”„ é¡¯ç¤º/éš±è—è¼‰å…¥ä¸­
function disasterShowLoading(show) {
    const overlay = document.getElementById('disaster-loading-overlay');
    if (overlay) {
        overlay.style.display = show ? 'flex' : 'none';
    }
}

// âŒ é—œé–‰ç½æƒ…æŸ¥å ±ç³»çµ±
function closeDisasterReportSystem() {
    console.log('âŒ é—œé–‰ç½æƒ…æŸ¥å ±ç³»çµ±');
    
    // åœæ­¢ä½ç½®ç›£è¦–
    if (disasterWatchPositionId !== null) {
        navigator.geolocation.clearWatch(disasterWatchPositionId);
        disasterWatchPositionId = null;
    }
    
    // ç§»é™¤å®¹å™¨
    if (disasterReportContainer) {
        disasterReportContainer.remove();
        disasterReportContainer = null;
    }
    
    // æ¢å¾©é é¢æ»¾å‹•
    document.body.style.overflow = 'auto';
    
    // é‡ç½®å…¨åŸŸè®Šæ•¸
    disasterCurrentPosition = { lat: null, lng: null };
    disasterIncidentItems = [];
    disasterSelectedFiles = [];
    
    showToast('ç½æƒ…æŸ¥å ±ç³»çµ±å·²é—œé–‰', 'info');
}

// ğŸ“± æ‰‹æ©Ÿç‰ˆå„ªåŒ–
document.addEventListener('DOMContentLoaded', function() {
    // ç›£è½è¦–çª—å¤§å°è®ŠåŒ–ï¼Œç¢ºä¿æ‰‹æ©Ÿç‰ˆæ­£å¸¸é¡¯ç¤º
    window.addEventListener('resize', function() {
        if (disasterReportContainer) {
            const isMobile = window.innerWidth <= 768;
            // å¯ä»¥åœ¨é€™è£¡åŠ å…¥éŸ¿æ‡‰å¼èª¿æ•´é‚è¼¯
        }
    });
});

		  </script>
		  <!-- ç…§ç‰‡æ”¾å¤§æ¨¡æ…‹æ¡† -->
		<div id="photo-modal" class="photo-modal">
			<span class="photo-modal-close" onclick="closePhotoModal()">&times;</span>
			<img class="photo-modal-content" id="modal-photo">
		</div>
	  </body>
	  </html>
